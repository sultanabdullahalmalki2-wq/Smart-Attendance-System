<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a237e">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ø­ØªØ±Ø§ÙÙŠ v7.0</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">    
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Tajawal',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;overflow-x:hidden}
.container{max-width:1400px;margin:0 auto;padding:20px}
.nav{background:white;border-radius:15px;padding:15px;margin-bottom:20px;display:flex;justify-content:space-around;box-shadow:0 5px 20px rgba(0,0,0,0.1);position:sticky;top:20px;z-index:100;overflow-x:auto}
.nav-item{flex:1;text-align:center;padding:12px;border-radius:10px;cursor:pointer;transition:all 0.3s;color:#666;font-weight:500;min-width:90px}
.nav-item:hover{background:#f5f5f5;transform:translateY(-2px)}
.nav-item.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 15px rgba(102,126,234,0.4)}
.nav-item i{display:block;font-size:22px;margin-bottom:5px}
.nav-item span{font-size:13px}
.sub-tabs{background:white;border-radius:12px;padding:10px;margin-bottom:20px;display:flex;gap:10px;box-shadow:0 3px 10px rgba(0,0,0,0.08)}
.sub-tab{flex:1;padding:12px 20px;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.3s;color:#666;font-weight:600;background:#f8f9fa}
.sub-tab:hover{background:#e9ecef}
.sub-tab.active{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:white;box-shadow:0 3px 12px rgba(17,153,142,0.3)}
.page{display:none;animation:fadeIn 0.5s}
.page.active{display:block}
.sub-page{display:none}
.sub-page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.card{background:white;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 5px 20px rgba(0,0,0,0.1)}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0;flex-wrap:wrap;gap:10px}
.card-title{font-size:1.5rem;font-weight:700;color:#1a237e;display:flex;align-items:center;gap:10px}
.card-title i{font-size:1.8rem;color:#667eea}
.btn{padding:12px 24px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s;font-family:'Tajawal',sans-serif;display:inline-flex;align-items:center;gap:8px;justify-content:center}
.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 15px rgba(102,126,234,0.4)}
.btn-primary:hover{transform:translateY(-2px)}
.btn-success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:white}
.btn-danger{background:linear-gradient(135deg,#eb3349 0%,#f45c43 100%);color:white}
.btn-warning{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white}
.btn-info{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white}
.btn-secondary{background:#f5f5f5;color:#666}
.btn-whatsapp{background:#25d366;color:white}
.btn-close{background:#dc3545;color:white}
.form-group{margin-bottom:20px}
.form-label{display:block;margin-bottom:8px;font-weight:600;color:#333;font-size:15px}
.form-input,.form-select,.form-textarea{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;font-family:'Tajawal',sans-serif;transition:all 0.3s}
.form-textarea{min-height:120px;resize:vertical}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
.filters-section{background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:20px}
.filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px}
.filter-actions{display:flex;gap:10px;flex-wrap:wrap}
.student-list{display:grid;gap:15px}
.student-item{background:#f8f9fa;padding:15px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;transition:all 0.3s;border-right:4px solid transparent}
.student-item:hover{background:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.08);transform:translateX(-5px);border-right-color:#667eea}
.student-item.selected{background:#e3f2fd;border-right-color:#2196f3}
.student-checkbox{width:20px;height:20px;cursor:pointer;margin-left:10px}
.student-info{flex:1}
.student-name{font-size:1.1rem;font-weight:700;color:#1a237e;margin-bottom:5px}
.student-details{display:flex;gap:15px;flex-wrap:wrap;font-size:14px;color:#666}
.student-detail{display:flex;align-items:center;gap:5px}
.student-detail i{color:#667eea}
.student-record{margin-top:10px;padding:10px;background:rgba(102,126,234,0.05);border-radius:8px;display:flex;gap:15px;flex-wrap:wrap;font-size:13px}
.record-badge{padding:4px 10px;border-radius:15px;font-weight:600;display:inline-flex;align-items:center;gap:5px}
.record-badge.delays{background:#fff3cd;color:#856404}
.record-badge.absences{background:#f8d7da;color:#721c24}
.record-badge.notes{background:#d1ecf1;color:#0c5460}
.student-actions{display:flex;gap:10px}
.btn-icon{width:40px;height:40px;border-radius:10px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s;font-size:16px}
.btn-icon.edit{background:#667eea;color:white}
.btn-icon.delete{background:#f45c43;color:white}
.btn-icon:hover{transform:scale(1.1)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
@media (max-width:768px){
.stats-grid{grid-template-columns:repeat(2,1fr);gap:12px}
}
@media (max-width:480px){
.stats-grid{grid-template-columns:1fr;gap:10px}
}
.stat-card{background:white;padding:20px;border-radius:12px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,0.1);transition:all 0.3s}
.stat-card:hover{transform:translateY(-5px)}
.stat-icon{font-size:2.5rem;margin-bottom:10px}
.stat-value{font-size:2rem;font-weight:900;margin-bottom:5px}
.stat-label{color:#666;font-size:14px;font-weight:500}
.levels-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
.level-card{padding:20px;border-radius:12px;border-right:5px solid;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
.level-card.safe{background:#d4edda;border-right-color:#28a745}
.level-card.attention{background:#fff3cd;border-right-color:#ffc107}
.level-card.warning{background:#ffe0b2;border-right-color:#fd7e14}
.level-card.danger{background:#f8d7da;border-right-color:#dc3545}
.level-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.level-title{font-size:1.2rem;font-weight:700}
.level-count{font-size:2rem;font-weight:900}
.level-threshold{font-size:13px;color:#666;margin-bottom:10px}
.level-threshold-input{width:80px;padding:5px;border:1px solid #ddd;border-radius:5px;text-align:center;margin:0 5px}
.level-students{max-height:200px;overflow-y:auto}
.level-student{padding:8px;background:white;margin-bottom:5px;border-radius:6px;font-size:14px;display:flex;justify-content:space-between}
.search-box{position:relative;margin-bottom:20px}
.search-input{width:100%;padding:15px 50px 15px 20px;border:2px solid #e0e0e0;border-radius:12px;font-size:16px}
.search-input:focus{border-color:#667eea}
.search-icon{position:absolute;left:20px;top:50%;transform:translateY(-50%);color:#667eea;font-size:20px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;overflow-y:auto;padding:20px 0}
.modal.active{display:flex}
.modal-content{background:white;border-radius:20px;padding:30px;max-width:500px;width:90%;max-height:85vh;overflow-y:auto;margin:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
.modal-title{font-size:1.5rem;font-weight:700;color:#1a237e}
.modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#666;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%}
.modal-close:hover{background:#f0f0f0}
.empty-state{text-align:center;padding:60px 20px;color:#666}
.empty-icon{font-size:4rem;margin-bottom:20px;opacity:0.5}
.empty-text{font-size:1.2rem;margin-bottom:10px}
.toast{position:fixed;bottom:30px;right:30px;background:white;padding:15px 20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.2);z-index:100000;display:flex;align-items:center;gap:12px;min-width:300px;transform:translateX(400px);transition:transform 0.3s}
.toast.show{transform:translateX(0)}
.toast-icon{font-size:24px}
.toast.success{border-right:4px solid #38ef7d}
.toast.success .toast-icon{color:#38ef7d}
.toast.error{border-right:4px solid #f45c43}
.toast.error .toast-icon{color:#f45c43}
.toast.info{border-right:4px solid #667eea}
.toast.info .toast-icon{color:#667eea}
.subscription-badge{background:white;padding:15px 20px;border-radius:12px;display:flex;align-items:center;gap:15px;margin-bottom:20px;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
.subscription-icon{font-size:2rem}
.subscription-info{flex:1}
.subscription-status{font-weight:700;font-size:16px;margin-bottom:5px}
.subscription-expiry{font-size:13px;color:#666}
.subscription-badge.trial{border-right:4px solid #ff9800}
.subscription-badge.active{border-right:4px solid #4caf50}
#lockScreen,#paymentPage{position:fixed;top:0;left:0;width:100vw;min-height:100vh;z-index:99999;overflow-y:auto}
.lock-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(26,35,126,0.95) 0%,rgba(13,71,161,0.95) 100%)}
.lock-container,.payment-container{position:relative;z-index:1;max-width:500px;margin:0 auto;padding:20px;min-height:100vh;display:flex;flex-direction:column;justify-content:flex-start;padding-top:40px;padding-bottom:40px}
.lock-header{text-align:center;margin-bottom:30px}
.lock-icon-main{font-size:70px;margin-bottom:15px}
.lock-main-title{color:white;font-size:2rem;margin-bottom:10px;font-weight:900}
.lock-subtitle{color:rgba(255,255,255,0.9);font-size:1.1rem}
.features-grid{display:grid;gap:15px;margin-bottom:30px}
.feature-item{background:rgba(255,255,255,0.1);padding:20px;border-radius:15px;display:flex;gap:15px}
.feature-icon{font-size:2rem;min-width:50px;height:50px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center}
.feature-content{flex:1}
.feature-title{color:white;font-size:1.1rem;font-weight:700;margin-bottom:5px}
.feature-text{color:rgba(255,255,255,0.8);font-size:14px}
.btn-subscribe-main{width:100%;padding:18px;background:linear-gradient(135deg,#ffd89b 0%,#19547b 100%);color:white;border:none;border-radius:15px;font-size:1.2rem;font-weight:900;cursor:pointer;margin-bottom:15px}
.warning-box{background:rgba(244,67,54,0.15);border:2px solid rgba(244,67,54,0.5);border-radius:15px;padding:20px;margin-top:20px;display:flex;gap:15px}
.warning-icon{font-size:2rem;color:#ff5252}
.warning-content{flex:1;color:white}
.countdown-timer{background:rgba(244,67,54,0.3);padding:4px 12px;border-radius:20px;font-weight:900;color:#ffeb3b}
.payment-methods{display:grid;gap:15px;margin-bottom:30px}
.payment-method{background:rgba(255,255,255,0.95);padding:20px;border-radius:15px;cursor:pointer;border:3px solid transparent}
.payment-method.selected{border-color:#ffd89b;background:white}
.method-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
.method-icon{font-size:2rem;min-width:50px;height:50px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:12px;display:flex;align-items:center;justify-content:center}
.method-title h3{font-size:1.2rem;color:#1a237e}
.method-content{display:none;margin-top:15px;padding-top:15px;border-top:2px solid #f0f0f0}
.payment-method.selected .method-content{display:block}
.bank-info{background:#e3f2fd;padding:15px;border-radius:10px;margin-bottom:15px}
.bank-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px dashed rgba(0,0,0,0.1)}
.activation-section{background:rgba(255,255,255,0.95);padding:25px;border-radius:15px;text-align:center}
.activation-input-group{display:flex;gap:10px}
.activation-input{flex:1;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;text-align:center;font-family:monospace;text-transform:uppercase}
.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:30px}
.chart-container{background:white;padding:20px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
.chart-container h3{color:#1a237e;margin-bottom:15px;text-align:center}
.export-section{text-align:center;margin-top:30px}
.sync-indicator{position:fixed;top:20px;left:20px;background:white;padding:10px 15px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.1);display:flex;align-items:center;gap:10px;z-index:1000}
.sync-indicator.syncing{background:#fff3cd}
.sync-indicator.success{background:#d4edda}
.sync-indicator.error{background:#f8d7da}
.sync-indicator i{animation:spin 1s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.sync-progress{width:100px;height:4px;background:#e0e0e0;border-radius:2px;overflow:hidden;margin-right:10px}
.sync-progress-bar{height:100%;background:#667eea;transition:width 0.3s}
.excel-instructions{background:#e3f2fd;padding:15px;border-radius:10px;margin-bottom:15px;border-right:4px solid #2196f3}
.excel-instructions h4{color:#1976d2;margin-bottom:10px}
.excel-instructions ul{margin-right:20px;color:#555}
.excel-instructions li{margin-bottom:5px}
@media (max-width:768px){
.nav{padding:10px 5px}
.nav-item{padding:10px 5px;font-size:12px;min-width:70px}
.stats-grid{grid-template-columns:repeat(2,1fr)}
.filters-grid{grid-template-columns:1fr}
.student-item{flex-direction:column;align-items:start;gap:15px}
.levels-grid{grid-template-columns:1fr}
.charts-grid{grid-template-columns:1fr}
.d-flex.gap-10{justify-content:center}
.d-flex.gap-10 .btn{flex:1 1 calc(50% - 5px);min-width:120px;max-width:200px;font-size:14px}
}
@media (max-width:480px){
.d-flex.gap-10{flex-direction:column}
.d-flex.gap-10 .btn{width:100%;max-width:100%}
}
.w-100{width:100%}
.d-flex{display:flex}
.gap-10{gap:10px}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-thumb{background:#667eea;border-radius:10px}

.btn:disabled, .btn-icon:disabled, input:disabled, select:disabled, textarea:disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    pointer-events: none !important;
}
.disabled-action {
    pointer-events: none !important;
    opacity: 0.5 !important;
    cursor: not-allowed !important;
}

/* Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ */
.btn:disabled:not([data-allow="true"]), 
.btn-icon:disabled:not([data-allow="true"]), 
input:disabled:not([data-allow="true"]), 
select:disabled:not([data-allow="true"]), 
textarea:disabled:not([data-allow="true"]) {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    pointer-events: none !important;
}

.disabled-action:not([data-allow="true"]) {
    pointer-events: none !important;
    opacity: 0.5 !important;
    cursor: not-allowed !important;
}

/* Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ */
[data-allow="true"] {
    pointer-events: auto !important;
    opacity: 1 !important;
    cursor: pointer !important;
}
</style>
</head>
<body>

<div id="lockScreen" style="display:none;">
<div class="lock-overlay"></div>
<div class="lock-container">
<div class="lock-header">
<div class="lock-icon-main">ğŸ”’</div>
<h1 class="lock-main-title">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠ</h1>
<p class="lock-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø´Ø§Ù…Ù„Ø©</p>
</div>
<div class="features-grid">
<div class="feature-item"><div class="feature-icon">ğŸ“Š</div><div class="feature-content"><div class="feature-title">ØªÙ‚Ø§Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠØ©</div><div class="feature-text">ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ©</div></div></div>
<div class="feature-item"><div class="feature-icon">â˜ï¸</div><div class="feature-content"><div class="feature-title">Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø­Ø§Ø¨ÙŠØ©</div><div class="feature-text">ÙˆØµÙˆÙ„ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø²</div></div></div>
<div class="feature-item"><div class="feature-icon">ğŸ“±</div><div class="feature-content"><div class="feature-title">ÙˆØ§ØªØ³Ø§Ø¨</div><div class="feature-text">Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</div></div></div>
</div>
<button class="btn-subscribe-main" onclick="app.showPaymentPage()" data-allow="true">ğŸš€ Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† - 35 Ø±ÙŠØ§Ù„</button>
<button class="btn btn-info w-100" onclick="app.returnToApp()" data-allow="true">â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</button>
<div class="warning-box">
<span class="warning-icon">âš ï¸</span>
<div class="warning-content"><strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù…ØªØ¨Ù‚ÙŠ <span class="countdown-timer" id="trialDaysLeft">7</span> Ø£ÙŠØ§Ù…</div>
</div>
</div>
</div>

<div id="paymentPage" style="display:none;">
<div class="lock-overlay"></div>
<div class="payment-container">
<button class="btn btn-secondary" onclick="app.hidePaymentPage()" style="margin-bottom:20px;" data-allow="true">â† Ø±Ø¬ÙˆØ¹</button>
<div class="payment-header" style="text-align:center;margin-bottom:30px;">
<div style="font-size:60px;margin-bottom:15px;">ğŸ’³</div>
<h2 style="color:white;font-size:2rem;margin-bottom:10px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹</h2>
</div>
<div class="payment-methods">
<div class="payment-method" id="bankTransfer" onclick="app.selectPaymentMethod('bank')">
<div class="method-header">
<div class="method-icon">ğŸ¦</div>
<div class="method-title"><h3>Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ</h3></div>
<input type="radio" name="paymentMethod" value="bank">
</div>
<div class="method-content">
<div class="bank-info">
<div class="bank-row"><span>Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†:</span><span style="font-family:monospace;">SA1234567891234567891234</span></div>
<div class="bank-row"><span>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:</span><span style="font-family:monospace;">1234567890</span></div>
<div class="bank-row" style="border:none;"><span>Ø§Ù„Ù…Ø¨Ù„Øº:</span><span style="color:#11998e;font-weight:bold;">35 Ø±ÙŠØ§Ù„</span></div>
</div>
<div style="text-align:center;margin-top:15px;padding:15px;background:white;border-radius:10px;">
<p style="margin-bottom:10px;font-weight:bold;color:#1a237e;">Ø±Ù…Ø² QR Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</p>
<div style="width:200px;height:200px;margin:0 auto;background:#f0f0f0;display:flex;align-items:center;justify-content:center;border-radius:10px;border:2px solid #e0e0e0;">
<i class="fas fa-qrcode" style="font-size:100px;color:#667eea;"></i>
</div>
<p style="margin-top:10px;font-size:12px;color:#666;">Ø§Ù…Ø³Ø­ Ø§Ù„Ø±Ù…Ø² Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ù†Ùƒ</p>
</div>
</div>
</div>
<div class="payment-method" id="whatsappPay" onclick="app.selectPaymentMethod('whatsapp')">
<div class="method-header">
<div class="method-icon">ğŸ’¬</div>
<div class="method-title"><h3>ÙˆØ§ØªØ³Ø§Ø¨</h3></div>
<input type="radio" name="paymentMethod" value="whatsapp">
</div>
<div class="method-content">
<a href="https://wa.me/966533371147?text=Ø£Ø±ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…" class="btn btn-whatsapp w-100" target="_blank" style="text-decoration:none;justify-content:center;"><i class="fab fa-whatsapp"></i> ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù†</a>
</div>
</div>
</div>
<div class="activation-section">
<h3 style="color:#1a237e;margin-bottom:10px;">Ù‡Ù„ Ù„Ø¯ÙŠÙƒ ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ØŸ</h3>
<div class="activation-input-group">
<input type="text" id="activationCodeInput" data-allow="true" placeholder="SK-XXXXX-XXXXX" class="activation-input">
<button onclick="app.activateSubscription()" class="btn btn-success" data-allow="true">ØªÙØ¹ÙŠÙ„</button>
</div>
</div>
</div>
</div>

<div class="sync-indicator" id="syncIndicator" style="display:none;">
<i class="fas fa-sync"></i>
<div class="sync-progress">
<div class="sync-progress-bar" id="syncProgressBar"></div>
</div>
<span id="syncText">Ù…Ø²Ø§Ù…Ù†Ø©...</span>
</div>

<div class="container">

<nav class="nav">
<div class="nav-item active" onclick="app.showPage('home')"><i class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
<div class="nav-item" onclick="app.showPage('students')"><i class="fas fa-users"></i><span>Ø§Ù„Ø·Ù„Ø§Ø¨</span></div>
<div class="nav-item" onclick="app.showPage('attendance')"><i class="fas fa-clock"></i><span>Ø§Ù„ØªØ£Ø®ÙŠØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</span></div>
<div class="nav-item" onclick="app.showPage('notes')"><i class="fas fa-sticky-note"></i><span>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span></div>
<div class="nav-item" onclick="app.showPage('analytics')"><i class="fas fa-chart-bar"></i><span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span></div>
<div class="nav-item" onclick="app.showPage('reports')"><i class="fas fa-file-alt"></i><span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></div>
<div class="nav-item" onclick="app.showPage('settings')"><i class="fas fa-cog"></i><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
</nav>

<div id="homePage" class="page active">
<div class="subscription-badge trial" id="subscriptionBadge">
<div class="subscription-icon">â°</div>
<div class="subscription-info">
<div class="subscription-status" id="subscriptionStatus">ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</div>
<div class="subscription-expiry" id="subscriptionExpiry">Ù…ØªØ¨Ù‚ÙŠ 7 Ø£ÙŠØ§Ù…</div>
<div id="activationCodeDisplay" style="font-family:monospace;font-weight:bold;color:#667eea;margin-top:5px;"></div>
</div>
<button class="btn btn-warning" onclick="app.showPaymentPage()" data-allow="true">Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†</button>
</div>

<div class="stats-grid">
<div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value" id="totalStudents">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div></div>
<div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-value" id="presentToday">0</div><div class="stat-label">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</div></div>
<div class="stat-card"><div class="stat-icon">â°</div><div class="stat-value" id="delaysToday">0</div><div class="stat-label">Ø§Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</div></div>
<div class="stat-card"><div class="stat-icon">âŒ</div><div class="stat-value" id="absentToday">0</div><div class="stat-label">Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</div></div>
<div class="stat-card"><div class="stat-icon">ğŸ“</div><div class="stat-value" id="notesToday">0</div><div class="stat-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div></div>
</div>

<div class="card">
<div class="card-header"><h2 class="card-title"><i class="fas fa-bolt"></i>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h2></div>
<div class="d-flex gap-10" style="flex-wrap:wrap;">
<button class="btn btn-primary" onclick="app.showPage('students')"><i class="fas fa-user-plus"></i>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
<button class="btn btn-success" onclick="app.showPage('attendance')"><i class="fas fa-clock"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ£Ø®ÙŠØ±</button>
<button class="btn btn-warning" onclick="app.showPage('notes')"><i class="fas fa-sticky-note"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©</button>
<button class="btn btn-info" onclick="app.showPage('reports')"><i class="fas fa-file-export"></i>Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ±</button>
</div>
</div>
</div>

<div id="studentsPage" class="page">
<div class="card">
<div class="card-header">
<h2 class="card-title"><i class="fas fa-users"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
<button class="btn btn-primary" onclick="app.showAddStudentModal()"><i class="fas fa-user-plus"></i>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
</div>

<div class="excel-instructions" id="excelInstructions" style="display:none;">
<h4><i class="fas fa-info-circle"></i> ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel:</h4>
<ul>
<li>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ 5 Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ§Ù„ÙŠ:</li>
<li>Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„: <strong>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</strong> (Ù…Ø·Ù„ÙˆØ¨)</li>
<li>Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ: <strong>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</strong> (Ù…Ø·Ù„ÙˆØ¨)</li>
<li>Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø«: <strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</strong> (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</li>
<li>Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø§Ø¨Ø¹: <strong>Ø§Ù„ØµÙ</strong> (Ù…Ø·Ù„ÙˆØ¨)</li>
<li>Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø®Ø§Ù…Ø³: <strong>Ø§Ù„ÙØµÙ„</strong> (Ù…Ø·Ù„ÙˆØ¨)</li>
<li>Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„ÙØµÙˆÙ„ Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…Ù„Ù</li>
</ul>
</div>

<div class="search-box">
<input type="text" class="search-input" id="studentSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." oninput="app.searchStudents()">
<i class="fas fa-search search-icon"></i>
</div>

<div class="d-flex gap-10" style="margin-bottom:20px;flex-wrap:wrap;">
<label for="excelFile" class="btn btn-success" style="margin:0;cursor:pointer;"><i class="fas fa-file-excel"></i>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</label>
<input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none;">
<button class="btn btn-info" onclick="app.toggleExcelInstructions()"><i class="fas fa-question-circle"></i>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
<button class="btn btn-primary" onclick="app.exportStudentsExcel()"><i class="fas fa-download"></i>ØªØµØ¯ÙŠØ± Excel</button>
<button class="btn btn-danger" onclick="app.deleteAllStudents()"><i class="fas fa-trash"></i>Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
</div>

<div id="studentsList"></div>
</div>
</div>

<div id="attendancePage" class="page">
<div class="sub-tabs">
<div class="sub-tab active" onclick="app.showSubPage('delays')">â° Ø§Ù„ØªØ£Ø®ÙŠØ±</div>
<div class="sub-tab" onclick="app.showSubPage('absences')">âŒ Ø§Ù„ØºÙŠØ§Ø¨</div>
</div>

<div id="delaysSubPage" class="sub-page active">
<div class="card">
<div class="card-header">
<h2 class="card-title"><i class="fas fa-clock"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ£Ø®ÙŠØ±</h2>
<input type="date" class="form-input" id="delaysDate" style="width:auto;" onchange="app.loadDelays()">
</div>

<div class="filters-section">
<div class="filters-grid">
<div><label class="form-label">Ø§Ù„ØµÙ</label><select class="form-select" id="delaysGradeFilter" onchange="app.loadDelays()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option></select></div>
<div><label class="form-label">Ø§Ù„ÙØµÙ„</label><select class="form-select" id="delaysClassFilter" onchange="app.loadDelays()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option></select></div>
</div>
<div class="filter-actions">
<button class="btn btn-primary" onclick="app.selectAllDelays()"><i class="fas fa-check-square"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
<button class="btn btn-secondary" onclick="app.deselectAllDelays()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
<button class="btn btn-success" onclick="app.saveDelaysToRecord()"><i class="fas fa-save"></i>Ø­ÙØ¸</button>
<button class="btn btn-whatsapp" onclick="app.sendDelaysWhatsApp()"><i class="fab fa-whatsapp"></i>ÙˆØ§ØªØ³Ø§Ø¨</button>
</div>
</div>

<div class="search-box">
<input type="text" class="search-input" id="delaysSearch" placeholder="Ø¨Ø­Ø«..." oninput="app.searchDelays()">
<i class="fas fa-search search-icon"></i>
</div>

<div id="delaysList"></div>
</div>
</div>

<div id="absencesSubPage" class="sub-page">
<div class="card">
<div class="card-header">
<h2 class="card-title"><i class="fas fa-user-times"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</h2>
<input type="date" class="form-input" id="absencesDate" style="width:auto;" onchange="app.loadAbsences()">
</div>

<div class="filters-section">
<div class="filters-grid">
<div><label class="form-label">Ø§Ù„ØµÙ</label><select class="form-select" id="absencesGradeFilter" onchange="app.loadAbsences()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option></select></div>
<div><label class="form-label">Ø§Ù„ÙØµÙ„</label><select class="form-select" id="absencesClassFilter" onchange="app.loadAbsences()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option></select></div>
</div>
<div class="filter-actions">
<button class="btn btn-primary" onclick="app.selectAllAbsences()"><i class="fas fa-check-square"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
<button class="btn btn-secondary" onclick="app.deselectAllAbsences()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
<button class="btn btn-success" onclick="app.saveAbsencesToRecord()"><i class="fas fa-save"></i>Ø­ÙØ¸</button>
<button class="btn btn-whatsapp" onclick="app.sendAbsencesWhatsApp()"><i class="fab fa-whatsapp"></i>ÙˆØ§ØªØ³Ø§Ø¨</button>
</div>
</div>

<div class="search-box">
<input type="text" class="search-input" id="absencesSearch" placeholder="Ø¨Ø­Ø«..." oninput="app.searchAbsences()">
<i class="fas fa-search search-icon"></i>
</div>

<div id="absencesList"></div>
</div>
</div>
</div>

<div id="notesPage" class="page">
<div class="card">
<div class="card-header">
<h2 class="card-title"><i class="fas fa-sticky-note"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
<input type="date" class="form-input" id="notesDate" style="width:auto;" onchange="app.loadNotes()">
</div>

<div class="filters-section">
<div class="filters-grid">
<div><label class="form-label">Ø§Ù„ØµÙ</label><select class="form-select" id="notesGradeFilter" onchange="app.loadNotes()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option></select></div>
<div><label class="form-label">Ø§Ù„ÙØµÙ„</label><select class="form-select" id="notesClassFilter" onchange="app.loadNotes()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option></select></div>
</div>
<div><label class="form-label">Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label><textarea class="form-textarea" id="noteText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©..."></textarea></div>
<div class="filter-actions">
<button class="btn btn-primary" onclick="app.selectAllNotes()"><i class="fas fa-check-square"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
<button class="btn btn-secondary" onclick="app.deselectAllNotes()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
<button class="btn btn-success" onclick="app.saveNotesToRecord()"><i class="fas fa-save"></i>Ø­ÙØ¸</button>
<button class="btn btn-whatsapp" onclick="app.sendNotesWhatsApp()"><i class="fab fa-whatsapp"></i>ÙˆØ§ØªØ³Ø§Ø¨</button>
</div>
</div>

<div class="search-box">
<input type="text" class="search-input" id="notesSearch" placeholder="Ø¨Ø­Ø«..." oninput="app.searchNotes()">
<i class="fas fa-search search-icon"></i>
</div>

<div id="notesList"></div>
</div>
</div>

<div id="analyticsPage" class="page">
<div class="card">
<div class="card-header">
<h2 class="card-title"><i class="fas fa-chart-bar"></i>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
<button class="btn btn-primary" onclick="app.generateAnalytics()"><i class="fas fa-sync"></i>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
</div>

<div class="stats-grid">
<div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value" id="analyticsTotalStudents">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div></div>
<div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-value" id="analyticsAttendanceRate">0%</div><div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div></div>
<div class="stat-card"><div class="stat-icon">âŒ</div><div class="stat-value" id="analyticsAbsenceRate">0%</div><div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„ØºÙŠØ§Ø¨</div></div>
<div class="stat-card"><div class="stat-icon">â°</div><div class="stat-value" id="analyticsDelayRate">0%</div><div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ£Ø®ÙŠØ±</div></div>
</div>

<div class="card" style="margin-top:20px;">
<div class="card-header">
<h2 class="card-title"><i class="fas fa-exclamation-triangle"></i>Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨</h2>
<button class="btn btn-info" onclick="app.showAbsenceLevelsSettings()"><i class="fas fa-cog"></i>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</button>
</div>

<div class="levels-grid" id="absenceLevels">
<div class="level-card safe">
<div class="level-header">
<div class="level-title">ğŸŸ¢ Ù…Ø³ØªÙˆÙ‰ Ø¢Ù…Ù†</div>
<div class="level-count" id="level1Count">0</div>
</div>
<div class="level-threshold">Ù…Ù† <span class="level-threshold-input" id="level1Min">1</span> Ø¥Ù„Ù‰ <span class="level-threshold-input" id="level1Max">5</span> Ø£ÙŠØ§Ù…</div>
<div class="level-students" id="level1Students"></div>
</div>

<div class="level-card attention">
<div class="level-header">
<div class="level-title">ğŸŸ¡ Ù…Ø³ØªÙˆÙ‰ ØªÙ†Ø¨ÙŠÙ‡</div>
<div class="level-count" id="level2Count">0</div>
</div>
<div class="level-threshold">Ù…Ù† <span class="level-threshold-input" id="level2Min">6</span> Ø¥Ù„Ù‰ <span class="level-threshold-input" id="level2Max">10</span> Ø£ÙŠØ§Ù…</div>
<div class="level-students" id="level2Students"></div>
</div>

<div class="level-card warning">
<div class="level-header">
<div class="level-title">ğŸŸ  Ù…Ø³ØªÙˆÙ‰ ØªØ­Ø°ÙŠØ±</div>
<div class="level-count" id="level3Count">0</div>
</div>
<div class="level-threshold">Ù…Ù† <span class="level-threshold-input" id="level3Min">11</span> Ø¥Ù„Ù‰ <span class="level-threshold-input" id="level3Max">15</span> Ø£ÙŠØ§Ù…</div>
<div class="level-students" id="level3Students"></div>
</div>

<div class="level-card danger">
<div class="level-header">
<div class="level-title">ğŸ”´ Ù…Ø³ØªÙˆÙ‰ Ø®Ø·Ø±</div>
<div class="level-count" id="level4Count">0</div>
</div>
<div class="level-threshold">Ø£ÙƒØ«Ø± Ù…Ù† <span class="level-threshold-input" id="level4Min">15</span> ÙŠÙˆÙ…</div>
<div class="level-students" id="level4Students"></div>
</div>
</div>
</div>

<div class="charts-grid">
<div class="chart-container">
<h3>Ù†Ø³Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
<canvas id="attendanceChart"></canvas>
</div>
<div class="chart-container">
<h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ù‡Ø±ÙŠØ©</h3>
<canvas id="monthlyChart"></canvas>
</div>
<div class="chart-container">
<h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</h3>
<canvas id="gradeChart"></canvas>
</div>
<div class="chart-container">
<h3>Ø£ÙƒØ«Ø± Ø§Ù„Ø·Ù„Ø§Ø¨ ØºÙŠØ§Ø¨Ø§Ù‹</h3>
<canvas id="topAbsentChart"></canvas>
</div>
</div>

<div class="export-section">
<button class="btn btn-success" onclick="app.exportToPDF()">
<i class="fas fa-file-pdf"></i> ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± PDF
</button>
</div>
</div>
</div>

<div id="reportsPage" class="page">
<div class="card">
<div class="card-header"><h2 class="card-title"><i class="fas fa-print"></i>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2></div>

<div class="form-group"><label class="form-label">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
<select class="form-select" id="reportType">
<option value="delays">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ£Ø®ÙŠØ±</option>
<option value="absences">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨</option>
<option value="notes">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
<option value="comprehensive">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„ØºØ§Ø¦Ø¨ÙŠÙ†</option>
</select>
</div>

<div class="form-group"><label class="form-label">Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
<select class="form-select" id="reportScope" onchange="app.handleReportScope()">
<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</option>
<option value="dateRange">Ù†Ø·Ø§Ù‚ Ø²Ù…Ù†ÙŠ</option>
<option value="student">Ø·Ø§Ù„Ø¨ Ù…Ø­Ø¯Ø¯</option>
</select>
</div>

<div id="dateRangeSection" style="display:none;">
<div class="d-flex gap-10" style="flex-wrap:wrap;margin-bottom:20px;">
<div style="flex:1;" class="form-group"><label class="form-label">Ù…Ù†</label><input type="date" class="form-input" id="reportStartDate"></div>
<div style="flex:1;" class="form-group"><label class="form-label">Ø¥Ù„Ù‰</label><input type="date" class="form-input" id="reportEndDate"></div>
</div>
</div>

<div id="studentSection" style="display:none;">
<div class="form-group"><label class="form-label">Ø§Ù„Ø·Ø§Ù„Ø¨</label><select class="form-select" id="reportStudent"></select></div>
</div>

<div class="d-flex gap-10" style="flex-wrap:wrap;margin-top:20px;">
<button class="btn btn-primary" onclick="app.generatePrintReport()"><i class="fas fa-eye"></i>Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
<button class="btn btn-success" onclick="app.printReport()"><i class="fas fa-print"></i>Ø·Ø¨Ø§Ø¹Ø©</button>
<button class="btn btn-info" onclick="app.exportReportExcel()"><i class="fas fa-file-excel"></i>Excel</button>
<button class="btn btn-warning" onclick="app.exportReportPDF()"><i class="fas fa-file-pdf"></i>PDF</button>
</div>

<div id="reportPreview" style="margin-top:30px;"></div>
</div>
</div>

<div id="settingsPage" class="page">
<div class="card">
<div class="card-header"><h2 class="card-title"><i class="fas fa-cog"></i>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2></div>

<div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input type="text" class="form-input" id="schoolName" value="Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©"></div>
<div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</label><input type="text" class="form-input" id="teacherName" value="Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯"></div>

<div style="background:#f8f9fa;padding:20px;border-radius:12px;margin:20px 0;">
<h3 style="color:#1a237e;margin-bottom:15px;"><i class="fas fa-crown" style="color:#ffd700;"></i> Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h3>
<div style="display:grid;gap:10px;">
<div style="display:flex;justify-content:space-between;padding:10px;background:white;border-radius:8px;"><span>Ø§Ù„Ø­Ø§Ù„Ø©:</span><span id="settingsStatus">ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</span></div>
<div style="display:flex;justify-content:space-between;padding:10px;background:white;border-radius:8px;"><span>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</span><span id="settingsExpiry">--</span></div>
<div style="display:flex;justify-content:space-between;padding:10px;background:white;border-radius:8px;"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span><span id="settingsDaysLeft">7 Ø£ÙŠØ§Ù…</span></div>
<div style="display:flex;justify-content:space-between;padding:10px;background:white;border-radius:8px;"><span>Device ID:</span><span id="deviceId" style="font-family:monospace;font-size:12px;">--</span></div>
</div>
</div>

<div style="background:#e3f2fd;padding:20px;border-radius:12px;margin-bottom:20px;">
<h3 style="color:#1a237e;margin-bottom:10px;"><i class="fas fa-key"></i> Ø§Ù„ØªÙØ¹ÙŠÙ„</h3>
<input type="text" id="activationCodeSettings" data-allow="true" placeholder="SK-XXXXX-XXXXX" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;margin-bottom:15px;font-family:monospace;text-align:center;text-transform:uppercase;">
<button onclick="app.activateSubscription('settings')" class="btn btn-success w-100" data-allow="true"><i class="fas fa-check-circle"></i> ØªÙØ¹ÙŠÙ„</button>
<button onclick="app.showPaymentPage()" class="btn btn-primary w-100" data-allow="true" style="margin-top:10px;"><i class="fas fa-shopping-cart"></i> Ø´Ø±Ø§Ø¡ ÙƒÙˆØ¯</button>
</div>

<div class="d-flex gap-10" style="flex-wrap:wrap;">
<button class="btn btn-primary" onclick="app.saveSettings()"><i class="fas fa-save"></i>Ø­ÙØ¸</button>
<button class="btn btn-info" onclick="app.forceSync()"><i class="fas fa-sync"></i>Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù†</button>
<button class="btn btn-danger" onclick="app.resetApp()"><i class="fas fa-redo"></i>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
</div>

<div style="margin-top:30px;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:12px;color:white;text-align:center;">
<div style="font-size:2.5rem;margin-bottom:10px;">ğŸ‘¨â€ğŸ’»</div>
<h3 style="margin-bottom:5px;">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠ</h3>
<p style="font-size:14px;opacity:0.9;margin-bottom:15px;">v7.0 | Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©</p>
<a href="https://wa.me/966533371147" class="btn btn-whatsapp" target="_blank" style="display:inline-flex;text-decoration:none;"><i class="fab fa-whatsapp"></i>ØªÙˆØ§ØµÙ„</a>
</div>
</div>
</div>

</div>

<div id="studentModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title" id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</h3>
<button class="modal-close" onclick="app.closeStudentModal()">Ã—</button>
</div>
<form onsubmit="app.saveStudent(event)">
<div class="form-group"><label class="form-label">Ø§Ù„Ø§Ø³Ù…</label><input type="text" class="form-input" id="studentName" required></div>
<div class="form-group"><label class="form-label">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</label><input type="text" class="form-input" id="studentID" required></div>
<div class="form-group"><label class="form-label">Ø§Ù„Ø¬ÙˆØ§Ù„</label><input type="tel" class="form-input" id="studentPhone"></div>
<div class="form-group"><label class="form-label">Ø§Ù„ØµÙ</label><select class="form-select" id="studentGrade" required><option value="">Ø§Ø®ØªØ±</option></select></div>
<div class="form-group"><label class="form-label">Ø§Ù„ÙØµÙ„</label><select class="form-select" id="studentClass" required><option value="">Ø§Ø®ØªØ±</option></select></div>
<div class="d-flex gap-10"><button type="submit" class="btn btn-primary" style="flex:1;">Ø­ÙØ¸</button><button type="button" class="btn btn-secondary" style="flex:1;" onclick="app.closeStudentModal()">Ø¥Ù„ØºØ§Ø¡</button></div>
</form>
</div>
</div>

<div id="absenceLevelsModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨</h3>
<button class="modal-close" onclick="app.closeAbsenceLevelsModal()">Ã—</button>
</div>
<div class="form-group">
<label class="form-label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„ (Ø¢Ù…Ù†)</label>
<div style="display:flex;align-items:center;gap:10px;">
<span>Ù…Ù†</span>
<input type="number" class="form-input" id="configLevel1Min" value="1" min="0" style="width:80px;">
<span>Ø¥Ù„Ù‰</span>
<input type="number" class="form-input" id="configLevel1Max" value="5" min="0" style="width:80px;">
<span>ÙŠÙˆÙ…</span>
</div>
</div>
<div class="form-group">
<label class="form-label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù†ÙŠ (ØªÙ†Ø¨ÙŠÙ‡)</label>
<div style="display:flex;align-items:center;gap:10px;">
<span>Ù…Ù†</span>
<input type="number" class="form-input" id="configLevel2Min" value="6" min="0" style="width:80px;">
<span>Ø¥Ù„Ù‰</span>
<input type="number" class="form-input" id="configLevel2Max" value="10" min="0" style="width:80px;">
<span>ÙŠÙˆÙ…</span>
</div>
</div>
<div class="form-group">
<label class="form-label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù„Ø« (ØªØ­Ø°ÙŠØ±)</label>
<div style="display:flex;align-items:center;gap:10px;">
<span>Ù…Ù†</span>
<input type="number" class="form-input" id="configLevel3Min" value="11" min="0" style="width:80px;">
<span>Ø¥Ù„Ù‰</span>
<input type="number" class="form-input" id="configLevel3Max" value="15" min="0" style="width:80px;">
<span>ÙŠÙˆÙ…</span>
</div>
</div>
<div class="form-group">
<label class="form-label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø§Ø¨Ø¹ (Ø®Ø·Ø±)</label>
<div style="display:flex;align-items:center;gap:10px;">
<span>Ø£ÙƒØ«Ø± Ù…Ù†</span>
<input type="number" class="form-input" id="configLevel4Min" value="15" min="0" style="width:80px;">
<span>ÙŠÙˆÙ…</span>
</div>
</div>
<div class="d-flex gap-10">
<button class="btn btn-primary" style="flex:1;" onclick="app.saveAbsenceLevelsSettings()">Ø­ÙØ¸</button>
<button class="btn btn-secondary" style="flex:1;" onclick="app.closeAbsenceLevelsModal()">Ø¥Ù„ØºØ§Ø¡</button>
</div>
</div>
</div>

<div id="toast" class="toast"></div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
const firebaseConfig = {
    apiKey: "AIzaSyD0zfRWvvVJt0qswbY_0W-tbEzcuzi1URw",
    authDomain: "attendancesystem-366b0.firebaseapp.com",
    databaseURL: "https://attendancesystem-366b0-default-rtdb.firebaseio.com",
    projectId: "attendancesystem-366b0",
    storageBucket: "attendancesystem-366b0.firebasestorage.app",
    messagingSenderId: "570925561837",
    appId: "1:570925561837:web:4095ef962b691e764e59e4"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase
firebase.initializeApp(firebaseConfig);

class AttendanceApp {
    constructor() {
        this.db = firebase.database();
        this.students = [];
        this.delays = {};
        this.absences = {};
        this.notes = {};
        this.grades = [];
        this.classes = [];
        this.currentStudentId = null;
        this.deviceId = this.createDeviceId();
        this.charts = {};
        this.absenceLevels = {
            level1: { min: 1, max: 5 },
            level2: { min: 6, max: 10 },
            level3: { min: 11, max: 15 },
            level4: { min: 16, max: 999 }
        };
        
        // Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø­Ø³Ù† Ø¬Ø¯Ø§Ù‹
        this.syncQueue = [];
        this.isSyncing = false;
        this.lastSyncTime = 0;
        this.syncInProgress = false;
        this.pendingSync = {};
        this.syncTimeout = null;
        this.syncRetryCount = 0;
        this.maxRetries = 3;
        
        this.init();
    }

    init() {
        this.loadFromLocalStorage();
        this.setupEventListeners();
        this.checkSubscription();
        this.updateUI();
        this.setTodayDate();
        this.setupSubscriptionInterceptor();
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù‡Ø§Ø²
    createDeviceId() {
        const fingerprint = {
            screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
            userAgent: navigator.userAgent,
            language: navigator.language,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            platform: navigator.platform,
            cookieEnabled: navigator.cookieEnabled
        };

        const dataString = JSON.stringify(fingerprint);
        let hash = 0;
        for (let i = 0; i < dataString.length; i++) {
            const char = dataString.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }

        const deviceId = 'device_' + Math.abs(hash).toString(16);
        localStorage.setItem('device_id', deviceId);
        return deviceId;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
    async checkSubscription() {
        try {
            const snapshot = await this.db.ref(`trials/${this.deviceId}`).once('value');
            const trialData = snapshot.val();

            if (trialData) {
                const now = new Date();
                const firstInstall = new Date(trialData.firstInstall);
                const daysSinceFirstInstall = Math.floor((now - firstInstall) / (1000 * 60 * 60 * 24));

                if (daysSinceFirstInstall > 7 && trialData.status === 'trial') {
                    this.handleCheatingDetection();
                    return;
                }

                if (trialData.installCount > 3) {
                    this.handleCheatingDetection();
                    return;
                }

                this.subscription = trialData;
            } else {
                this.subscription = {
                    deviceId: this.deviceId,
                    firstInstall: new Date().toISOString(),
                    lastSeen: new Date().toISOString(),
                    installCount: 1,
                    status: 'trial',
                    expiryDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                    activationCode: '',
                    isActivated: false
                };

                await this.db.ref(`trials/${this.deviceId}`).set(this.subscription);
            }

            this.updateSubscriptionUI();
        } catch (error) {
            console.error('Error checking subscription:', error);
            this.showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'error');
        }
    }

    handleCheatingDetection() {
        localStorage.setItem('permanently_blocked', 'true');
        document.body.innerHTML = `
            <div style="text-align:center; padding:50px; font-family:Arial; background:#f5f5f5; min-height:100vh; display:flex; flex-direction:column; justify-content:center;">
                <h1 style="color:red;">ğŸš« ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù†Ø¸Ø§Ù…</h1>
                <p>ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„ØªÙ„Ø§Ø¹Ø¨ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¬Ø±Ø¨Ø©.</p>
                <p>Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ³Ø¬Ù„ Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø®Ø¯Ø§Ø¹Ù‡.</p>
                <p>Device ID: ${this.deviceId}</p>
                <p>Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…: support@example.com</p>
            </div>
        `;
    }

    updateSubscriptionUI() {
        const now = new Date();
        const expiry = new Date(this.subscription.expiryDate);
        const daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));

        document.getElementById('trialDaysLeft').textContent = Math.max(0, daysLeft);
        document.getElementById('deviceId').textContent = this.deviceId;

        if (this.subscription.isActivated) {
            document.getElementById('subscriptionStatus').textContent = 'Ù…ÙØ¹Ù‘Ù„ âœ“';
            document.getElementById('subscriptionExpiry').textContent = `ÙŠÙ†ØªÙ‡ÙŠ ${expiry.toLocaleDateString('ar-SA')}`;
            document.getElementById('subscriptionBadge').className = 'subscription-badge active';
            document.getElementById('lockScreen').style.display = 'none';
            this.displayActivationCode();
        } else if (daysLeft > 0) {
            document.getElementById('subscriptionStatus').textContent = 'ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©';
            document.getElementById('subscriptionExpiry').textContent = `Ù…ØªØ¨Ù‚ÙŠ ${daysLeft} Ø£ÙŠØ§Ù…`;
            document.getElementById('subscriptionBadge').className = 'subscription-badge trial';
            document.getElementById('lockScreen').style.display = 'none';
        } else {
            document.getElementById('lockScreen').style.display = 'flex';
        }

        document.getElementById('settingsStatus').textContent = this.subscription.isActivated ? 'Ù…ÙØ¹Ù‘Ù„ âœ“' : 'ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©';
        document.getElementById('settingsExpiry').textContent = expiry.toLocaleDateString('ar-SA');
        document.getElementById('settingsDaysLeft').textContent = `${Math.max(0, daysLeft)} Ø£ÙŠØ§Ù…`;
    }

    displayActivationCode() {
        if (this.subscription.activationCode && this.subscription.isActivated) {
            const displayElement = document.getElementById('activationCodeDisplay');
            if (displayElement) {
                displayElement.textContent = `ÙƒÙˆØ¯: ${this.subscription.activationCode}`;
            }
        }
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    closeApplication() {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ØŸ')) {
            window.close();
            // Ø¨Ø¯ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
            document.body.innerHTML = `
                <div style="text-align:center; padding:50px; font-family:'Tajawal'; background:#f5f5f5; min-height:100vh; display:flex; flex-direction:column; justify-content:center;">
                    <h1 style="color:#667eea;">ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</h1>
                    <p>ÙŠØ±Ø¬Ù‰ Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ ÙŠØ¯ÙˆÙŠØ§Ù‹</p>
                    <button onclick="location.reload()" style="padding:10px 20px; background:#667eea; color:white; border:none; border-radius:5px; cursor:pointer;">Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­</button>
                </div>
            `;
        }
    }

    // Return to app temporarily (will redirect to lock screen on any action)
    returnToApp() {
        // Hide lock screen temporarily
        document.getElementById('lockScreen').style.display = 'none';

        // Check subscription status after a brief moment
        setTimeout(() => {
            const now = new Date();
            const expiry = new Date(this.subscription.expiryDate);
            const isExpired = now > expiry && !this.subscription.isActivated;

            if (isExpired) {
                // User will be redirected back on any action
                this.showToast('ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØµÙØ­ØŒ Ù„ÙƒÙ† Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ø³ØªØ¹ÙŠØ¯Ùƒ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„', 'info');
            }
        }, 100);
    }

    // Setup subscription interceptor to catch all user actions
    setupSubscriptionInterceptor() {
        // Intercept all clicks
        document.addEventListener('click', (e) => {
            // Skip if clicking on allowed elements
            const allowedElement = e.target.closest('[data-allow="true"]');
            if (allowedElement) return;

            // Skip if clicking within lock screen or payment modals
            const inLockScreen = e.target.closest('#lockScreen');
            const inPaymentPage = e.target.closest('#paymentPage');
            if (inLockScreen || inPaymentPage) return;

            // Check if subscription is expired
            if (this.subscription) {
                const now = new Date();
                const expiry = new Date(this.subscription.expiryDate);
                const isExpired = now > expiry && !this.subscription.isActivated;

                if (isExpired) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    document.getElementById('lockScreen').style.display = 'flex';
                    this.showToast('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'error');
                    return false;
                }
            }
        }, true);

        // Intercept form submissions
        document.addEventListener('submit', (e) => {
            if (this.subscription) {
                const now = new Date();
                const expiry = new Date(this.subscription.expiryDate);
                const isExpired = now > expiry && !this.subscription.isActivated;

                if (isExpired) {
                    e.preventDefault();
                    e.stopPropagation();
                    document.getElementById('lockScreen').style.display = 'flex';
                    this.showToast('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'error');
                    return false;
                }
            }
        }, true);

        // Intercept input changes
        document.addEventListener('change', (e) => {
            const allowedElement = e.target.closest('[data-allow="true"]');
            if (allowedElement) return;

            if (this.subscription) {
                const now = new Date();
                const expiry = new Date(this.subscription.expiryDate);
                const isExpired = now > expiry && !this.subscription.isActivated;

                if (isExpired) {
                    e.preventDefault();
                    e.stopPropagation();
                    document.getElementById('lockScreen').style.display = 'flex';
                    this.showToast('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'error');
                    return false;
                }
            }
        }, true);
    }

    // Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙØ§Ø¦Ù‚ Ø§Ù„Ø³Ø±Ø¹Ø©
    async syncToCloud(data = null, priority = false) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¹Ù…Ù„ÙŠØ© Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø§Ø±ÙŠØ© ÙˆØ£ÙˆÙ„ÙˆÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©ØŒ Ø£Ø¶Ù Ù„Ù„Ø·Ø§Ø¨ÙˆØ±
        if (this.syncInProgress && !priority) {
            this.syncQueue.push({ data, timestamp: Date.now() });
            return;
        }

        // Ù…Ù†Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© Ø¬Ø¯Ø§Ù‹
        const now = Date.now();
        if (now - this.lastSyncTime < 3000 && !priority) {
            this.syncQueue.push({ data, timestamp: Date.now() });
            return;
        }

        this.syncInProgress = true;
        this.lastSyncTime = now;
        this.syncRetryCount = 0;

        try {
            // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØµØ§Ù…ØªØ©: ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©

            // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØºØ±Ø©
            const syncData = data || this.prepareSyncData();

            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØºØ±Ø© ÙÙ‚Ø·
            await this.syncCompressedData(syncData);

            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…
            await this.db.ref(`trials/${this.deviceId}/lastSeen`).set(new Date().toISOString());

            this.showSyncIndicator('success', 'ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 100);
            setTimeout(() => this.hideSyncIndicator(), 1500);

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
            this.processSyncQueue();

        } catch (error) {
            console.error('Sync error:', error);
            this.syncRetryCount++;
            
            if (this.syncRetryCount < this.maxRetries) {
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø©
                setTimeout(() => {
                    this.syncQueue.push({ data, timestamp: Date.now() });
                    this.processSyncQueue();
                }, 1000 * this.syncRetryCount);
            } else {
                this.showSyncIndicator('error', 'ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© - Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 0);
                setTimeout(() => this.hideSyncIndicator(), 3000);
                this.syncRetryCount = 0;
            }
        } finally {
            this.syncInProgress = false;
        }
    }

    prepareSyncData() {
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµØºØ±Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
        return {
            // ÙÙ‚Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            studentsCount: this.students.length,
            lastModified: new Date().toISOString(),
            // Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµØºØ±Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ (Ø£ÙˆÙ„ 20 Ø·Ø§Ù„Ø¨ ÙÙ‚Ø·)
            recentStudents: this.students.slice(0, 20).map(s => ({
                id: s.id,
                name: s.name,
                grade: s.grade,
                class: s.class
            })),
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·
            todayData: {
                date: new Date().toISOString().split('T')[0],
                delays: this.delays[new Date().toISOString().split('T')[0]] || {},
                absences: this.absences[new Date().toISOString().split('T')[0]] || {},
                notes: this.notes[new Date().toISOString().split('T')[0]] || {}
            },
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©
            grades: this.grades,
            classes: this.classes,
            absenceLevels: this.absenceLevels
        };
    }

    async syncCompressedData(data) {
        // Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØºØ±Ø©
        const updates = {};
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        updates[`users/${this.deviceId}/summary`] = {
            studentsCount: data.studentsCount,
            lastModified: data.lastModified,
            grades: data.grades,
            classes: data.classes,
            absenceLevels: data.absenceLevels
        };

        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…
        const today = data.todayData.date;
        updates[`users/${this.deviceId}/daily/${today}`] = {
            delays: data.todayData.delays,
            absences: data.todayData.absences,
            notes: data.todayData.notes
        };

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ«ÙŠÙ†
        updates[`users/${this.deviceId}/recentStudents`] = data.recentStudents;

        // ØªÙ†ÙÙŠØ° Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
        await this.db.ref().update(updates);
    }


    async syncOnlyChanges(changedData) {
        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù†ØªÙ‚Ø§Ø¦ÙŠØ© - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø© ÙÙ‚Ø·
        const today = new Date().toISOString().split('T')[0];
        const updates = {};
        updates[`users/${this.deviceId}/daily/${today}`] = changedData;
        await this.db.ref().update(updates);
    }
    processSyncQueue() {
        if (this.syncQueue.length > 0 && !this.syncInProgress) {
            const nextSync = this.syncQueue.shift();
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† 10 Ø«ÙˆØ§Ù†ÙŠ)
            if (Date.now() - nextSync.timestamp < 10000) {
                this.syncToCloud(nextSync.data);
            }
        }
    }

    showSyncIndicator(status, text, progress = 0) {
        const indicator = document.getElementById('syncIndicator');
        const syncText = document.getElementById('syncText');
        const progressBar = document.getElementById('syncProgressBar');
        
        indicator.className = `sync-indicator ${status}`;
        syncText.textContent = text;
        progressBar.style.width = `${progress}%`;
        indicator.style.display = 'flex';
    }

    updateSyncProgress(progress) {
        const progressBar = document.getElementById('syncProgressBar');
        const syncText = document.getElementById('syncText');
        progressBar.style.width = `${progress}%`;
        syncText.textContent = `Ù…Ø²Ø§Ù…Ù†Ø©... ${progress}%`;
    }

    hideSyncIndicator() {
        document.getElementById('syncIndicator').style.display = 'none';
    }

    async forceSync() {
        // Ù…Ø³Ø­ Ø§Ù„Ø·Ø§Ø¨ÙˆØ± ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
        this.syncQueue = [];
        this.showSyncIndicator('syncing', 'Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©...', 0);
        
        try {
            const fullData = {
                students: this.students,
                delays: this.delays,
                absences: this.absences,
                notes: this.notes,
                grades: this.grades,
                classes: this.classes,
                absenceLevels: this.absenceLevels,
                lastSync: new Date().toISOString()
            };

            // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
            const chunks = this.chunkData(fullData);
            let completed = 0;

            const totalChunks = chunks.length;

            // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ø§Ù„ÙØ¹Ù„ÙŠØ©
            for (const chunk of chunks) {
                await this.db.ref(`users/${this.deviceId}/data/${chunk.path}`).set(chunk.data);
                completed++;
                const progress = Math.round((completed / totalChunks) * 100);
                this.updateSyncProgress(progress);

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ù„Ø·Ù…Ø£Ù†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                this.showSyncIndicator('syncing', `Ù…Ø²Ø§Ù…Ù†Ø©... ${completed}/${totalChunks} (${progress}%)`, progress);
            }

            await this.db.ref(`trials/${this.deviceId}/lastSeen`).set(new Date().toISOString());

            this.showSyncIndicator('success', 'ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ“', 100);
            setTimeout(() => this.hideSyncIndicator(), 2000);
            this.showToast('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } catch (error) {
            console.error('Full sync error:', error);
            this.showSyncIndicator('error', 'ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© - Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 0);
            setTimeout(() => this.hideSyncIndicator(), 3000);
        }
    }

    chunkData(data) {
        const chunks = [];
        
        // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¥Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡ ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (10 Ø·Ù„Ø§Ø¨ ÙÙ‚Ø·)
        if (data.students && data.students.length > 10) {
            const studentChunks = [];
            for (let i = 0; i < data.students.length; i += 10) {
                studentChunks.push({
                    path: `students_chunk_${Math.floor(i / 10)}`,
                    data: data.students.slice(i, i + 10)
                });
            }
            chunks.push(...studentChunks);
        } else {
            chunks.push({ path: 'students', data: data.students || [] });
        }

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ù‚Ø³Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
        if (data.delays && Object.keys(data.delays).length > 0) {
            chunks.push({ path: 'delays', data: data.delays });
        }
        if (data.absences && Object.keys(data.absences).length > 0) {
            chunks.push({ path: 'absences', data: data.absences });
        }
        if (data.notes && Object.keys(data.notes).length > 0) {
            chunks.push({ path: 'notes', data: data.notes });
        }

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ© Ø§Ù„ØµØºÙŠØ±Ø©
        const smallData = {
            grades: data.grades || [],
            classes: data.classes || [],
            absenceLevels: data.absenceLevels || this.absenceLevels,
            lastSync: data.lastSync
        };

        chunks.push({ path: 'metadata', data: smallData });
        return chunks;
    }

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
    async activateSubscription(source = 'payment') {
        const inputId = source === 'settings' ? 'activationCodeSettings' : 'activationCodeInput';
        const code = document.getElementById(inputId).value.trim().toUpperCase();

        if (!code) {
            this.showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯', 'error');
            return;
        }

        // Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­Ø© - ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø­Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        // Valid activation codes - One of these codes must be entered to activate the program
        const validCodes = [
            'SK-2025-001A',  // ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ Ø±Ù‚Ù… 1 - Activation code #1
            'SK-2025-002B',  // ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ Ø±Ù‚Ù… 2 - Activation code #2
            'SK-2025-003C',  // ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ Ø±Ù‚Ù… 3 - Activation code #3
            'SK-DEMO-TEST'   // ÙƒÙˆØ¯ ØªØ¬Ø±ÙŠØ¨ÙŠ - Demo code
        ];

        if (!validCodes.includes(code)) {
            this.showToast('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
            return;
        }

        try {
            this.subscription.status = 'active';
            this.subscription.isActivated = true;
            this.subscription.activationCode = code;
            this.subscription.expiryDate = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString();

            await this.db.ref(`trials/${this.deviceId}`).update(this.subscription);

            this.updateSubscriptionUI();
            this.hidePaymentPage();
            this.showToast('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            
            document.getElementById(inputId).value = '';
        } catch (error) {
            console.error('Activation error:', error);
            this.showToast('ÙØ´Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„', 'error');
        }
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨
    showAbsenceLevelsSettings() {
        document.getElementById('configLevel1Min').value = this.absenceLevels.level1.min;
        document.getElementById('configLevel1Max').value = this.absenceLevels.level1.max;
        document.getElementById('configLevel2Min').value = this.absenceLevels.level2.min;
        document.getElementById('configLevel2Max').value = this.absenceLevels.level2.max;
        document.getElementById('configLevel3Min').value = this.absenceLevels.level3.min;
        document.getElementById('configLevel3Max').value = this.absenceLevels.level3.max;
        document.getElementById('configLevel4Min').value = this.absenceLevels.level4.min;
        
        document.getElementById('absenceLevelsModal').classList.add('active');
    }

    closeAbsenceLevelsModal() {
        document.getElementById('absenceLevelsModal').classList.remove('active');
    }

    async saveAbsenceLevelsSettings() {
        this.absenceLevels = {
            level1: {
                min: parseInt(document.getElementById('configLevel1Min').value),
                max: parseInt(document.getElementById('configLevel1Max').value)
            },
            level2: {
                min: parseInt(document.getElementById('configLevel2Min').value),
                max: parseInt(document.getElementById('configLevel2Max').value)
            },
            level3: {
                min: parseInt(document.getElementById('configLevel3Min').value),
                max: parseInt(document.getElementById('configLevel3Max').value)
            },
            level4: {
                min: parseInt(document.getElementById('configLevel4Min').value),
                max: 999
            }
        };

        await this.saveToLocalStorage();
        this.updateAbsenceLevels();
        this.closeAbsenceLevelsModal();
        this.showToast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª', 'success');
    }

    updateAbsenceLevels() {
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
        document.getElementById('level1Min').textContent = this.absenceLevels.level1.min;
        document.getElementById('level1Max').textContent = this.absenceLevels.level1.max;
        document.getElementById('level2Min').textContent = this.absenceLevels.level2.min;
        document.getElementById('level2Max').textContent = this.absenceLevels.level2.max;
        document.getElementById('level3Min').textContent = this.absenceLevels.level3.min;
        document.getElementById('level3Max').textContent = this.absenceLevels.level3.max;
        document.getElementById('level4Min').textContent = this.absenceLevels.level4.min;

        // ØªØµÙ†ÙŠÙ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨
        const level1Students = [];
        const level2Students = [];
        const level3Students = [];
        const level4Students = [];

        this.students.forEach(student => {
            const record = this.getStudentRecord(student.id);
            const absences = record.absences;

            if (absences >= this.absenceLevels.level1.min && absences <= this.absenceLevels.level1.max) {
                level1Students.push(student);
            } else if (absences >= this.absenceLevels.level2.min && absences <= this.absenceLevels.level2.max) {
                level2Students.push(student);
            } else if (absences >= this.absenceLevels.level3.min && absences <= this.absenceLevels.level3.max) {
                level3Students.push(student);
            } else if (absences >= this.absenceLevels.level4.min) {
                level4Students.push(student);
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
        document.getElementById('level1Count').textContent = level1Students.length;
        document.getElementById('level2Count').textContent = level2Students.length;
        document.getElementById('level3Count').textContent = level3Students.length;
        document.getElementById('level4Count').textContent = level4Students.length;

        // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø·Ù„Ø§Ø¨
        this.updateLevelStudentsList('level1Students', level1Students);
        this.updateLevelStudentsList('level2Students', level2Students);
        this.updateLevelStudentsList('level3Students', level3Students);
        this.updateLevelStudentsList('level4Students', level4Students);
    }

    updateLevelStudentsList(elementId, students) {
        const element = document.getElementById(elementId);
        if (students.length === 0) {
            element.innerHTML = '<div style="text-align:center;color:#999;padding:10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</div>';
        } else {
            element.innerHTML = students.map(s => `
                <div class="level-student">
                    <span>${s.name}</span>
                    <span>${s.grade} - ${s.class}</span>
                </div>
            `).join('');
        }
    }

    showPage(page) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        const pageEl = document.getElementById(page + 'Page');
        if (pageEl) pageEl.classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(n => {
            const oncl = n.getAttribute('onclick') || '';
            if (oncl.includes(`showPage('${page}')`) || oncl.includes(`showPage("${page}")`)) {
                n.classList.add('active');
            }
        });

        if (page === 'students') this.updateStudentsList();
        if (page === 'attendance') { this.showSubPage('delays'); this.loadDelays(); }
        if (page === 'notes') this.loadNotes();
        if (page === 'analytics') this.generateAnalytics();
        if (page === 'reports') this.populateReportStudents();
        if (page === 'settings') this.loadSettings();
    }

    showSubPage(subPage) {
        if (subPage === 'delays' || subPage === 'absences') {
            document.querySelectorAll('#attendancePage .sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#attendancePage .sub-page').forEach(p => p.classList.remove('active'));
            
            document.querySelectorAll('#attendancePage .sub-tab').forEach(t => {
                const oncl = t.getAttribute('onclick') || '';
                if (oncl.includes(`showSubPage('${subPage}')`) || oncl.includes(`showSubPage("${subPage}")`)) {
                    t.classList.add('active');
                }
            });
            
            const sp = document.getElementById(subPage + 'SubPage');
            if (sp) sp.classList.add('active');
            
            if (subPage === 'delays') this.loadDelays();
            if (subPage === 'absences') this.loadAbsences();
        }
    }

    showAddStudentModal() {
        document.getElementById('modalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨';
        document.getElementById('studentModal').classList.add('active');
        this.currentStudentId = null;
        document.querySelector('#studentModal form').reset();
    }

    showEditStudentModal(id) {
        const student = this.students.find(s => s.id === id);
        if (!student) return;
        
        document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨';
        document.getElementById('studentName').value = student.name;
        document.getElementById('studentID').value = student.civilId;
        document.getElementById('studentPhone').value = student.phone || '';
        document.getElementById('studentGrade').value = student.grade;
        document.getElementById('studentClass').value = student.class;
        document.getElementById('studentModal').classList.add('active');
        this.currentStudentId = id;
    }

    closeStudentModal() {
        document.getElementById('studentModal').classList.remove('active');
        this.currentStudentId = null;
    }


    toggleExcelInstructions() {
        const instructions = document.getElementById('excelInstructions');
        if (instructions.style.display === 'none') {
            instructions.style.display = 'block';
        } else {
            instructions.style.display = 'none';
        }
    }


    async saveStudent(event) {
        event.preventDefault();
        
        const student = {
            id: this.currentStudentId || Date.now().toString(),
            name: document.getElementById('studentName').value.trim(),
            civilId: document.getElementById('studentID').value.trim(),
            phone: document.getElementById('studentPhone').value.trim(),
            grade: document.getElementById('studentGrade').value,
            class: document.getElementById('studentClass').value,
            addedDate: this.currentStudentId ?
                (this.students.find(s => s.id === this.currentStudentId)?.addedDate || new Date().toISOString()) :
                new Date().toISOString()
        };

        if (this.currentStudentId) {
            const index = this.students.findIndex(s => s.id === this.currentStudentId);
            this.students[index] = student;
            this.showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'success');
        } else {
            this.students.push(student);
            this.showToast('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'success');
        }

        await this.saveToLocalStorage();
        this.updateStudentsList();
        this.closeStudentModal();
        this.updateStats();
    }

    async deleteStudent(id) {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) return;
        
        this.students = this.students.filter(s => s.id !== id);
        Object.keys(this.delays).forEach(date => delete this.delays[date][id]);
        Object.keys(this.absences).forEach(date => delete this.absences[date][id]);
        Object.keys(this.notes).forEach(date => delete this.notes[date][id]);
        
        await this.saveToLocalStorage();
        this.updateStudentsList();
        this.showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
        this.updateStats();
    }

    deleteAllStudents() {
        if (!confirm('Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ')) return;
        if (prompt('Ø§ÙƒØªØ¨ "Ù†Ø¹Ù…"') !== 'Ù†Ø¹Ù…') return;
        
        this.students = [];
        this.delays = {};
        this.absences = {};
        this.notes = {};
        
        this.saveToLocalStorage();
        this.updateStudentsList();
        this.updateStats();
        this.showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'info');
    }

    searchStudents() {
        const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
        const filtered = this.students.filter(s =>
            s.name.toLowerCase().includes(searchTerm) ||
            s.civilId.includes(searchTerm)
        );
        this.updateStudentsList(filtered);
    }

    updateStudentsList(students = this.students) {
        const list = document.getElementById('studentsList');
        if (students.length === 0) {
            list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</div></div>';
            return;
        }

        list.innerHTML = '<div class="student-list">' + students.map(s => {
            const record = this.getStudentRecord(s.id);
            return `
                <div class="student-item">
                    <div class="student-info">
                        <div class="student-name">${s.name}</div>
                        <div class="student-details">
                            <span class="student-detail"><i class="fas fa-id-card"></i>${s.civilId}</span>
                            <span class="student-detail"><i class="fas fa-phone"></i>${s.phone || '--'}</span>
                            <span class="student-detail"><i class="fas fa-graduation-cap"></i>${s.grade} - ${s.class}</span>
                        </div>
                        <div class="student-record">
                            <span class="record-badge delays"><i class="fas fa-clock"></i> ${record.delays}</span>
                            <span class="record-badge absences"><i class="fas fa-times-circle"></i> ${record.absences}</span>
                            <span class="record-badge notes"><i class="fas fa-sticky-note"></i> ${record.notes}</span>
                        </div>
                    </div>
                    <div class="student-actions">
                        <button class="btn-icon edit" onclick="app.showEditStudentModal('${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon delete" onclick="app.deleteStudent('${s.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }).join('') + '</div>';
    }

    getStudentRecord(studentId) {
        let delays = 0, absences = 0, notes = 0;
        Object.keys(this.delays).forEach(date => { if (this.delays[date][studentId]) delays++; });
        Object.keys(this.absences).forEach(date => { if (this.absences[date][studentId]) absences++; });
        Object.keys(this.notes).forEach(date => { if (this.notes[date][studentId]) notes++; });
        return { delays, absences, notes };
    }

    setupEventListeners() {
        const excelFile = document.getElementById('excelFile');
        if (excelFile) excelFile.addEventListener('change', (e) => this.importExcel(e));
    }

    importExcel(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                let imported = 0;
                const newGrades = new Set(this.grades);
                const newClasses = new Set(this.classes);

                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row[0]) continue;

                    const grade = String(row[3] || '').trim();
                    const classVal = String(row[4] || '').trim();

                    if (grade && !newGrades.has(grade)) newGrades.add(grade);
                    if (classVal && !newClasses.has(classVal)) newClasses.add(classVal);

                    const student = {
                        id: Date.now().toString() + i,
                        name: String(row[0] || '').trim(),
                        civilId: String(row[1] || '').trim(),
                        phone: String(row[2] || '').trim(),
                        grade: grade,
                        class: classVal,
                        addedDate: new Date().toISOString()
                    };

                    if (student.name && student.civilId && student.grade && student.class) {
                        this.students.push(student);
                        imported++;
                    }
                }

                this.grades = Array.from(newGrades);
                this.classes = Array.from(newClasses);
                this.populateGradeClassSelects();
                this.saveToLocalStorage();
                this.updateStudentsList();
                this.updateStats();
                this.showToast(`Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${imported} Ø·Ø§Ù„Ø¨`, 'success');
                e.target.value = '';
            } catch (error) {
                this.showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    exportStudentsExcel() {
        if (this.students.length === 0) {
            this.showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨', 'error');
            return;
        }

        const data = [
            ['#', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ø³Ø¬Ù„', 'Ø§Ù„Ø¬ÙˆØ§Ù„', 'Ø§Ù„ØµÙ', 'Ø§Ù„ÙØµÙ„', 'Ø§Ù„ØªØ£Ø®ÙŠØ±', 'Ø§Ù„ØºÙŠØ§Ø¨', 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª'],
            ...this.students.map((s, i) => {
                const record = this.getStudentRecord(s.id);
                return [i + 1, s.name, s.civilId, s.phone || '', s.grade, s.class, record.delays, record.absences, record.notes];
            })
        ];

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø·Ù„Ø§Ø¨');
        XLSX.writeFile(wb, `Ø§Ù„Ø·Ù„Ø§Ø¨_${new Date().toISOString().split('T')[0]}.xlsx`);
        this.showToast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'success');
    }

    populateGradeClassSelects() {
        ['studentGrade', 'delaysGradeFilter', 'absencesGradeFilter', 'notesGradeFilter'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                const currentValue = select.value;
                const isFilter = id.includes('Filter');
                select.innerHTML = isFilter ? '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>' : '<option value="">Ø§Ø®ØªØ±</option>';
                this.grades.forEach(grade => {
                    select.innerHTML += `<option value="${grade}">${grade}</option>`;
                });
                if (currentValue) select.value = currentValue;
            }
        });

        ['studentClass', 'delaysClassFilter', 'absencesClassFilter', 'notesClassFilter'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                const currentValue = select.value;
                const isFilter = id.includes('Filter');
                select.innerHTML = isFilter ? '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>' : '<option value="">Ø§Ø®ØªØ±</option>';
                this.classes.forEach(cls => {
                    select.innerHTML += `<option value="${cls}">${cls}</option>`;
                });
                if (currentValue) select.value = currentValue;
            }
        });
    }

    loadDelays() {
        const date = document.getElementById('delaysDate').value;
        if (!date) return;

        const gradeFilter = document.getElementById('delaysGradeFilter').value;
        const classFilter = document.getElementById('delaysClassFilter').value;

        let filtered = this.students;
        if (gradeFilter) filtered = filtered.filter(s => s.grade === gradeFilter);
        if (classFilter) filtered = filtered.filter(s => s.class === classFilter);

        const list = document.getElementById('delaysList');
        if (filtered.length === 0) {
            list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div></div>';
            return;
        }

        list.innerHTML = '<div class="student-list">' + filtered.map(s => {
            const isDelayed = this.delays[date]?.[s.id] || false;
            return `
                <div class="student-item ${isDelayed ? 'selected' : ''}" id="delay_${s.id}">
                    <input type="checkbox" class="student-checkbox" ${isDelayed ? 'checked' : ''} onchange="app.toggleDelay('${s.id}')">
                    <div class="student-info">
                        <div class="student-name">${s.name}</div>
                        <div class="student-details">
                            <span class="student-detail"><i class="fas fa-graduation-cap"></i>${s.grade} - ${s.class}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('') + '</div>';
    }

    toggleDelay(studentId) {
        const date = document.getElementById('delaysDate').value;
        if (!this.delays[date]) this.delays[date] = {};
        this.delays[date][studentId] = !this.delays[date][studentId];
        if (!this.delays[date][studentId]) delete this.delays[date][studentId];
        document.getElementById(`delay_${studentId}`).classList.toggle('selected');
    }

    searchDelays() {
        const searchTerm = document.getElementById('delaysSearch').value.toLowerCase();
        document.querySelectorAll('#delaysList .student-item').forEach(item => {
            const name = item.querySelector('.student-name').textContent.toLowerCase();
            item.style.display = name.includes(searchTerm) ? '' : 'none';
        });
    }

    selectAllDelays() {
        const date = document.getElementById('delaysDate').value;
        if (!this.delays[date]) this.delays[date] = {};
        document.querySelectorAll('#delaysList .student-checkbox').forEach(cb => {
            cb.checked = true;
            const studentId = cb.parentElement.id.replace('delay_', '');
            this.delays[date][studentId] = true;
            cb.parentElement.classList.add('selected');
        });
    }

    deselectAllDelays() {
        const date = document.getElementById('delaysDate').value;
        if (this.delays[date]) this.delays[date] = {};
        document.querySelectorAll('#delaysList .student-checkbox').forEach(cb => {
            cb.checked = false;
            cb.parentElement.classList.remove('selected');
        });
    }

    async saveDelaysToRecord() {
        await this.saveToLocalStorage();
        this.showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'success');
        this.updateStats();
    }

    sendDelaysWhatsApp() {
        const date = document.getElementById('delaysDate').value;
        const delayed = this.delays[date] || {};
        const delayedStudents = this.students.filter(s => delayed[s.id]);

        if (delayedStudents.length === 0) {
            this.showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯', 'error');
            return;
        }

        const schoolName = localStorage.getItem('schoolName') || 'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©';
        let message = `*ØªØ£Ø®ÙŠØ± - ${schoolName}*\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(date).toLocaleDateString('ar-SA')}\n\n`;
        delayedStudents.forEach((s, i) => {
            message += `${i + 1}. ${s.name} - ${s.grade} ${s.class}\n`;
        });

        window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }

    loadAbsences() {
        const date = document.getElementById('absencesDate').value;
        if (!date) return;

        const gradeFilter = document.getElementById('absencesGradeFilter').value;
        const classFilter = document.getElementById('absencesClassFilter').value;

        let filtered = this.students;
        if (gradeFilter) filtered = filtered.filter(s => s.grade === gradeFilter);
        if (classFilter) filtered = filtered.filter(s => s.class === classFilter);

        const list = document.getElementById('absencesList');
        if (filtered.length === 0) {
            list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div></div>';
            return;
        }

        list.innerHTML = '<div class="student-list">' + filtered.map(s => {
            const isAbsent = this.absences[date]?.[s.id] || false;
            return `
                <div class="student-item ${isAbsent ? 'selected' : ''}" id="absence_${s.id}">
                    <input type="checkbox" class="student-checkbox" ${isAbsent ? 'checked' : ''} onchange="app.toggleAbsence('${s.id}')">
                    <div class="student-info">
                        <div class="student-name">${s.name}</div>
                        <div class="student-details">
                            <span class="student-detail"><i class="fas fa-graduation-cap"></i>${s.grade} - ${s.class}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('') + '</div>';
    }

    toggleAbsence(studentId) {
        const date = document.getElementById('absencesDate').value;
        if (!this.absences[date]) this.absences[date] = {};
        this.absences[date][studentId] = !this.absences[date][studentId];
        if (!this.absences[date][studentId]) delete this.absences[date][studentId];
        document.getElementById(`absence_${studentId}`).classList.toggle('selected');
    }

    searchAbsences() {
        const searchTerm = document.getElementById('absencesSearch').value.toLowerCase();
        document.querySelectorAll('#absencesList .student-item').forEach(item => {
            const name = item.querySelector('.student-name').textContent.toLowerCase();
            item.style.display = name.includes(searchTerm) ? '' : 'none';
        });
    }

    selectAllAbsences() {
        const date = document.getElementById('absencesDate').value;
        if (!this.absences[date]) this.absences[date] = {};
        document.querySelectorAll('#absencesList .student-checkbox').forEach(cb => {
            cb.checked = true;
            const studentId = cb.parentElement.id.replace('absence_', '');
            this.absences[date][studentId] = true;
            cb.parentElement.classList.add('selected');
        });
    }

    deselectAllAbsences() {
        const date = document.getElementById('absencesDate').value;
        if (this.absences[date]) this.absences[date] = {};
        document.querySelectorAll('#absencesList .student-checkbox').forEach(cb => {
            cb.checked = false;
            cb.parentElement.classList.remove('selected');
        });
    }

    async saveAbsencesToRecord() {
        await this.saveToLocalStorage();
        this.showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'success');
        this.updateStats();
    }

    sendAbsencesWhatsApp() {
        const date = document.getElementById('absencesDate').value;
        const absent = this.absences[date] || {};
        const absentStudents = this.students.filter(s => absent[s.id]);

        if (absentStudents.length === 0) {
            this.showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯', 'error');
            return;
        }

        const schoolName = localStorage.getItem('schoolName') || 'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©';
        let message = `*ØºÙŠØ§Ø¨ - ${schoolName}*\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(date).toLocaleDateString('ar-SA')}\n\n`;
        absentStudents.forEach((s, i) => {
            message += `${i + 1}. ${s.name} - ${s.grade} ${s.class}\n`;
        });

        window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }

    loadNotes() {
        const date = document.getElementById('notesDate').value;
        if (!date) return;

        const gradeFilter = document.getElementById('notesGradeFilter').value;
        const classFilter = document.getElementById('notesClassFilter').value;

        let filtered = this.students;
        if (gradeFilter) filtered = filtered.filter(s => s.grade === gradeFilter);
        if (classFilter) filtered = filtered.filter(s => s.class === classFilter);

        const list = document.getElementById('notesList');
        if (filtered.length === 0) {
            list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div></div>';
            return;
        }

        list.innerHTML = '<div class="student-list">' + filtered.map(s => {
            const hasNote = this.notes[date]?.[s.id] || false;
            return `
                <div class="student-item ${hasNote ? 'selected' : ''}" id="note_${s.id}">
                    <input type="checkbox" class="student-checkbox" ${hasNote ? 'checked' : ''} onchange="app.toggleNote('${s.id}')">
                    <div class="student-info">
                        <div class="student-name">${s.name}</div>
                        <div class="student-details">
                            <span class="student-detail"><i class="fas fa-graduation-cap"></i>${s.grade} - ${s.class}</span>
                        </div>
                        ${hasNote ? `<div style="margin-top:8px;padding:8px;background:#fff3cd;border-radius:6px;font-size:13px;">${this.notes[date][s.id]}</div>` : ''}
                    </div>
                </div>
            `;
        }).join('') + '</div>';
    }

    toggleNote(studentId) {
        const checkbox = document.querySelector(`#note_${studentId} .student-checkbox`);
        const item = document.getElementById(`note_${studentId}`);
        if (checkbox.checked) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
            const date = document.getElementById('notesDate').value;
            if (this.notes[date]?.[studentId]) {
                delete this.notes[date][studentId];
                this.loadNotes();
            }
        }
    }

    searchNotes() {
        const searchTerm = document.getElementById('notesSearch').value.toLowerCase();
        document.querySelectorAll('#notesList .student-item').forEach(item => {
            const name = item.querySelector('.student-name').textContent.toLowerCase();
            item.style.display = name.includes(searchTerm) ? '' : 'none';
        });
    }

    selectAllNotes() {
        document.querySelectorAll('#notesList .student-checkbox').forEach(cb => {
            cb.checked = true;
            cb.parentElement.classList.add('selected');
        });
    }

    deselectAllNotes() {
        document.querySelectorAll('#notesList .student-checkbox').forEach(cb => {
            cb.checked = false;
            cb.parentElement.classList.remove('selected');
        });
    }

    async saveNotesToRecord() {
        const date = document.getElementById('notesDate').value;
        const noteText = document.getElementById('noteText').value.trim();

        if (!noteText) {
            this.showToast('Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', 'error');
            return;
        }

        const selectedStudents = [];
        document.querySelectorAll('#notesList .student-checkbox:checked').forEach(cb => {
            const studentId = cb.parentElement.id.replace('note_', '');
            selectedStudents.push(studentId);
        });

        if (selectedStudents.length === 0) {
            this.showToast('Ø­Ø¯Ø¯ Ø·Ø§Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
            return;
        }

        if (!this.notes[date]) this.notes[date] = {};
        selectedStudents.forEach(id => {
            this.notes[date][id] = noteText;
        });

        await this.saveToLocalStorage();
        this.showToast(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù€ ${selectedStudents.length} Ø·Ø§Ù„Ø¨`, 'success');
        document.getElementById('noteText').value = '';
        this.loadNotes();
        this.updateStats();
    }

    sendNotesWhatsApp() {
        const date = document.getElementById('notesDate').value;
        const noteText = document.getElementById('noteText').value.trim();

        const selectedStudents = [];
        document.querySelectorAll('#notesList .student-checkbox:checked').forEach(cb => {
            const studentId = cb.parentElement.id.replace('note_', '');
            const student = this.students.find(s => s.id === studentId);
            if (student) selectedStudents.push(student);
        });

        if (selectedStudents.length === 0 || !noteText) {
            this.showToast('Ø­Ø¯Ø¯ Ø·Ù„Ø§Ø¨ ÙˆØ§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', 'error');
            return;
        }

        const schoolName = localStorage.getItem('schoolName') || 'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©';
        let message = `*Ù…Ù„Ø§Ø­Ø¸Ø© - ${schoolName}*\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(date).toLocaleDateString('ar-SA')}\n\n*Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:* ${noteText}\n\n`;
        selectedStudents.forEach((s, i) => {
            message += `${i + 1}. ${s.name} - ${s.grade} ${s.class}\n`;
        });

        window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }

    // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    async generateAnalytics() {
        try {
            this.showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...', 'info');
            
            const analytics = {
                totalStudents: this.students.length,
                attendanceRate: this.calculateAttendanceRate(),
                absenceRate: this.calculateAbsenceRate(),
                delayRate: this.calculateDelayRate(),
                monthlyStats: this.getMonthlyStats(),
                gradeDistribution: this.getGradeDistribution(),
                topAbsentStudents: this.getTopAbsentStudents(),
                timestamp: new Date().toISOString()
            };

            await this.db.ref(`analytics/${this.deviceId}`).set(analytics);

            document.getElementById('analyticsTotalStudents').textContent = analytics.totalStudents;
            document.getElementById('analyticsAttendanceRate').textContent = analytics.attendanceRate + '%';
            document.getElementById('analyticsAbsenceRate').textContent = analytics.absenceRate + '%';
            document.getElementById('analyticsDelayRate').textContent = analytics.delayRate + '%';

            this.updateAbsenceLevels();
            this.createCharts(analytics);
            
            this.showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } catch (error) {
            console.error('Analytics error:', error);
            this.showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'error');
        }
    }

    calculateAttendanceRate() {
        if (this.students.length === 0) return 0;
        
        const totalDays = Object.keys(this.absences).length;
        if (totalDays === 0) return 100;

        let totalAttendance = 0;
        this.students.forEach(student => {
            let attendanceDays = 0;
            Object.keys(this.absences).forEach(date => {
                if (!this.absences[date][student.id]) {
                    attendanceDays++;
                }
            });
            totalAttendance += (attendanceDays / totalDays) * 100;
        });

        return Math.round(totalAttendance / this.students.length);
    }

    calculateAbsenceRate() {
        return 100 - this.calculateAttendanceRate();
    }

    calculateDelayRate() {
        if (this.students.length === 0) return 0;
        
        const totalDays = Object.keys(this.delays).length;
        if (totalDays === 0) return 0;

        let totalDelays = 0;
        Object.values(this.delays).forEach(dayDelays => {
            totalDelays += Object.keys(dayDelays).length;
        });

        return Math.round((totalDelays / (this.students.length * totalDays)) * 100);
    }

    getMonthlyStats() {
        const monthlyStats = {};
        const currentYear = new Date().getFullYear();

        ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'].forEach(month => {
            const monthKey = `${currentYear}-${month}`;
            let delays = 0, absences = 0;

            Object.keys(this.delays).forEach(date => {
                if (date.startsWith(monthKey)) {
                    delays += Object.keys(this.delays[date]).length;
                }
            });

            Object.keys(this.absences).forEach(date => {
                if (date.startsWith(monthKey)) {
                    absences += Object.keys(this.absences[date]).length;
                }
            });

            monthlyStats[month] = { delays, absences };
        });

        return monthlyStats;
    }

    getGradeDistribution() {
        const distribution = {};
        this.students.forEach(student => {
            if (!distribution[student.grade]) {
                distribution[student.grade] = 0;
            }
            distribution[student.grade]++;
        });
        return distribution;
    }

    getTopAbsentStudents() {
        const studentAbsences = {};
        this.students.forEach(student => {
            studentAbsences[student.id] = {
                name: student.name,
                grade: student.grade,
                count: 0
            };
        });

        Object.values(this.absences).forEach(dayAbsences => {
            Object.keys(dayAbsences).forEach(studentId => {
                if (studentAbsences[studentId]) {
                    studentAbsences[studentId].count++;
                }
            });
        });

        return Object.values(studentAbsences)
            .sort((a, b) => b.count - a.count)
            .slice(0, 10);
    }

    createCharts(analytics) {
        this.createAttendanceChart(analytics);
        this.createMonthlyChart(analytics);
        this.createGradeDistributionChart(analytics);
        this.createTopAbsentChart(analytics);
    }

    createAttendanceChart(analytics) {
        const ctx = document.getElementById('attendanceChart');
        if (!ctx) return;

        if (this.charts.attendance) {
            this.charts.attendance.destroy();
        }

        this.charts.attendance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Ø­Ø¶ÙˆØ±', 'ØºÙŠØ§Ø¨', 'ØªØ£Ø®ÙŠØ±'],
                datasets: [{
                    data: [
                        analytics.attendanceRate,
                        analytics.absenceRate,
                        analytics.delayRate
                    ],
                    backgroundColor: [
                        '#4CAF50',
                        '#F44336',
                        '#FF9800'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                family: 'Tajawal',
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    createMonthlyChart(analytics) {
        const ctx = document.getElementById('monthlyChart');
        if (!ctx) return;

        const months = Object.keys(analytics.monthlyStats);
        const delays = months.map(m => analytics.monthlyStats[m].delays);
        const absences = months.map(m => analytics.monthlyStats[m].absences);

        if (this.charts.monthly) {
            this.charts.monthly.destroy();
        }

        this.charts.monthly = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months.map(m => {
                    const date = new Date(m + '-01');
                    return date.toLocaleDateString('ar-SA', { month: 'short' });
                }),
                datasets: [{
                    label: 'Ø§Ù„ØªØ£Ø®ÙŠØ±',
                    data: delays,
                    borderColor: '#FF9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Ø§Ù„ØºÙŠØ§Ø¨',
                    data: absences,
                    borderColor: '#F44336',
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            font: {
                                family: 'Tajawal',
                                size: 14
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: {
                                family: 'Tajawal'
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                family: 'Tajawal'
                            }
                        }
                    }
                }
            }
        });
    }

    createGradeDistributionChart(analytics) {
        const ctx = document.getElementById('gradeChart');
        if (!ctx) return;

        const grades = Object.keys(analytics.gradeDistribution);
        const counts = Object.values(analytics.gradeDistribution);

        if (this.charts.grade) {
            this.charts.grade.destroy();
        }

        this.charts.grade = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: grades,
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨',
                    data: counts,
                    backgroundColor: '#2196F3',
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: {
                                family: 'Tajawal'
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                family: 'Tajawal'
                            }
                        }
                    }
                }
            }
        });
    }

    createTopAbsentChart(analytics) {
        const ctx = document.getElementById('topAbsentChart');
        if (!ctx) return;

        const names = analytics.topAbsentStudents.map(s => s.name);
        const counts = analytics.topAbsentStudents.map(s => s.count);

        if (this.charts.topAbsent) {
            this.charts.topAbsent.destroy();
        }

        this.charts.topAbsent = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: names,
                datasets: [{
                    label: 'Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨',
                    data: counts,
                    backgroundColor: '#F44336',
                    borderRadius: 5
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            font: {
                                family: 'Tajawal'
                            }
                        }
                    },
                    y: {
                        ticks: {
                            font: {
                                family: 'Tajawal'
                            }
                        }
                    }
                }
            }
        });
    }

    // Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF
    async exportToPDF() {
        try {
            this.showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± PDF...', 'info');
            
            const analytics = {
                totalStudents: this.students.length,
                attendanceRate: this.calculateAttendanceRate(),
                absenceRate: this.calculateAbsenceRate(),
                delayRate: this.calculateDelayRate(),
                gradeDistribution: this.getGradeDistribution(),
                topAbsentStudents: this.getTopAbsentStudents()
            };

            const docDefinition = {
                content: [
                    {
                        text: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ£Ø®ÙŠØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø´Ø§Ù…Ù„',
                        style: 'header',
                        alignment: 'center',
                        margin: [0, 0, 0, 20]
                    },
                    
                    {
                        text: [
                            { text: 'Ø§Ù„ØªØ§Ø±ÙŠØ®: ', bold: true },
                            new Date().toLocaleDateString('ar-SA')
                        ],
                        margin: [0, 0, 0, 10]
                    },
                    
                    {
                        text: 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
                        style: 'subheader',
                        margin: [0, 20, 0, 10]
                    },
                    
                    this.createStatsTable(analytics),
                    
                    {
                        text: 'Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨',
                        style: 'subheader',
                        margin: [0, 20, 0, 10]
                    },
                    
                    this.createAbsenceLevelsTable(),
                    
                    {
                        text: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ',
                        style: 'subheader',
                        margin: [0, 20, 0, 10]
                    },
                    
                    this.createGradeTable(analytics),
                    
                    {
                        text: 'Ø£ÙƒØ«Ø± Ø§Ù„Ø·Ù„Ø§Ø¨ ØºÙŠØ§Ø¨Ø§Ù‹',
                        style: 'subheader',
                        margin: [0, 20, 0, 10]
                    },
                    
                    this.createTopAbsentTable(analytics),
                    
                    {
                        text: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†',
                        style: 'subheader',
                        margin: [0, 20, 0, 10]
                    },
                    
                    this.createAbsentStudentsTable(),
                    
                    {
                        text: 'Ø§Ù„Ø®Ù„Ø§ØµØ© ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª',
                        style: 'subheader',
                        margin: [0, 20, 0, 10]
                    },
                    
                    this.createSummary(analytics)
                ],
                
                styles: {
                    header: {
                        fontSize: 24,
                        bold: true,
                        font: 'Tajawal'
                    },
                    subheader: {
                        fontSize: 18,
                        bold: true,
                        font: 'Tajawal',
                        margin: [0, 15, 0, 5]
                    },
                    tableHeader: {
                        bold: true,
                        fontSize: 12,
                        font: 'Tajawal',
                        color: 'white',
                        fillColor: '#2196F3'
                    },
                    tableCell: {
                        fontSize: 10,
                        font: 'Tajawal',
                        margin: [5, 5, 5, 5]
                    }
                },
                
                defaultStyle: {
                    font: 'Tajawal',
                    fontSize: 12
                },
                
                pageOrientation: 'portrait',
                pageSize: 'A4',
                pageMargins: [40, 60, 40, 60]
            };

            pdfMake.createPdf(docDefinition).download(`ØªÙ‚Ø±ÙŠØ±_${new Date().toISOString().split('T')[0]}.pdf`);
            this.showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } catch (error) {
            console.error('PDF export error:', error);
            this.showToast('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± PDF', 'error');
        }
    }

    createStatsTable(analytics) {
        return {
            table: {
                headerRows: 1,
                widths: ['*', '*'],
                body: [
                    [
                        { text: 'Ø§Ù„Ù…Ø¤Ø´Ø±', style: 'tableHeader' },
                        { text: 'Ø§Ù„Ù‚ÙŠÙ…Ø©', style: 'tableHeader' }
                    ],
                    [
                        { text: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨', style: 'tableCell' },
                        { text: analytics.totalStudents.toString(), style: 'tableCell' }
                    ],
                    [
                        { text: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±', style: 'tableCell' },
                        { text: `${analytics.attendanceRate}%`, style: 'tableCell' }
                    ],
                    [
                        { text: 'Ù†Ø³Ø¨Ø© Ø§Ù„ØºÙŠØ§Ø¨', style: 'tableCell' },
                        { text: `${analytics.absenceRate}%`, style: 'tableCell' }
                    ],
                    [
                        { text: 'Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ£Ø®ÙŠØ±', style: 'tableCell' },
                        { text: `${analytics.delayRate}%`, style: 'tableCell' }
                    ]
                ]
            },
            layout: {
                fillColor: function (rowIndex, node, columnIndex) {
                    return (rowIndex % 2 === 0) ? '#F5F5F5' : null;
                }
            }
        };
    }

    createAbsenceLevelsTable() {
        const tableBody = [
            [
                { text: 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰', style: 'tableHeader' },
                { text: 'Ø§Ù„Ù†Ø·Ø§Ù‚', style: 'tableHeader' },
                { text: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨', style: 'tableHeader' }
            ]
        ];

        const levels = [
            { name: 'Ø¢Ù…Ù†', min: this.absenceLevels.level1.min, max: this.absenceLevels.level1.max },
            { name: 'ØªÙ†Ø¨ÙŠÙ‡', min: this.absenceLevels.level2.min, max: this.absenceLevels.level2.max },
            { name: 'ØªØ­Ø°ÙŠØ±', min: this.absenceLevels.level3.min, max: this.absenceLevels.level3.max },
            { name: 'Ø®Ø·Ø±', min: this.absenceLevels.level4.min, max: 'Ø£ÙƒØ«Ø±' }
        ];

        levels.forEach(level => {
            const count = this.getStudentsCountInLevel(level.min, level.max);
            const range = level.max === 'Ø£ÙƒØ«Ø±' ? `Ø£ÙƒØ«Ø± Ù…Ù† ${level.min}` : `${level.min} - ${level.max}`;
            tableBody.push([
                { text: level.name, style: 'tableCell' },
                { text: range, style: 'tableCell' },
                { text: count.toString(), style: 'tableCell' }
            ]);
        });

        return {
            table: {
                headerRows: 1,
                widths: ['*', '*', '*'],
                body: tableBody
            },
            layout: {
                fillColor: function (rowIndex, node, columnIndex) {
                    return (rowIndex % 2 === 0) ? '#F5F5F5' : null;
                }
            }
        };
    }

    getStudentsCountInLevel(min, max) {
        let count = 0;
        this.students.forEach(student => {
            const record = this.getStudentRecord(student.id);
            const absences = record.absences;
            
            if (max === 'Ø£ÙƒØ«Ø±') {
                if (absences >= min) count++;
            } else {
                if (absences >= min && absences <= max) count++;
            }
        });
        return count;
    }

    createGradeTable(analytics) {
        const tableBody = [
            [
                { text: 'Ø§Ù„ØµÙ', style: 'tableHeader' },
                { text: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨', style: 'tableHeader' }
            ]
        ];

        Object.entries(analytics.gradeDistribution).forEach(([grade, count]) => {
            tableBody.push([
                { text: grade, style: 'tableCell' },
                { text: count.toString(), style: 'tableCell' }
            ]);
        });

        return {
            table: {
                headerRows: 1,
                widths: ['*', '*'],
                body: tableBody
            },
            layout: {
                fillColor: function (rowIndex, node, columnIndex) {
                    return (rowIndex % 2 === 0) ? '#F5F5F5' : null;
                }
            }
        };
    }

    createTopAbsentTable(analytics) {
        const tableBody = [
            [
                { text: 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', style: 'tableHeader' },
                { text: 'Ø§Ù„ØµÙ', style: 'tableHeader' },
                { text: 'Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨', style: 'tableHeader' }
            ]
        ];

        analytics.topAbsentStudents.forEach(student => {
            tableBody.push([
                { text: student.name, style: 'tableCell' },
                { text: student.grade, style: 'tableCell' },
                { text: student.count.toString(), style: 'tableCell' }
            ]);
        });

        return {
            table: {
                headerRows: 1,
                widths: ['*', '*', '*'],
                body: tableBody
            },
            layout: {
                fillColor: function (rowIndex, node, columnIndex) {
                    return (rowIndex % 2 === 0) ? '#F5F5F5' : null;
                }
            }
        };
    }

    createAbsentStudentsTable() {
        const absentStudents = this.students.filter(s => {
            const record = this.getStudentRecord(s.id);
            return record.absences > 0;
        }).sort((a, b) => {
            const recordA = this.getStudentRecord(a.id);
            const recordB = this.getStudentRecord(b.id);
            return recordB.absences - recordA.absences;
        });

        const tableBody = [
            [
                { text: 'Ø§Ù„Ø§Ø³Ù…', style: 'tableHeader' },
                { text: 'Ø§Ù„Ø³Ø¬Ù„', style: 'tableHeader' },
                { text: 'Ø§Ù„ØµÙ', style: 'tableHeader' },
                { text: 'Ø§Ù„ØªØ£Ø®ÙŠØ±', style: 'tableHeader' },
                { text: 'Ø§Ù„ØºÙŠØ§Ø¨', style: 'tableHeader' },
                { text: 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª', style: 'tableHeader' }
            ]
        ];

        absentStudents.forEach(student => {
            const record = this.getStudentRecord(student.id);
            tableBody.push([
                { text: student.name, style: 'tableCell' },
                { text: student.civilId, style: 'tableCell' },
                { text: `${student.grade} - ${student.class}`, style: 'tableCell' },
                { text: record.delays.toString(), style: 'tableCell' },
                { text: record.absences.toString(), style: 'tableCell' },
                { text: record.notes.toString(), style: 'tableCell' }
            ]);
        });

        return {
            table: {
                headerRows: 1,
                widths: ['*', '*', '*', '*', '*', '*'],
                body: tableBody
            },
            layout: {
                fillColor: function (rowIndex, node, columnIndex) {
                    return (rowIndex % 2 === 0) ? '#F5F5F5' : null;
                }
            }
        };
    }

    createSummary(analytics) {
        const recommendations = [];

        if (analytics.absenceRate > 10) {
            recommendations.push('â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„ØºÙŠØ§Ø¨ Ù…Ø±ØªÙØ¹Ø©ØŒ ÙŠÙˆØµÙ‰ Ø¨Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†');
        }

        if (analytics.delayRate > 15) {
            recommendations.push('â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ£Ø®ÙŠØ± Ø¹Ø§Ù„ÙŠØ©ØŒ ÙŠÙˆØµÙ‰ Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØµØ§Ø±Ù…Ø©');
        }

        if (analytics.attendanceRate < 85) {
            recommendations.push('â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù†Ø®ÙØ¶Ø©ØŒ ÙŠÙˆØµÙ‰ Ø¨ØªØ­Ø³ÙŠÙ† Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ù„Ù…');
        }

        const level4Count = this.getStudentsCountInLevel(this.absenceLevels.level4.min, 'Ø£ÙƒØ«Ø±');
        if (level4Count > 0) {
            recommendations.push(`â€¢ ÙŠÙˆØ¬Ø¯ ${level4Count} Ø·Ø§Ù„Ø¨ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø±ØŒ ÙŠØªØ·Ù„Ø¨ ØªØ¯Ø®Ù„ ÙÙˆØ±ÙŠ`);
        }

        return {
            ul: recommendations.length > 0 ? recommendations : ['â€¢ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨ÙƒÙØ§Ø¡Ø©ØŒ Ù†Ø³Ø¨ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¬ÙŠØ¯Ø©']
        };
    }

    handleReportScope() {
        const scope = document.getElementById('reportScope').value;
        document.getElementById('dateRangeSection').style.display = scope === 'dateRange' ? 'block' : 'none';
        document.getElementById('studentSection').style.display = scope === 'student' ? 'block' : 'none';
    }

    populateReportStudents() {
        const select = document.getElementById('reportStudent');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ±</option>' +
            this.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    generatePrintReport() {
        const type = document.getElementById('reportType').value;
        const scope = document.getElementById('reportScope').value;

        let html = `<div style="padding:20px;background:white;border-radius:12px;">`;
        html += `<h2 style="text-align:center;color:#1a237e;margin-bottom:20px;">ØªÙ‚Ø±ÙŠØ± ${this.getReportTypeName(type)}</h2>`;

        if (type === 'comprehensive') {
            html += this.generateComprehensiveAbsentReport(scope);
        } else {
            html += this.generateSpecificReport(type, scope);
        }

        html += `</div>`;
        document.getElementById('reportPreview').innerHTML = html;
    }

    getReportTypeName(type) {
        const names = {
            delays: 'Ø§Ù„ØªØ£Ø®ÙŠØ±',
            absences: 'Ø§Ù„ØºÙŠØ§Ø¨',
            notes: 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
            comprehensive: 'Ø´Ø§Ù…Ù„ Ù„Ù„ØºØ§Ø¦Ø¨ÙŠÙ†'
        };
        return names[type] || type;
    }

    generateComprehensiveAbsentReport(scope) {
        let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#667eea;color:white;">';
        html += '<th style="padding:10px;border:1px solid #ddd;">Ø§Ù„Ø§Ø³Ù…</th>';
        html += '<th style="padding:10px;border:1px solid #ddd;">Ø§Ù„ØµÙ</th>';
        html += '<th style="padding:10px;border:1px solid #ddd;">Ø§Ù„ØªØ£Ø®ÙŠØ±</th>';
        html += '<th style="padding:10px;border:1px solid #ddd;">Ø§Ù„ØºÙŠØ§Ø¨</th>';
        html += '<th style="padding:10px;border:1px solid #ddd;">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>';
        html += '</tr></thead><tbody>';

        let students = this.students.filter(s => {
            const record = this.getStudentRecord(s.id);
            return record.absences > 0;
        });

        if (scope === 'student') {
            const studentId = document.getElementById('reportStudent').value;
            students = students.filter(s => s.id === studentId);
        }

        students.forEach(s => {
            const record = this.getStudentRecord(s.id);
            html += '<tr>';
            html += `<td style="padding:10px;border:1px solid #ddd;">${s.name}</td>`;
            html += `<td style="padding:10px;border:1px solid #ddd;">${s.grade} - ${s.class}</td>`;
            html += `<td style="padding:10px;border:1px solid #ddd;">${record.delays}</td>`;
            html += `<td style="padding:10px;border:1px solid #ddd;">${record.absences}</td>`;
            html += `<td style="padding:10px;border:1px solid #ddd;">${record.notes}</td>`;
            html += '</tr>';
        });

        html += '</tbody></table>';
        return html;
    }

    generateSpecificReport(type, scope) {
        const dataMap = {
            delays: this.delays,
            absences: this.absences,
            notes: this.notes
        };
        const data = dataMap[type];

        // Get date range if scope is dateRange
        let startDate = null;
        let endDate = null;
        if (scope === 'dateRange') {
            startDate = document.getElementById('reportStartDate').value;
            endDate = document.getElementById('reportEndDate').value;
        }

        let html = '<div>';
        let foundRecords = false;

        Object.keys(data).forEach(date => {
            // Filter by date range if specified
            if (startDate && endDate) {
                if (date < startDate || date > endDate) {
                    return; // Skip dates outside range
                }
            }

            const records = data[date];
            if (Object.keys(records).length > 0) {
                foundRecords = true;
                html += `<h3 style="color:#667eea;margin:15px 0;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(date).toLocaleDateString('ar-SA')}</h3>`;
                html += '<ul>';
                Object.keys(records).forEach(studentId => {
                    const student = this.students.find(s => s.id === studentId);
                    if (student) {
                        const noteText = type === 'notes' ? ` - ${records[studentId]}` : '';
                        html += `<li style="padding:8px;border-bottom:1px solid #eee;">${student.name} - ${student.grade} ${student.class}${noteText}</li>`;
                    }
                });
                html += '</ul>';
            }
        });

        if (!foundRecords) {
            html += '<p style="text-align:center;color:#999;padding:30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>';
        }

        html += '</div>';
        return html;
    }

    printReport() {
        window.print();
    }

    exportReportExcel() {
        const type = document.getElementById('reportType').value;
        
        let students = this.students;
        if (type === 'comprehensive') {
            students = students.filter(s => {
                const record = this.getStudentRecord(s.id);
                return record.absences > 0;
            });
        }

        const data = [
            ['#', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ø³Ø¬Ù„', 'Ø§Ù„ØµÙ', 'Ø§Ù„ÙØµÙ„', 'Ø§Ù„ØªØ£Ø®ÙŠØ±', 'Ø§Ù„ØºÙŠØ§Ø¨', 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª'],
            ...students.map((s, i) => {
                const record = this.getStudentRecord(s.id);
                return [i + 1, s.name, s.civilId, s.grade, s.class, record.delays, record.absences, record.notes];
            })
        ];

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
        XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_${type}_${new Date().toISOString().split('T')[0]}.xlsx`);
        this.showToast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'success');
    }

    async exportReportPDF() {
        await this.exportToPDF();
    }

    loadSettings() {
        document.getElementById('schoolName').value = localStorage.getItem('schoolName') || 'Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©';
        document.getElementById('teacherName').value = localStorage.getItem('teacherName') || 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯';
        this.updateSubscriptionUI();
    }

    saveSettings() {
        localStorage.setItem('schoolName', document.getElementById('schoolName').value);
        localStorage.setItem('teacherName', document.getElementById('teacherName').value);
        this.showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'success');
    }

    resetApp() {
        if (!confirm('Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ØŸ')) return;
        localStorage.clear();
        location.reload();
    }

    showPaymentPage() {
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById('paymentPage').style.display = 'flex';
    }

    hidePaymentPage() {
        document.getElementById('paymentPage').style.display = 'none';
        document.getElementById('lockScreen').style.display = 'flex';
    }

    selectPaymentMethod(method) {
        document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
        document.querySelectorAll('[name="paymentMethod"]').forEach(r => r.checked = false);

        if (method === 'bank') {
            document.getElementById('bankTransfer').classList.add('selected');
            document.querySelector('#bankTransfer input').checked = true;
        } else if (method === 'whatsapp') {
            document.getElementById('whatsappPay').classList.add('selected');
            document.querySelector('#whatsappPay input').checked = true;
        }
    }

    setTodayDate() {
        const today = new Date().toISOString().split('T')[0];
        ['delaysDate', 'absencesDate', 'notesDate'].forEach(id => {
            const input = document.getElementById(id);
            if (input) input.value = today;
        });
    }

    updateStats() {
        const total = this.students.length;
        document.getElementById('totalStudents').textContent = total;

        const today = new Date().toISOString().split('T')[0];
        const todayDelays = this.delays[today] || {};
        const todayAbsences = this.absences[today] || {};
        const todayNotes = this.notes[today] || {};

        const delaysCount = Object.keys(todayDelays).length;
        const absentCount = Object.keys(todayAbsences).length;
        const notesCount = Object.keys(todayNotes).length;
        const presentCount = total - absentCount;

        document.getElementById('delaysToday').textContent = delaysCount;
        document.getElementById('absentToday').textContent = absentCount;
        document.getElementById('notesToday').textContent = notesCount;
        document.getElementById('presentToday').textContent = presentCount;
    }

    updateUI() {
        this.updateStudentsList();
        this.updateStats();
        this.populateGradeClassSelects();
    }

    async saveToLocalStorage() {
        localStorage.setItem('students', JSON.stringify(this.students));
        localStorage.setItem('delays', JSON.stringify(this.delays));
        localStorage.setItem('absences', JSON.stringify(this.absences));
        localStorage.setItem('notes', JSON.stringify(this.notes));
        localStorage.setItem('grades', JSON.stringify(this.grades));
        localStorage.setItem('classes', JSON.stringify(this.classes));
        localStorage.setItem('absenceLevels', JSON.stringify(this.absenceLevels));
        
        // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        if (this.deviceId) {
            this.syncToCloud();
        }
    }

    loadFromLocalStorage() {
        const students = localStorage.getItem('students');
        const delays = localStorage.getItem('delays');
        const absences = localStorage.getItem('absences');
        const notes = localStorage.getItem('notes');
        const grades = localStorage.getItem('grades');
        const classes = localStorage.getItem('classes');
        const absenceLevels = localStorage.getItem('absenceLevels');

        if (students) this.students = JSON.parse(students);
        if (delays) this.delays = JSON.parse(delays);
        if (absences) this.absences = JSON.parse(absences);
        if (notes) this.notes = JSON.parse(notes);
        if (grades) this.grades = JSON.parse(grades);
        if (classes) this.classes = JSON.parse(classes);
        if (absenceLevels) this.absenceLevels = JSON.parse(absenceLevels);

        this.updateStudentsList();
        this.updateStats();
    }

    showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const icons = {
            success: 'âœ“',
            error: 'âœ—',
            info: 'â„¹'
        };

        toast.innerHTML = `<div class="toast-icon">${icons[type]}</div><div>${message}</div>`;
        toast.className = `toast ${type} show`;

        setTimeout(() => toast.classList.remove('show'), 3000);
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
var app = new AttendanceApp();
window.app = app;
</script>
</body>
</html>
