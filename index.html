<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>نظام الحضور الذكي </title>
    
<!-- PWA Support -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="الحضور الذكي">

<!-- App Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">    
    
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<!-- PDF Export Libraries -->
<script src="https://unpkg.com/@digicole/pdfmake-rtl/build/pdfmake.min.js"></script>
<script src="https://unpkg.com/@digicole/pdfmake-rtl/build/vfs_fonts.js"></script>
<style>
/* =================== Base & Reset =================== */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333;-webkit-font-smoothing:antialiased}
.container{max-width:600px;margin:0 auto;background:#fff;min-height:100vh;padding-bottom:70px}

/* =================== Headers =================== */
header{background:linear-gradient(135deg,#1976d2 0%,#1565c0 100%);color:white;padding:22px;text-align:center;position:sticky;top:0;z-index:100}
header.absence{background:linear-gradient(135deg,#d32f2f 0%,#c62828 100%)}
header.notes{background:linear-gradient(135deg,#00897b 0%,#00796b 100%)}
header h1{font-size:22px;font-weight:600;letter-spacing:0.3px}
header p{font-size:14px;margin-top:6px;opacity:0.95;font-weight:500}

/* =================== Content & Inputs =================== */
.content{padding:20px}
.search-input{width:100%;padding:16px;border:2px solid #e0e0e0;border-radius:12px;font-size:17px;font-family:inherit;margin:12px 0;font-weight:500}
.search-input:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 3px rgba(25,118,210,0.1)}
.date-input{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;background:white;margin:15px 0;font-family:inherit;font-weight:500}
.note-container{background:#e0f2f1;padding:18px;border-radius:12px;border:2px solid #00897b;margin:15px 0}
.note-label{font-size:15px;font-weight:700;color:#00695c;margin-bottom:10px;display:block}
.note-textarea{width:100%;min-height:120px;padding:14px;border:2px solid #80cbc4;border-radius:10px;font-size:16px;font-family:inherit;background:white;resize:vertical;font-weight:500}
.note-textarea:focus{outline:none;border-color:#00897b;box-shadow:0 0 0 3px rgba(0,137,123,0.1)}
.note-char-count{text-align:left;font-size:13px;color:#666;margin-top:6px;font-weight:600}
.filters-container{display:flex;gap:12px;margin:15px 0}
.filter-select{flex:1;padding:14px 12px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;font-family:inherit;background:white;cursor:pointer;font-weight:500;-webkit-appearance: menulist;appearance: menulist;min-height: 44px;}
.filter-select:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 3px rgba(25,118,210,0.1)}

/* =================== Components =================== */
.students-list{list-style:none;padding:0}
.student-item{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:16px;margin:12px 0;cursor:pointer;transition:all 0.3s}
.student-item:active{transform:translateY(2px)}
.student-name{font-size:18px;font-weight:600;margin-bottom:6px;letter-spacing:0.2px}
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600;margin-left:6px;color:white}
.badge.delay{background:#ff9800}
.badge.absence{background:#f44336}
.badge.note{background:#00897b}
.btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:17px;font-weight:600;cursor:pointer;margin:6px 0;color:white;font-family:inherit}
.btn-primary{background:linear-gradient(135deg,#1976d2 0%,#1565c0 100%)}
.btn-success{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%)}
.btn-warning{background:linear-gradient(135deg,#ff9800 0%,#f57c00 100%)}
.btn-danger{background:linear-gradient(135deg,#d32f2f 0%,#c62828 100%)}
.btn-notes{background:linear-gradient(135deg,#00897b 0%,#00796b 100%)}
.btn:active{transform:scale(0.98)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:white;box-shadow:0 -2px 10px rgba(0,0,0,0.1);display:flex;z-index:100}
.nav-item{flex:1;text-align:center;padding:10px 6px;cursor:pointer;border:none;background:none;color:#666;font-size:11px;font-weight:600}
.nav-item.active{color:#1976d2}
.nav-icon{font-size:22px;display:block;margin-bottom:3px}
.page{display:none}
.page.active{display:block}
.tabs{display:flex;flex-wrap: wrap;gap:10px;margin:16px 0;position:sticky;top:84px;background:white;padding:12px 0;z-index:90}
.tab{flex:1;padding:13px 16px;border:2px solid #e0e0e0;background:white;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap}
.tab.active{background:#1976d2;color:white;border-color:#1976d2}
.notes-page .tab.active{background:#00897b;border-color:#00897b}
.tab:active{transform:scale(0.97)}
.tab-content{display:none}
.tab-content.active{display:block}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000}
.modal.active{display:flex;align-items:center;justify-content:center;padding:20px}
.modal-content{background:white;border-radius:18px;padding:26px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
.toast{position:fixed;bottom:80px;left:20px;right:20px;background:#323232;color:white;padding:16px 20px;border-radius:10px;z-index:2000;display:none;font-size:15px;font-weight:500}
.toast.show{display:block}
.record-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin:16px 0}
.record-card{background:#f8f9fa;border-radius:12px;padding:15px;border:2px solid #e0e0e0}
.record-card.delays{border-color:#ff9800;background:linear-gradient(135deg,#fff3e0,#ffe0b2)}
.record-card.absences{border-color:#f44336;background:linear-gradient(135deg,#ffebee,#ffcdd2)}
.record-card.notes{border-color:#00897b;background:linear-gradient(135deg,#e0f2f1,#b2dfdb)}
.record-card h4{font-size:15px;margin-bottom:10px;color:#333;border-bottom:2px solid rgba(0,0,0,0.1);padding-bottom:8px;font-weight:600}
.record-card.delays h4{color:#e65100}
.record-card.absences h4{color:#c62828}
.record-card.notes h4{color:#00695c}
.record-list{max-height:180px;overflow-y:auto}
.record-item{background:white;padding:9px;border-radius:7px;margin:5px 0;font-size:13px}
.record-item-header{display:flex;justify-content:space-between;align-items:flex-start}
.record-type{font-weight:600;font-size:12px}
.record-card.delays .record-type{color:#e65100}
.record-card.absences .record-type{color:#c62828}
.record-card.notes .record-type{color:#00695c}
.record-date{color:#666;font-size:11px;margin-top:2px}
.record-note-text{background:#f8f9fa;padding:8px;border-radius:6px;font-size:12px;margin-top:6px;border-right:3px solid #00897b;line-height:1.4}
.delete-btn{background:#f44336;color:white;border:none;padding:5px 9px;border-radius:5px;font-size:10px;cursor:pointer;font-weight:600}
.delete-btn:active{transform:scale(0.95)}
.selected-count{background:#4caf50;color:white;padding:12px;border-radius:10px;text-align:center;margin:12px 0;font-weight:600;font-size:15px}
.selected-count.absence{background:#d32f2f}
.selected-count.notes{background:#00897b}
.action-btns{position:sticky;bottom:70px;background:white;padding:16px 20px;box-shadow:0 -2px 10px rgba(0,0,0,0.1);margin:0 -20px;display:none;gap:12px}
.action-btns.show{display:flex}
.action-btns .btn{margin:0;padding:13px;font-size:15px}
.hidden{display:none}

/* =================== Stats Page =================== */
.stats-page{background:#f5f5f5}
.stats-card{background:white;border-radius:12px;padding:20px;margin:15px 0;box-shadow:0 2px 4px rgba(0,0,0,0.08)}
.stats-card h3{font-size:18px;font-weight:600;color:#333;margin-bottom:15px;border-bottom:2px solid #e0e0e0;padding-bottom:10px}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:15px 0}
.stat-box{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:18px;border-radius:10px;text-align:center}
.stat-box.success{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%)}
.stat-box.danger{background:linear-gradient(135deg,#f44336 0%,#d32f2f 100%)}
.stat-box.warning{background:linear-gradient(135deg,#ff9800 0%,#f57c00 100%)}
.stat-box.info{background:linear-gradient(135deg,#2196f3 0%,#1976d2 100%)}
.stat-number{font-size:32px;font-weight:700;margin:8px 0}
.stat-label{font-size:13px;opacity:0.95;font-weight:500}
.level-card{border-radius:10px;padding:16px;margin:12px 0;border-right:5px solid}
.level-1{background:#e8f5e9;border-color:#4caf50}
.level-1 .level-title{color:#2e7d32}
.level-2{background:#fff9c4;border-color:#ffc107}
.level-2 .level-title{color:#f57f17}
.level-3{background:#ffe0b2;border-color:#ff9800}
.level-3 .level-title{color:#e65100}
.level-4{background:#ffebee;border-color:#f44336}
.level-4 .level-title{color:#c62828}
.level-title{font-size:16px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;word-break:break-word}
.level-card{border-radius:10px;padding:16px;margin:12px 0;border-right:5px solid;overflow:hidden}
.level-student{background:white;padding:10px 12px;border-radius:8px;margin:6px 0;font-size:14px;display:flex;justify-content:space-between;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.student-name-stat{font-weight:600;color:#333}
.student-days{color:#666;font-size:13px}
.level-empty{text-align:center;padding:20px;color:#999;font-size:14px}
.settings-input{display:flex;align-items:center;gap:10px;margin:10px 0}
.settings-input label{flex:1;font-size:14px;font-weight:500;color:#666}
.settings-input input{width:60px;padding:8px;border:2px solid #e0e0e0;border-radius:6px;text-align:center;font-size:14px;font-weight:600}
.percentage-circle{width:120px;height:120px;margin:20px auto;position:relative}
.percentage-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:28px;font-weight:700;color:#1976d2}
.settings-card{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:22px;margin:16px 0}
.settings-card h3{margin-bottom:12px;font-size:18px;font-weight:600}
.settings-card p{color:#666;font-size:15px;margin-bottom:16px;line-height:1.6}

/* =================== Subscription & Payment UI =================== */
.subscription-hero{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;text-align:center;border-radius:15px;margin:20px 0}
.app-logo{width:100px;height:100px;background:linear-gradient(135deg,#0A84FF 0%,#5AC8FA 100%);border-radius:22px;display:flex;align-items:center;justify-content:center;margin:0 auto 15px;box-shadow:0 10px 30px rgba(10,132,255,0.3),0 5px 15px rgba(10,132,255,0.2);position:relative;overflow:hidden}
.app-logo::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%)}
.app-logo-icon{font-size:50px;position:relative;z-index:1;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2))}
.subscription-price{font-size:48px;font-weight:700;margin:15px 0}
.subscription-price small{font-size:18px;opacity:0.9}
.payment-card{background:white;border-radius:15px;padding:25px;margin:20px 0;box-shadow:0 4px 15px rgba(0,0,0,0.1);border:2px solid #e0e0e0}
.payment-card h3{color:#1976d2;font-size:20px;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.bank-info{background:#f8f9fa;padding:18px;border-radius:10px;margin:15px 0;border-right:4px solid #1976d2}
.bank-info-row{display:flex;justify-content:space-between;align-items:center;margin:12px 0;padding:10px 0;border-bottom:1px solid #e0e0e0}
.bank-info-row:last-child{border-bottom:none}
.bank-label{font-weight:600;color:#666;font-size:14px}
.bank-value {font-weight: 700;color: #1976d2;font-size:15px;direction: ltr;text-align: left;word-break: break-all;overflow-wrap: break-word;max-width: 100%;}
.copy-btn{background:#4caf50;color:white;border:none;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer;margin-right:8px;font-weight:600}
.copy-btn:active{transform:scale(0.95)}
.qr-container{text-align:center;padding:20px;background:#f8f9fa;border-radius:10px;margin:15px 0}
.qr-code{width:200px;height:200px;margin:15px auto;border:3px solid #1976d2;border-radius:10px;padding:10px;background:white}
.qr-code img{width:100%;height:100%;object-fit:contain}
.activation-steps{background:#e3f2fd;padding:20px;border-radius:10px;margin:20px 0}
.activation-steps h4{color:#1976d2;margin-bottom:15px;font-size:18px}
.step-item{display:flex;align-items:flex-start;margin:15px 0}
.step-number{background:#1976d2;color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;margin-left:12px;flex-shrink:0}
.step-text{flex:1;font-size:15px;line-height:1.6;color:#333}
.developer-info{background:#f5f5f5;padding:20px;border-radius:10px;text-align:center;margin:20px 0;border:2px solid #e0e0e0}
.developer-name{font-size:18px;font-weight:600;color:#333;margin:10px 0}
.developer-role{color:#666;font-size:14px;margin-bottom:15px}
.whatsapp-link{display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg,#25d366 0%,#128c7e 100%);color:white;text-decoration:none;border-radius:10px;font-weight:600;font-size:15px;margin-top:10px}
.whatsapp-link:active{transform:scale(0.97)}

/* =================== Subscription Badge =================== */
.subscription-badge{position:fixed;top:15px;right:15px;background:white;border-radius:12px;padding:10px 15px;box-shadow:0 4px 15px rgba(0,0,0,0.1);display:flex;align-items:center;gap:10px;z-index:1000;animation:slideInRight 0.5s ease;cursor:pointer}
.badge-icon{font-size:24px;line-height:1}
.badge-text{display:flex;flex-direction:column;line-height:1.2}
.badge-days{font-size:18px;font-weight:700;color:#333}
.badge-label{font-size:11px;color:#666}
.subscription-badge.trial{border-left:4px solid #ff9800}
.subscription-badge.active{border-left:4px solid #4caf50}
.subscription-badge.warning{border-left:4px solid #f44336;animation:pulse 2s infinite}

/* =================== Lock Screen & Payment Page =================== */
#lockScreen, #paymentPage{position:fixed;top:0;left:0;width:100vw;min-height:100vh;height:auto;z-index:99999;overflow-y:auto;-webkit-overflow-scrolling:touch}
.lock-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg, rgba(26,35,126,0.95) 0%, rgba(13,71,161,0.95) 100%);backdrop-filter:blur(10px)}
.lock-container, .payment-container{position:relative;z-index:1;max-width:500px;margin:0 auto;padding:20px;min-height:100vh;display:flex;flex-direction:column;justify-content:center}
.lock-header{text-align:center;margin-bottom:30px;animation:fadeInDown 0.6s ease-out}
.lock-icon-main{font-size:70px;margin-bottom:15px;animation:bounce 2s infinite}
.lock-main-title{color:white;font-size:2rem;margin-bottom:10px;font-weight:bold}
.lock-subtitle{color:rgba(255,255,255,0.9);font-size:1.1rem;margin:0}
.subscription-card{background:white;border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:fadeInUp 0.6s ease-out 0.2s both}
.card-badge{background:linear-gradient(135deg,#FFD700,#FFA500);color:#333;display:inline-block;padding:8px 20px;border-radius:50px;font-weight:bold;font-size:0.9rem;margin-bottom:20px}
.price-section{text-align:center;margin:25px 0;padding:20px;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);border-radius:15px}
.old-price{color:#999;text-decoration:line-through;font-size:1.2rem;display:block;margin-bottom:10px}
.new-price-wrapper{display:flex;align-items:baseline;justify-content:center;gap:10px}
.new-price{font-size:4rem;font-weight:bold;color:#1976d2;line-height:1}
.currency{font-size:1.5rem;color:#1976d2}
.duration{color:#666;font-size:1rem;display:block;margin-top:5px}
.benefits-list{margin:25px 0}
.benefit-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #f0f0f0}
.benefit-item:last-child{border-bottom:none}
.benefit-icon{font-size:1.3rem;flex-shrink:0}
.benefit-text{color:#333;font-size:1rem;line-height:1.4}
.btn-subscribe-main{width:100%;padding:18px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:12px;font-size:1.2rem;font-weight:bold;cursor:pointer;box-shadow:0 10px 30px rgba(102,126,234,0.4);transition:all 0.3s;margin-top:10px}
.btn-subscribe-main:hover{transform:translateY(-2px);box-shadow:0 15px 40px rgba(102,126,234,0.5)}
.btn-subscribe-main:active{transform:translateY(0)}
.guarantee{text-align:center;color:#666;font-size:0.85rem;margin-top:15px}
.warning-box{background:rgba(255,243,205,0.95);border-radius:12px;padding:15px;display:flex;align-items:flex-start;gap:12px;margin-top:20px;animation:fadeInUp 0.6s ease-out 0.4s both}
.warning-icon{font-size:1.5rem;flex-shrink:0}
.warning-content{color:#856404;font-size:0.9rem;line-height:1.5}
.payment-container{padding-top:60px}
.btn-back{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.3);padding:10px 20px;border-radius:8px;font-size:1rem;cursor:pointer;backdrop-filter:blur(10px);transition:all 0.3s}
.btn-back:hover{background:rgba(255,255,255,0.3)}
.payment-header{text-align:center;margin-bottom:30px;color:white}
.payment-icon{font-size:60px;margin-bottom:15px}
.payment-header h2{font-size:2rem;margin-bottom:10px}
.payment-subtitle{font-size:1rem;opacity:0.9}
.payment-methods{display:flex;flex-direction:column;gap:15px;margin-bottom:30px}
.payment-method{background:white;border-radius:15px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,0.1)}
.method-header{display:flex;justify-content:space-between;align-items:center;padding:20px;cursor:pointer;transition:background 0.3s}
.method-header:hover{background:#f8f9fa}
.method-info{display:flex;align-items:center;gap:15px}
.method-icon{font-size:1.8rem}
.method-name{font-size:1.1rem;font-weight:bold;color:#333}
.method-arrow{color:#999;transition:transform 0.3s}
.method-details{padding:0 20px 20px;animation:slideDown 0.3s ease-out}
.bank-info-card{background:#f8f9fa;border-radius:12px;padding:20px;margin-bottom:20px}
.info-row{display:flex;flex-direction:column;gap:5px;margin-bottom:15px}
.info-row:last-child{margin-bottom:0}
.info-label{color:#666;font-size:0.9rem}
.info-value{color:#333;font-size:1.1rem;font-weight:bold}
.iban-container {display: flex;gap: 10px;margin-top: 10px;flex-wrap: wrap;}
.iban-input {flex: 1;padding: 12px;border: 2px solid #e0e0e0;border-radius: 8px;font-family: monospace;font-size: 0.95rem;word-break: break-all;min-width: 0;}
.qr-section{text-align:center}
.qr-section h4{margin-bottom:15px;color:#333}
.qr-placeholder{background:white;border:2px dashed #ddd;border-radius:12px;padding:40px;color:#999}
.activation-section{background:white;border-radius:15px;padding:25px;margin-bottom:20px}
.activation-section h3{margin-bottom:10px;color:#333}
.activation-hint{color:#666;font-size:0.9rem;margin-bottom:15px}
.activation-input-group{display:flex;gap:10px}
.activation-input{flex:1;padding:14px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;text-transform:uppercase}
.btn-activate{padding:14px 25px;background:#4CAF50;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;transition:background 0.3s}
.btn-activate:hover{background:#45a049}
.support-section{background:rgba(255,255,255,0.95);border-radius:15px;padding:20px;text-align:center}
.support-section h4{margin-bottom:15px;color:#333}
.support-contacts{display:flex;flex-direction:column;gap:10px}
.support-link{display:flex;align-items:center;justify-content:center;gap:10px;padding:12px;background:#f8f9fa;border-radius:8px;text-decoration:none;color:#333;transition:background 0.3s}
.support-link:hover{background:#e9ecef}

/* =================== Animations =================== */
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes fadeInDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes slideDown{from{opacity:0;max-height:0}to{opacity:1;max-height:1000px}}

/* =================== Responsive =================== */
@media (max-width: 768px){
  .subscription-badge{top:10px;right:10px;padding:8px 12px}
  .badge-icon{font-size:20px}
  .badge-days{font-size:16px}
  .badge-label{font-size:10px}
}
@media (max-width: 480px){
  .lock-main-title{font-size:1.5rem}
  .new-price{font-size:3rem}
  .subscription-card{padding:20px}
  .benefit-text{font-size:0.9rem}
  .btn-subscribe-main{font-size:1rem;padding:15px}
  .activation-input-group{flex-direction:column}
  .btn-activate{width:100%}
  .lock-container, .payment-container {padding: 15px;
    min-height: 100vh;
    justify-content: flex-start;
    padding-top: 40px;
  }
  
  .lock-subtitle {
    font-size: 0.9rem;
    padding: 0 10px;
  }
  
  .lock-icon-main {
    font-size: 50px;
  }
  
  .currency {
    font-size: 1.2rem;
  }
  
  .old-price {
    font-size: 1rem;
  }
  
  .card-badge {
    font-size: 0.8rem;
    padding: 6px 15px;
  }
  
  .payment-header h2 {
    font-size: 1.5rem;
  }
  
  .payment-icon {
    font-size: 45px;
  }
  
  .method-name {
    font-size: 0.95rem;
  }
  
  .method-icon {
    font-size: 1.5rem;
  }
  
  .bank-info-card {
    padding: 15px;
  }
  
  .info-value {
    font-size: 0.95rem;
    word-break: break-all;
  }
  
  .iban-input {
    font-size: 0.85rem;
    padding: 10px;
  }
  
  .warning-box {
    padding: 12px;
    font-size: 0.85rem;
  }
  
  .btn-back {
    padding: 8px 15px;
    font-size: 0.9rem;
  }
}

/* ثم أضف هذا القسم الجديد بعد إغلاق 480px */
@media (max-width: 375px) {
  .lock-container, .payment-container {
    padding: 10px;
    padding-top: 30px;
  }
  
  .subscription-card {
    padding: 15px;
  }
  
  .new-price {
    font-size: 2.5rem;
  }
  
  .lock-main-title {
    font-size: 1.3rem;
  }
  
  .benefit-item {
    padding: 8px 0;
  }
  
  .app-logo {
    width: 80px;
    height: 80px;
  }
  
  .app-logo-icon {
    font-size: 40px;
  }
}

.actions-menu { position: relative; }
.actions-menu > summary {
  cursor: pointer;
  padding: 12px 16px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  list-style: none;
}
.actions-menu[open] > summary { /* حالة الفتح */ }
.actions-menu > *:not(summary) { display: block; margin-top: 8px; }

      #subscriptionBadge .badge-code {
    font-size: 10px;
    color: #777;
    margin-top: 3px;
  }
    
</style>
</head>
    
<body>
<div class="container">

<!-- شاشة القفل الاحترافية -->
<div id="lockScreen" style="display:none">
  <div class="lock-overlay"></div>
  <div class="lock-container">
    <div class="lock-header">
      <div class="lock-icon-main">🔒</div>
      <h2 class="lock-main-title">انتهت الفترة التجريبية</h2>
      <p class="lock-subtitle">شكراً لتجربتك! استمتعت بـ <strong>7 أيام</strong> مجانية</p>
    </div>
    <div class="subscription-card">
      <div class="card-badge">عرض خاص 🎁</div>
      <div class="price-section">
        <span class="old-price">99 ريال</span>
        <div class="new-price-wrapper">
          <span class="currency">ريال</span>
          <span class="new-price">35</span>
        </div>
        <span class="duration">/ سنة كاملة</span>
      </div>
      <div class="benefits-list">
        <div class="benefit-item"><span class="benefit-icon">✅</span><span class="benefit-text">استرجاع جميع بياناتك المحفوظة</span></div>
        <div class="benefit-item"><span class="benefit-icon">☁️</span><span class="benefit-text">نسخ احتياطي تلقائي في السحابة</span></div>
        <div class="benefit-item"><span class="benefit-icon">🔄</span><span class="benefit-text">تحديثات مجانية مدى الحياة</span></div>
        <div class="benefit-item"><span class="benefit-icon">💬</span><span class="benefit-text">دعم فني مجاني على مدار الساعة</span></div>
      </div>
      <button class="btn-subscribe-main" onclick="app.showPaymentPage()">🚀 اشترك الآن واسترجع بياناتك</button>
      <p class="guarantee">💯 ضمان استرجاع الأموال خلال 14 يوم</p>
    </div>
    <div class="warning-box">
      <span class="warning-icon">⚠️</span>
      <div class="warning-content"><strong>تنبيه مهم:</strong> سيتم حذف بياناتك نهائياً بعد <strong>30 يوم</strong> من انتهاء الفترة التجريبية</div>
    </div>
  </div>
</div>

<!-- صفحة معلومات الدفع -->
<div id="paymentPage" style="display:none">
  <div class="lock-overlay"></div>
  <div class="payment-container">
    <button class="btn-back" onclick="app.hidePaymentPage()">← رجوع</button>
    <div class="payment-header">
      <div class="payment-icon">💳</div>
      <h2>معلومات الدفع</h2>
      <p class="payment-subtitle">اختر طريقة الدفع المناسبة</p>
    </div>
    <div class="payment-methods">
      <div class="payment-method" id="bankTransferSection">
        <div class="method-header" onclick="app.selectPaymentMethod('bank')">
          <div class="method-info"><span class="method-icon">🏦</span><span class="method-name">تحويل بنكي</span></div>
          <span class="method-arrow">▼</span>
        </div>
        <div class="method-details" id="bankDetails" style="display:none">
          <div class="bank-info-card">
            <div class="info-row"><span class="info-label">البنك:</span><span class="info-value">مصرف الراجحي</span></div>
            <div class="info-row"><span class="info-label">الاسم:</span><span class="info-value">سلطان عبدالله المالكي</span></div>
            <div class="info-row">
              <span class="info-label">رقم الآيبان:</span>
              <div class="iban-container">
                <input type="text" id="ibanNumber" value="SA4780000381608010039716" readonly class="iban-input">
                <button onclick="app.copyText('SA4780000381608010039716')" class="btn-copy">📋 نسخ</button>
              </div>
            </div>
          </div>
          <div class="qr-section">
            <h4>📱 أو امسح رمز QR</h4>
            <div class="qr-placeholder"><p>QR Code هنا</p><small>استخدم تطبيق الراجحي المباشر</small></div>
          </div>
        </div>
      </div>
      <div class="payment-method">
        <div class="method-header" onclick="app.contactWhatsApp()">
          <div class="method-info"><span class="method-icon">💚</span><span class="method-name">التواصل عبر واتساب</span></div>
          <span class="method-arrow">→</span>
        </div>
      </div>
    </div>
    <div class="activation-section">
      <h3>🔑 لديك كود تفعيل؟</h3>
      <p class="activation-hint">بعد إتمام الدفع، ستحصل على كود التفعيل</p>
      <div class="activation-input-group">
        <input type="text" id="activationCodeInput" placeholder="SK-XXXXX-XXXXX" class="activation-input">
        <button onclick="app.activateSubscription()" class="btn-activate">تفعيل</button>
      </div>
    </div>
    <div class="support-section">
      <h4>💬 بحاجة لمساعدة؟</h4>
      <div class="support-contacts">
        <a href="https://wa.me/966533371147" class="support-link" target="_blank"><span>📱</span> واتساب: 966533371147</a>
        <a href="mailto:support@attendance.app" class="support-link"><span>📧</span> البريد: support@attendance.app</a>
      </div>
    </div>
  </div>
</div>

<!-- الصفحة الرئيسية -->
<div id="mainPage" class="page active">
<header>
<h1>🎓 نظام الحضور الذكي</h1>
<p>ذكاء في التنظيم… ووضوح في المتابعة</p>
</header>
<div class="content">
<input type="text" id="searchInput" class="search-input" placeholder="ابحث عن طالب...">
<ul id="studentsList" class="students-list"></ul>
<div id="emptyState" style="text-align:center;padding:50px 20px;color:#999">
<div style="font-size:60px">🔍</div>
<div style="font-size:16px;margin-top:10px">استخدم البحث للعثور على طالب</div>
</div>
</div>
</div>

<!-- صفحة التأخرات -->
<div id="delaysPage" class="page">
<header><h1>⏰ التأخرات</h1><p>ذكاء في التنظيم… ووضوح في المتابعة</p></header>
<div class="content">
<div class="tabs">
<button class="tab active" onclick="app.switchTab('delays','morning', this)">صباحي</button>
<button class="tab" onclick="app.switchTab('delays','break', this)">فسحة</button>
<button class="tab" onclick="app.switchTab('delays','departure', this)">انصراف</button>
<button class="tab" onclick="app.switchTab('delays','view', this)">استعراض</button>

</div>
<div id="delayMorningTab" class="tab-content active">
<input type="date" id="dateMorning" class="date-input">
<input type="text" id="searchMorning" class="search-input" placeholder="ابحث عن طالب...">
<div class="filters-container"><select id="classMorning" class="filter-select"><option value="">جميع الصفوف</option></select><select id="classroomMorning" class="filter-select"><option value="">جميع الفصول</option></select></div>
<div id="countMorning" class="selected-count hidden">تم اختيار <span>0</span> طالب</div>
<ul id="listMorning" class="students-list"></ul>
</div>
<div id="delayBreakTab" class="tab-content">
<input type="date" id="dateBreak" class="date-input">
<input type="text" id="searchBreak" class="search-input" placeholder="ابحث عن طالب...">
<div class="filters-container"><select id="classBreak" class="filter-select"><option value="">جميع الصفوف</option></select><select id="classroomBreak" class="filter-select"><option value="">جميع الفصول</option></select></div>
<div id="countBreak" class="selected-count hidden">تم اختيار <span>0</span> طالب</div>
<ul id="listBreak" class="students-list"></ul>
</div>
<div id="delayDepartureTab" class="tab-content">
<input type="date" id="dateDeparture" class="date-input">
<input type="text" id="searchDeparture" class="search-input" placeholder="ابحث عن طالب...">
<div class="filters-container"><select id="classDeparture" class="filter-select"><option value="">جميع الصفوف</option></select><select id="classroomDeparture" class="filter-select"><option value="">جميع الفصول</option></select></div>
<div id="countDeparture" class="selected-count hidden">تم اختيار <span>0</span> طالب</div>
<ul id="listDeparture" class="students-list"></ul>
</div>
<div id="delayViewTab" class="tab-content">
<div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
<input type="text" id="searchDelayView" class="search-input" placeholder="ابحث بالاسم..." style="flex:1;">
<button class="btn btn-primary" onclick="app.exportAllDelays()" style="padding:12px 20px;white-space:nowrap;">📄 تصدير الكل</button>
<button class="btn btn-success" onclick="app.showDateSelector('delay')" style="padding:12px 20px;white-space:nowrap;">📅 تصدير يوم محدد</button>
<button class="btn btn-warning" onclick="app.exportSelectedStudentDelays()" style="padding:12px 20px;white-space:nowrap;">👤 تصدير طالب محدد</button>
</div>
<div id="delayViewList"></div>
</div>
<div id="delayActions" class="action-btns">
<button class="btn btn-primary" onclick="app.confirmAction('saveDelay')">💾 حفظ</button>
<button class="btn btn-success" onclick="app.confirmAction('saveAndSendDelay')">💾📤 حفظ وإرسال</button>
<button class="btn btn-warning" onclick="app.confirmAction('sendDelay')">📤 إرسال</button>
</div>
</div>
</div>

<!-- صفحة الغياب -->
<div id="absencesPage" class="page">
<header class="absence"><h1>📅 الغياب</h1><p>ذكاء في التنظيم… ووضوح في المتابعة</p></header>
<div class="content">
<div class="tabs">
<button class="tab active" onclick="app.switchTab('absence','daily', this)">غياب يومي</button>
<button class="tab" onclick="app.switchTab('absence','view', this)">استعراض</button>

</div>
<div id="absenceDailyTab" class="tab-content active">
<input type="date" id="dateAbsence" class="date-input">
<input type="text" id="searchAbsence" class="search-input" placeholder="ابحث عن طالب...">
<div class="filters-container"><select id="classAbsence" class="filter-select"><option value="">جميع الصفوف</option></select><select id="classroomAbsence" class="filter-select"><option value="">جميع الفصول</option></select></div>
<div id="countAbsence" class="selected-count absence hidden">تم اختيار <span>0</span> طالب</div>
<ul id="listAbsence" class="students-list"></ul>
</div>
<div id="absenceViewTab" class="tab-content">
<div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
<input type="text" id="searchAbsenceView" class="search-input" placeholder="ابحث بالاسم..." style="flex:1;">
<button class="btn btn-primary" onclick="app.exportAllAbsences()" style="padding:12px 20px;white-space:nowrap;">📄 تصدير الكل</button>
<button class="btn btn-success" onclick="app.showDateSelector('absence')" style="padding:12px 20px;white-space:nowrap;">📅 تصدير يوم محدد</button>
<button class="btn btn-warning" onclick="app.exportSelectedStudentAbsences()" style="padding:12px 20px;white-space:nowrap;">👤 تصدير طالب محدد</button>
</div>
<div id="absenceViewList"></div>
</div>
<div id="absenceActions" class="action-btns">
<button class="btn btn-primary" onclick="app.confirmAction('saveAbsence')">💾 حفظ</button>
<button class="btn btn-success" onclick="app.confirmAction('saveAndSendAbsence')">💾📤 حفظ وإرسال</button>
<button class="btn btn-warning" onclick="app.confirmAction('sendAbsence')">📤 إرسال</button>
</div>
</div>
</div>

<!-- صفحة الملاحظات -->
<div id="notesPage" class="page notes-page">
<header class="notes"><h1>📝 الملاحظات</h1><p>ذكاء في التنظيم… ووضوح في المتابعة</p></header>
<div class="content">
<div class="tabs">
  <button class="tab active" onclick="app.switchTab('notes','add', this)">إضافة ملاحظة</button>
  <button class="tab" onclick="app.switchTab('notes','view', this)">استعراض</button>
</div>
<div id="noteAddTab" class="tab-content active">

<div class="note-container">
<label class="note-label">📝 اكتب الملاحظة:</label>
<textarea id="noteTextarea" class="note-textarea" placeholder="مثال: تميز في الإجابة - لم يحضر الكتاب - سلوك ممتاز..." maxlength="500"></textarea>
<div class="note-char-count"><span id="noteCharCount">0</span> / 500 حرف</div>
</div>
<input type="date" id="dateNote" class="date-input">
<input type="text" id="searchNote" class="search-input" placeholder="ابحث عن طالب...">
<div class="filters-container"><select id="classNote" class="filter-select"><option value="">جميع الصفوف</option></select><select id="classroomNote" class="filter-select"><option value="">جميع الفصول</option></select></div>
<div id="countNote" class="selected-count notes hidden">تم اختيار <span>0</span> طالب</div>
<ul id="listNote" class="students-list"></ul>
</div>
<div id="noteViewTab" class="tab-content">
<div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
<input type="text" id="searchNoteView" class="search-input" placeholder="ابحث بالاسم..." style="flex:1;">
<button class="btn btn-primary" onclick="app.exportAllNotes()" style="padding:12px 20px;white-space:nowrap;">📄 تصدير الكل</button>
<button class="btn btn-success" onclick="app.showDateSelector('note')" style="padding:12px 20px;white-space:nowrap;">📅 تصدير يوم محدد</button>
<button class="btn btn-warning" onclick="app.exportSelectedStudentNotes()" style="padding:12px 20px;white-space:nowrap;">👤 تصدير طالب محدد</button>
</div>
<div id="noteViewList"></div>
</div>
<div id="noteActions" class="action-btns">
<button class="btn btn-notes" onclick="app.confirmAction('saveNote')">💾 حفظ</button>
<button class="btn btn-success" onclick="app.confirmAction('saveAndSendNote')">💾📤 حفظ وإرسال</button>
<button class="btn btn-warning" onclick="app.confirmAction('sendNote')">📤 إرسال</button>
</div>
</div>
</div>

<!-- صفحة الإحصائيات -->
<div id="statsPage" class="page stats-page">
<header style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)"><h1>📊 الإحصائيات</h1><p>ذكاء في التنظيم… ووضوح في المتابعة</p></header>
<div class="content">
<div class="stats-toolbar">
<button class="tab active" onclick="app.switchTab('stats','daily', this)">اليومية</button>
<button class="tab" onclick="app.switchTab('stats','weekly', this)">الأسبوعية</button>
<button class="tab" onclick="app.switchTab('stats','monthly', this)">الشهرية</button>
<button class="tab" onclick="app.switchTab('stats','levels', this)">مستويات الغياب</button>

<button class="btn btn-success" onclick="app.exportCurrentStats()" style="background:#4caf50;color:white;">📄 تصدير</button>
</div>
<div id="statsDailyTab" class="tab-content active">
<div class="stats-card"><h3>📅 إحصائيات اليوم - <span id="dailyDate"></span></h3>
<div class="stats-grid">
<div class="stat-box info"><div class="stat-number" id="dailyTotal">0</div><div class="stat-label">إجمالي الطلاب</div></div>
<div class="stat-box success"><div class="stat-number" id="dailyPresent">0</div><div class="stat-label">الحاضرون</div></div>
<div class="stat-box danger"><div class="stat-number" id="dailyAbsent">0</div><div class="stat-label">الغائبون</div></div>
<div class="stat-box warning"><div class="stat-number" id="dailyLate">0</div><div class="stat-label">المتأخرون</div></div>
</div>
<div style="background:#e3f2fd;padding:20px;border-radius:10px;text-align:center;margin-top:15px"><div style="font-size:14px;color:#1976d2;margin-bottom:8px;font-weight:600">نسبة الحضور</div><div style="font-size:42px;font-weight:700;color:#1976d2" id="dailyPercentage">0%</div></div>
</div>
</div>
<div id="statsWeeklyTab" class="tab-content">
<div class="stats-card"><h3>📊 إحصائيات الأسبوع</h3>
<div class="stats-grid">
<div class="stat-box info"><div class="stat-number" id="weeklyDays">7</div><div class="stat-label">أيام</div></div>
<div class="stat-box success"><div class="stat-number" id="weeklyAvgPresent">0</div><div class="stat-label">متوسط الحضور</div></div>
<div class="stat-box danger"><div class="stat-number" id="weeklyTotalAbsent">0</div><div class="stat-label">إجمالي الغياب</div></div>
<div class="stat-box warning"><div class="stat-number" id="weeklyTotalLate">0</div><div class="stat-label">إجمالي التأخرات</div></div>
</div>
</div>
</div>
<div id="statsMonthlyTab" class="tab-content">
<div class="stats-card"><h3>📅 إحصائيات الشهر</h3>
<div class="stats-grid">
<div class="stat-box info"><div class="stat-number" id="monthlyDays">30</div><div class="stat-label">أيام الدراسة</div></div>
<div class="stat-box success"><div class="stat-number" id="monthlyAvgPresent">0</div><div class="stat-label">متوسط الحضور</div></div>
<div class="stat-box danger"><div class="stat-number" id="monthlyTotalAbsent">0</div><div class="stat-label">إجمالي الغياب</div></div>
<div class="stat-box warning"><div class="stat-number" id="monthlyTotalLate">0</div><div class="stat-label">إجمالي التأخرات</div></div>
</div>
<div class="stats-card"><h3>🏆 الطلاب الأكثر غياباً</h3><div id="topAbsentList"></div></div>
</div>
</div>
<div id="statsLevelsTab" class="tab-content">
<div class="stats-card"><h3>⚙️ إعدادات المستويات</h3>
<div class="settings-input"><label>🟢 المستوى الأول: من</label><input type="number" id="level1Min" value="1" min="1"><span>إلى</span><input type="number" id="level1Max" value="5" min="1"><span>أيام</span></div>
<div class="settings-input"><label>🟡 المستوى الثاني: من</label><input type="number" id="level2Min" value="6" min="1"><span>إلى</span><input type="number" id="level2Max" value="10" min="1"><span>أيام</span></div>
<div class="settings-input"><label>🟠 المستوى الثالث: من</label><input type="number" id="level3Min" value="11" min="1"><span>إلى</span><input type="number" id="level3Max" value="15" min="1"><span>أيام</span></div>
<div class="settings-input"><label>🔴 المستوى الرابع: من</label><input type="number" id="level4Min" value="16" min="1"><span>إلى</span><input type="number" id="level4Max" value="20" min="1"><span>أيام</span></div>
<button class="btn btn-primary" onclick="app.saveLevelSettings()">💾 حفظ الإعدادات</button>
</div>
<div class="level-card level-1" id="level1Card"><div class="level-title">🟢 المستوى الأول (آمن)</div><div id="level1Students"></div></div>
<div class="level-card level-2" id="level2Card"><div class="level-title">🟡 المستوى الثاني (انتباه)</div><div id="level2Students"></div></div>
<div class="level-card level-3" id="level3Card"><div class="level-title">🟠 المستوى الثالث (تحذير)</div><div id="level3Students"></div></div>
<div class="level-card level-4" id="level4Card"><div class="level-title">🔴 المستوى الرابع (خطر!)</div><div id="level4Students"></div></div>
</div>
</div>
</div>

<!-- صفحة الإعدادات -->
<div id="settingsPage" class="page">
<header><h1>⚙️ الإعدادات</h1><p>نظام الحضور الذكي - إدارة احترافية</p></header>
<div class="content">
<div class="subscription-hero">
<div class="app-logo"><div class="app-logo-icon">👨‍🎓</div></div>
<h2 style="font-size:24px;margin:10px 0">نظام الحضور الذكي</h2>
<p style="opacity:0.95;font-size:15px">إدارة احترافية للحضور والغياب</p>
<div class="subscription-price">35 ر.س<small>/ سنوياً</small></div>
</div>
<div class="payment-card">
<h3>💳 معلومات الدفع</h3>
<div class="bank-info">
<div class="bank-info-row"><span class="bank-label">🏦 البنك:</span><span class="bank-value">مصرف الراجحي</span></div>
<div class="bank-info-row"><span class="bank-label">📋 رقم الآيبان:</span><div style="display:flex;align-items:center;gap:8px"><button class="copy-btn" onclick="app.copyText('SA4780000381608010039716')">نسخ</button><span class="bank-value" dir="ltr">SA47 8000 0381 6080 1003 9716</span></div></div>
<div class="bank-info-row"><span class="bank-label">🔢 رقم الحساب:</span><div style="display:flex;align-items:center;gap:8px"><button class="copy-btn" onclick="app.copyText('381000010006080039716')">نسخ</button><span class="bank-value" dir="ltr">381000010006080039716</span></div></div>
<div class="bank-info-row"><span class="bank-label">💰 المبلغ:</span><span class="bank-value">35 ريال سعودي</span></div>
</div>
<div class="qr-container">
<h4 style="color:#1976d2;font-size:18px;margin-bottom:10px">📱 امسح للتحويل السريع</h4>
<p style="color:#666;font-size:14px;margin-bottom:15px">استخدم تطبيق الراجحي المباشر</p>
<div class="qr-code"><img src="brkwd.jpg" alt="باركود التحويل السريع" style="width:100%;height:100%;object-fit:contain"></div>
<p style="color:#999;font-size:13px;margin-top:10px">امسح الباركود باستخدام كاميرا الجوال</p>
</div>
</div>
<div class="activation-steps">
<h4>🚀 خطوات التفعيل</h4>
<div class="step-item"><div class="step-number">1</div><div class="step-text">قم بتحويل المبلغ (35 ريال) عبر الآيبان أو الباركود أعلاه</div></div>
<div class="step-item"><div class="step-number">2</div><div class="step-text">التقط صورة لإيصال التحويل من تطبيق البنك</div></div>
<div class="step-item"><div class="step-number">3</div><div class="step-text">أرسل الإيصال عبر واتساب للدعم الفني: <strong>0533371147</strong></div></div>
<div class="step-item"><div class="step-number">4</div><div class="step-text">ستحصل على <strong>كود التفعيل</strong> خلال دقائق</div></div>
<a href="https://wa.me/966533371147?text=مرحباً، أريد تفعيل نظام الحضور الذكي" class="whatsapp-link" target="_blank" style="width:100%;margin-top:15px;justify-content:center"><span style="font-size:22px">📱</span><span>تواصل مع الدعم الفني</span></a>
</div>
<div class="settings-card" style="margin-bottom:20px;">
<h3 style="color:#1976d2;margin-bottom:15px;">🔑 تفعيل الاشتراك</h3>
<p style="color:#666;margin-bottom:15px;">أدخل كود الاشتراك لتفعيل التطبيق لمدة سنة كاملة</p>
<input type="text" id="activationCodeSettings" placeholder="أدخل كود التفعيل الذي حصلت عليه" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;margin-bottom:15px;">
<button onclick="app.activateSubscriptionFromSettings()" style="width:100%;padding:15px;background:#4caf50;color:white;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">✅ تفعيل الاشتراك الآن</button>
</div>
<div class="developer-info">
<div style="font-size:40px;margin-bottom:10px">👨‍💻</div>
<div class="developer-name">تكوين</div>
<div class="developer-role">مطور التطبيق</div>
<p style="font-size:14px;color:#666;line-height:1.6">متخصص في تطوير أنظمة إدارة التعليم<br>جودة عالية • دعم مستمر • تحديثات دورية</p>
</div>
<div class="settings-card">
<h3>📥 استيراد بيانات الطلاب</h3>
<p>قم برفع ملف Excel يحتوي على: الاسم - السجل المدني - الجوال - الصف - الفصل</p>
<input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none">
<button class="btn btn-primary" onclick="document.getElementById('excelFile').click()">📂 اختر ملف Excel</button>
</div>
<div class="settings-card">
<h3>🗑️ إعادة تعيين التطبيق</h3>
<p>سيتم حذف جميع البيانات بشكل نهائي</p>
<button class="btn btn-danger" onclick="app.confirmAction('reset')">مسح جميع البيانات</button>
</div>
<div class="settings-card">
<h3>ℹ️ معلومات التطبيق</h3>
<p style="font-size:15px;line-height:1.7"><strong>الاسم:</strong> نظام الحضور الذكي<br><strong>الإصدار:</strong> 5.0.0<br><strong>التحديث:</strong> أكتوبر 2025<br><strong>الاشتراك:</strong> 35 ريال سنوياً</p>
</div>
</div>
</div>

<!-- أيقونة حالة الاشتراك -->
<div id="subscriptionBadge" class="subscription-badge">
    <div class="badge-icon"></div>
    <div class="badge-text">
        <span class="badge-days">7</span>
        <span class="badge-label">المدة المتبقية</span>
        <span class="badge-code" dir="ltr"></span>
    </div>
</div>


<!-- Navigation Bar -->
<div class="bottom-nav">
<button class="nav-item active" onclick="app.showPage('main')"><span class="nav-icon">🏠</span>الرئيسية</button>
<button class="nav-item" onclick="app.showPage('delays')"><span class="nav-icon">⏰</span>التأخرات</button>
<button class="nav-item" onclick="app.showPage('absences')"><span class="nav-icon">📅</span>الغياب</button>
<button class="nav-item" onclick="app.showPage('notes')"><span class="nav-icon">📝</span>الملاحظات</button>
<button class="nav-item" onclick="app.showPage('stats')"><span class="nav-icon">📊</span>الإحصائيات</button>
<button class="nav-item" onclick="app.showPage('settings')"><span class="nav-icon">⚙️</span>الإعدادات</button>
</div>

<!-- Modals -->
<div id="studentModal" class="modal" onclick="if(event.target.id==='studentModal')app.closeModal()">
<div class="modal-content" onclick="event.stopPropagation()">
<h2 style="text-align:center;color:#1976d2;margin-bottom:20px;font-size:20px">بيانات الطالب</h2>
<div id="modalBody"></div>
<button class="btn btn-primary" onclick="app.closeModal()">إغلاق</button>
</div>
</div>
<div id="confirmModal" class="modal" onclick="if(event.target.id==='confirmModal')app.closeConfirm()">
<div class="modal-content" onclick="event.stopPropagation()">
<h3 id="confirmTitle" style="text-align:center;margin-bottom:12px;font-size:19px">تأكيد العملية</h3>
<p id="confirmMsg" style="text-align:center;color:#666;margin-bottom:22px;font-size:15px">هل أنت متأكد؟</p>
<div style="display:flex;gap:12px">
<button class="btn" style="flex:1;background:#f5f5f5;color:#333" onclick="app.closeConfirm()">إلغاء</button>
<button class="btn btn-primary" style="flex:1" id="confirmYes">تأكيد</button>
</div>
</div>
</div>
<div id="dateModal" class="modal" onclick="if(event.target.id==='dateModal')app.closeDateModal()">
<div class="modal-content" onclick="event.stopPropagation()">
<h3 style="text-align:center;margin-bottom:20px;color:#1976d2;font-size:20px">اختر التاريخ</h3>
<input type="date" id="exportDate" class="date-input" style="margin-bottom:20px">
<div style="display:flex;gap:12px">
<button class="btn" style="flex:1;background:#f5f5f5;color:#333" onclick="app.closeDateModal()">إلغاء</button>
<button class="btn btn-primary" style="flex:1" id="exportDateBtn">تصدير</button>
</div>
</div>
</div>

</div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBfX3dU3d7a4a5a6a7a8a9a0a1a2a3a4a5",
  authDomain: "attendance-app.firebaseapp.com",
  databaseURL: "https://attendance-app-default-rtdb.firebaseio.com",
  projectId: "attendance-app",
  storageBucket: "attendance-app.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef123456"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// App Object
const app = {
  currentPage: 'main',
  students: [],
  selectedStudents: {
    morning: [],
    break: [],
    departure: [],
    absence: [],
    note: []
  },
  subscription: {
    status: 'trial', // trial, active, expired
    daysLeft: 7,
    code: null
  },
  
  // Initialize the app
  init: function() {
    this.setupEventListeners();
    this.loadStudents();
    this.checkSubscription();
    this.setDefaultDates();
    this.loadClassFilters();
  },
  
  // Setup event listeners
  setupEventListeners: function() {
    // Search inputs
    document.getElementById('searchInput').addEventListener('input', () => this.filterStudents('main'));
    document.getElementById('searchMorning').addEventListener('input', () => this.filterStudents('delays', 'morning'));
    document.getElementById('searchBreak').addEventListener('input', () => this.filterStudents('delays', 'break'));
    document.getElementById('searchDeparture').addEventListener('input', () => this.filterStudents('delays', 'departure'));
    document.getElementById('searchAbsence').addEventListener('input', () => this.filterStudents('absence', 'daily'));
    document.getElementById('searchNote').addEventListener('input', () => this.filterStudents('notes', 'add'));
    
    // View search inputs
    document.getElementById('searchDelayView').addEventListener('input', () => this.filterRecords('delays'));
    document.getElementById('searchAbsenceView').addEventListener('input', () => this.filterRecords('absence'));
    document.getElementById('searchNoteView').addEventListener('input', () => this.filterRecords('notes'));
    
    // Date inputs
    document.getElementById('dateMorning').addEventListener('change', () => this.loadRecords('delays', 'morning'));
    document.getElementById('dateBreak').addEventListener('change', () => this.loadRecords('delays', 'break'));
    document.getElementById('dateDeparture').addEventListener('change', () => this.loadRecords('delays', 'departure'));
    document.getElementById('dateAbsence').addEventListener('change', () => this.loadRecords('absence', 'daily'));
    document.getElementById('dateNote').addEventListener('change', () => this.loadRecords('notes', 'add'));
    
    // Filter selects
    document.getElementById('classMorning').addEventListener('change', () => this.filterStudents('delays', 'morning'));
    document.getElementById('classroomMorning').addEventListener('change', () => this.filterStudents('delays', 'morning'));
    document.getElementById('classBreak').addEventListener('change', () => this.filterStudents('delays', 'break'));
    document.getElementById('classroomBreak').addEventListener('change', () => this.filterStudents('delays', 'break'));
    document.getElementById('classDeparture').addEventListener('change', () => this.filterStudents('delays', 'departure'));
    document.getElementById('classroomDeparture').addEventListener('change', () => this.filterStudents('delays', 'departure'));
    document.getElementById('classAbsence').addEventListener('change', () => this.filterStudents('absence', 'daily'));
    document.getElementById('classroomAbsence').addEventListener('change', () => this.filterStudents('absence', 'daily'));
    document.getElementById('classNote').addEventListener('change', () => this.filterStudents('notes', 'add'));
    document.getElementById('classroomNote').addEventListener('change', () => this.filterStudents('notes', 'add'));
    
    // Note textarea
    document.getElementById('noteTextarea').addEventListener('input', () => this.updateNoteCharCount());
    
    // File input
    document.getElementById('excelFile').addEventListener('change', (e) => this.importExcel(e));
  },
  
  // Set default dates to today
  setDefaultDates: function() {
    const today = this.formatDate(new Date());
    document.getElementById('dateMorning').value = today;
    document.getElementById('dateBreak').value = today;
    document.getElementById('dateDeparture').value = today;
    document.getElementById('dateAbsence').value = today;
    document.getElementById('dateNote').value = today;
    document.getElementById('dailyDate').textContent = today;
  },
  
  // Format date as YYYY-MM-DD
  formatDate: function(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  },
  
  // Load students from Firebase
  loadStudents: function() {
    database.ref('students').once('value', (snapshot) => {
      if (snapshot.exists()) {
        this.students = snapshot.val();
        this.displayStudents('main');
      } else {
        this.showToast('لا يوجد طلاب مسجلين. قم باستيراد بيانات الطلاب من صفحة الإعدادات.');
      }
    });
  },
  
  // Load class filters
  loadClassFilters: function() {
    const classes = [...new Set(this.students.map(student => student.class))].sort();
    const classrooms = [...new Set(this.students.map(student => student.classroom))].sort();
    
    // Populate class filters
    const classFilters = [
      'classMorning', 'classBreak', 'classDeparture', 
      'classAbsence', 'classNote'
    ];
    
    classFilters.forEach(id => {
      const select = document.getElementById(id);
      select.innerHTML = '<option value="">جميع الصفوف</option>';
      classes.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls;
        option.textContent = cls;
        select.appendChild(option);
      });
    });
    
    // Populate classroom filters
    const classroomFilters = [
      'classroomMorning', 'classroomBreak', 'classroomDeparture', 
      'classroomAbsence', 'classroomNote'
    ];
    
    classroomFilters.forEach(id => {
      const select = document.getElementById(id);
      select.innerHTML = '<option value="">جميع الفصول</option>';
      classrooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room;
        option.textContent = room;
        select.appendChild(option);
      });
    });
  },
  
  // Display students
  displayStudents: function(page, type = null) {
    let listId, searchId;
    
    switch(page) {
      case 'main':
        listId = 'studentsList';
        searchId = 'searchInput';
        break;
      case 'delays':
        listId = `list${type.charAt(0).toUpperCase() + type.slice(1)}`;
        searchId = `search${type.charAt(0).toUpperCase() + type.slice(1)}`;
        break;
      case 'absence':
        listId = 'listAbsence';
        searchId = 'searchAbsence';
        break;
      case 'notes':
        listId = 'listNote';
        searchId = 'searchNote';
        break;
    }
    
    const list = document.getElementById(listId);
    const searchValue = document.getElementById(searchId).value.toLowerCase();
    
    // Get filter values
    let classFilter = '', classroomFilter = '';
    if (page !== 'main') {
      classFilter = document.getElementById(`class${type.charAt(0).toUpperCase() + type.slice(1)}`).value;
      classroomFilter = document.getElementById(`classroom${type.charAt(0).toUpperCase() + type.slice(1)}`).value;
    }
    
    // Filter students
    let filteredStudents = this.students.filter(student => {
      const matchesSearch = student.name.toLowerCase().includes(searchValue) || 
                           student.id.toLowerCase().includes(searchValue);
      const matchesClass = !classFilter || student.class === classFilter;
      const matchesClassroom = !classroomFilter || student.classroom === classroomFilter;
      
      return matchesSearch && matchesClass && matchesClassroom;
    });
    
    // Clear list
    list.innerHTML = '';
    
    if (filteredStudents.length === 0) {
      list.innerHTML = '<div style="text-align:center;padding:30px;color:#999">لا يوجد طلاب مطابقين للبحث</div>';
      return;
    }
    
    // Create student items
    filteredStudents.forEach(student => {
      const item = document.createElement('li');
      item.className = 'student-item';
      item.dataset.id = student.id;
      
      // Check if student is selected
      let isSelected = false;
      if (page === 'delays' && type) {
        isSelected = this.selectedStudents[type].includes(student.id);
      } else if (page === 'absence') {
        isSelected = this.selectedStudents.absence.includes(student.id);
      } else if (page === 'notes') {
        isSelected = this.selectedStudents.note.includes(student.id);
      }
      
      if (isSelected) {
        item.style.background = '#e3f2fd';
        item.style.border = '2px solid #1976d2';
      }
      
      // Get student records for today
      const today = this.formatDate(new Date());
      const records = this.getStudentRecords(student.id, today);
      
      // Create badges
      let badges = '';
      if (records.delays.morning) badges += '<span class="badge delay">صباحي</span>';
      if (records.delays.break) badges += '<span class="badge delay">فسحة</span>';
      if (records.delays.departure) badges += '<span class="badge delay">انصراف</span>';
      if (records.absence) badges += '<span class="badge absence">غياب</span>';
      if (records.notes.length > 0) badges += '<span class="badge note">ملاحظة</span>';
      
      item.innerHTML = `
        <div class="student-name">${student.name} ${badges}</div>
        <div style="font-size:14px;color:#666;margin-top:4px">
          ${student.class} - ${student.classroom} | ${student.id}
        </div>
      `;
      
      item.addEventListener('click', () => this.toggleStudentSelection(page, type, student.id));
      list.appendChild(item);
    });
    
    // Update selected count
    if (page !== 'main') {
      this.updateSelectedCount(page, type);
    }
  },
  
  // Toggle student selection
  toggleStudentSelection: function(page, type, studentId) {
    let selectedArray;
    
    if (page === 'delays' && type) {
      selectedArray = this.selectedStudents[type];
    } else if (page === 'absence') {
      selectedArray = this.selectedStudents.absence;
    } else if (page === 'notes') {
      selectedArray = this.selectedStudents.note;
    }
    
    const index = selectedArray.indexOf(studentId);
    if (index > -1) {
      selectedArray.splice(index, 1);
    } else {
      selectedArray.push(studentId);
    }
    
    this.displayStudents(page, type);
  },
  
  // Update selected count
  updateSelectedCount: function(page, type) {
    let countId, selectedArray;
    
    if (page === 'delays' && type) {
      countId = `count${type.charAt(0).toUpperCase() + type.slice(1)}`;
      selectedArray = this.selectedStudents[type];
    } else if (page === 'absence') {
      countId = 'countAbsence';
      selectedArray = this.selectedStudents.absence;
    } else if (page === 'notes') {
      countId = 'countNote';
      selectedArray = this.selectedStudents.note;
    }
    
    const countElement = document.getElementById(countId);
    if (selectedArray.length > 0) {
      countElement.classList.remove('hidden');
      countElement.querySelector('span').textContent = selectedArray.length;
      
      // Show action buttons
      let actionsId;
      if (page === 'delays') {
        actionsId = 'delayActions';
      } else if (page === 'absence') {
        actionsId = 'absenceActions';
      } else if (page === 'notes') {
        actionsId = 'noteActions';
      }
      
      document.getElementById(actionsId).classList.add('show');
    } else {
      countElement.classList.add('hidden');
      
      // Hide action buttons
      let actionsId;
      if (page === 'delays') {
        actionsId = 'delayActions';
      } else if (page === 'absence') {
        actionsId = 'absenceActions';
      } else if (page === 'notes') {
        actionsId = 'noteActions';
      }
      
      document.getElementById(actionsId).classList.remove('show');
    }
  },
  
  // Filter students
  filterStudents: function(page, type = null) {
    this.displayStudents(page, type);
  },
  
  // Get student records for a specific date
  getStudentRecords: function(studentId, date) {
    const records = {
      delays: {
        morning: false,
        break: false,
        departure: false
      },
      absence: false,
      notes: []
    };
    
    // Get delays
    database.ref(`delays/${date}/${studentId}`).once('value', (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        records.delays.morning = data.morning || false;
        records.delays.break = data.break || false;
        records.delays.departure = data.departure || false;
      }
    });
    
    // Get absence
    database.ref(`absences/${date}/${studentId}`).once('value', (snapshot) => {
      if (snapshot.exists()) {
        records.absence = true;
      }
    });
    
    // Get notes
    database.ref(`notes/${date}/${studentId}`).once('value', (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        if (Array.isArray(data)) {
          records.notes = data;
        } else {
          records.notes = [data];
        }
      }
    });
    
    return records;
  },
  
  // Load records for view tabs
  loadRecords: function(page, type) {
    let dateId, listId;
    
    if (page === 'delays') {
      dateId = `date${type.charAt(0).toUpperCase() + type.slice(1)}`;
      listId = 'delayViewList';
    } else if (page === 'absence') {
      dateId = 'dateAbsence';
      listId = 'absenceViewList';
    } else if (page === 'notes') {
      dateId = 'dateNote';
      listId = 'noteViewList';
    }
    
    const date = document.getElementById(dateId).value;
    const list = document.getElementById(listId);
    
    // Clear list
    list.innerHTML = '<div style="text-align:center;padding:20px"><div class="spinner"></div></div>';
    
    // Get records for the selected date
    if (page === 'delays') {
      this.loadDelayRecords(date);
    } else if (page === 'absence') {
      this.loadAbsenceRecords(date);
    } else if (page === 'notes') {
      this.loadNoteRecords(date);
    }
  },
  
  // Load delay records
  loadDelayRecords: function(date) {
    const list = document.getElementById('delayViewList');
    list.innerHTML = '';
    
    database.ref(`delays/${date}`).once('value', (snapshot) => {
      if (!snapshot.exists()) {
        list.innerHTML = '<div style="text-align:center;padding:30px;color:#999">لا توجد سجلات تأخر في هذا اليوم</div>';
        return;
      }
      
      const delays = snapshot.val();
      const records = [];
      
      // Process each student's delays
      Object.keys(delays).forEach(studentId => {
        const student = this.students.find(s => s.id === studentId);
        if (!student) return;
        
        const studentDelays = delays[studentId];
        
        if (studentDelays.morning) {
          records.push({
            studentId,
            studentName: student.name,
            studentClass: student.class,
            studentClassroom: student.classroom,
            type: 'صباحي',
            date
          });
        }
        
        if (studentDelays.break) {
          records.push({
            studentId,
            studentName: student.name,
            studentClass: student.class,
            studentClassroom: student.classroom,
            type: 'فسحة',
            date
          });
        }
        
        if (studentDelays.departure) {
          records.push({
            studentId,
            studentName: student.name,
            studentClass: student.class,
            studentClassroom: student.classroom,
            type: 'انصراف',
            date
          });
        }
      });
      
      // Sort by name
      records.sort((a, b) => a.studentName.localeCompare(b.studentName));
      
      // Display records
      if (records.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:30px;color:#999">لا توجد سجلات تأخر في هذا اليوم</div>';
        return;
      }
      
      const grid = document.createElement('div');
      grid.className = 'record-grid';
      
      const morningRecords = records.filter(r => r.type === 'صباحي');
      const breakRecords = records.filter(r => r.type === 'فسحة');
      const departureRecords = records.filter(r => r.type === 'انصراف');
      
      // Morning delays card
      const morningCard = document.createElement('div');
      morningCard.className = 'record-card delays';
      morningCard.innerHTML = `
        <h4>تأخر صباحي (${morningRecords.length})</h4>
        <div class="record-list">
          ${morningRecords.map(record => `
            <div class="record-item">
              <div class="record-item-header">
                <div>
                  <div class="record-type">${record.studentName}</div>
                  <div class="record-date">${record.studentClass} - ${record.studentClassroom}</div>
                </div>
                <button class="delete-btn" onclick="app.deleteRecord('delays', '${record.date}', '${record.studentId}', 'morning')">حذف</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      // Break delays card
      const breakCard = document.createElement('div');
      breakCard.className = 'record-card delays';
      breakCard.innerHTML = `
        <h4>تأخر فسحة (${breakRecords.length})</h4>
        <div class="record-list">
          ${breakRecords.map(record => `
            <div class="record-item">
              <div class="record-item-header">
                <div>
                  <div class="record-type">${record.studentName}</div>
                  <div class="record-date">${record.studentClass} - ${record.studentClassroom}</div>
                </div>
                <button class="delete-btn" onclick="app.deleteRecord('delays', '${record.date}', '${record.studentId}', 'break')">حذف</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      // Departure delays card
      const departureCard = document.createElement('div');
      departureCard.className = 'record-card delays';
      departureCard.innerHTML = `
        <h4>تأخر انصراف (${departureRecords.length})</h4>
        <div class="record-list">
          ${departureRecords.map(record => `
            <div class="record-item">
              <div class="record-item-header">
                <div>
                  <div class="record-type">${record.studentName}</div>
                  <div class="record-date">${record.studentClass} - ${record.studentClassroom}</div>
                </div>
                <button class="delete-btn" onclick="app.deleteRecord('delays', '${record.date}', '${record.studentId}', 'departure')">حذف</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      grid.appendChild(morningCard);
      grid.appendChild(breakCard);
      grid.appendChild(departureCard);
      
      list.appendChild(grid);
    });
  },
  
  // Load absence records
  loadAbsenceRecords: function(date) {
    const list = document.getElementById('absenceViewList');
    list.innerHTML = '';
    
    database.ref(`absences/${date}`).once('value', (snapshot) => {
      if (!snapshot.exists()) {
        list.innerHTML = '<div style="text-align:center;padding:30px;color:#999">لا توجد سجلات غياب في هذا اليوم</div>';
        return;
      }
      
      const absences = snapshot.val();
      const records = [];
      
      // Process each student's absence
      Object.keys(absences).forEach(studentId => {
        const student = this.students.find(s => s.id === studentId);
        if (!student) return;
        
        records.push({
          studentId,
          studentName: student.name,
          studentClass: student.class,
          studentClassroom: student.classroom,
          date
        });
      });
      
      // Sort by name
      records.sort((a, b) => a.studentName.localeCompare(b.studentName));
      
      // Display records
      const card = document.createElement('div');
      card.className = 'record-card absences';
      card.innerHTML = `
        <h4>سجلات الغياب (${records.length})</h4>
        <div class="record-list">
          ${records.map(record => `
            <div class="record-item">
              <div class="record-item-header">
                <div>
                  <div class="record-type">${record.studentName}</div>
                  <div class="record-date">${record.studentClass} - ${record.studentClassroom}</div>
                </div>
                <button class="delete-btn" onclick="app.deleteRecord('absences', '${record.date}', '${record.studentId}')">حذف</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      list.appendChild(card);
    });
  },
  
  // Load note records
  loadNoteRecords: function(date) {
    const list = document.getElementById('noteViewList');
    list.innerHTML = '';
    
    database.ref(`notes/${date}`).once('value', (snapshot) => {
      if (!snapshot.exists()) {
        list.innerHTML = '<div style="text-align:center;padding:30px;color:#999">لا توجد ملاحظات في هذا اليوم</div>';
        return;
      }
      
      const notes = snapshot.val();
      const records = [];
      
      // Process each student's notes
      Object.keys(notes).forEach(studentId => {
        const student = this.students.find(s => s.id === studentId);
        if (!student) return;
        
        const studentNotes = notes[studentId];
        const notesArray = Array.isArray(studentNotes) ? studentNotes : [studentNotes];
        
        notesArray.forEach(note => {
          records.push({
            studentId,
            studentName: student.name,
            studentClass: student.class,
            studentClassroom: student.classroom,
            note,
            date
          });
        });
      });
      
      // Sort by name
      records.sort((a, b) => a.studentName.localeCompare(b.studentName));
      
      // Display records
      const card = document.createElement('div');
      card.className = 'record-card notes';
      card.innerHTML = `
        <h4>سجلات الملاحظات (${records.length})</h4>
        <div class="record-list">
          ${records.map(record => `
            <div class="record-item">
              <div class="record-item-header">
                <div>
                  <div class="record-type">${record.studentName}</div>
                  <div class="record-date">${record.studentClass} - ${record.studentClassroom}</div>
                </div>
                <button class="delete-btn" onclick="app.deleteRecord('notes', '${record.date}', '${record.studentId}', '${record.note}')">حذف</button>
              </div>
              <div class="record-note-text">${record.note}</div>
            </div>
          `).join('')}
        </div>
      `;
      
      list.appendChild(card);
    });
  },
  
  // Filter records in view tabs
  filterRecords: function(page) {
    let searchId, listId;
    
    if (page === 'delays') {
      searchId = 'searchDelayView';
      listId = 'delayViewList';
    } else if (page === 'absence') {
      searchId = 'searchAbsenceView';
      listId = 'absenceViewList';
    } else if (page === 'notes') {
      searchId = 'searchNoteView';
      listId = 'noteViewList';
    }
    
    const searchValue = document.getElementById(searchId).value.toLowerCase();
    const list = document.getElementById(listId);
    
    // Get all record items
    const recordItems = list.querySelectorAll('.record-item');
    
    recordItems.forEach(item => {
      const studentName = item.querySelector('.record-type').textContent.toLowerCase();
      if (studentName.includes(searchValue)) {
        item.style.display = 'block';
      } else {
        item.style.display = 'none';
      }
    });
  },
  
  // Delete record
  deleteRecord: function(type, date, studentId, subType = null) {
    this.showConfirm(
      'حذف السجل',
      'هل أنت متأكد من حذف هذا السجل؟',
      () => {
        if (type === 'delays') {
          database.ref(`delays/${date}/${studentId}/${subType}`).remove()
            .then(() => {
              this.showToast('تم حذف السجل بنجاح');
              this.loadRecords(type, subType);
            })
            .catch(error => {
              this.showToast('حدث خطأ أثناء حذف السجل');
              console.error(error);
            });
        } else if (type === 'absences') {
          database.ref(`absences/${date}/${studentId}`).remove()
            .then(() => {
              this.showToast('تم حذف السجل بنجاح');
              this.loadRecords(type, 'daily');
            })
            .catch(error => {
              this.showToast('حدث خطأ أثناء حذف السجل');
              console.error(error);
            });
        } else if (type === 'notes') {
          database.ref(`notes/${date}/${studentId}`).once('value', (snapshot) => {
            if (snapshot.exists()) {
              const notes = snapshot.val();
              const notesArray = Array.isArray(notes) ? notes : [notes];
              
              // Find and remove the specific note
              const index = notesArray.findIndex(note => note === subType);
              if (index > -1) {
                notesArray.splice(index, 1);
                
                // Update the notes array
                database.ref(`notes/${date}/${studentId}`).set(notesArray.length > 0 ? notesArray : null)
                  .then(() => {
                    this.showToast('تم حذف السجل بنجاح');
                    this.loadRecords(type, 'add');
                  })
                  .catch(error => {
                    this.showToast('حدث خطأ أثناء حذف السجل');
                    console.error(error);
                  });
              }
            }
          });
        }
      }
    );
  },
  
  // Confirm action
  confirmAction: function(action) {
    let title, message, callback;
    
    switch(action) {
      case 'saveDelay':
        title = 'حفظ التأخرات';
        message = 'هل أنت متأكد من حفظ التأخرات المحددة؟';
        callback = () => this.saveDelays(false);
        break;
      case 'saveAndSendDelay':
        title = 'حفظ وإرسال التأخرات';
        message = 'هل أنت متأكد من حفظ وإرسال التأخرات المحددة؟';
        callback = () => this.saveDelays(true);
        break;
      case 'sendDelay':
        title = 'إرسال التأخرات';
        message = 'هل أنت متأكد من إرسال التأخرات المحددة؟';
        callback = () => this.sendDelays();
        break;
      case 'saveAbsence':
        title = 'حفظ الغياب';
        message = 'هل أنت متأكد من حفظ الغياب المحدد؟';
        callback = () => this.saveAbsences(false);
        break;
      case 'saveAndSendAbsence':
        title = 'حفظ وإرسال الغياب';
        message = 'هل أنت متأكد من حفظ وإرسال الغياب المحدد؟';
        callback = () => this.saveAbsences(true);
        break;
      case 'sendAbsence':
        title = 'إرسال الغياب';
        message = 'هل أنت متأكد من إرسال الغياب المحدد؟';
        callback = () => this.sendAbsences();
        break;
      case 'saveNote':
        title = 'حفظ الملاحظات';
        message = 'هل أنت متأكد من حفظ الملاحظات المحددة؟';
        callback = () => this.saveNotes(false);
        break;
      case 'saveAndSendNote':
        title = 'حفظ وإرسال الملاحظات';
        message = 'هل أنت متأكد من حفظ وإرسال الملاحظات المحددة؟';
        callback = () => this.saveNotes(true);
        break;
      case 'sendNote':
        title = 'إرسال الملاحظات';
        message = 'هل أنت متأكد من إرسال الملاحظات المحددة؟';
        callback = () => this.sendNotes();
        break;
      case 'reset':
        title = 'إعادة تعيين التطبيق';
        message = 'هل أنت متأكد من حذف جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.';
        callback = () => this.resetApp();
        break;
    }
    
    this.showConfirm(title, message, callback);
  },
  
  // Save delays
  saveDelays: function(send = false) {
    // Get active tab
    const activeTab = document.querySelector('#delaysPage .tab.active');
    const type = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
    
    // Get date
    const dateId = `date${type.charAt(0).toUpperCase() + type.slice(1)}`;
    const date = document.getElementById(dateId).value;
    
    // Get selected students
    const selectedStudents = this.selectedStudents[type];
    
    if (selectedStudents.length === 0) {
      this.showToast('لم يتم تحديد أي طلاب');
      return;
    }
    
    // Save delays to Firebase
    const updates = {};
    selectedStudents.forEach(studentId => {
      updates[`delays/${date}/${studentId}/${type}`] = true;
    });
    
    database.ref().update(updates)
      .then(() => {
        this.showToast('تم حفظ التأخرات بنجاح');
        
        // Clear selection
        this.selectedStudents[type] = [];
        this.displayStudents('delays', type);
        
        // Load records
        this.loadRecords('delays', type);
        
        // Send if requested
        if (send) {
          this.sendDelays();
        }
      })
      .catch(error => {
        this.showToast('حدث خطأ أثناء حفظ التأخرات');
        console.error(error);
      });
  },
  
  // Send delays
  sendDelays: function() {
    // Get active tab
    const activeTab = document.querySelector('#delaysPage .tab.active');
    const type = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
    
    // Get date
    const dateId = `date${type.charAt(0).toUpperCase() + type.slice(1)}`;
    const date = document.getElementById(dateId).value;
    
    // Get selected students
    const selectedStudents = this.selectedStudents[type];
    
    if (selectedStudents.length === 0) {
      this.showToast('لم يتم تحديد أي طلاب');
      return;
    }
    
    // Create Excel file
    const data = [];
    const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'نوع التأخر', 'التاريخ'];
    data.push(headers);
    
    selectedStudents.forEach(studentId => {
      const student = this.students.find(s => s.id === studentId);
      if (!student) return;
      
      let typeText = '';
      if (type === 'morning') typeText = 'صباحي';
      else if (type === 'break') typeText = 'فسحة';
      else if (type === 'departure') typeText = 'انصراف';
      
      data.push([
        student.name,
        student.id,
        student.phone || '',
        student.class,
        student.classroom,
        typeText,
        date
      ]);
    });
    
    // Generate and download Excel file
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'التأخرات');
    
    const fileName = `التأخرات_${type}_${date}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    this.showToast('تم إرسال التأخرات بنجاح');
  },
  
  // Save absences
  saveAbsences: function(send = false) {
    // Get date
    const date = document.getElementById('dateAbsence').value;
    
    // Get selected students
    const selectedStudents = this.selectedStudents.absence;
    
    if (selectedStudents.length === 0) {
      this.showToast('لم يتم تحديد أي طلاب');
      return;
    }
    
    // Save absences to Firebase
    const updates = {};
    selectedStudents.forEach(studentId => {
      updates[`absences/${date}/${studentId}`] = true;
    });
    
    database.ref().update(updates)
      .then(() => {
        this.showToast('تم حفظ الغياب بنجاح');
        
        // Clear selection
        this.selectedStudents.absence = [];
        this.displayStudents('absence', 'daily');
        
        // Load records
        this.loadRecords('absence', 'daily');
        
        // Send if requested
        if (send) {
          this.sendAbsences();
        }
      })
      .catch(error => {
        this.showToast('حدث خطأ أثناء حفظ الغياب');
        console.error(error);
      });
  },
  
  // Send absences
  sendAbsences: function() {
    // Get date
    const date = document.getElementById('dateAbsence').value;
    
    // Get selected students
    const selectedStudents = this.selectedStudents.absence;
    
    if (selectedStudents.length === 0) {
      this.showToast('لم يتم تحديد أي طلاب');
      return;
    }
    
    // Create Excel file
    const data = [];
    const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'التاريخ'];
    data.push(headers);
    
    selectedStudents.forEach(studentId => {
      const student = this.students.find(s => s.id === studentId);
      if (!student) return;
      
      data.push([
        student.name,
        student.id,
        student.phone || '',
        student.class,
        student.classroom,
        date
      ]);
    });
    
    // Generate and download Excel file
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'الغياب');
    
    const fileName = `الغياب_${date}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    this.showToast('تم إرسال الغياب بنجاح');
  },
  
  // Save notes
  saveNotes: function(send = false) {
    // Get date and note text
    const date = document.getElementById('dateNote').value;
    const noteText = document.getElementById('noteTextarea').value.trim();
    
    if (!noteText) {
      this.showToast('الرجاء كتابة ملاحظة');
      return;
    }
    
    // Get selected students
    const selectedStudents = this.selectedStudents.note;
    
    if (selectedStudents.length === 0) {
      this.showToast('لم يتم تحديد أي طلاب');
      return;
    }
    
    // Save notes to Firebase
    const updates = {};
    selectedStudents.forEach(studentId => {
      // Get existing notes
      database.ref(`notes/${date}/${studentId}`).once('value', (snapshot) => {
        let notes = [];
        
        if (snapshot.exists()) {
          const existingNotes = snapshot.val();
          notes = Array.isArray(existingNotes) ? existingNotes : [existingNotes];
        }
        
        // Add new note
        notes.push(noteText);
        
        // Update notes
        database.ref(`notes/${date}/${studentId}`).set(notes);
      });
    });
    
    this.showToast('تم حفظ الملاحظات بنجاح');
    
    // Clear selection and note text
    this.selectedStudents.note = [];
    document.getElementById('noteTextarea').value = '';
    this.updateNoteCharCount();
    this.displayStudents('notes', 'add');
    
    // Load records
    this.loadRecords('notes', 'add');
    
    // Send if requested
    if (send) {
      this.sendNotes();
    }
  },
  
  // Send notes
  sendNotes: function() {
    // Get date and note text
    const date = document.getElementById('dateNote').value;
    const noteText = document.getElementById('noteTextarea').value.trim();
    
    if (!noteText) {
      this.showToast('الرجاء كتابة ملاحظة');
      return;
    }
    
    // Get selected students
    const selectedStudents = this.selectedStudents.note;
    
    if (selectedStudents.length === 0) {
      this.showToast('لم يتم تحديد أي طلاب');
      return;
    }
    
    // Create Excel file
    const data = [];
    const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'الملاحظة', 'التاريخ'];
    data.push(headers);
    
    selectedStudents.forEach(studentId => {
      const student = this.students.find(s => s.id === studentId);
      if (!student) return;
      
      data.push([
        student.name,
        student.id,
        student.phone || '',
        student.class,
        student.classroom,
        noteText,
        date
      ]);
    });
    
    // Generate and download Excel file
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'الملاحظات');
    
    const fileName = `الملاحظات_${date}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    this.showToast('تم إرسال الملاحظات بنجاح');
  },
  
  // Update note character count
  updateNoteCharCount: function() {
    const textarea = document.getElementById('noteTextarea');
    const countElement = document.getElementById('noteCharCount');
    countElement.textContent = textarea.value.length;
  },
  
  // Show date selector for export
  showDateSelector: function(type) {
    document.getElementById('dateModal').classList.add('active');
    
    // Set export button action
    document.getElementById('exportDateBtn').onclick = () => {
      const date = document.getElementById('exportDate').value;
      
      if (!date) {
        this.showToast('الرجاء اختيار تاريخ');
        return;
      }
      
      if (type === 'delay') {
        this.exportDelaysByDate(date);
      } else if (type === 'absence') {
        this.exportAbsencesByDate(date);
      } else if (type === 'note') {
        this.exportNotesByDate(date);
      }
      
      this.closeDateModal();
    };
  },
  
  // Export delays by date
  exportDelaysByDate: function(date) {
    database.ref(`delays/${date}`).once('value', (snapshot) => {
      if (!snapshot.exists()) {
        this.showToast('لا توجد سجلات تأخر في هذا اليوم');
        return;
      }
      
      const delays = snapshot.val();
      const data = [];
      const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'نوع التأخر', 'التاريخ'];
      data.push(headers);
      
      // Process each student's delays
      Object.keys(delays).forEach(studentId => {
        const student = this.students.find(s => s.id === studentId);
        if (!student) return;
        
        const studentDelays = delays[studentId];
        
        if (studentDelays.morning) {
          data.push([
            student.name,
            student.id,
            student.phone || '',
            student.class,
            student.classroom,
            'صباحي',
            date
          ]);
        }
        
        if (studentDelays.break) {
          data.push([
            student.name,
            student.id,
            student.phone || '',
            student.class,
            student.classroom,
            'فسحة',
            date
          ]);
        }
        
        if (studentDelays.departure) {
          data.push([
            student.name,
            student.id,
            student.phone || '',
            student.class,
            student.classroom,
            'انصراف',
            date
          ]);
        }
      });
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'التأخرات');
      
      const fileName = `التأخرات_${date}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير التأخرات بنجاح');
    });
  },
  
  // Export absences by date
  exportAbsencesByDate: function(date) {
    database.ref(`absences/${date}`).once('value', (snapshot) => {
      if (!snapshot.exists()) {
        this.showToast('لا توجد سجلات غياب في هذا اليوم');
        return;
      }
      
      const absences = snapshot.val();
      const data = [];
      const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'التاريخ'];
      data.push(headers);
      
      // Process each student's absence
      Object.keys(absences).forEach(studentId => {
        const student = this.students.find(s => s.id === studentId);
        if (!student) return;
        
        data.push([
          student.name,
          student.id,
          student.phone || '',
          student.class,
          student.classroom,
          date
        ]);
      });
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'الغياب');
      
      const fileName = `الغياب_${date}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير الغياب بنجاح');
    });
  },
  
  // Export notes by date
  exportNotesByDate: function(date) {
    database.ref(`notes/${date}`).once('value', (snapshot) => {
      if (!snapshot.exists()) {
        this.showToast('لا توجد ملاحظات في هذا اليوم');
        return;
      }
      
      const notes = snapshot.val();
      const data = [];
      const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'الملاحظة', 'التاريخ'];
      data.push(headers);
      
      // Process each student's notes
      Object.keys(notes).forEach(studentId => {
        const student = this.students.find(s => s.id === studentId);
        if (!student) return;
        
        const studentNotes = notes[studentId];
        const notesArray = Array.isArray(studentNotes) ? studentNotes : [studentNotes];
        
        notesArray.forEach(note => {
          data.push([
            student.name,
            student.id,
            student.phone || '',
            student.class,
            student.classroom,
            note,
            date
          ]);
        });
      });
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'الملاحظات');
      
      const fileName = `الملاحظات_${date}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير الملاحظات بنجاح');
    });
  },
  
  // Export all delays
  exportAllDelays: function() {
    database.ref('delays').once('value', (snapshot) => {
      if (!snapshot.exists()) {
        this.showToast('لا توجد سجلات تأخر');
        return;
      }
      
      const allDelays = snapshot.val();
      const data = [];
      const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'نوع التأخر', 'التاريخ'];
      data.push(headers);
      
      // Process each date's delays
      Object.keys(allDelays).forEach(date => {
        const delays = allDelays[date];
        
        // Process each student's delays
        Object.keys(delays).forEach(studentId => {
          const student = this.students.find(s => s.id === studentId);
          if (!student) return;
          
          const studentDelays = delays[studentId];
          
          if (studentDelays.morning) {
            data.push([
              student.name,
              student.id,
              student.phone || '',
              student.class,
              student.classroom,
              'صباحي',
              date
            ]);
          }
          
          if (studentDelays.break) {
            data.push([
              student.name,
              student.id,
              student.phone || '',
              student.class,
              student.classroom,
              'فسحة',
              date
            ]);
          }
          
          if (studentDelays.departure) {
            data.push([
              student.name,
              student.id,
              student.phone || '',
              student.class,
              student.classroom,
              'انصراف',
              date
            ]);
          }
        });
      });
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'التأخرات');
      
      const fileName = `التأخرات_${this.formatDate(new Date())}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير التأخرات بنجاح');
    });
  },
  
  // Export all absences
  exportAllAbsences: function() {
    database.ref('absences').once('value', (snapshot) => {
      if (!snapshot.exists()) {
        this.showToast('لا توجد سجلات غياب');
        return;
      }
      
      const allAbsences = snapshot.val();
      const data = [];
      const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'التاريخ'];
      data.push(headers);
      
      // Process each date's absences
      Object.keys(allAbsences).forEach(date => {
        const absences = allAbsences[date];
        
        // Process each student's absence
        Object.keys(absences).forEach(studentId => {
          const student = this.students.find(s => s.id === studentId);
          if (!student) return;
          
          data.push([
            student.name,
            student.id,
            student.phone || '',
            student.class,
            student.classroom,
            date
          ]);
        });
      });
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'الغياب');
      
      const fileName = `الغياب_${this.formatDate(new Date())}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير الغياب بنجاح');
    });
  },
  
  // Export all notes
  exportAllNotes: function() {
    database.ref('notes').once('value', (snapshot) => {
      if (!snapshot.exists()) {
        this.showToast('لا توجد ملاحظات');
        return;
      }
      
      const allNotes = snapshot.val();
      const data = [];
      const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'الملاحظة', 'التاريخ'];
      data.push(headers);
      
      // Process each date's notes
      Object.keys(allNotes).forEach(date => {
        const notes = allNotes[date];
        
        // Process each student's notes
        Object.keys(notes).forEach(studentId => {
          const student = this.students.find(s => s.id === studentId);
          if (!student) return;
          
          const studentNotes = notes[studentId];
          const notesArray = Array.isArray(studentNotes) ? studentNotes : [studentNotes];
          
          notesArray.forEach(note => {
            data.push([
              student.name,
              student.id,
              student.phone || '',
              student.class,
              student.classroom,
              note,
              date
            ]);
          });
        });
      });
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'الملاحظات');
      
      const fileName = `الملاحظات_${this.formatDate(new Date())}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير الملاحظات بنجاح');
    });
  },
  
  // Export selected student delays
  exportSelectedStudentDelays: function() {
    // Show student selector modal
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = `
      <div style="margin-bottom:20px">
        <input type="text" id="studentSearch" class="search-input" placeholder="ابحث عن طالب...">
      </div>
      <div id="studentSelector" style="max-height:300px;overflow-y:auto"></div>
    `;
    
    // Display students
    const studentSelector = document.getElementById('studentSelector');
    this.students.forEach(student => {
      const item = document.createElement('div');
      item.className = 'student-item';
      item.style.cursor = 'pointer';
      item.innerHTML = `
        <div class="student-name">${student.name}</div>
        <div style="font-size:14px;color:#666;margin-top:4px">
          ${student.class} - ${student.classroom} | ${student.id}
        </div>
      `;
      
      item.addEventListener('click', () => {
        this.exportStudentDelays(student.id);
        this.closeModal();
      });
      
      studentSelector.appendChild(item);
    });
    
    // Setup search
    document.getElementById('studentSearch').addEventListener('input', (e) => {
      const searchValue = e.target.value.toLowerCase();
      
      Array.from(studentSelector.children).forEach(item => {
        const studentName = item.querySelector('.student-name').textContent.toLowerCase();
        if (studentName.includes(searchValue)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    });
    
    // Show modal
    document.getElementById('studentModal').classList.add('active');
  },
  
  // Export student delays
  exportStudentDelays: function(studentId) {
    const student = this.students.find(s => s.id === studentId);
    if (!student) return;
    
    database.ref('delays').once('value', (snapshot) => {
      if (!snapshot.exists()) {
        this.showToast('لا توجد سجلات تأخر');
        return;
      }
      
      const allDelays = snapshot.val();
      const data = [];
      const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'نوع التأخر', 'التاريخ'];
      data.push(headers);
      
      // Process each date's delays
      Object.keys(allDelays).forEach(date => {
        const delays = allDelays[date];
        
        // Check if student has delays on this date
        if (delays[studentId]) {
          const studentDelays = delays[studentId];
          
          if (studentDelays.morning) {
            data.push([
              student.name,
              student.id,
              student.phone || '',
              student.class,
              student.classroom,
              'صباحي',
              date
            ]);
          }
          
          if (studentDelays.break) {
            data.push([
              student.name,
              student.id,
              student.phone || '',
              student.class,
              student.classroom,
              'فسحة',
              date
            ]);
          }
          
          if (studentDelays.departure) {
            data.push([
              student.name,
              student.id,
              student.phone || '',
              student.class,
              student.classroom,
              'انصراف',
              date
            ]);
          }
        }
      });
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'التأخرات');
      
      const fileName = `التأخرات_${student.name}_${this.formatDate(new Date())}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير التأخرات بنجاح');
    });
  },
  
  // Export selected student absences
  exportSelectedStudentAbsences: function() {
    // Show student selector modal
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = `
      <div style="margin-bottom:20px">
        <input type="text" id="studentSearch" class="search-input" placeholder="ابحث عن طالب...">
      </div>
      <div id="studentSelector" style="max-height:300px;overflow-y:auto"></div>
    `;
    
    // Display students
    const studentSelector = document.getElementById('studentSelector');
    this.students.forEach(student => {
      const item = document.createElement('div');
      item.className = 'student-item';
      item.style.cursor = 'pointer';
      item.innerHTML = `
        <div class="student-name">${student.name}</div>
        <div style="font-size:14px;color:#666;margin-top:4px">
          ${student.class} - ${student.classroom} | ${student.id}
        </div>
      `;
      
      item.addEventListener('click', () => {
        this.exportStudentAbsences(student.id);
        this.closeModal();
      });
      
      studentSelector.appendChild(item);
    });
    
    // Setup search
    document.getElementById('studentSearch').addEventListener('input', (e) => {
      const searchValue = e.target.value.toLowerCase();
      
      Array.from(studentSelector.children).forEach(item => {
        const studentName = item.querySelector('.student-name').textContent.toLowerCase();
        if (studentName.includes(searchValue)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    });
    
    // Show modal
    document.getElementById('studentModal').classList.add('active');
  },
  
  // Export student absences
  exportStudentAbsences: function(studentId) {
    const student = this.students.find(s => s.id === studentId);
    if (!student) return;
    
    database.ref('absences').once('value', (snapshot) => {
      if (!snapshot.exists()) {
        this.showToast('لا توجد سجلات غياب');
        return;
      }
      
      const allAbsences = snapshot.val();
      const data = [];
      const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'التاريخ'];
      data.push(headers);
      
      // Process each date's absences
      Object.keys(allAbsences).forEach(date => {
        const absences = allAbsences[date];
        
        // Check if student has absence on this date
        if (absences[studentId]) {
          data.push([
            student.name,
            student.id,
            student.phone || '',
            student.class,
            student.classroom,
            date
          ]);
        }
      });
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'الغياب');
      
      const fileName = `الغياب_${student.name}_${this.formatDate(new Date())}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير الغياب بنجاح');
    });
  },
  
  // Export selected student notes
  exportSelectedStudentNotes: function() {
    // Show student selector modal
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = `
      <div style="margin-bottom:20px">
        <input type="text" id="studentSearch" class="search-input" placeholder="ابحث عن طالب...">
      </div>
      <div id="studentSelector" style="max-height:300px;overflow-y:auto"></div>
    `;
    
    // Display students
    const studentSelector = document.getElementById('studentSelector');
    this.students.forEach(student => {
      const item = document.createElement('div');
      item.className = 'student-item';
      item.style.cursor = 'pointer';
      item.innerHTML = `
        <div class="student-name">${student.name}</div>
        <div style="font-size:14px;color:#666;margin-top:4px">
          ${student.class} - ${student.classroom} | ${student.id}
        </div>
      `;
      
      item.addEventListener('click', () => {
        this.exportStudentNotes(student.id);
        this.closeModal();
      });
      
      studentSelector.appendChild(item);
    });
    
    // Setup search
    document.getElementById('studentSearch').addEventListener('input', (e) => {
      const searchValue = e.target.value.toLowerCase();
      
      Array.from(studentSelector.children).forEach(item => {
        const studentName = item.querySelector('.student-name').textContent.toLowerCase();
        if (studentName.includes(searchValue)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    });
    
    // Show modal
    document.getElementById('studentModal').classList.add('active');
  },
  
  // Export student notes
  exportStudentNotes: function(studentId) {
    const student = this.students.find(s => s.id === studentId);
    if (!student) return;
    
    database.ref('notes').once('value', (snapshot) => {
      if (!snapshot.exists()) {
        this.showToast('لا توجد ملاحظات');
        return;
      }
      
      const allNotes = snapshot.val();
      const data = [];
      const headers = ['الاسم', 'السجل المدني', 'الجوال', 'الصف', 'الفصل', 'الملاحظة', 'التاريخ'];
      data.push(headers);
      
      // Process each date's notes
      Object.keys(allNotes).forEach(date => {
        const notes = allNotes[date];
        
        // Check if student has notes on this date
        if (notes[studentId]) {
          const studentNotes = notes[studentId];
          const notesArray = Array.isArray(studentNotes) ? studentNotes : [studentNotes];
          
          notesArray.forEach(note => {
            data.push([
              student.name,
              student.id,
              student.phone || '',
              student.class,
              student.classroom,
              note,
              date
            ]);
          });
        }
      });
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'الملاحظات');
      
      const fileName = `الملاحظات_${student.name}_${this.formatDate(new Date())}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير الملاحظات بنجاح');
    });
  },
  
  // Load statistics
  loadStats: function(type) {
    if (type === 'daily') {
      this.loadDailyStats();
    } else if (type === 'weekly') {
      this.loadWeeklyStats();
    } else if (type === 'monthly') {
      this.loadMonthlyStats();
    } else if (type === 'levels') {
      this.loadLevelsStats();
    }
  },
  
  // Load daily statistics
  loadDailyStats: function() {
    const today = this.formatDate(new Date());
    document.getElementById('dailyDate').textContent = today;
    
    // Get total students
    const totalStudents = this.students.length;
    document.getElementById('dailyTotal').textContent = totalStudents;
    
    // Get today's records
    Promise.all([
      database.ref(`delays/${today}`).once('value'),
      database.ref(`absences/${today}`).once('value')
    ]).then(([delaysSnapshot, absencesSnapshot]) => {
      let presentCount = totalStudents;
      let delayCount = 0;
      let absenceCount = 0;
      
      // Process delays
      if (delaysSnapshot.exists()) {
        const delays = delaysSnapshot.val();
        const delayedStudents = new Set();
        
        Object.keys(delays).forEach(studentId => {
          const studentDelays = delays[studentId];
          
          if (studentDelays.morning || studentDelays.break || studentDelays.departure) {
            delayedStudents.add(studentId);
          }
        });
        
        delayCount = delayedStudents.size;
      }
      
      // Process absences
      if (absencesSnapshot.exists()) {
        const absences = absencesSnapshot.val();
        absenceCount = Object.keys(absences).length;
      }
      
      // Calculate present count
      presentCount = totalStudents - absenceCount;
      
      // Update UI
      document.getElementById('dailyPresent').textContent = presentCount;
      document.getElementById('dailyAbsent').textContent = absenceCount;
      document.getElementById('dailyLate').textContent = delayCount;
      
      // Calculate percentage
      const percentage = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;
      document.getElementById('dailyPercentage').textContent = `${percentage}%`;
    });
  },
  
  // Load weekly statistics
  loadWeeklyStats: function() {
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(today.getDate() - 7);
    
    const dates = [];
    for (let d = new Date(weekAgo); d <= today; d.setDate(d.getDate() + 1)) {
      dates.push(this.formatDate(new Date(d)));
    }
    
    let totalPresent = 0;
    let totalAbsent = 0;
    let totalLate = 0;
    
    // Get records for each day
    Promise.all(dates.map(date => 
      Promise.all([
        database.ref(`delays/${date}`).once('value'),
        database.ref(`absences/${date}`).once('value')
      ])
    )).then(results => {
      results.forEach(([delaysSnapshot, absencesSnapshot], index) => {
        const date = dates[index];
        
        // Process delays
        if (delaysSnapshot.exists()) {
          const delays = delaysSnapshot.val();
          const delayedStudents = new Set();
          
          Object.keys(delays).forEach(studentId => {
            const studentDelays = delays[studentId];
            
            if (studentDelays.morning || studentDelays.break || studentDelays.departure) {
              delayedStudents.add(studentId);
            }
          });
          
          totalLate += delayedStudents.size;
        }
        
        // Process absences
        if (absencesSnapshot.exists()) {
          const absences = absencesSnapshot.val();
          totalAbsent += Object.keys(absences).length;
        }
      });
      
      // Calculate present count
      totalPresent = (this.students.length * dates.length) - totalAbsent;
      
      // Calculate averages
      const avgPresent = Math.round(totalPresent / dates.length);
      
      // Update UI
      document.getElementById('weeklyAvgPresent').textContent = avgPresent;
      document.getElementById('weeklyTotalAbsent').textContent = totalAbsent;
      document.getElementById('weeklyTotalLate').textContent = totalLate;
    });
  },
  
  // Load monthly statistics
  loadMonthlyStats: function() {
    const today = new Date();
    const monthAgo = new Date(today);
    monthAgo.setDate(today.getDate() - 30);
    
    const dates = [];
    for (let d = new Date(monthAgo); d <= today; d.setDate(d.getDate() + 1)) {
      dates.push(this.formatDate(new Date(d)));
    }
    
    let totalPresent = 0;
    let totalAbsent = 0;
    let totalLate = 0;
    const studentAbsences = {};
    
    // Initialize student absences
    this.students.forEach(student => {
      studentAbsences[student.id] = 0;
    });
    
    // Get records for each day
    Promise.all(dates.map(date => 
      Promise.all([
        database.ref(`delays/${date}`).once('value'),
        database.ref(`absences/${date}`).once('value')
      ])
    )).then(results => {
      results.forEach(([delaysSnapshot, absencesSnapshot], index) => {
        const date = dates[index];
        
        // Process delays
        if (delaysSnapshot.exists()) {
          const delays = delaysSnapshot.val();
          const delayedStudents = new Set();
          
          Object.keys(delays).forEach(studentId => {
            const studentDelays = delays[studentId];
            
            if (studentDelays.morning || studentDelays.break || studentDelays.departure) {
              delayedStudents.add(studentId);
            }
          });
          
          totalLate += delayedStudents.size;
        }
        
        // Process absences
        if (absencesSnapshot.exists()) {
          const absences = absencesSnapshot.val();
          
          Object.keys(absences).forEach(studentId => {
            totalAbsent++;
            if (studentAbsences[studentId] !== undefined) {
              studentAbsences[studentId]++;
            }
          });
        }
      });
      
      // Calculate present count
      totalPresent = (this.students.length * dates.length) - totalAbsent;
      
      // Calculate averages
      const avgPresent = Math.round(totalPresent / dates.length);
      
      // Update UI
      document.getElementById('monthlyAvgPresent').textContent = avgPresent;
      document.getElementById('monthlyTotalAbsent').textContent = totalAbsent;
      document.getElementById('monthlyTotalLate').textContent = totalLate;
      
      // Get top absent students
      const topAbsent = Object.entries(studentAbsences)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([studentId, count]) => {
          const student = this.students.find(s => s.id === studentId);
          return {
            name: student ? student.name : 'Unknown',
            count
          };
        });
      
      // Update top absent list
      const topAbsentList = document.getElementById('topAbsentList');
      topAbsentList.innerHTML = '';
      
      if (topAbsent.length === 0) {
        topAbsentList.innerHTML = '<div class="level-empty">لا يوجد طلاب غائبين خلال الشهر</div>';
      } else {
        topAbsent.forEach((student, index) => {
          const item = document.createElement('div');
          item.className = 'level-student';
          item.innerHTML = `
            <div class="student-name-stat">${index + 1}. ${student.name}</div>
            <div class="student-days">${student.count} يوم</div>
          `;
          topAbsentList.appendChild(item);
        });
      }
    });
  },
  
  // Load levels statistics
  loadLevelsStats: function() {
    // Get level settings from localStorage or use defaults
    const levelSettings = {
      level1Min: parseInt(localStorage.getItem('level1Min') || '1'),
      level1Max: parseInt(localStorage.getItem('level1Max') || '5'),
      level2Min: parseInt(localStorage.getItem('level2Min') || '6'),
      level2Max: parseInt(localStorage.getItem('level2Max') || '10'),
      level3Min: parseInt(localStorage.getItem('level3Min') || '11'),
      level3Max: parseInt(localStorage.getItem('level3Max') || '15'),
      level4Min: parseInt(localStorage.getItem('level4Min') || '16'),
      level4Max: parseInt(localStorage.getItem('level4Max') || '20')
    };
    
    // Update UI
    document.getElementById('level1Min').value = levelSettings.level1Min;
    document.getElementById('level1Max').value = levelSettings.level1Max;
    document.getElementById('level2Min').value = levelSettings.level2Min;
    document.getElementById('level2Max').value = levelSettings.level2Max;
    document.getElementById('level3Min').value = levelSettings.level3Min;
    document.getElementById('level3Max').value = levelSettings.level3Max;
    document.getElementById('level4Min').value = levelSettings.level4Min;
    document.getElementById('level4Max').value = levelSettings.level4Max;
    
    // Get current month's absences
    const today = new Date();
    const monthAgo = new Date(today);
    monthAgo.setDate(today.getDate() - 30);
    
    const dates = [];
    for (let d = new Date(monthAgo); d <= today; d.setDate(d.getDate() + 1)) {
      dates.push(this.formatDate(new Date(d)));
    }
    
    const studentAbsences = {};
    
    // Initialize student absences
    this.students.forEach(student => {
      studentAbsences[student.id] = {
        name: student.name,
        class: student.class,
        classroom: student.classroom,
        count: 0
      };
    });
    
    // Get records for each day
    Promise.all(dates.map(date => 
      database.ref(`absences/${date}`).once('value')
    )).then(results => {
      results.forEach((absencesSnapshot, index) => {
        if (absencesSnapshot.exists()) {
          const absences = absencesSnapshot.val();
          
          Object.keys(absences).forEach(studentId => {
            if (studentAbsences[studentId]) {
              studentAbsences[studentId].count++;
            }
          });
        }
      });
      
      // Categorize students by level
      const level1Students = [];
      const level2Students = [];
      const level3Students = [];
      const level4Students = [];
      
      Object.values(studentAbsences).forEach(student => {
        if (student.count >= levelSettings.level1Min && student.count <= levelSettings.level1Max) {
          level1Students.push(student);
        } else if (student.count >= levelSettings.level2Min && student.count <= levelSettings.level2Max) {
          level2Students.push(student);
        } else if (student.count >= levelSettings.level3Min && student.count <= levelSettings.level3Max) {
          level3Students.push(student);
        } else if (student.count >= levelSettings.level4Min && student.count <= levelSettings.level4Max) {
          level4Students.push(student);
        }
      });
      
      // Update UI
      this.updateLevelStudents('level1Students', level1Students);
      this.updateLevelStudents('level2Students', level2Students);
      this.updateLevelStudents('level3Students', level3Students);
      this.updateLevelStudents('level4Students', level4Students);
    });
  },
  
  // Update level students list
  updateLevelStudents: function(elementId, students) {
    const element = document.getElementById(elementId);
    element.innerHTML = '';
    
    if (students.length === 0) {
      element.innerHTML = '<div class="level-empty">لا يوجد طلاب في هذا المستوى</div>';
    } else {
      students.forEach(student => {
        const item = document.createElement('div');
        item.className = 'level-student';
        item.innerHTML = `
          <div class="student-name-stat">${student.name}</div>
          <div class="student-days">${student.count} يوم</div>
        `;
        element.appendChild(item);
      });
    }
  },
  
  // Save level settings
  saveLevelSettings: function() {
    const levelSettings = {
      level1Min: document.getElementById('level1Min').value,
      level1Max: document.getElementById('level1Max').value,
      level2Min: document.getElementById('level2Min').value,
      level2Max: document.getElementById('level2Max').value,
      level3Min: document.getElementById('level3Min').value,
      level3Max: document.getElementById('level3Max').value,
      level4Min: document.getElementById('level4Min').value,
      level4Max: document.getElementById('level4Max').value
    };
    
    // Save to localStorage
    Object.keys(levelSettings).forEach(key => {
      localStorage.setItem(key, levelSettings[key]);
    });
    
    this.showToast('تم حفظ الإعدادات بنجاح');
    
    // Reload levels statistics
    this.loadLevelsStats();
  },
  
  // Export current statistics
  exportCurrentStats: function() {
    // Get active tab
    const activeTab = document.querySelector('#statsPage .tab.active');
    const type = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
    
    if (type === 'daily') {
      this.exportDailyStats();
    } else if (type === 'weekly') {
      this.exportWeeklyStats();
    } else if (type === 'monthly') {
      this.exportMonthlyStats();
    } else if (type === 'levels') {
      this.exportLevelsStats();
    }
  },
  
  // Export daily statistics
  exportDailyStats: function() {
    const today = this.formatDate(new Date());
    const totalStudents = this.students.length;
    
    // Get today's records
    Promise.all([
      database.ref(`delays/${today}`).once('value'),
      database.ref(`absences/${today}`).once('value')
    ]).then(([delaysSnapshot, absencesSnapshot]) => {
      let presentCount = totalStudents;
      let delayCount = 0;
      let absenceCount = 0;
      
      // Process delays
      if (delaysSnapshot.exists()) {
        const delays = delaysSnapshot.val();
        const delayedStudents = new Set();
        
        Object.keys(delays).forEach(studentId => {
          const studentDelays = delays[studentId];
          
          if (studentDelays.morning || studentDelays.break || studentDelays.departure) {
            delayedStudents.add(studentId);
          }
        });
        
        delayCount = delayedStudents.size;
      }
      
      // Process absences
      if (absencesSnapshot.exists()) {
        const absences = absencesSnapshot.val();
        absenceCount = Object.keys(absences).length;
      }
      
      // Calculate present count
      presentCount = totalStudents - absenceCount;
      
      // Calculate percentage
      const percentage = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;
      
      // Create data for Excel
      const data = [
        ['إحصائيات اليوم', today],
        [],
        ['إجمالي الطلاب', totalStudents],
        ['الحاضرون', presentCount],
        ['الغائبون', absenceCount],
        ['المتأخرون', delayCount],
        ['نسبة الحضور', `${percentage}%`]
      ];
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'إحصائيات اليوم');
      
      const fileName = `إحصائيات_اليوم_${today}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير الإحصائيات بنجاح');
    });
  },
  
  // Export weekly statistics
  exportWeeklyStats: function() {
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(today.getDate() - 7);
    
    const dates = [];
    for (let d = new Date(weekAgo); d <= today; d.setDate(d.getDate() + 1)) {
      dates.push(this.formatDate(new Date(d)));
    }
    
    let totalPresent = 0;
    let totalAbsent = 0;
    let totalLate = 0;
    
    // Get records for each day
    Promise.all(dates.map(date => 
      Promise.all([
        database.ref(`delays/${date}`).once('value'),
        database.ref(`absences/${date}`).once('value')
      ])
    )).then(results => {
      results.forEach(([delaysSnapshot, absencesSnapshot], index) => {
        const date = dates[index];
        
        // Process delays
        if (delaysSnapshot.exists()) {
          const delays = delaysSnapshot.val();
          const delayedStudents = new Set();
          
          Object.keys(delays).forEach(studentId => {
            const studentDelays = delays[studentId];
            
            if (studentDelays.morning || studentDelays.break || studentDelays.departure) {
              delayedStudents.add(studentId);
            }
          });
          
          totalLate += delayedStudents.size;
        }
        
        // Process absences
        if (absencesSnapshot.exists()) {
          const absences = absencesSnapshot.val();
          totalAbsent += Object.keys(absences).length;
        }
      });
      
      // Calculate present count
      totalPresent = (this.students.length * dates.length) - totalAbsent;
      
      // Calculate averages
      const avgPresent = Math.round(totalPresent / dates.length);
      
      // Create data for Excel
      const data = [
        ['إحصائيات الأسبوع', `${this.formatDate(weekAgo)} - ${this.formatDate(today)}`],
        [],
        ['عدد الأيام', dates.length],
        ['متوسط الحضور', avgPresent],
        ['إجمالي الغياب', totalAbsent],
        ['إجمالي التأخرات', totalLate]
      ];
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'إحصائيات الأسبوع');
      
      const fileName = `إحصائيات_الأسبوع_${this.formatDate(new Date())}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير الإحصائيات بنجاح');
    });
  },
  
  // Export monthly statistics
  exportMonthlyStats: function() {
    const today = new Date();
    const monthAgo = new Date(today);
    monthAgo.setDate(today.getDate() - 30);
    
    const dates = [];
    for (let d = new Date(monthAgo); d <= today; d.setDate(d.getDate() + 1)) {
      dates.push(this.formatDate(new Date(d)));
    }
    
    let totalPresent = 0;
    let totalAbsent = 0;
    let totalLate = 0;
    const studentAbsences = {};
    
    // Initialize student absences
    this.students.forEach(student => {
      studentAbsences[student.id] = 0;
    });
    
    // Get records for each day
    Promise.all(dates.map(date => 
      Promise.all([
        database.ref(`delays/${date}`).once('value'),
        database.ref(`absences/${date}`).once('value')
      ])
    )).then(results => {
      results.forEach(([delaysSnapshot, absencesSnapshot], index) => {
        const date = dates[index];
        
        // Process delays
        if (delaysSnapshot.exists()) {
          const delays = delaysSnapshot.val();
          const delayedStudents = new Set();
          
          Object.keys(delays).forEach(studentId => {
            const studentDelays = delays[studentId];
            
            if (studentDelays.morning || studentDelays.break || studentDelays.departure) {
              delayedStudents.add(studentId);
            }
          });
          
          totalLate += delayedStudents.size;
        }
        
        // Process absences
        if (absencesSnapshot.exists()) {
          const absences = absencesSnapshot.val();
          
          Object.keys(absences).forEach(studentId => {
            totalAbsent++;
            if (studentAbsences[studentId] !== undefined) {
              studentAbsences[studentId]++;
            }
          });
        }
      });
      
      // Calculate present count
      totalPresent = (this.students.length * dates.length) - totalAbsent;
      
      // Calculate averages
      const avgPresent = Math.round(totalPresent / dates.length);
      
      // Get top absent students
      const topAbsent = Object.entries(studentAbsences)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([studentId, count]) => {
          const student = this.students.find(s => s.id === studentId);
          return {
            name: student ? student.name : 'Unknown',
            count
          };
        });
      
      // Create data for Excel
      const data = [
        ['إحصائيات الشهر', `${this.formatDate(monthAgo)} - ${this.formatDate(today)}`],
        [],
        ['أيام الدراسة', dates.length],
        ['متوسط الحضور', avgPresent],
        ['إجمالي الغياب', totalAbsent],
        ['إجمالي التأخرات', totalLate],
        [],
        ['الطلاب الأكثر غياباً'],
        ['الترتيب', 'الاسم', 'عدد أيام الغياب']
      ];
      
      // Add top absent students
      topAbsent.forEach((student, index) => {
        data.push([index + 1, student.name, student.count]);
      });
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'إحصائيات الشهر');
      
      const fileName = `إحصائيات_الشهر_${this.formatDate(new Date())}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير الإحصائيات بنجاح');
    });
  },
  
  // Export levels statistics
  exportLevelsStats: function() {
    // Get level settings from localStorage or use defaults
    const levelSettings = {
      level1Min: parseInt(localStorage.getItem('level1Min') || '1'),
      level1Max: parseInt(localStorage.getItem('level1Max') || '5'),
      level2Min: parseInt(localStorage.getItem('level2Min') || '6'),
      level2Max: parseInt(localStorage.getItem('level2Max') || '10'),
      level3Min: parseInt(localStorage.getItem('level3Min') || '11'),
      level3Max: parseInt(localStorage.getItem('level3Max') || '15'),
      level4Min: parseInt(localStorage.getItem('level4Min') || '16'),
      level4Max: parseInt(localStorage.getItem('level4Max') || '20')
    };
    
    // Get current month's absences
    const today = new Date();
    const monthAgo = new Date(today);
    monthAgo.setDate(today.getDate() - 30);
    
    const dates = [];
    for (let d = new Date(monthAgo); d <= today; d.setDate(d.getDate() + 1)) {
      dates.push(this.formatDate(new Date(d)));
    }
    
    const studentAbsences = {};
    
    // Initialize student absences
    this.students.forEach(student => {
      studentAbsences[student.id] = {
        name: student.name,
        class: student.class,
        classroom: student.classroom,
        count: 0
      };
    });
    
    // Get records for each day
    Promise.all(dates.map(date => 
      database.ref(`absences/${date}`).once('value')
    )).then(results => {
      results.forEach((absencesSnapshot, index) => {
        if (absencesSnapshot.exists()) {
          const absences = absencesSnapshot.val();
          
          Object.keys(absences).forEach(studentId => {
            if (studentAbsences[studentId]) {
              studentAbsences[studentId].count++;
            }
          });
        }
      });
      
      // Categorize students by level
      const level1Students = [];
      const level2Students = [];
      const level3Students = [];
      const level4Students = [];
      
      Object.values(studentAbsences).forEach(student => {
        if (student.count >= levelSettings.level1Min && student.count <= levelSettings.level1Max) {
          level1Students.push(student);
        } else if (student.count >= levelSettings.level2Min && student.count <= levelSettings.level2Max) {
          level2Students.push(student);
        } else if (student.count >= levelSettings.level3Min && student.count <= levelSettings.level3Max) {
          level3Students.push(student);
        } else if (student.count >= levelSettings.level4Min && student.count <= levelSettings.level4Max) {
          level4Students.push(student);
        }
      });
      
      // Create data for Excel
      const data = [
        ['إحصائيات مستويات الغياب', `${this.formatDate(monthAgo)} - ${this.formatDate(today)}`],
        [],
        ['إعدادات المستويات'],
        ['المستوى', 'الحد الأدنى', 'الحد الأعلى'],
        ['المستوى الأول (آمن)', levelSettings.level1Min, levelSettings.level1Max],
        ['المستوى الثاني (انتباه)', levelSettings.level2Min, levelSettings.level2Max],
        ['المستوى الثالث (تحذير)', levelSettings.level3Min, levelSettings.level3Max],
        ['المستوى الرابع (خطر)', levelSettings.level4Min, levelSettings.level4Max],
        [],
        ['المستوى الأول (آمن)'],
        ['الاسم', 'الصف', 'الفصل', 'عدد أيام الغياب']
      ];
      
      // Add level 1 students
      level1Students.forEach(student => {
        data.push([student.name, student.class, student.classroom, student.count]);
      });
      
      // Add level 2 students
      data.push([], ['المستوى الثاني (انتباه)'], ['الاسم', 'الصف', 'الفصل', 'عدد أيام الغياب']);
      level2Students.forEach(student => {
        data.push([student.name, student.class, student.classroom, student.count]);
      });
      
      // Add level 3 students
      data.push([], ['المستوى الثالث (تحذير)'], ['الاسم', 'الصف', 'الفصل', 'عدد أيام الغياب']);
      level3Students.forEach(student => {
        data.push([student.name, student.class, student.classroom, student.count]);
      });
      
      // Add level 4 students
      data.push([], ['المستوى الرابع (خطر)'], ['الاسم', 'الصف', 'الفصل', 'عدد أيام الغياب']);
      level4Students.forEach(student => {
        data.push([student.name, student.class, student.classroom, student.count]);
      });
      
      // Generate and download Excel file
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'مستويات الغياب');
      
      const fileName = `مستويات_الغياب_${this.formatDate(new Date())}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      this.showToast('تم تصدير الإحصائيات بنجاح');
    });
  },
  
  // Import Excel file
  importExcel: function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        // Skip header row
        const rows = jsonData.slice(1);
        
        // Process rows
        const students = [];
        rows.forEach(row => {
          if (row.length >= 5 && row[0]) {
            students.push({
              name: row[0],
              id: row[1] || '',
              phone: row[2] || '',
              class: row[3] || '',
              classroom: row[4] || ''
            });
          }
        });
        
        if (students.length === 0) {
          this.showToast('لم يتم العثور على بيانات طلاب صالحة في الملف');
          return;
        }
        
        // Save students to Firebase
        const updates = {};
        students.forEach(student => {
          updates[`students/${student.id}`] = student;
        });
        
        database.ref().update(updates)
          .then(() => {
            this.showToast(`تم استيراد ${students.length} طالب بنجاح`);
            this.loadStudents();
            this.loadClassFilters();
          })
          .catch(error => {
            this.showToast('حدث خطأ أثناء استيراد البيانات');
            console.error(error);
          });
      } catch (error) {
        this.showToast('حدث خطأ أثناء قراءة الملف');
        console.error(error);
      }
    };
    
    reader.readAsArrayBuffer(file);
    
    // Reset file input
    event.target.value = '';
  },
  
  // Reset app
  resetApp: function() {
    if (!confirm('هل أنت متأكد من حذف جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.')) {
      return;
    }
    
    // Clear all data from Firebase
    database.ref().set(null)
      .then(() => {
        this.showToast('تم حذف جميع البيانات بنجاح');
        
        // Reset local data
        this.students = [];
        this.selectedStudents = {
          morning: [],
          break: [],
          departure: [],
          absence: [],
          note: []
        };
        
        // Reload app
        this.init();
      })
      .catch(error => {
        this.showToast('حدث خطأ أثناء حذف البيانات');
        console.error(error);
      });
  },
  
  // Check subscription
  checkSubscription: function() {
    // Get subscription from localStorage
    const subscriptionStatus = localStorage.getItem('subscriptionStatus') || 'trial';
    const subscriptionDaysLeft = parseInt(localStorage.getItem('subscriptionDaysLeft') || '7');
    const subscriptionCode = localStorage.getItem('subscriptionCode') || null;
    
    this.subscription = {
      status: subscriptionStatus,
      daysLeft: subscriptionDaysLeft,
      code: subscriptionCode
    };
    
    // Update UI
    this.updateSubscriptionUI();
    
    // Check if subscription is expired
    if (this.subscription.status === 'trial' && this.subscription.daysLeft <= 0) {
      this.showLockScreen();
    } else if (this.subscription.status === 'expired') {
      this.showLockScreen();
    }
  },
  
  // Update subscription UI
  updateSubscriptionUI: function() {
    const badge = document.getElementById('subscriptionBadge');
    const badgeIcon = badge.querySelector('.badge-icon');
    const badgeDays = badge.querySelector('.badge-days');
    const badgeCode = badge.querySelector('.badge-code');
    
    // Update badge content
    if (this.subscription.status === 'trial') {
      badge.className = 'subscription-badge trial';
      badgeIcon.textContent = '⏳';
      badgeDays.textContent = this.subscription.daysLeft;
      badgeCode.textContent = this.subscription.code || '';
    } else if (this.subscription.status === 'active') {
      badge.className = 'subscription-badge active';
      badgeIcon.textContent = '✅';
      badgeDays.textContent = this.subscription.daysLeft;
      badgeCode.textContent = this.subscription.code || '';
    } else if (this.subscription.status === 'expired') {
      badge.className = 'subscription-badge warning';
      badgeIcon.textContent = '❌';
      badgeDays.textContent = '0';
      badgeCode.textContent = this.subscription.code || '';
    }
  },
  
  // Show lock screen
  showLockScreen: function() {
    document.getElementById('lockScreen').style.display = 'block';
  },
  
  // Hide lock screen
  hideLockScreen: function() {
    document.getElementById('lockScreen').style.display = 'none';
  },
  
  // Show payment page
  showPaymentPage: function() {
    document.getElementById('lockScreen').style.display = 'none';
    document.getElementById('paymentPage').style.display = 'block';
  },
  
  // Hide payment page
  hidePaymentPage: function() {
    document.getElementById('paymentPage').style.display = 'none';
    document.getElementById('lockScreen').style.display = 'block';
  },
  
  // Select payment method
  selectPaymentMethod: function(method) {
    if (method === 'bank') {
      const details = document.getElementById('bankDetails');
      details.style.display = details.style.display === 'none' ? 'block' : 'none';
    }
  },
  
  // Contact WhatsApp
  contactWhatsApp: function() {
    window.open('https://wa.me/966533371147?text=مرحباً، أريد تفعيل نظام الحضور الذكي', '_blank');
  },
  
  // Activate subscription
  activateSubscription: function() {
    const code = document.getElementById('activationCodeInput').value.trim();
    
    if (!code) {
      this.showToast('الرجاء إدخال كود التفعيل');
      return;
    }
    
    // Validate code (in a real app, this would be done on the server)
    if (code.startsWith('SK-') && code.length === 15) {
      // Update subscription
      this.subscription = {
        status: 'active',
        daysLeft: 365,
        code: code
      };
      
      // Save to localStorage
      localStorage.setItem('subscriptionStatus', 'active');
      localStorage.setItem('subscriptionDaysLeft', '365');
      localStorage.setItem('subscriptionCode', code);
      
      // Update UI
      this.updateSubscriptionUI();
      
      // Hide payment page
      document.getElementById('paymentPage').style.display = 'none';
      
      this.showToast('تم تفعيل الاشتراك بنجاح');
    } else {
      this.showToast('كود التفعيل غير صحيح');
    }
  },
  
  // Activate subscription from settings
  activateSubscriptionFromSettings: function() {
    const code = document.getElementById('activationCodeSettings').value.trim();
    
    if (!code) {
      this.showToast('الرجاء إدخال كود التفعيل');
      return;
    }
    
    // Validate code (in a real app, this would be done on the server)
    if (code.startsWith('SK-') && code.length === 15) {
      // Update subscription
      this.subscription = {
        status: 'active',
        daysLeft: 365,
        code: code
      };
      
      // Save to localStorage
      localStorage.setItem('subscriptionStatus', 'active');
      localStorage.setItem('subscriptionDaysLeft', '365');
      localStorage.setItem('subscriptionCode', code);
      
      // Update UI
      this.updateSubscriptionUI();
      
      this.showToast('تم تفعيل الاشتراك بنجاح');
    } else {
      this.showToast('كود التفعيل غير صحيح');
    }
  },
  
  // Copy text to clipboard
  copyText: function(text) {
    navigator.clipboard.writeText(text)
      .then(() => {
        this.showToast('تم نسخ النص بنجاح');
      })
      .catch(err => {
        this.showToast('فشل نسخ النص');
        console.error(err);
      });
  },
  
  // Show page
  showPage: function(pageId) {
    // Hide all pages
    document.querySelectorAll('.page').forEach(page => {
      page.classList.remove('active');
    });
    
    // Show selected page
    document.getElementById(`${pageId}Page`).classList.add('active');
    
    // Update navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.remove('active');
    });
    event.target.closest('.nav-item').classList.add('active');
    
    // Update current page
    this.currentPage = pageId;
    
    // Load page-specific data
    if (pageId === 'stats') {
      // Get active tab
      const activeTab = document.querySelector('#statsPage .tab.active');
      if (activeTab) {
        const type = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
        this.loadStats(type);
      }
    } else if (pageId === 'delays') {
      // Get active tab
      const activeTab = document.querySelector('#delaysPage .tab.active');
      if (activeTab) {
        const type = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
        if (type !== 'view') {
          this.displayStudents('delays', type);
        } else {
          const dateId = `date${type.charAt(0).toUpperCase() + type.slice(1)}`;
          const date = document.getElementById(dateId).value;
          this.loadRecords('delays', type);
        }
      }
    } else if (pageId === 'absence') {
      // Get active tab
      const activeTab = document.querySelector('#absencesPage .tab.active');
      if (activeTab) {
        const type = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
        if (type !== 'view') {
          this.displayStudents('absence', type);
        } else {
          this.loadRecords('absence', type);
        }
      }
    } else if (pageId === 'notes') {
      // Get active tab
      const activeTab = document.querySelector('#notesPage .tab.active');
      if (activeTab) {
        const type = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
        if (type !== 'view') {
          this.displayStudents('notes', type);
        } else {
          this.loadRecords('notes', type);
        }
      }
    }
  },
  
  // Switch tab
  switchTab: function(page, type, element) {
    // Update active tab
    document.querySelectorAll(`#${page}Page .tab`).forEach(tab => {
      tab.classList.remove('active');
    });
    element.classList.add('active');
    
    // Update active content
    document.querySelectorAll(`#${page}Page .tab-content`).forEach(content => {
      content.classList.remove('active');
    });
    
    const tabId = `${page}${type.charAt(0).toUpperCase() + type.slice(1)}Tab`;
    document.getElementById(tabId).classList.add('active');
    
    // Load data
    if (page === 'stats') {
      this.loadStats(type);
    } else if (page === 'delays') {
      if (type !== 'view') {
        this.displayStudents('delays', type);
      } else {
        const dateId = `date${type.charAt(0).toUpperCase() + type.slice(1)}`;
        const date = document.getElementById(dateId).value;
        this.loadRecords('delays', type);
      }
    } else if (page === 'absence') {
      if (type !== 'view') {
        this.displayStudents('absence', type);
      } else {
        this.loadRecords('absence', type);
      }
    } else if (page === 'notes') {
      if (type !== 'view') {
        this.displayStudents('notes', type);
      } else {
        this.loadRecords('notes', type);
      }
    }
  },
  
  // Show modal
  showModal: function(modalId) {
    document.getElementById(modalId).classList.add('active');
  },
  
  // Close modal
  closeModal: function() {
    document.getElementById('studentModal').classList.remove('active');
  },
  
  // Show confirm modal
  showConfirm: function(title, message, onConfirm) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMsg').textContent = message;
    document.getElementById('confirmYes').onclick = onConfirm;
    document.getElementById('confirmModal').classList.add('active');
  },
  
  // Close confirm modal
  closeConfirm: function() {
    document.getElementById('confirmModal').classList.remove('active');
  },
  
  // Show date modal
  showDateModal: function() {
    document.getElementById('dateModal').classList.add('active');
  },
  
  // Close date modal
  closeDateModal: function() {
    document.getElementById('dateModal').classList.remove('active');
  },
  
  // Show toast
  showToast: function(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
      toast.classList.remove('show');
    }, 3000);
  }
};

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  app.init();
});

// Check subscription status daily
setInterval(() => {
  if (app.subscription.status === 'trial' && app.subscription.daysLeft > 0) {
    app.subscription.daysLeft--;
    localStorage.setItem('subscriptionDaysLeft', app.subscription.daysLeft.toString());
    app.updateSubscriptionUI();
    
    if (app.subscription.daysLeft <= 0) {
      app.showLockScreen();
    }
  } else if (app.subscription.status === 'active' && app.subscription.daysLeft > 0) {
    app.subscription.daysLeft--;
    localStorage.setItem('subscriptionDaysLeft', app.subscription.daysLeft.toString());
    app.updateSubscriptionUI();
    
    if (app.subscription.daysLeft <= 0) {
      app.subscription.status = 'expired';
      localStorage.setItem('subscriptionStatus', 'expired');
      app.updateSubscriptionUI();
      app.showLockScreen();
    }
  }
}, 24 * 60 * 60 * 1000); // Check daily
</script>
</body>
</html>
