<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ÿßŸÑÿ∞ŸÉŸä  v4.0</title>
    
<!-- PWA Support -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ÿßŸÑÿ≠ÿ∂Ÿàÿ± ÿßŸÑÿ∞ŸÉŸä">

<!-- App Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">    
    
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333;-webkit-font-smoothing:antialiased}
.container{max-width:600px;margin:0 auto;background:#fff;min-height:100vh;padding-bottom:70px}
header{background:linear-gradient(135deg,#1976d2 0%,#1565c0 100%);color:white;padding:22px;text-align:center;position:sticky;top:0;z-index:100}
header.absence{background:linear-gradient(135deg,#d32f2f 0%,#c62828 100%)}
header.notes{background:linear-gradient(135deg,#00897b 0%,#00796b 100%)}
header h1{font-size:22px;font-weight:600;letter-spacing:0.3px}
header p{font-size:14px;margin-top:6px;opacity:0.95;font-weight:500}
.content{padding:20px}
.search-input{width:100%;padding:16px;border:2px solid #e0e0e0;border-radius:12px;font-size:17px;font-family:inherit;margin:12px 0;font-weight:500}
.search-input:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 3px rgba(25,118,210,0.1)}
.date-input{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;background:white;margin:15px 0;font-family:inherit;font-weight:500}
.note-container{background:#e0f2f1;padding:18px;border-radius:12px;border:2px solid #00897b;margin:15px 0}
.note-label{font-size:15px;font-weight:700;color:#00695c;margin-bottom:10px;display:block}
.note-textarea{width:100%;min-height:120px;padding:14px;border:2px solid #80cbc4;border-radius:10px;font-size:16px;font-family:inherit;background:white;resize:vertical;font-weight:500}
.note-textarea:focus{outline:none;border-color:#00897b;box-shadow:0 0 0 3px rgba(0,137,123,0.1)}
.note-char-count{text-align:left;font-size:13px;color:#666;margin-top:6px;font-weight:600}
.filters-container{display:flex;gap:12px;margin:15px 0}
.filter-select{flex:1;padding:14px 12px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;font-family:inherit;background:white;cursor:pointer;font-weight:500}
.filter-select:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 3px rgba(25,118,210,0.1)}
.students-list{list-style:none;padding:0}
.student-item{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:16px;margin:12px 0;cursor:pointer;transition:all 0.3s}
.student-item:active{transform:translateY(2px)}
.student-name{font-size:18px;font-weight:600;margin-bottom:6px;letter-spacing:0.2px}
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600;margin-left:6px;color:white}
.badge.delay{background:#ff9800}
.badge.absence{background:#f44336}
.badge.note{background:#00897b}
.btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:17px;font-weight:600;cursor:pointer;margin:6px 0;color:white;font-family:inherit}
.btn-primary{background:linear-gradient(135deg,#1976d2 0%,#1565c0 100%)}
.btn-success{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%)}
.btn-warning{background:linear-gradient(135deg,#ff9800 0%,#f57c00 100%)}
.btn-danger{background:linear-gradient(135deg,#d32f2f 0%,#c62828 100%)}
.btn-notes{background:linear-gradient(135deg,#00897b 0%,#00796b 100%)}
.btn:active{transform:scale(0.98)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:white;box-shadow:0 -2px 10px rgba(0,0,0,0.1);display:flex;z-index:100}
.nav-item{flex:1;text-align:center;padding:10px 6px;cursor:pointer;border:none;background:none;color:#666;font-size:11px;font-weight:600}
.nav-item.active{color:#1976d2}
.nav-icon{font-size:22px;display:block;margin-bottom:3px}
.page{display:none}
.page.active{display:block}
.tabs{display:flex;gap:10px;margin:16px 0;position:sticky;top:84px;background:white;padding:12px 0;z-index:90}
.tab{flex:1;padding:13px 16px;border:2px solid #e0e0e0;background:white;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap}
.tab.active{background:#1976d2;color:white;border-color:#1976d2}
.notes-page .tab.active{background:#00897b;border-color:#00897b}
.tab:active{transform:scale(0.97)}
.tab-content{display:none}
.tab-content.active{display:block}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000}
.modal.active{display:flex;align-items:center;justify-content:center;padding:20px}
.modal-content{background:white;border-radius:18px;padding:26px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
.toast{position:fixed;bottom:80px;left:20px;right:20px;background:#323232;color:white;padding:16px 20px;border-radius:10px;z-index:2000;display:none;font-size:15px;font-weight:500}
.toast.show{display:block}
.record-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin:16px 0}
.record-card{background:#f8f9fa;border-radius:12px;padding:15px;border:2px solid #e0e0e0}
.record-card.delays{border-color:#ff9800;background:linear-gradient(135deg,#fff3e0,#ffe0b2)}
.record-card.absences{border-color:#f44336;background:linear-gradient(135deg,#ffebee,#ffcdd2)}
.record-card.notes{border-color:#00897b;background:linear-gradient(135deg,#e0f2f1,#b2dfdb)}
.record-card h4{font-size:15px;margin-bottom:10px;color:#333;border-bottom:2px solid rgba(0,0,0,0.1);padding-bottom:8px;font-weight:600}
.record-card.delays h4{color:#e65100}
.record-card.absences h4{color:#c62828}
.record-card.notes h4{color:#00695c}
.record-list{max-height:180px;overflow-y:auto}
.record-item{background:white;padding:9px;border-radius:7px;margin:5px 0;font-size:13px}
.record-item-header{display:flex;justify-content:space-between;align-items:flex-start}
.record-type{font-weight:600;font-size:12px}
.record-card.delays .record-type{color:#e65100}
.record-card.absences .record-type{color:#c62828}
.record-card.notes .record-type{color:#00695c}
.record-date{color:#666;font-size:11px;margin-top:2px}
.record-note-text{background:#f8f9fa;padding:8px;border-radius:6px;font-size:12px;margin-top:6px;border-right:3px solid #00897b;line-height:1.4}
.delete-btn{background:#f44336;color:white;border:none;padding:5px 9px;border-radius:5px;font-size:10px;cursor:pointer;font-weight:600}
.delete-btn:active{transform:scale(0.95)}
.selected-count{background:#4caf50;color:white;padding:12px;border-radius:10px;text-align:center;margin:12px 0;font-weight:600;font-size:15px}
.selected-count.absence{background:#d32f2f}
.selected-count.notes{background:#00897b}
.action-btns{position:sticky;bottom:70px;background:white;padding:16px 20px;box-shadow:0 -2px 10px rgba(0,0,0,0.1);margin:0 -20px;display:none;gap:12px}
.action-btns.show{display:flex}
.action-btns .btn{margin:0;padding:13px;font-size:15px}
.hidden{display:none}
.stats-page{background:#f5f5f5}
.stats-card{background:white;border-radius:12px;padding:20px;margin:15px 0;box-shadow:0 2px 4px rgba(0,0,0,0.08)}
.stats-card h3{font-size:18px;font-weight:600;color:#333;margin-bottom:15px;border-bottom:2px solid #e0e0e0;padding-bottom:10px}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:15px 0}
.stat-box{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:18px;border-radius:10px;text-align:center}
.stat-box.success{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%)}
.stat-box.danger{background:linear-gradient(135deg,#f44336 0%,#d32f2f 100%)}
.stat-box.warning{background:linear-gradient(135deg,#ff9800 0%,#f57c00 100%)}
.stat-box.info{background:linear-gradient(135deg,#2196f3 0%,#1976d2 100%)}
.stat-number{font-size:32px;font-weight:700;margin:8px 0}
.stat-label{font-size:13px;opacity:0.95;font-weight:500}
.level-card{border-radius:10px;padding:16px;margin:12px 0;border-right:5px solid}
.level-1{background:#e8f5e9;border-color:#4caf50}
.level-1 .level-title{color:#2e7d32}
.level-2{background:#fff9c4;border-color:#ffc107}
.level-2 .level-title{color:#f57f17}
.level-3{background:#ffe0b2;border-color:#ff9800}
.level-3 .level-title{color:#e65100}
.level-4{background:#ffebee;border-color:#f44336}
.level-4 .level-title{color:#c62828}
.level-title{font-size:16px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.level-student{background:white;padding:10px 12px;border-radius:8px;margin:6px 0;font-size:14px;display:flex;justify-content:space-between;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.student-name-stat{font-weight:600;color:#333}
.student-days{color:#666;font-size:13px}
.level-empty{text-align:center;padding:20px;color:#999;font-size:14px}
.settings-input{display:flex;align-items:center;gap:10px;margin:10px 0}
.settings-input label{flex:1;font-size:14px;font-weight:500;color:#666}
.settings-input input{width:60px;padding:8px;border:2px solid #e0e0e0;border-radius:6px;text-align:center;font-size:14px;font-weight:600}
.percentage-circle{width:120px;height:120px;margin:20px auto;position:relative}
.percentage-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:28px;font-weight:700;color:#1976d2}
.settings-card{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:22px;margin:16px 0}
.settings-card h3{margin-bottom:12px;font-size:18px;font-weight:600}
/* CSS ŸÑŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸàÿßŸÑÿØÿπŸÖ */
.subscription-hero{
background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
color:white;
padding:30px;
text-align:center;
border-radius:15px;
margin:20px 0;
}
.app-logo{
width:100px;
height:100px;
background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
border-radius:22px;
display:flex;
align-items:center;
justify-content:center;
margin:0 auto 15px;
font-size:50px;
box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
.subscription-price{
font-size:48px;
font-weight:700;
margin:15px 0;
}
.subscription-price small{
font-size:18px;
opacity:0.9;
}
.payment-card{
background:white;
border-radius:15px;
padding:25px;
margin:20px 0;
box-shadow:0 4px 15px rgba(0,0,0,0.1);
border:2px solid #e0e0e0;
}
.payment-card h3{
color:#1976d2;
font-size:20px;
margin-bottom:20px;
display:flex;
align-items:center;
gap:10px;
}
.bank-info{
background:#f8f9fa;
padding:18px;
border-radius:10px;
margin:15px 0;
border-right:4px solid #1976d2;
}
.bank-info-row{
display:flex;
justify-content:space-between;
align-items:center;
margin:12px 0;
padding:10px 0;
border-bottom:1px solid #e0e0e0;
}
.bank-info-row:last-child{
border-bottom:none;
}
.bank-label{
font-weight:600;
color:#666;
font-size:14px;
}
.bank-value{
font-weight:700;
color:#1976d2;
font-size:15px;
direction:ltr;
text-align:left;
}
.copy-btn{
background:#4caf50;
color:white;
border:none;
padding:6px 12px;
border-radius:6px;
font-size:12px;
cursor:pointer;
margin-right:8px;
font-weight:600;
}
.copy-btn:active{
transform:scale(0.95);
}
.qr-container{
text-align:center;
padding:20px;
background:#f8f9fa;
border-radius:10px;
margin:15px 0;
}
.qr-code{
width:200px;
height:200px;
margin:15px auto;
border:3px solid #1976d2;
border-radius:10px;
padding:10px;
background:white;
}
.qr-code img{
width:100%;
height:100%;
object-fit:contain;
}
.activation-steps{
background:#e3f2fd;
padding:20px;
border-radius:10px;
margin:20px 0;
}
.activation-steps h4{
color:#1976d2;
margin-bottom:15px;
font-size:18px;
}
.step-item{
display:flex;
align-items:flex-start;
margin:15px 0;
}
.step-number{
background:#1976d2;
color:white;
width:30px;
height:30px;
border-radius:50%;
display:flex;
align-items:center;
justify-content:center;
font-weight:700;
font-size:14px;
margin-left:12px;
flex-shrink:0;
}
.step-text{
flex:1;
font-size:15px;
line-height:1.6;
color:#333;
}
.developer-info{
background:#f5f5f5;
padding:20px;
border-radius:10px;
text-align:center;
margin:20px 0;
border:2px solid #e0e0e0;
}
.developer-name{
font-size:18px;
font-weight:600;
color:#333;
margin:10px 0;
}
.developer-role{
color:#666;
font-size:14px;
margin-bottom:15px;
}
.settings-card p{color:#666;font-size:15px;margin-bottom:16px;line-height:1.6}
.app-logo {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #0A84FF 0%, #5AC8FA 100%);
    border-radius: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3),
                0 5px 15px rgba(10, 132, 255, 0.2);
    position: relative;
    overflow: hidden;
}

.app-logo::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
}

.app-logo-icon {
    font-size: 50px;
    position: relative;
    z-index: 1;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

/* CSS ÿßŸÑÿÆÿßÿµ ÿ®ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© */
.lock-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.lock-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.lock-icon {
    font-size: 60px;
    margin-bottom: 20px;
}

.lock-title {
    font-size: 24px;
    margin-bottom: 15px;
    color: #333;
}

.lock-message {
    font-size: 16px;
    margin-bottom: 25px;
    color: #666;
    line-height: 1.5;
}

.activation-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 20px;
    text-align: center;
}

.trial-banner {
    background: linear-gradient(135deg, #ffeb3b 0%, #ffc107 100%);
    color: #333;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    font-size: 16px;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
}

.trial-banner.warning {
    background: linear-gradient(135deg, #ff5722 0%, #f44336 100%);
    color: white;
    animation: blink 1s infinite;
}

@keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
.whatsapp-link{display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg,#25d366 0%,#128c7e 100%);color:white;text-decoration:none;border-radius:10px;font-weight:600;font-size:15px;margin-top:10px}
.whatsapp-link:active{transform:scale(0.97)}

.app-logo {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #0A84FF 0%, #5AC8FA 100%);
    border-radius: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3),
                0 5px 15px rgba(10, 132, 255, 0.2);
    position: relative;
    overflow: hidden;
}

.app-logo::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
}

.app-logo-icon {
    font-size: 50px;
    position: relative;
    z-index: 1;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

/* ÿ£ŸäŸÇŸàŸÜÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ */
.subscription-badge{
  position: fixed;
  top: 15px;
  right: 15px;
  background: white;
  border-radius: 12px;
  padding: 10px 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 1000;
  animation: slideInRight 0.5s ease;
}

.badge-icon{
  font-size: 24px;
  line-height: 1;
}

.badge-text{
  display: flex;
  flex-direction: column;
  line-height: 1.2;
}

.badge-days{
  font-size: 18px;
  font-weight: 700;
  color: #333;
}

.badge-label{
  font-size: 11px;
  color: #666;
}

/* ÿ≠ÿßŸÑÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ© */
.subscription-badge.trial{
  border-left: 4px solid #ff9800;
}

.subscription-badge.active{
  border-left: 4px solid #4caf50;
}

.subscription-badge.warning{
  border-left: 4px solid #f44336;
  animation: pulse 2s infinite;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* ŸÑŸÑÿ¨ŸàÿßŸÑ */
@media (max-width: 768px) {
  .subscription-badge{
    top: 10px;
    right: 10px;
    padding: 8px 12px;
  }
  .badge-icon{
    font-size: 20px;
  }
  .badge-days{
    font-size: 16px;
  }
  .badge-label{
    font-size: 10px;
  }
}


/* ÿ•ÿµŸÑÿßÿ≠ ŸÖÿ¥ÿßŸÉŸÑ Select ŸÅŸä iOS Safari */
.filter-select {
  -webkit-appearance: menulist;
  appearance: menulist;
  min-height: 44px; /* ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÑŸÖÿ≥ ŸÅŸä iOS */
}

/* ÿ•ÿµŸÑÿßÿ≠ ŸÖÿ¥ÿßŸÉŸÑ PWA */
@supports (-webkit-touch-callout: none) {
  .filter-select {
    background-color: white !important;
    border: 2px solid #e0e0e0 !important;
  }
  
  .filter-select option {
    background-color: white;
    color: #333;
  }
}
/* ===== ÿ™ÿµŸÖŸäŸÖ ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇŸÅŸÑ ŸÖÿ™ÿ¨ÿßŸàÿ® ŸÑŸÑÿ¨ŸàÿßŸÑ ===== */
#lockScreen {
  position: fixed !important;
  top: 0;
  left: 0;
  width: 100vw !important;
  height: 100vh !important;
  background: rgba(0, 0, 0, 0.95);
  z-index: 99999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 15px;
  box-sizing: border-box;
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch;
}

.lock-content {
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  box-sizing: border-box;
}

.lock-icon {
  font-size: 50px !important;
  margin-bottom: 15px;
}

.lock-title {
  font-size: 1.5rem !important;
  margin-bottom: 10px;
}

.lock-message {
  font-size: 0.95rem !important;
  margin-bottom: 20px;
  line-height: 1.5;
}

/* ÿ™ÿµÿ∫Ÿäÿ± ŸÇÿ≥ŸÖ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿÆÿßÿµ */
#lockScreen [style*="gradient"] {
  padding: 15px !important;
  margin: 15px 0 !important;
}

#lockScreen h3 {
  font-size: 1.2rem !important;
  margin-bottom: 15px !important;
}

#lockScreen ul {
  margin: 15px 0 !important;
}

#lockScreen li {
  padding: 6px 0 !important;
  font-size: 0.9rem !important;
}

/* ÿ™ÿµÿ∫Ÿäÿ± ÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿπÿ± */
#lockScreen [style*="font-size: 52px"] {
  font-size: 2.5rem !important;
}

#lockScreen [style*="font-size: 20px"] {
  font-size: 1rem !important;
}

#lockScreen [style*="font-size: 18px"] {
  font-size: 0.9rem !important;
}

/* ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± */
#lockScreen button {
  width: 100% !important;
  padding: 14px 20px !important;
  font-size: 1.1rem !important;
  margin: 10px 0 !important;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* ÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ± */
#lockScreen [style*="background: #fff3cd"] {
  padding: 12px !important;
  margin: 15px 0 !important;
  font-size: 0.85rem !important;
}

/* ŸÑŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© ÿ¨ÿØÿßŸã */
@media (max-width: 400px) {
  .lock-content {
    padding: 15px;
    max-height: 85vh;
  }
  
  .lock-icon {
    font-size: 40px !important;
  }
  
  .lock-title {
    font-size: 1.3rem !important;
  }
  
  .lock-message {
    font-size: 0.85rem !important;
  }
  
  #lockScreen h3 {
    font-size: 1rem !important;
  }
  
  #lockScreen li {
    font-size: 0.85rem !important;
  }
  
  #lockScreen [style*="font-size: 52px"] {
    font-size: 2rem !important;
  }
  
  #lockScreen button {
    font-size: 1rem !important;
    padding: 12px 15px !important;
  }
}

/* ŸÑŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑÿ£ŸÅŸÇŸäÿ© (landscape) */
@media (max-height: 600px) and (orientation: landscape) {
  .lock-content {
    max-height: 95vh;
    padding: 10px 20px;
  }
  
  .lock-icon {
    font-size: 35px !important;
    margin-bottom: 10px;
  }
  
  #lockScreen [style*="gradient"] {
    padding: 10px !important;
    margin: 10px 0 !important;
  }
  
  #lockScreen ul {
    margin: 10px 0 !important;
  }
  
  #lockScreen li {
    padding: 4px 0 !important;
  }
}

/* ===== ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇŸÅŸÑ ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ© ===== */
#lockScreen, #paymentPage {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 99999;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.lock-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, rgba(26,35,126,0.95) 0%, rgba(13,71,161,0.95) 100%);
  backdrop-filter: blur(10px);
}

.lock-container, .payment-container {
  position: relative;
  z-index: 1;
  max-width: 500px;
  margin: 0 auto;
  padding: 20px;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.lock-header {
  text-align: center;
  margin-bottom: 30px;
  animation: fadeInDown 0.6s ease-out;
}

.lock-icon-main {
  font-size: 70px;
  margin-bottom: 15px;
  animation: bounce 2s infinite;
}

.lock-main-title {
  color: white;
  font-size: 2rem;
  margin-bottom: 10px;
  font-weight: bold;
}

.lock-subtitle {
  color: rgba(255,255,255,0.9);
  font-size: 1.1rem;
  margin: 0;
}

.subscription-card {
  background: white;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: fadeInUp 0.6s ease-out 0.2s both;
}

.card-badge {
  background: linear-gradient(135deg, #FFD700, #FFA500);
  color: #333;
  display: inline-block;
  padding: 8px 20px;
  border-radius: 50px;
  font-weight: bold;
  font-size: 0.9rem;
  margin-bottom: 20px;
}

.price-section {
  text-align: center;
  margin: 25px 0;
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border-radius: 15px;
}

.old-price {
  color: #999;
  text-decoration: line-through;
  font-size: 1.2rem;
  display: block;
  margin-bottom: 10px;
}

.new-price-wrapper {
  display: flex;
  align-items: baseline;
  justify-content: center;
  gap: 10px;
}

.new-price {
  font-size: 4rem;
  font-weight: bold;
  color: #1976d2;
  line-height: 1;
}

.currency {
  font-size: 1.5rem;
  color: #1976d2;
}

.duration {
  color: #666;
  font-size: 1rem;
  display: block;
  margin-top: 5px;
}

.benefits-list {
  margin: 25px 0;
}

.benefit-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid #f0f0f0;
}

.benefit-item:last-child {
  border-bottom: none;
}

.benefit-icon {
  font-size: 1.3rem;
  flex-shrink: 0;
}

.benefit-text {
  color: #333;
  font-size: 1rem;
  line-height: 1.4;
}

.btn-subscribe-main {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 1.2rem;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 10px 30px rgba(102,126,234,0.4);
  transition: all 0.3s;
  margin-top: 10px;
}

.btn-subscribe-main:hover {
  transform: translateY(-2px);
  box-shadow: 0 15px 40px rgba(102,126,234,0.5);
}

.btn-subscribe-main:active {
  transform: translateY(0);
}

.guarantee {
  text-align: center;
  color: #666;
  font-size: 0.85rem;
  margin-top: 15px;
}

.warning-box {
  background: rgba(255,243,205,0.95);
  border-radius: 12px;
  padding: 15px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-top: 20px;
  animation: fadeInUp 0.6s ease-out 0.4s both;
}

.warning-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.warning-content {
  color: #856404;
  font-size: 0.9rem;
  line-height: 1.5;
}

/* ===== ÿµŸÅÿ≠ÿ© ÿßŸÑÿØŸÅÿπ ===== */
.payment-container {
  padding-top: 60px;
}

.btn-back {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(255,255,255,0.2);
  color: white;
  border: 2px solid rgba(255,255,255,0.3);
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  backdrop-filter: blur(10px);
  transition: all 0.3s;
}

.btn-back:hover {
  background: rgba(255,255,255,0.3);
}

.payment-header {
  text-align: center;
  margin-bottom: 30px;
  color: white;
}

.payment-icon {
  font-size: 60px;
  margin-bottom: 15px;
}

.payment-header h2 {
  font-size: 2rem;
  margin-bottom: 10px;
}

.payment-subtitle {
  font-size: 1rem;
  opacity: 0.9;
}

.payment-methods {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-bottom: 30px;
}

.payment-method {
  background: white;
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.method-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  cursor: pointer;
  transition: background 0.3s;
}

.method-header:hover {
  background: #f8f9fa;
}

.method-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

.method-icon {
  font-size: 1.8rem;
}

.method-name {
  font-size: 1.1rem;
  font-weight: bold;
  color: #333;
}

.method-arrow {
  color: #999;
  transition: transform 0.3s;
}

.method-details {
  padding: 0 20px 20px;
  animation: slideDown 0.3s ease-out;
}

.bank-info-card {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.info-row {
  display: flex;
  flex-direction: column;
  gap: 5px;
  margin-bottom: 15px;
}

.info-row:last-child {
  margin-bottom: 0;
}

.info-label {
  color: #666;
  font-size: 0.9rem;
}

.info-value {
  color: #333;
  font-size: 1.1rem;
  font-weight: bold;
}

.iban-container {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.iban-input {
  flex: 1;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-family: monospace;
  font-size: 0.95rem;
}

.btn-copy {
  padding: 12px 20px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.3s;
}

.btn-copy:hover {
  background: #45a049;
}

.qr-section {
  text-align: center;
}

.qr-section h4 {
  margin-bottom: 15px;
  color: #333;
}

.qr-placeholder {
  background: white;
  border: 2px dashed #ddd;
  border-radius: 12px;
  padding: 40px;
  color: #999;
}

.activation-section {
  background: white;
  border-radius: 15px;
  padding: 25px;
  margin-bottom: 20px;
}

.activation-section h3 {
  margin-bottom: 10px;
  color: #333;
}

.activation-hint {
  color: #666;
  font-size: 0.9rem;
  margin-bottom: 15px;
}

.activation-input-group {
  display: flex;
  gap: 10px;
}

.activation-input {
  flex: 1;
  padding: 14px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1rem;
  text-transform: uppercase;
}

.btn-activate {
  padding: 14px 25px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s;
}

.btn-activate:hover {
  background: #45a049;
}

.support-section {
  background: rgba(255,255,255,0.95);
  border-radius: 15px;
  padding: 20px;
  text-align: center;
}

.support-section h4 {
  margin-bottom: 15px;
  color: #333;
}

.support-contacts {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.support-link {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
  text-decoration: none;
  color: #333;
  transition: background 0.3s;
}

.support-link:hover {
  background: #e9ecef;
}

@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes slideDown {
  from {
    opacity: 0;
    max-height: 0;
  }
  to {
    opacity: 1;
    max-height: 1000px;
  }
}

@media (max-width: 480px) {
  .lock-main-title {
    font-size: 1.5rem;
  }
  
  .new-price {
    font-size: 3rem;
  }
  
  .subscription-card {
    padding: 20px;
  }
  
  .benefit-text {
    font-size: 0.9rem;
  }
  
  .btn-subscribe-main {
    font-size: 1rem;
    padding: 15px;
  }
  
  .activation-input-group {
    flex-direction: column;
  }
  
  .btn-activate {
    width: 100%;
  }
}
    
    

/* ===== ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇŸÅŸÑ ===== */
#lockScreen {
  display: none !important;
}

#lockScreen[style*="display: block"],
#lockScreen[style*="display: flex"] {
  display: flex !important;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 999999 !important;
}

#paymentPage {
  display: none !important;
}

#paymentPage[style*="display: block"],
#paymentPage[style*="display: flex"] {
  display: flex !important;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 999999 !important;
}

/* ÿ•ÿÆŸÅÿßÿ° ÿ£Ÿä ÿπŸÜÿßÿµÿ± ÿ£ÿÆÿ±Ÿâ ÿπŸÜÿØ ÿπÿ±ÿ∂ ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇŸÅŸÑ */
body:has(#lockScreen[style*="display: flex"]) .container,
body:has(#lockScreen[style*="display: flex"]) .page,
body:has(#lockScreen[style*="display: flex"]) nav {
  display: none !important;
}

body:has(#paymentPage[style*="display: flex"]) .container,
body:has(#paymentPage[style*="display: flex"]) .page,
body:has(#paymentPage[style*="display: flex"]) nav {
  display: none !important;
}

</style>
</head>
    
<body>
<div class="container">
<script>
// ÿ•ÿπÿØÿßÿØ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDV9YcTWPcGCJDAx5hoy4xz2i6Adg_3F5k",
  authDomain: "smart-attendance-system-63a71.firebaseapp.com",
  databaseURL: "https://smart-attendance-system-63a71-default-rtdb.firebaseio.com",
  projectId: "smart-attendance-system-63a71"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const app={
students:[],
delays:{},
absences:{},
notes:{},
subscriptions:{},
selected:{morning:new Set(),break:new Set(),departure:new Set(),absence:new Set(),note:new Set()},
currentTab:{delay:'morning',absence:'daily',notes:'add',stats:'daily'},

init() {
  this.loadData();
  this.setToday();
  if(!this.checkSubscription()) return;
  this.checkExpiredTrials();
  this.setupEvents();
  this.renderStudents();
  this.loadLevelSettings();
  this.updateAllStats();
  
  // ÿ™ÿ£ÿÆŸäÿ± ŸÖŸÑÿ° ÿßŸÑŸÅŸÑÿßÿ™ÿ± ŸÑŸÄ iOS (ŸÖŸáŸÖ ÿ¨ÿØÿßŸã!)
  setTimeout(() => {
    this.populateFilters();
  }, 300);
  
  this.setupRealtimeSync();
  this.checkOnlineStatus(); 
  
  // ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿØÿ´ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ©
  const badge = document.getElementById('subscriptionBadge');
  if(badge){
    badge.onclick = () => {
      this.showPage('settings');
    };
    badge.style.cursor = 'pointer';
  }
},

// ÿØÿßŸÑÿ© ÿ¨ÿØŸäÿØÿ©: ÿ•ŸÜÿ¥ÿßÿ° ŸÅÿ™ÿ±ÿ© ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© 7 ÿ£ŸäÿßŸÖ
initTrialSubscription(){
  const code = 'SK-TRIAL-' + Date.now();
  const endDate = new Date();
  endDate.setDate(endDate.getDate() + 7); // ‚Üê 7 ÿ£ŸäÿßŸÖ ŸÅŸÇÿ∑
  
  this.subscriptions[code] = {
    active: true,
    startDate: new Date().toISOString(),
    endDate: endDate.toISOString(),
    isTrial: true
  };
  
  localStorage.setItem('activationCode', code);
  this.saveData();
  
  this.showToast('üéâ ŸÖÿ±ÿ≠ÿ®ÿßŸã! ŸÑÿØŸäŸÉ 7 ÿ£ŸäÿßŸÖ ÿ™ÿ¨ÿ±ÿ®ÿ© ŸÖÿ¨ÿßŸÜŸäÿ©', 5000);
  
  return code;
},

getDeviceId(){
  let deviceId = localStorage.getItem('deviceId');
  if(!deviceId){
    deviceId = 'device-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('deviceId', deviceId);
  }
  return deviceId;
},


// ŸÉÿ¥ŸÅ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ (ÿØÿßŸÑÿ© ŸÖŸÜŸÅÿµŸÑÿ© ÿÆÿßÿ±ÿ¨ init)
checkOnlineStatus(){
  const updateOnlineStatus = () => {
    const statusBadge = document.getElementById('subscriptionBadge');
    if(statusBadge){
      if(navigator.onLine){
        statusBadge.style.borderLeft = '4px solid #4caf50';
        this.syncPendingData(); // ŸÖÿ≤ÿßŸÖŸÜÿ© ÿπŸÜÿØ ÿßŸÑÿπŸàÿØÿ© ÿ£ŸàŸÜŸÑÿßŸäŸÜ
      }else{
        statusBadge.style.borderLeft = '4px solid #ff9800';
        this.showToast('‚ö†Ô∏è Ÿàÿ∂ÿπ ÿ£ŸàŸÅŸÑÿßŸäŸÜ - ÿ≥Ÿäÿ™ŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿπŸÜÿØ ÿßŸÑÿßÿ™ÿµÿßŸÑ');
      }
    }
  };
  
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus();
},


// ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ© ŸÑŸÑŸÖÿ≤ÿßŸÖŸÜÿ©
savePendingData(data){
  const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
  pending.push({...data, timestamp: Date.now()});
  localStorage.setItem('pendingSync', JSON.stringify(pending));
},

// ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©
syncPendingData(){
  const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
  if(pending.length === 0) return;
  
  const activationCode = localStorage.getItem('activationCode');
  if(!activationCode || !activationCode.startsWith('SK-')) return;
  
  this.showToast('üîÑ ÿ¨ÿßÿ±Ÿç ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©...');
  
  // ŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ Firebase
  database.ref('subscriptions/' + activationCode).set({
    students: this.students,
    delays: this.delays,
    absences: this.absences,
    notes: this.notes,
    lastUpdate: Date.now()
  }).then(() => {
    localStorage.setItem('pendingSync', '[]');
    this.showToast('‚úÖ ÿ™ŸÖÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
  }).catch((error) => {
    console.log('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©:', error);
  });
},



setupRealtimeSync(){
const activationCode = localStorage.getItem('activationCode');
if(!activationCode || !activationCode.startsWith('SK-')) return;

database.ref('subscriptions/' + activationCode).on('value', (snapshot) => {
  const data = snapshot.val();
  if(data && data.lastUpdate && data.lastUpdate !== this.lastUpdate){
    this.lastUpdate = data.lastUpdate;
    this.students = data.students || [];
    this.delays = data.delays || {};
    this.absences = data.absences || {};
    this.notes = data.notes || {};
    this.renderStudents();
    this.showToast('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
  }
});
},

lastUpdate: 0,

loadData(){
const activationCode = localStorage.getItem('activationCode');

if(!activationCode || !activationCode.startsWith('SK-')){
  // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿ≠ŸÑŸäÿßŸã
  this.students=JSON.parse(localStorage.getItem('students')||'[]');
  this.delays=JSON.parse(localStorage.getItem('delays')||'{}');
  this.absences=JSON.parse(localStorage.getItem('absences')||'{}');
  this.notes=JSON.parse(localStorage.getItem('notes')||'{}');
  return;
}

// ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
database.ref('subscriptions/' + activationCode).once('value').then((snapshot) => {
  const data = snapshot.val();
  if(data){
    this.students = data.students || [];
    this.delays = data.delays || {};
    this.absences = data.absences || {};
    this.notes = data.notes || {};

    // ÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸäÿßŸã
    localStorage.setItem('students',JSON.stringify(this.students));
    localStorage.setItem('delays',JSON.stringify(this.delays));
    localStorage.setItem('absences',JSON.stringify(this.absences));
    localStorage.setItem('notes',JSON.stringify(this.notes));

    this.renderStudents();
  }else{
    // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©ÿå ÿ≠ŸÖŸëŸÑ ŸÖÿ≠ŸÑŸäÿßŸã
    this.students=JSON.parse(localStorage.getItem('students')||'[]');
    this.delays=JSON.parse(localStorage.getItem('delays')||'{}');
    this.absences=JSON.parse(localStorage.getItem('absences')||'{}');
    this.notes=JSON.parse(localStorage.getItem('notes')||'{}');
  }
}).catch((error)=>{
  console.log('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ:', error);
  // ŸÅŸä ÿ≠ÿßŸÑ ÿßŸÑÿÆÿ∑ÿ£ÿå ÿ≠ŸÖŸëŸÑ ŸÖÿ≠ŸÑŸäÿßŸã
  this.students=JSON.parse(localStorage.getItem('students')||'[]');
  this.delays=JSON.parse(localStorage.getItem('delays')||'{}');
  this.absences=JSON.parse(localStorage.getItem('absences')||'{}');
  this.notes=JSON.parse(localStorage.getItem('notes')||'{}');
});
},

saveData(){
  // ÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸä
  localStorage.setItem('students',JSON.stringify(this.students));
  localStorage.setItem('delays',JSON.stringify(this.delays));
  localStorage.setItem('absences',JSON.stringify(this.absences));
  localStorage.setItem('notes',JSON.stringify(this.notes));
  localStorage.setItem('subscriptions',JSON.stringify(this.subscriptions));
  
  // ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ŸÅŸä Firebase
  const code = localStorage.getItem('activationCode');
  if(code && typeof database !== 'undefined'){
    const deviceId = this.getDeviceId();
    database.ref('backups/' + deviceId).set({
      code: code,
      students: this.students,
      delays: this.delays,
      absences: this.absences,
      notes: this.notes,
      lastBackup: new Date().toISOString(),
      studentCount: this.students.length
    }).catch(error => console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä:', error));
  }
},



setToday(){
const today=new Date().toISOString().split('T')[0];
['dateMorning','dateBreak','dateDeparture','dateAbsence','dateNote'].forEach(id=>{
const el=document.getElementById(id);
if(el)el.value=today;
});

    
},

setupEvents(){
const self=this;

document.getElementById('searchInput').addEventListener('input',function(e){
const q=e.target.value.toLowerCase();
if(!q){
document.getElementById('studentsList').innerHTML='';
document.getElementById('emptyState').style.display='block';
return;
}
document.getElementById('emptyState').style.display='none';
const filtered=self.students.filter(s=>
s.name.toLowerCase().includes(q)||s.phone.includes(q)||s.class.toLowerCase().includes(q)
);
self.renderStudents(filtered);
});

['Morning','Break','Departure','Absence','Note'].forEach(t=>{
const search=document.getElementById('search'+t);
if(search)search.addEventListener('input',function(){self.filterList(t.toLowerCase());});
const cls=document.getElementById('class'+t);
if(cls)cls.addEventListener('change',function(){self.filterList(t.toLowerCase());});
const clsr=document.getElementById('classroom'+t);
if(clsr)clsr.addEventListener('change',function(){self.filterList(t.toLowerCase());});
});

const views=['DelayView','AbsenceView','NoteView'];
views.forEach(v=>{
const el=document.getElementById('search'+v);
if(el)el.addEventListener('input',function(){
if(v==='DelayView')self.renderDelayView();
else if(v==='AbsenceView')self.renderAbsenceView();
else if(v==='NoteView')self.renderNoteView();
});
});

const noteTextarea=document.getElementById('noteTextarea');
if(noteTextarea){
noteTextarea.addEventListener('input',function(e){
document.getElementById('noteCharCount').textContent=e.target.value.length;
});
}

const excelFile=document.getElementById('excelFile');
if(excelFile){
excelFile.addEventListener('change',function(e){self.importExcel(e);});
}
},

renderStudents(list=[]){
const ul=document.getElementById('studentsList');
ul.innerHTML=list.map((s,i)=>{
const idx=this.students.indexOf(s);
const dCount=(this.delays[s.civil]||[]).length;
const aCount=(this.absences[s.civil]||[]).length;
const nCount=(this.notes[s.civil]||[]).length;
let badges='';
if(dCount>0)badges+=`<span class="badge delay">${dCount} ÿ™ÿ£ÿÆÿ±</span>`;
if(aCount>0)badges+=`<span class="badge absence">${aCount} ÿ∫Ÿäÿßÿ®</span>`;
if(nCount>0)badges+=`<span class="badge note">${nCount} ŸÖŸÑÿßÿ≠ÿ∏ÿ©</span>`;
return`<li class="student-item" onclick="app.showStudent(${idx})">
<div class="student-name">${badges}${s.name}</div>
<div style="font-size:15px;color:#666;margin-top:4px">${s.class} - ${s.classroom} | üìû ${s.phone}</div>
</li>`;
}).join('');
},

populateFilters() {
  // ÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã
  if (!this.students || this.students.length === 0) {
    console.log('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ∑ŸÑÿßÿ®');
    return;
  }
  
  const classes = [...new Set(this.students.map(s => s.class))].filter(c => c).sort();
  const classrooms = [...new Set(this.students.map(s => s.classroom))].filter(c => c).sort();
  
  ['Morning', 'Break', 'Departure', 'Absence', 'Note'].forEach(t => {
    const cls = document.getElementById(`class${t}`);
    const clsr = document.getElementById(`classroom${t}`);
    
    if (cls) {
      // ÿßÿ≠ÿ∞ŸÅ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ£ŸàŸÑÿßŸã
      cls.innerHTML = '';
      
      // ÿ£ÿ∂ŸÅ ÿßŸÑÿÆŸäÿßÿ± ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'ÿßŸÑŸÉŸÑ';
      cls.appendChild(defaultOption);
      
      // ÿ£ÿ∂ŸÅ ÿßŸÑÿµŸÅŸàŸÅ
      classes.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        cls.appendChild(option);
      });
    }
    
    if (clsr) {
      // ÿßÿ≠ÿ∞ŸÅ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ£ŸàŸÑÿßŸã
      clsr.innerHTML = '';
      
      // ÿ£ÿ∂ŸÅ ÿßŸÑÿÆŸäÿßÿ± ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'ÿßŸÑŸÉŸÑ';
      clsr.appendChild(defaultOption);
      
      // ÿ£ÿ∂ŸÅ ÿßŸÑŸÅÿµŸàŸÑ
      classrooms.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        clsr.appendChild(option);
      });
    }
  });
  
  // ÿ•ÿ¨ÿ®ÿßÿ± Safari ÿπŸÑŸâ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ±ÿ≥ŸÖ (ŸÖŸáŸÖ ÿ¨ÿØÿßŸã ŸÑŸÄ iOS)
  setTimeout(() => {
    document.querySelectorAll('.filter-select').forEach(select => {
      select.style.display = 'none';
      select.offsetHeight; // Force reflow
      select.style.display = '';
    });
  }, 100);
},


renderList(type){
const list=document.getElementById('list'+type.charAt(0).toUpperCase()+type.slice(1));
const key=type==='absence'?'absence':type==='note'?'note':type;
list.innerHTML=this.students.map((s,i)=>{
const idx=this.students.indexOf(s);
const checked=this.selected[key].has(idx)?'checked':'';
return`<li class="student-item">
<label style="display:flex;align-items:center;gap:12px;cursor:pointer">
<input type="checkbox" ${checked} onchange="app.toggleStudent('${key}',${idx})" style="width:22px;height:22px;cursor:pointer">
<div style="flex:1">
<div style="font-weight:600;font-size:16px">${s.name}</div>
<div style="font-size:14px;color:#666;margin-top:3px">${s.class} - ${s.classroom}</div>
</div>
</label>
</li>`;
}).join('');
this.updateCount(key);
},

filterList(type){
const T=type.charAt(0).toUpperCase()+type.slice(1);
const search=document.getElementById('search'+T).value.toLowerCase();
const cls=document.getElementById('class'+T).value;
const clsr=document.getElementById('classroom'+T).value;
const filtered=this.students.filter(s=>{
const matchSearch=!search||s.name.toLowerCase().includes(search);
const matchClass=!cls||s.class===cls;
const matchClassroom=!clsr||s.classroom===clsr;
return matchSearch&&matchClass&&matchClassroom;
});
const list=document.getElementById('list'+T);
const key=type==='absence'?'absence':type==='note'?'note':type;
list.innerHTML=filtered.map((s)=>{
const idx=this.students.indexOf(s);
const checked=this.selected[key].has(idx)?'checked':'';
return`<li class="student-item">
<label style="display:flex;align-items:center;gap:12px;cursor:pointer">
<input type="checkbox" ${checked} onchange="app.toggleStudent('${key}',${idx})" style="width:22px;height:22px;cursor:pointer">
<div style="flex:1">
<div style="font-weight:600;font-size:16px">${s.name}</div>
<div style="font-size:14px;color:#666;margin-top:3px">${s.class} - ${s.classroom}</div>
</div>
</label>
</li>`;
}).join('');
},

toggleStudent(key,idx){
this.selected[key].has(idx)?this.selected[key].delete(idx):this.selected[key].add(idx);
this.updateCount(key);
this.updateActions();
},

updateCount(key){
const T=key==='absence'?'Absence':key==='note'?'Note':key.charAt(0).toUpperCase()+key.slice(1);
const div=document.getElementById('count'+T);
const count=this.selected[key].size;
if(count>0){
div.classList.remove('hidden');
div.querySelector('span').textContent=count;
}else{
div.classList.add('hidden');
}
},

updateActions(){
const page=document.querySelector('.page.active').id;
if(page==='delaysPage'){
const key=this.currentTab.delay;
const actions=document.getElementById('delayActions');
this.selected[key].size>0&&this.currentTab.delay!=='view'?actions.classList.add('show'):actions.classList.remove('show');
}else if(page==='absencesPage'){
const actions=document.getElementById('absenceActions');
this.selected.absence.size>0&&this.currentTab.absence!=='view'?actions.classList.add('show'):actions.classList.remove('show');
}else if(page==='notesPage'){
const actions=document.getElementById('noteActions');
this.selected.note.size>0&&this.currentTab.notes!=='view'?actions.classList.add('show'):actions.classList.remove('show');
}
},

showPage(page){
document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
const pages=['main','delays','absences','notes','stats','settings'];
const idx=pages.indexOf(page);
document.getElementById(page+'Page').classList.add('active');
document.querySelectorAll('.nav-item')[idx].classList.add('active');
if(page==='delays')this.renderList(this.currentTab.delay);
if(page==='absences')this.currentTab.absence==='daily'?this.renderList('absence'):this.renderAbsenceView();
if(page==='notes')this.currentTab.notes==='add'?this.renderList('note'):this.renderNoteView();
if(page==='stats'){
this.currentTab.stats='daily';
// ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™
document.querySelectorAll('#statsPage .tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('#statsPage .tab-content').forEach(c=>c.classList.remove('active'));
document.querySelector('#statsPage .tab').classList.add('active');
document.getElementById('statsDailyTab').classList.add('active');
this.updateAllStats();
}

this.updateActions();
},

switchTab(page,tab){
const container=page==='delays'?'delaysPage':page==='absence'?'absencesPage':page==='notes'?'notesPage':'statsPage';
document.querySelectorAll(`#${container} .tab`).forEach(t=>t.classList.remove('active'));
document.querySelectorAll(`#${container} .tab-content`).forEach(t=>t.classList.remove('active'));
event.target.classList.add('active');
if(page==='delays'){
this.currentTab.delay=tab;
document.getElementById('delay'+tab.charAt(0).toUpperCase()+tab.slice(1)+'Tab').classList.add('active');
if(tab==='view')this.renderDelayView();
else this.renderList(tab);
}else if(page==='absence'){
this.currentTab.absence=tab;
document.getElementById('absence'+tab.charAt(0).toUpperCase()+tab.slice(1)+'Tab').classList.add('active');
if(tab==='view')this.renderAbsenceView();
else this.renderList('absence');

}else if(page==='notes'){
this.currentTab.notes=tab;
document.getElementById('note'+tab.charAt(0).toUpperCase()+tab.slice(1)+'Tab').classList.add('active');
if(tab==='view')this.renderNoteView();
else this.renderList('note');
}else if(page==='stats'){

this.currentTab.stats=tab;
document.querySelectorAll('#statsPage .tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('#statsPage .tab-content').forEach(c=>c.classList.remove('active'));
event.target.classList.add('active');
document.getElementById('stats'+tab.charAt(0).toUpperCase()+tab.slice(1)+'Tab').classList.add('active');
this.updateAllStats();
}
this.updateActions();
},

confirmAction(action){
  if(action==='saveDelay'||action==='saveAndSendDelay'||action==='sendDelay'){
    const key=this.currentTab.delay;
    const count=this.selected[key].size;
    if(count===0)return this.showToast('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£Ÿä ÿ∑ÿßŸÑÿ®');
    let msg='';
    if(action==='saveDelay')msg=`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ŸÅÿ∏ ÿ™ÿ£ÿÆÿ± ${count} ÿ∑ÿßŸÑÿ®ÿü`;
    else if(action==='saveAndSendDelay')msg=`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ŸÅÿ∏ Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÄ ${count} ÿ∑ÿßŸÑÿ®ÿü`;
    else msg=`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÄ ${count} ÿ∑ÿßŸÑÿ®ÿü`;
    this.showConfirm(msg,()=>{
      if(action==='saveDelay'){
        this.saveDelay();
        this.clearSelection('delay');
      }
      else if(action==='saveAndSendDelay'){
        this.saveDelay();
        setTimeout(()=>{
          this.sendDelay();
          setTimeout(()=>this.clearSelection('delay'),1000);
        },500);
      }
      else this.sendDelay();
    });
  }else if(action==='saveAbsence'||action==='saveAndSendAbsence'||action==='sendAbsence'){
    const count=this.selected.absence.size;
    if(count===0)return this.showToast('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£Ÿä ÿ∑ÿßŸÑÿ®');
    let msg='';
    if(action==='saveAbsence')msg=`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ŸÅÿ∏ ÿ∫Ÿäÿßÿ® ${count} ÿ∑ÿßŸÑÿ®ÿü`;
    else if(action==='saveAndSendAbsence')msg=`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ŸÅÿ∏ Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÄ ${count} ÿ∑ÿßŸÑÿ®ÿü`;
    else msg=`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÄ ${count} ÿ∑ÿßŸÑÿ®ÿü`;
    this.showConfirm(msg,()=>{
      if(action==='saveAbsence'){
        this.saveAbsence();
        this.clearSelection('absence');
      }
      else if(action==='saveAndSendAbsence'){
        this.saveAbsence();
        setTimeout(()=>{
          this.sendAbsence();
          setTimeout(()=>this.clearSelection('absence'),1000);
        },500);
      }
      else this.sendAbsence();
    });
  }else if(action==='saveNote'||action==='saveAndSendNote'||action==='sendNote'){
    const count=this.selected.note.size;
    if(count===0)return this.showToast('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£Ÿä ÿ∑ÿßŸÑÿ®');
    
    // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÅŸÇÿ∑ ŸÑŸÑÿ≠ŸÅÿ∏ ÿ£Ÿà ÿßŸÑÿ≠ŸÅÿ∏+ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ
    if(action==='saveNote'||action==='saveAndSendNote'){
      const noteText=document.getElementById('noteTextarea').value.trim();
      if(!noteText)return this.showToast('‚ö†Ô∏è Ÿäÿ¨ÿ® ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ£ŸàŸÑÿßŸã');
    }
    
    let msg='';
    if(action==='saveNote')msg=`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ŸÅÿ∏ ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÑŸÄ ${count} ÿ∑ÿßŸÑÿ®ÿü`;
    else if(action==='saveAndSendNote')msg=`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ŸÅÿ∏ Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÑŸÄ ${count} ÿ∑ÿßŸÑÿ®ÿü`;
    else msg=`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÑŸÄ ${count} ÿ∑ÿßŸÑÿ®ÿü`;
    this.showConfirm(msg,()=>{
      if(action==='saveNote'){
        this.saveNote();
        this.clearSelection('note');
      }
      else if(action==='saveAndSendNote'){
        this.saveNote();
        setTimeout(()=>{
          this.sendNote();
          setTimeout(()=>this.clearSelection('note'),1000);
        },500);
      }
      else this.sendNote();
    });
  }else if(action==='reset'){
    this.showConfirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ™ÿ£ÿÆÿ±ÿßÿ™ ŸàÿßŸÑÿ∫Ÿäÿßÿ® ŸàÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ÿü\nŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.',()=>this.resetApp());
  }
},


saveDelay(){
  const key = this.currentTab.delay;
  const T = key.charAt(0).toUpperCase() + key.slice(1);
  const date = new Date(document.getElementById(`date${T}`).value).toLocaleDateString('ar-SA');
  const typeName = key === 'morning' ? 'ÿ™ÿ£ÿÆÿ± ÿµÿ®ÿßÿ≠Ÿä' : key === 'break' ? 'ÿ™ÿ£ÿÆÿ± ÿ®ÿπÿØ ÿßŸÑŸÅÿ≥ÿ≠ÿ©' : 'ÿ™ÿ£ÿÆÿ± ÿßŸÑÿßŸÜÿµÿ±ÿßŸÅ';
  
  this.selected[key].forEach(i => {
    const civil = this.students[i].civil;
    if(!this.delays[civil]) this.delays[civil] = [];
    this.delays[civil].push({type: typeName, date});
  });
  
  // ŸÑÿß ÿ™ŸÖÿ≥ÿ≠ selected ŸáŸÜÿß - ÿ≥ŸÜŸÖÿ≥ÿ≠Ÿáÿß ÿ®ÿπÿØ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ
  // this.selected[key].clear(); ‚Üê ÿßÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ±
  
  this.renderList(key);
  this.saveData();
  this.showToast('‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏');
},

saveAbsence(){
const date=new Date(document.getElementById('dateAbsence').value).toLocaleDateString('ar-SA');
this.selected.absence.forEach(i=>{
const civil=this.students[i].civil;
if(!this.absences[civil])this.absences[civil]=[];
this.absences[civil].push({date});
});
//this.selected.absence.clear();
this.renderList('absence');
this.saveData();
this.updateActions();
this.showToast('‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ®ŸÜÿ¨ÿßÿ≠');
},

saveNote(){
  const noteText=document.getElementById('noteTextarea').value.trim();
  
  // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÜÿµ
  if(!noteText) {
    this.showToast('‚ö†Ô∏è Ÿäÿ¨ÿ® ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ£ŸàŸÑÿßŸã');
    return;
  }
  
  const date=new Date(document.getElementById('dateNote').value).toLocaleDateString('ar-SA');
  this.selected.note.forEach(i=>{
    const civil=this.students[i].civil;
    if(!this.notes[civil])this.notes[civil]=[];
    this.notes[civil].push({text:noteText,date});
  });
  
  // ŸÑÿß ÿ™ŸÖÿ≥ÿ≠ selected ŸáŸÜÿß - ÿ≥Ÿäÿ™ŸÖ ÿßŸÑŸÖÿ≥ÿ≠ ŸÅŸä clearSelection ÿ®ÿπÿØ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ
  // this.selected.note.clear();
  
  document.getElementById('noteTextarea').value='';
  document.getElementById('noteCharCount').textContent='0';
  this.renderList('note');
  this.saveData();
  this.updateActions();
  this.showToast('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
},

sendDelay(){
  const key = this.currentTab.delay;
  const selected = Array.from(this.selected[key]);
  if(selected.length === 0) {
    this.showToast('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£Ÿä ÿ∑ÿßŸÑÿ®');
    return;
  }
  
  const typeName = key === 'morning' ? 'ÿ™ÿ£ÿÆÿ± ÿµÿ®ÿßÿ≠Ÿä' : key === 'break' ? 'ÿ™ÿ£ÿÆÿ± ÿ®ÿπÿØ ÿßŸÑŸÅÿ≥ÿ≠ÿ©' : 'ÿ™ÿ£ÿÆÿ± ÿßŸÑÿßŸÜÿµÿ±ÿßŸÅ';
  
  selected.forEach((i, index) => {
    const student = this.students[i];
    const phone = student.parentPhone || student.phone;
    
    if(!phone) {
      this.showToast(`‚ö†Ô∏è ${student.name}: ŸÑÿß ŸäŸàÿ¨ÿØ ÿ±ŸÇŸÖ ÿ¨ŸàÿßŸÑ ŸÖÿ≥ÿ¨ŸÑ`);
      return;
    }
    
    // ÿµŸäÿßÿ∫ÿ© ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
    const message = `ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá\n\n` +
                    `ÿπÿ≤Ÿäÿ≤Ÿä ŸàŸÑŸä ÿ£ŸÖÿ± ÿßŸÑÿ∑ÿßŸÑÿ®/ÿ©: *${student.name}*\n\n` +
                    `ŸÜŸàÿØ ÿ•ÿπŸÑÿßŸÖŸÉŸÖ ÿ®ÿ£ŸÜ ÿßÿ®ŸÜŸÉŸÖ/ÿßÿ®ŸÜÿ™ŸÉŸÖ ÿ≥ÿ¨ŸÑ *${typeName}*\n\n` +
                    `üìÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${new Date().toLocaleDateString('ar-SA')}\n` +
                    `üïê ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'})}\n\n` +
                    `ŸÜÿ£ŸÖŸÑ ŸÖŸÜŸÉŸÖ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ŸàÿßŸÑÿ™ÿπÿßŸàŸÜ\n\n` +
                    `_ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ÿßŸÑÿ∞ŸÉŸä_`;
    
    // ÿ™ŸÜÿ∏ŸäŸÅ ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ (ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ŸàÿßŸÑÿ±ŸÖŸàÿ≤)
    let phoneNumber = phone.replace(/\D/g, '');
    
    // ÿ•ÿ∂ÿßŸÅÿ© ŸÉŸàÿØ ÿßŸÑÿ≥ÿπŸàÿØŸäÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ±ŸÇŸÖ Ÿäÿ®ÿØÿ£ ÿ®ŸÄ 05
    if(phoneNumber.startsWith('05')) {
      phoneNumber = '966' + phoneNumber.substring(1);
    }
    
    // ŸÅÿ™ÿ≠ Ÿàÿßÿ™ÿ≥ÿßÿ® ŸÖÿπ ÿ™ÿ£ÿÆŸäÿ± (3 ÿ´ŸàÿßŸÜŸä ÿ®ŸäŸÜ ŸÉŸÑ ÿ±ÿ≥ÿßŸÑÿ©)
    setTimeout(() => {
      window.open(`https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`, '_blank');
    }, index * 3000);
  });
  
  this.showToast(`‚úÖ ÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ${selected.length} ŸÖÿ≠ÿßÿØÿ´ÿ© Ÿàÿßÿ™ÿ≥ÿßÿ® ÿ®ÿπÿØ ŸÇŸÑŸäŸÑ`);
},


sendAbsence(){
  const selected = Array.from(this.selected.absence);
  if(selected.length === 0) {
    this.showToast('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£Ÿä ÿ∑ÿßŸÑÿ®');
    return;
  }
  
  selected.forEach((i, index) => {
    const student = this.students[i];
    const phone = student.parentPhone || student.phone;
    
    if(!phone) {
      this.showToast(`‚ö†Ô∏è ${student.name}: ŸÑÿß ŸäŸàÿ¨ÿØ ÿ±ŸÇŸÖ ÿ¨ŸàÿßŸÑ ŸÖÿ≥ÿ¨ŸÑ`);
      return;
    }
    
    // ÿµŸäÿßÿ∫ÿ© ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
    const message = `ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá\n\n` +
                    `ÿπÿ≤Ÿäÿ≤Ÿä ŸàŸÑŸä ÿ£ŸÖÿ± ÿßŸÑÿ∑ÿßŸÑÿ®/ÿ©: *${student.name}*\n\n` +
                    `ŸÜŸàÿØ ÿ•ÿπŸÑÿßŸÖŸÉŸÖ ÿ®ÿ£ŸÜ ÿßÿ®ŸÜŸÉŸÖ/ÿßÿ®ŸÜÿ™ŸÉŸÖ *ÿ∫ÿßÿ¶ÿ®/ÿ© ÿßŸÑŸäŸàŸÖ*\n\n` +
                    `üìÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${new Date().toLocaleDateString('ar-SA')}\n\n` +
                    `ŸÜÿ£ŸÖŸÑ ŸÖŸÜŸÉŸÖ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ŸàÿßŸÑÿßÿ∑ŸÖÿ¶ŸÜÿßŸÜ ÿπŸÑŸâ ÿßŸÑÿ∑ÿßŸÑÿ®/ÿ©\n\n` +
                    `_ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ÿßŸÑÿ∞ŸÉŸä_`;
    
    // ÿ™ŸÜÿ∏ŸäŸÅ ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ
    let phoneNumber = phone.replace(/\D/g, '');
    
    // ÿ•ÿ∂ÿßŸÅÿ© ŸÉŸàÿØ ÿßŸÑÿ≥ÿπŸàÿØŸäÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ±ŸÇŸÖ Ÿäÿ®ÿØÿ£ ÿ®ŸÄ 05
    if(phoneNumber.startsWith('05')) {
      phoneNumber = '966' + phoneNumber.substring(1);
    }
    
    // ŸÅÿ™ÿ≠ Ÿàÿßÿ™ÿ≥ÿßÿ® ŸÖÿπ ÿ™ÿ£ÿÆŸäÿ± (3 ÿ´ŸàÿßŸÜŸä ÿ®ŸäŸÜ ŸÉŸÑ ÿ±ÿ≥ÿßŸÑÿ©)
    setTimeout(() => {
      window.open(`https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`, '_blank');
    }, index * 3000);
  });
  
  this.showToast(`‚úÖ ÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ${selected.length} ŸÖÿ≠ÿßÿØÿ´ÿ© Ÿàÿßÿ™ÿ≥ÿßÿ® ÿ®ÿπÿØ ŸÇŸÑŸäŸÑ`);
},


 sendNote(){
  const selected = Array.from(this.selected.note);
  
  if(selected.length === 0) {
    this.showToast('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ£Ÿä ÿ∑ÿßŸÑÿ®');
    return;
  }
  
  // ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿßŸÑŸÜÿµ ŸÖŸÜ ÿ¢ÿÆÿ± ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ£Ÿà ŸÖŸÜ textarea
  let noteText = document.getElementById('noteTextarea').value.trim();
  
  // ÿ•ÿ∞ÿß ŸÉÿßŸÜ textarea ŸÅÿßÿ±ÿ∫ÿå ÿÆÿ∞ ÿßŸÑŸÜÿµ ŸÖŸÜ ÿ¢ÿÆÿ± ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©
  if(!noteText && selected.length > 0) {
    const firstStudent = this.students[selected[0]];
    const civil = firstStudent.civil;
    if(this.notes[civil] && this.notes[civil].length > 0) {
      noteText = this.notes[civil][this.notes[civil].length - 1].text;
    }
  }
  
  if(!noteText) {
    this.showToast('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÑŸÑÿ•ÿ±ÿ≥ÿßŸÑ');
    return;
  }
  
  selected.forEach((i, index) => {
    const student = this.students[i];
    const phone = student.parentPhone || student.phone;
    
    if(!phone) {
      this.showToast(`‚ö†Ô∏è ${student.name}: ŸÑÿß ŸäŸàÿ¨ÿØ ÿ±ŸÇŸÖ ÿ¨ŸàÿßŸÑ ŸÖÿ≥ÿ¨ŸÑ`);
      return;
    }
    
    // ÿµŸäÿßÿ∫ÿ© ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
    const message = `ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá\n\n` +
                    `ÿπÿ≤Ÿäÿ≤Ÿä ŸàŸÑŸä ÿ£ŸÖÿ± ÿßŸÑÿ∑ÿßŸÑÿ®/ÿ©: *${student.name}*\n\n` +
                    `üìù *ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÖŸáŸÖÿ©:*\n` +
                    `${noteText}\n\n` +
                    `üìÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${new Date().toLocaleDateString('ar-SA')}\n\n` +
                    `ŸÜÿ¥ŸÉÿ± ŸÑŸÉŸÖ ÿ™ÿπÿßŸàŸÜŸÉŸÖ\n\n` +
                    `_ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ÿßŸÑÿ∞ŸÉŸä_`;
    
    // ÿ™ŸÜÿ∏ŸäŸÅ ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ
    let phoneNumber = phone.replace(/\D/g, '');
    
    // ÿ•ÿ∂ÿßŸÅÿ© ŸÉŸàÿØ ÿßŸÑÿ≥ÿπŸàÿØŸäÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ±ŸÇŸÖ Ÿäÿ®ÿØÿ£ ÿ®ŸÄ 05
    if(phoneNumber.startsWith('05')) {
      phoneNumber = '966' + phoneNumber.substring(1);
    }
    
    // ŸÅÿ™ÿ≠ Ÿàÿßÿ™ÿ≥ÿßÿ® ŸÖÿπ ÿ™ÿ£ÿÆŸäÿ± (3 ÿ´ŸàÿßŸÜŸä ÿ®ŸäŸÜ ŸÉŸÑ ÿ±ÿ≥ÿßŸÑÿ©)
    setTimeout(() => {
      window.open(`https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`, '_blank');
    }, index * 3000);
  });
  
  this.showToast(`‚úÖ ÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ${selected.length} ŸÖÿ≠ÿßÿØÿ´ÿ© Ÿàÿßÿ™ÿ≥ÿßÿ® ÿ®ÿπÿØ ŸÇŸÑŸäŸÑ`);
},
   
    
    clearSelection(type){
  if(type === 'delay'){
    const key = this.currentTab.delay;
    this.selected[key].clear();
    this.renderList(key);
  } else if(type === 'absence'){
    this.selected.absence.clear();
    this.renderList('absence');
  } else if(type === 'note'){
    this.selected.note.clear();
    this.renderList('note');
  }
  this.updateActions();
},



renderDelayView(){
const search=document.getElementById('searchDelayView').value.toLowerCase();
const all=[];
for(const civil in this.delays){
const s=this.students.find(st=>st.civil===civil);
if(s&&(!search||s.name.toLowerCase().includes(search))){
this.delays[civil].forEach((d,i)=>all.push({s,d,civil,i}));
}
}
all.sort((a,b)=>new Date(b.d.date)-new Date(a.d.date));
const div=document.getElementById('delayViewList');
if(all.length===0){
div.innerHTML='<div style="text-align:center;padding:50px;color:#999;font-size:15px">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ£ÿÆÿ±ÿßÿ™</div>';
return;
}
div.innerHTML=all.map(item=>`
<div class="record-item" style="border-right:4px solid #ff9800;padding:14px;display:flex;justify-content:space-between;align-items:center">
<div style="flex:1">
<div style="font-weight:600;color:#e65100;font-size:15px">${item.s.name}</div>
<div style="font-size:13px;color:#666;margin-top:4px">${item.d.type} - üìÖ ${item.d.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteRecord('delay','${item.civil}',${item.i})">üóëÔ∏è</button>
</div>
`).join('');
},

renderAbsenceView(){
const search=document.getElementById('searchAbsenceView').value.toLowerCase();
const all=[];
for(const civil in this.absences){
const s=this.students.find(st=>st.civil===civil);
if(s&&(!search||s.name.toLowerCase().includes(search))){
this.absences[civil].forEach((a,i)=>all.push({s,a,civil,i}));
}
}
all.sort((a,b)=>new Date(b.a.date)-new Date(a.a.date));
const div=document.getElementById('absenceViewList');
if(all.length===0){
div.innerHTML='<div style="text-align:center;padding:50px;color:#999;font-size:15px">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∫Ÿäÿßÿ®</div>';
return;
}
div.innerHTML=all.map(item=>`
<div class="record-item" style="border-right:4px solid #f44336;padding:14px;display:flex;justify-content:space-between;align-items:center">
<div style="flex:1">
<div style="font-weight:600;color:#c62828;font-size:15px">${item.s.name}</div>
<div style="font-size:13px;color:#666;margin-top:4px">ÿ∫Ÿäÿßÿ® ŸäŸàŸÖŸä - üìÖ ${item.a.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteRecord('absence','${item.civil}',${item.i})">üóëÔ∏è</button>
</div>
`).join('');
},

renderNoteView(){
const search=document.getElementById('searchNoteView').value.toLowerCase();
const all=[];
for(const civil in this.notes){
const s=this.students.find(st=>st.civil===civil);
if(s&&(!search||s.name.toLowerCase().includes(search))){
this.notes[civil].forEach((n,i)=>all.push({s,n,civil,i}));
}
}
all.sort((a,b)=>new Date(b.n.date)-new Date(a.n.date));
const div=document.getElementById('noteViewList');
if(all.length===0){
div.innerHTML='<div style="text-align:center;padding:50px;color:#999;font-size:15px">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</div>';
return;
}
div.innerHTML=all.map(item=>`
<div class="record-item" style="border-right:4px solid #00897b;padding:14px">
<div class="record-item-header">
<div style="flex:1">
<div style="font-weight:600;color:#00695c;font-size:15px">${item.s.name}</div>
<div style="font-size:13px;color:#666;margin-top:4px">üìÖ ${item.n.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteRecord('note','${item.civil}',${item.i})">üóëÔ∏è</button>
</div>
<div class="record-note-text">${item.n.text}</div>
</div>
`).join('');
},

deleteRecord(type,civil,idx){
if(!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ¨ŸÑÿü'))return;
if(type==='delay'){
this.delays[civil].splice(idx,1);
if(this.delays[civil].length===0)delete this.delays[civil];
this.renderDelayView();
}else if(type==='absence'){
this.absences[civil].splice(idx,1);
if(this.absences[civil].length===0)delete this.absences[civil];
this.renderAbsenceView();
}else if(type==='note'){
this.notes[civil].splice(idx,1);
if(this.notes[civil].length===0)delete this.notes[civil];
this.renderNoteView();
}
this.saveData();
this.showToast('‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ');
},

showStudent(idx){
const s=this.students[idx];
const delays=this.delays[s.civil]||[];
const absences=this.absences[s.civil]||[];
const notes=this.notes[s.civil]||[];
const modal=document.getElementById('studentModal');
const body=document.getElementById('modalBody');
body.innerHTML=`
<div style="margin-bottom:18px">
<div style="margin:12px 0;padding:12px 0;border-bottom:1px solid #f0f0f0">
<strong style="color:#666;font-size:15px">üë§ ÿßŸÑÿßÿ≥ŸÖ:</strong> <span style="font-size:16px">${s.name}</span>
</div>
<div style="margin:12px 0;padding:12px 0;border-bottom:1px solid #f0f0f0">
<strong style="color:#666;font-size:15px">üÜî ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿØŸÜŸä:</strong> <span style="font-size:16px">${s.civil}</span>
</div>
<div style="margin:12px 0;padding:12px 0;border-bottom:1px solid #f0f0f0">
<strong style="color:#666;font-size:15px">üì± ÿßŸÑÿ¨ŸàÿßŸÑ:</strong> <span style="font-size:16px">${s.phone}</span>
</div>
<div style="margin:12px 0;padding:12px 0;border-bottom:1px solid #f0f0f0">
<strong style="color:#666;font-size:15px">üìö ÿßŸÑÿµŸÅ:</strong> <span style="font-size:16px">${s.class}</span>
</div>
<div style="margin:12px 0;padding:12px 0">
<strong style="color:#666;font-size:15px">üè´ ÿßŸÑŸÅÿµŸÑ:</strong> <span style="font-size:16px">${s.classroom}</span>
</div>
</div>
<div class="record-grid">
<div class="record-card delays">
<h4>‚è∞ ÿßŸÑÿ™ÿ£ÿÆÿ±ÿßÿ™ (${delays.length})</h4>
<div class="record-list">
${delays.length>0?delays.map((d,i)=>`
<div class="record-item">
<div class="record-item-header">
<div class="record-info">
<div class="record-type">${d.type}</div>
<div class="record-date">üìÖ ${d.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteFromModal('delay','${s.civil}',${i})">üóëÔ∏è</button>
</div>
</div>
`).join(''):'<div style="text-align:center;color:#4caf50;padding:12px;font-size:13px">‚úÖ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ£ÿÆÿ±ÿßÿ™</div>'}
</div>
</div>
<div class="record-card absences">
<h4>üìÖ ÿßŸÑÿ∫Ÿäÿßÿ® (${absences.length})</h4>
<div class="record-list">
${absences.length>0?absences.map((a,i)=>`
<div class="record-item">
<div class="record-item-header">
<div class="record-info">
<div style="font-weight:600;color:#c62828;font-size:12px">ÿ∫Ÿäÿßÿ® ŸäŸàŸÖŸä</div>
<div class="record-date">üìÖ ${a.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteFromModal('absence','${s.civil}',${i})">üóëÔ∏è</button>
</div>
</div>
`).join(''):'<div style="text-align:center;color:#4caf50;padding:12px;font-size:13px">‚úÖ ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∫Ÿäÿßÿ®</div>'}
</div>
</div>
<div class="record-card notes">
<h4>üìù ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ (${notes.length})</h4>
<div class="record-list">
${notes.length>0?notes.map((n,i)=>`
<div class="record-item">
<div class="record-item-header">
<div class="record-info">
<div class="record-type">ŸÖŸÑÿßÿ≠ÿ∏ÿ©</div>
<div class="record-date">üìÖ ${n.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteFromModal('note','${s.civil}',${i})">üóëÔ∏è</button>
</div>
<div class="record-note-text">${n.text}</div>
</div>
`).join(''):'<div style="text-align:center;color:#4caf50;padding:12px;font-size:13px">‚úÖ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</div>'}
</div>
</div>
</div>
`;
modal.classList.add('active');
},

deleteFromModal(type,civil,idx){
if(!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ¨ŸÑÿü'))return;
if(type==='delay'){
this.delays[civil].splice(idx,1);
if(this.delays[civil].length===0)delete this.delays[civil];
}else if(type==='absence'){
this.absences[civil].splice(idx,1);
if(this.absences[civil].length===0)delete this.absences[civil];
}else if(type==='note'){
this.notes[civil].splice(idx,1);
if(this.notes[civil].length===0)delete this.notes[civil];
}
this.saveData();
this.closeModal();
this.renderStudents();
this.showToast('‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ');
},

closeModal(){
document.getElementById('studentModal').classList.remove('active');
},

showConfirm(msg,onYes){
document.getElementById('confirmMsg').textContent=msg;
document.getElementById('confirmYes').onclick=function(){
app.closeConfirm();
onYes();
};
document.getElementById('confirmModal').classList.add('active');
},

closeConfirm(){
document.getElementById('confirmModal').classList.remove('active');
},

importExcel(e){
const file=e.target.files[0];
if(!file)return;
const reader=new FileReader();
const self=this;
reader.onload=function(ev){
try{
const data=new Uint8Array(ev.target.result);
const wb=XLSX.read(data,{type:'array'});
const sheet=wb.Sheets[wb.SheetNames[0]];
const json=XLSX.utils.sheet_to_json(sheet);
self.students=json.map(r=>({
name:r['ÿßŸÑÿßÿ≥ŸÖ']||r['Name']||'',
civil:String(r['ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿØŸÜŸä']||r['Civil']||''),
phone:String(r['ÿßŸÑÿ¨ŸàÿßŸÑ']||r['Phone']||''),
class:r['ÿßŸÑÿµŸÅ']||r['Class']||'',
classroom:r['ÿßŸÑŸÅÿµŸÑ']||r['Classroom']||''
}));
self.saveData();
self.populateFilters();
self.showToast(`‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${self.students.length} ÿ∑ÿßŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠`);
e.target.value='';
}catch(err){
self.showToast('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ');
}
};
reader.readAsArrayBuffer(file);
},

resetApp(){
localStorage.clear();
this.students=[];
this.delays={};
this.absences={};
this.notes={};
this.selected={morning:new Set(),break:new Set(),departure:new Set(),absence:new Set(),note:new Set()};
document.getElementById('studentsList').innerHTML='';
document.getElementById('noteTextarea').value='';
document.getElementById('noteCharCount').textContent='0';
this.showToast('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
this.showPage('main');
},

showToast(msg){
const toast=document.getElementById('toast');
toast.textContent=msg;
toast.classList.add('show');
setTimeout(function(){toast.classList.remove('show');},3000);
},  

// ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©
subscription: {
    trialDays: 30,
    activationCodes: [],
},

// ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ
checkSubscription(){
  let code = localStorage.getItem('activationCode');
  
  // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸàÿ¨ÿØ ŸÉŸàÿØ - ÿ£ŸÜÿ¥ÿ¶ ÿ™ÿ¨ÿ±ÿ®ÿ© 7 ÿ£ŸäÿßŸÖ
  if(!code){
    code = this.initTrialSubscription();
  }
  
  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ŸÖŸÜ localStorage
  const storedSubs = localStorage.getItem('subscriptions');
  if(storedSubs){
    this.subscriptions = JSON.parse(storedSubs);
  }
  
  const subscription = this.subscriptions[code];
  
  if(!subscription || !subscription.active){
    document.getElementById('lockScreen').style.display = 'flex';
    return false;
  }
  
  const days = this.calculateRemainingDays(subscription.endDate);
  
  // ÿ™ŸÜÿ®ŸäŸáÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©
  if(subscription.isTrial){
    if(days === 2){
      this.showToast('‚è∞ ÿ™ÿ®ŸÇŸâ ŸäŸàŸÖÿßŸÜ ŸÖŸÜ ÿßŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑŸÖÿ¨ÿßŸÜŸäÿ©!', 8000);
    } else if(days === 1){
      this.showToast('üî• ÿ¢ÿÆÿ± ŸäŸàŸÖ! ÿßÿ¥ÿ™ÿ±ŸÉ ÿßŸÑÿ¢ŸÜ ŸÑÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ', 10000);
    } else if(days === 0){
      this.showToast('‚ö†Ô∏è ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©', 5000);
    }
  }
  
  this.updateSubscriptionBadge(days);
  
  if(days <= 0){
    document.getElementById('lockScreen').style.display = 'flex';
    return false;
  }
  
  return true;
},

calculateRemainingDays(endDate){
  const now = new Date();
  const end = new Date(endDate);
  const diff = end - now;
  return Math.ceil(diff / (1000 * 60 * 60 * 24));
},

updateSubscriptionBadge(days){
  const badge = document.getElementById('subscriptionBadge');
  if(!badge) return;
  
  const daysEl = badge.querySelector('.badge-days');
  const labelEl = badge.querySelector('.badge-label');
  
  if(daysEl) daysEl.textContent = days;
  if(labelEl) labelEl.textContent = days === 1 ? 'ŸäŸàŸÖ ŸÖÿ™ÿ®ŸÇŸä' : 'ÿ£ŸäÿßŸÖ ŸÖÿ™ÿ®ŸÇŸäÿ©';
  
  // ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑŸàŸÜ ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©
  badge.classList.remove('trial', 'warning', 'active');
  if(days <= 3){
    badge.classList.add('warning');
  } else if(days <= 7){
    badge.classList.add('trial');
  } else {
    badge.classList.add('active');
  }
},
    async checkExpiredTrials(){
  const deviceId = this.getDeviceId();
  if(typeof database === 'undefined') return;
  
  try {
    const code = localStorage.getItem('activationCode');
    if(!code || !code.includes('TRIAL')) return;
    
    const subscription = this.subscriptions[code];
    if(!subscription) return;
    
    const endDate = new Date(subscription.endDate);
    const now = new Date();
    const daysSinceExpiry = Math.floor((now - endDate) / (1000 * 60 * 60 * 24));
    
    // ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÇÿ®ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ ÿ®ŸÄ 5 ÿ£ŸäÿßŸÖ
    if(daysSinceExpiry === 18){
      this.showToast('‚ö†Ô∏è ÿ™ÿ®ŸÇŸâ 5 ÿ£ŸäÿßŸÖ Ÿàÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸÜŸáÿßÿ¶ŸäÿßŸã! ÿßÿ¥ÿ™ÿ±ŸÉ ÿßŸÑÿ¢ŸÜ.', 15000);
    }
    
    // ÿ≠ÿ∞ŸÅ ÿ®ÿπÿØ 30 ŸäŸàŸÖ
    if(daysSinceExpiry >= 23){
      await database.ref('backups/' + deviceId).remove();
      localStorage.clear();
      alert('‚ö†Ô∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿ®ÿ≥ÿ®ÿ® ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©.\n\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ®ÿØÿ° ŸÖŸÜ ÿ¨ÿØŸäÿØ ÿ®ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ.');
      location.reload();
    }
  } catch(error){
    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÅÿ≠ÿµ ÿßŸÑÿ™ÿ¨ÿßÿ±ÿ®:', error);
  }
},



// ÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿßŸÜÿ± ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©

 updateTrialBanner(days,isActivated){
  const badge=document.getElementById('subscriptionBadge');
  const daysSpan=badge?.querySelector('.badge-days');
  const labelSpan=badge?.querySelector('.badge-label');
  const iconDiv=badge?.querySelector('.badge-icon');
  
  if(!badge) return;
  
  // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ≠ÿßŸÑÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
  badge.classList.remove('trial','active','warning');
  
  if(isActivated){
    // ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÅÿπŸëŸÑ
    iconDiv.textContent='‚úÖ';
    daysSpan.textContent=days;
    labelSpan.textContent='ŸäŸàŸÖ ŸÖÿ™ÿ®ŸÇŸä';
    badge.classList.add('active');
  }else{
    // ŸÅÿ™ÿ±ÿ© ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©
    if(days<=3){
      iconDiv.textContent='‚ö†Ô∏è';
      badge.classList.add('warning');
    }else if(days<=7){
      iconDiv.textContent='‚è∞';
      badge.classList.add('warning');
    }else{
      iconDiv.textContent='üì¶';
      badge.classList.add('trial');
    }
    daysSpan.textContent=days;
    labelSpan.textContent='ŸäŸàŸÖ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä';
  }
  
  badge.style.display='flex';
},
   

// ÿπÿ±ÿ∂ ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇŸÅŸÑ
showLockScreen() {
    const lockScreen = document.getElementById('lockScreen');
    if (lockScreen) {
        lockScreen.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
},

// ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇŸÅŸÑ
hideLockScreen() {
    const lockScreen = document.getElementById('lockScreen');
    if (lockScreen) {
        lockScreen.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
},

// ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ
activateSubscription(){
  let code = document.getElementById('activationCode')?.value?.trim().toUpperCase();
  
  // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸàÿ¨ÿØ ÿßŸÑÿπŸÜÿµÿ±ÿå ÿ¨ÿ±ÿ® ÿßŸÑÿπŸÜÿµÿ± ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
  if(!code){
    code = document.getElementById('activationCodeInput')?.value?.trim().toUpperCase();
  }
  
  if(!code){
    this.showToast('‚ö†Ô∏è ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑ');
    return;
  }
  
  if(!code.startsWith('SK-')){
    this.showToast('‚ö†Ô∏è ÿßŸÑŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ - Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ®ÿØÿ£ ÿ®ŸÄ SK-');
    return;
  }
  
  // ÿ≠ÿØÿØ ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ
  const isTrial = code.includes('TRIAL');
  const endDate = new Date();
  
  if(isTrial){
    endDate.setDate(endDate.getDate() + 7); // 7 ÿ£ŸäÿßŸÖ
  } else {
    endDate.setFullYear(endDate.getFullYear() + 1); // ÿ≥ŸÜÿ© ŸÉÿßŸÖŸÑÿ©
  }
  
  this.subscriptions[code] = {
    active: true,
    startDate: new Date().toISOString(),
    endDate: endDate.toISOString(),
    isTrial: isTrial,
    paid: !isTrial
  };
  
  localStorage.setItem('activationCode', code);
  localStorage.setItem('subscriptions', JSON.stringify(this.subscriptions));
  this.saveData();
  
  // ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇŸÅŸÑ
  document.getElementById('lockScreen').style.display = 'none';
  
  this.showToast('‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßÿ¥ÿ™ÿ±ÿßŸÉŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!', 5000);
  
  setTimeout(() => {
    this.showPage('main');
    location.reload();
  }, 2000);
},



// ÿ•ÿ∂ÿßŸÅÿ© ŸÉŸàÿØ ÿ™ŸÅÿπŸäŸÑ ÿ¨ÿØŸäÿØ (ŸÑŸÑŸÖÿ∑Ÿàÿ±)
addActivationCode(code) {
    this.subscription.activationCodes.push(code.toUpperCase());
    localStorage.setItem('validCodes', JSON.stringify(this.subscription.activationCodes));
},

// ÿØÿßŸÑÿ© ŸÜÿ≥ÿÆ ÿßŸÑŸÜÿµ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©
copyText(text){
if(navigator.clipboard){
navigator.clipboard.writeText(text).then(()=>{
this.showToast('‚úÖ ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ ÿ®ŸÜÿ¨ÿßÿ≠');
}).catch(()=>{
this.showToast('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ');
});
}else{
const textarea=document.createElement('textarea');
textarea.value=text;
textarea.style.position='fixed';
textarea.style.opacity='0';
document.body.appendChild(textarea);
textarea.select();
try{
document.execCommand('copy');
this.showToast('‚úÖ ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ ÿ®ŸÜÿ¨ÿßÿ≠');
}catch(err){
this.showToast('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ');
}
document.body.removeChild(textarea);
}
},

// ŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ÿßŸÑÿ∫Ÿäÿßÿ® (ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿπÿØŸäŸÑ)
levelSettings:{
level1:{min:1,max:5},
level2:{min:6,max:10},
level3:{min:11,max:15},
level4:{min:16,max:20}
},

// ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™
loadLevelSettings(){
const stored=localStorage.getItem('levelSettings');
if(stored){
this.levelSettings=JSON.parse(stored);
this.applyLevelSettings();
}
},

// ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≠ŸÇŸàŸÑ
applyLevelSettings(){
document.getElementById('level1Min').value=this.levelSettings.level1.min;
document.getElementById('level1Max').value=this.levelSettings.level1.max;
document.getElementById('level2Min').value=this.levelSettings.level2.min;
document.getElementById('level2Max').value=this.levelSettings.level2.max;
document.getElementById('level3Min').value=this.levelSettings.level3.min;
document.getElementById('level3Max').value=this.levelSettings.level3.max;
document.getElementById('level4Min').value=this.levelSettings.level4.min;
document.getElementById('level4Max').value=this.levelSettings.level4.max;
},

// ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™
saveLevelSettings(){
this.levelSettings={
level1:{
min:parseInt(document.getElementById('level1Min').value),
max:parseInt(document.getElementById('level1Max').value)
},
level2:{
min:parseInt(document.getElementById('level2Min').value),
max:parseInt(document.getElementById('level2Max').value)
},
level3:{
min:parseInt(document.getElementById('level3Min').value),
max:parseInt(document.getElementById('level3Max').value)
},
level4:{
min:parseInt(document.getElementById('level4Min').value),
max:parseInt(document.getElementById('level4Max').value)
}
};
localStorage.setItem('levelSettings',JSON.stringify(this.levelSettings));
this.renderAbsenceLevels();
this.showToast('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™');
},

// ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸäŸàŸÖŸäÿ©
calculateDailyStats(){
const today=new Date().toLocaleDateString('ar-SA');
let absentToday=0;
let lateToday=0;
for(const civil in this.absences){
if(this.absences[civil].some(a=>a.date===today))absentToday++;
}
for(const civil in this.delays){
if(this.delays[civil].some(d=>d.date===today))lateToday++;
}
const total=this.students.length;
const present=total-absentToday;
const percentage=total>0?Math.round((present/total)*100):0;
document.getElementById('dailyDate').textContent=today;
document.getElementById('dailyTotal').textContent=total;
document.getElementById('dailyPresent').textContent=present;
document.getElementById('dailyAbsent').textContent=absentToday;
document.getElementById('dailyLate').textContent=lateToday;
document.getElementById('dailyPercentage').textContent=percentage+'%';
},

// ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©
calculateWeeklyStats(){
const now=new Date();
const weekAgo=new Date(now.getTime()-(7*24*60*60*1000));
let totalAbsent=0;
let totalLate=0;
for(const civil in this.absences){
totalAbsent+=this.absences[civil].filter(a=>{
const date=new Date(a.date.split('/').reverse().join('-'));
return date>=weekAgo&&date<=now;
}).length;
}
for(const civil in this.delays){
totalLate+=this.delays[civil].filter(d=>{
const date=new Date(d.date.split('/').reverse().join('-'));
return date>=weekAgo&&date<=now;
}).length;
}
const avgPresent=this.students.length>0?Math.round((this.students.length*7-totalAbsent)/7):0;
document.getElementById('weeklyDays').textContent='7';
document.getElementById('weeklyAvgPresent').textContent=avgPresent;
document.getElementById('weeklyTotalAbsent').textContent=totalAbsent;
document.getElementById('weeklyTotalLate').textContent=totalLate;
},

// ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©
calculateMonthlyStats(){
const now=new Date();
const monthAgo=new Date(now.getFullYear(),now.getMonth(),1);
let totalAbsent=0;
let totalLate=0;
const absentCounts={};
for(const civil in this.absences){
const count=this.absences[civil].filter(a=>{
const date=new Date(a.date.split('/').reverse().join('-'));
return date>=monthAgo&&date<=now;
}).length;
totalAbsent+=count;
if(count>0)absentCounts[civil]=count;
}
for(const civil in this.delays){
totalLate+=this.delays[civil].filter(d=>{
const date=new Date(d.date.split('/').reverse().join('-'));
return date>=monthAgo&&date<=now;
}).length;
}
const days=now.getDate();
const avgPresent=this.students.length>0?Math.round((this.students.length*days-totalAbsent)/days):0;
document.getElementById('monthlyDays').textContent=days;
document.getElementById('monthlyAvgPresent').textContent=avgPresent;
document.getElementById('monthlyTotalAbsent').textContent=totalAbsent;
document.getElementById('monthlyTotalLate').textContent=totalLate;
const sorted=Object.entries(absentCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
const listDiv=document.getElementById('topAbsentList');
if(sorted.length===0){
listDiv.innerHTML='<div class="level-empty">‚úÖ ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∫Ÿäÿßÿ® Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</div>';
}else{
listDiv.innerHTML=sorted.map(([civil,count])=>{
const s=this.students.find(st=>st.civil===civil);
return s?`<div class="level-student">
<span class="student-name-stat">${s.name}</span>
<span class="student-days">${count} ŸäŸàŸÖ</span>
</div>`:'';
}).join('');
}
},

// ÿπÿ±ÿ∂ ŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ÿßŸÑÿ∫Ÿäÿßÿ®
renderAbsenceLevels(){
const levels={1:[],2:[],3:[],4:[]};
for(const civil in this.absences){
const count=this.absences[civil].length;
const s=this.students.find(st=>st.civil===civil);
if(!s)continue;
if(count>=this.levelSettings.level1.min&&count<=this.levelSettings.level1.max){
levels[1].push({student:s,days:count});
}else if(count>=this.levelSettings.level2.min&&count<=this.levelSettings.level2.max){
levels[2].push({student:s,days:count});
}else if(count>=this.levelSettings.level3.min&&count<=this.levelSettings.level3.max){
levels[3].push({student:s,days:count});
}else if(count>=this.levelSettings.level4.min&&count<=this.levelSettings.level4.max){
levels[4].push({student:s,days:count});
}
}
for(let i=1;i<=4;i++){
const div=document.getElementById(`level${i}Students`);
if(levels[i].length===0){
div.innerHTML='<div class="level-empty">‚úÖ ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∑ŸÑÿßÿ® ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ</div>';
}else{
div.innerHTML=levels[i].map(item=>`
<div class="level-student">
<span class="student-name-stat">${item.student.name}</span>
<span class="student-days">${item.days} ŸäŸàŸÖ</span>
</div>
`).join('');
}
}
},

// ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ©
updateAllStats(){
this.calculateDailyStats();
this.calculateWeeklyStats();
this.calculateMonthlyStats();
this.renderAbsenceLevels();
}
};

document.addEventListener('DOMContentLoaded',function(){app.init();});


// ÿØÿπŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ©
if ('serviceWorker' in navigator && 'SyncManager' in window) {
  navigator.serviceWorker.ready.then(swRegistration => {
    return swRegistration.sync.register('sync-data');
  });
}

    
</script>
<button onclick="document.getElementById('lockScreen').style.display='flex'" 
        style="position:fixed; bottom:20px; right:20px; z-index:999999; background:#f44336; color:white; border:none; padding:20px; border-radius:50%; font-size:24px; box-shadow:0 4px 12px rgba(0,0,0,0.4); cursor:pointer;">
  üîí
</button>


<!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÇŸÅŸÑ ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ© -->
<div id="lockScreen" style="display:none;">
  <div class="lock-overlay"></div>
  <div class="lock-container">

    <div class="lock-header">
      <div class="lock-icon-main">üîí</div>
      <h2 class="lock-main-title">ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©</h2>
      <p class="lock-subtitle">ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ™ÿ¨ÿ±ÿ®ÿ™ŸÉ! ÿßÿ≥ÿ™ŸÖÿ™ÿπÿ™ ÿ®ŸÄ <strong>7 ÿ£ŸäÿßŸÖ</strong> ŸÖÿ¨ÿßŸÜŸäÿ©</p>
    </div>

    <div class="subscription-card">
      <div class="card-badge">ÿπÿ±ÿ∂ ÿÆÿßÿµ üéÅ</div>

      <div class="price-section">
        <span class="old-price">99 ÿ±ŸäÿßŸÑ</span>
        <div class="new-price-wrapper">
          <span class="currency">ÿ±ŸäÿßŸÑ</span>
          <span class="new-price">75</span>
        </div>
        <span class="duration">/ ÿ≥ŸÜÿ© ŸÉÿßŸÖŸÑÿ©</span>
      </div>

      <div class="benefits-list">
        <div class="benefit-item">
          <span class="benefit-icon">‚úÖ</span>
          <span class="benefit-text">ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©</span>
        </div>
        <div class="benefit-item">
          <span class="benefit-icon">‚òÅÔ∏è</span>
          <span class="benefit-text">ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©</span>
        </div>
        <div class="benefit-item">
          <span class="benefit-icon">üîÑ</span>
          <span class="benefit-text">ÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ŸÖÿ¨ÿßŸÜŸäÿ© ŸÖÿØŸâ ÿßŸÑÿ≠Ÿäÿßÿ©</span>
        </div>
        <div class="benefit-item">
          <span class="benefit-icon">üí¨</span>
          <span class="benefit-text">ÿØÿπŸÖ ŸÅŸÜŸä ŸÖÿ¨ÿßŸÜŸä 24/7</span>
        </div>
      </div>

      <button class="btn-subscribe-main" onclick="app.showPaymentPage()">
        üöÄ ÿßÿ¥ÿ™ÿ±ŸÉ ÿßŸÑÿ¢ŸÜ Ÿàÿßÿ≥ÿ™ÿ±ÿ¨ÿπ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ
      </button>

      <p class="guarantee">üíØ ÿ∂ŸÖÿßŸÜ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ£ŸÖŸàÿßŸÑ ÿÆŸÑÿßŸÑ 14 ŸäŸàŸÖ</p>
    </div>

    <div class="warning-box">
      <span class="warning-icon">‚ö†Ô∏è</span>
      <div class="warning-content">
        <strong>ÿ™ŸÜÿ®ŸäŸá ŸÖŸáŸÖ:</strong> ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸÜŸáÿßÿ¶ŸäÿßŸã ÿ®ÿπÿØ <strong>30 ŸäŸàŸÖ</strong>
      </div>
    </div>

  </div>
</div>

<!-- ÿµŸÅÿ≠ÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿØŸÅÿπ -->
<div id="paymentPage" style="display:none;">
  <div class="lock-overlay"></div>
  <div class="payment-container">

    <button class="btn-back" onclick="app.hidePaymentPage()">‚Üê ÿ±ÿ¨Ÿàÿπ</button>

    <div class="payment-header">
      <div class="payment-icon">üí≥</div>
      <h2>ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿØŸÅÿπ</h2>
      <p class="payment-subtitle">ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©</p>
    </div>

    <div class="payment-methods">
      <div class="payment-method">
        <div class="method-header" onclick="app.selectPaymentMethod('bank')">
          <div class="method-info">
            <span class="method-icon">üè¶</span>
            <span class="method-name">ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä</span>
          </div>
          <span class="method-arrow">‚ñº</span>
        </div>

        <div class="method-details" id="bankDetails" style="display:none">
          <div class="bank-info-card">
            <div class="info-row">
              <span class="info-label">ÿßŸÑÿ®ŸÜŸÉ:</span>
              <span class="info-value">ŸÖÿµÿ±ŸÅ ÿßŸÑÿ±ÿßÿ¨ÿ≠Ÿä</span>
            </div>
            <div class="info-row">
              <span class="info-label">ÿßŸÑÿßÿ≥ŸÖ:</span>
              <span class="info-value">ÿ≥ŸÑÿ∑ÿßŸÜ ÿπÿ®ÿØÿßŸÑŸÑŸá ÿßŸÑŸÖÿßŸÑŸÉŸä</span>
            </div>
            <div class="info-row">
              <span class="info-label">ÿ±ŸÇŸÖ ÿßŸÑÿ¢Ÿäÿ®ÿßŸÜ:</span>
              <div class="iban-container">
                <input type="text" id="ibanNumber" value="SA0000000000000000000000" readonly class="iban-input">
                <button onclick="app.copyIBAN()" class="btn-copy">üìã ŸÜÿ≥ÿÆ</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="payment-method">
        <div class="method-header" onclick="app.contactWhatsApp()">
          <div class="method-info">
            <span class="method-icon">üíö</span>
            <span class="method-name">ÿßŸÑÿ™ŸàÿßÿµŸÑ ÿπÿ®ÿ± Ÿàÿßÿ™ÿ≥ÿßÿ®</span>
          </div>
          <span class="method-arrow">‚Üí</span>
        </div>
      </div>
    </div>

    <div class="activation-section">
      <h3>üîë ŸÑÿØŸäŸÉ ŸÉŸàÿØ ÿ™ŸÅÿπŸäŸÑÿü</h3>
      <p class="activation-hint">ÿ®ÿπÿØ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿØŸÅÿπÿå ÿ≥ÿ™ÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÉŸàÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑ</p>
      <div class="activation-input-group">
        <input type="text" id="activationCodeInput" placeholder="SK-XXXXX-XXXXX" class="activation-input">
        <button onclick="app.activateSubscription()" class="btn-activate">ÿ™ŸÅÿπŸäŸÑ</button>
      </div>
    </div>

    <div class="support-section">
      <h4>üí¨ ÿ®ÿ≠ÿßÿ¨ÿ© ŸÑŸÖÿ≥ÿßÿπÿØÿ©ÿü</h4>
      <div class="support-contacts">
        <a href="https://wa.me/966533371147" class="support-link" target="_blank">
          <span>üì±</span> Ÿàÿßÿ™ÿ≥ÿßÿ®: 966533371147
        </a>
      </div>
    </div>

  </div>
</div>

</body>
</html>
