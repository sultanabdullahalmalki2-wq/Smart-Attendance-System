<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ  v4.0</title>
    
<!-- PWA Support -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ">

<!-- App Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">    
    
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333;-webkit-font-smoothing:antialiased}
.container{max-width:600px;margin:0 auto;background:#fff;min-height:100vh;padding-bottom:70px}
header{background:linear-gradient(135deg,#1976d2 0%,#1565c0 100%);color:white;padding:22px;text-align:center;position:sticky;top:0;z-index:100}
header.absence{background:linear-gradient(135deg,#d32f2f 0%,#c62828 100%)}
header.notes{background:linear-gradient(135deg,#00897b 0%,#00796b 100%)}
header h1{font-size:22px;font-weight:600;letter-spacing:0.3px}
header p{font-size:14px;margin-top:6px;opacity:0.95;font-weight:500}
.content{padding:20px}
.search-input{width:100%;padding:16px;border:2px solid #e0e0e0;border-radius:12px;font-size:17px;font-family:inherit;margin:12px 0;font-weight:500}
.search-input:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 3px rgba(25,118,210,0.1)}
.date-input{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;background:white;margin:15px 0;font-family:inherit;font-weight:500}
.note-container{background:#e0f2f1;padding:18px;border-radius:12px;border:2px solid #00897b;margin:15px 0}
.note-label{font-size:15px;font-weight:700;color:#00695c;margin-bottom:10px;display:block}
.note-textarea{width:100%;min-height:120px;padding:14px;border:2px solid #80cbc4;border-radius:10px;font-size:16px;font-family:inherit;background:white;resize:vertical;font-weight:500}
.note-textarea:focus{outline:none;border-color:#00897b;box-shadow:0 0 0 3px rgba(0,137,123,0.1)}
.note-char-count{text-align:left;font-size:13px;color:#666;margin-top:6px;font-weight:600}
.filters-container{display:flex;gap:12px;margin:15px 0}
.filter-select{flex:1;padding:14px 12px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;font-family:inherit;background:white;cursor:pointer;font-weight:500}
.filter-select:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 3px rgba(25,118,210,0.1)}
.students-list{list-style:none;padding:0}
.student-item{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:16px;margin:12px 0;cursor:pointer;transition:all 0.3s}
.student-item:active{transform:translateY(2px)}
.student-name{font-size:18px;font-weight:600;margin-bottom:6px;letter-spacing:0.2px}
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600;margin-left:6px;color:white}
.badge.delay{background:#ff9800}
.badge.absence{background:#f44336}
.badge.note{background:#00897b}
.btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:17px;font-weight:600;cursor:pointer;margin:6px 0;color:white;font-family:inherit}
.btn-primary{background:linear-gradient(135deg,#1976d2 0%,#1565c0 100%)}
.btn-success{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%)}
.btn-warning{background:linear-gradient(135deg,#ff9800 0%,#f57c00 100%)}
.btn-danger{background:linear-gradient(135deg,#d32f2f 0%,#c62828 100%)}
.btn-notes{background:linear-gradient(135deg,#00897b 0%,#00796b 100%)}
.btn:active{transform:scale(0.98)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:white;box-shadow:0 -2px 10px rgba(0,0,0,0.1);display:flex;z-index:100}
.nav-item{flex:1;text-align:center;padding:10px 6px;cursor:pointer;border:none;background:none;color:#666;font-size:11px;font-weight:600}
.nav-item.active{color:#1976d2}
.nav-icon{font-size:22px;display:block;margin-bottom:3px}
.page{display:none}
.page.active{display:block}
.tabs{display:flex;gap:10px;margin:16px 0;position:sticky;top:84px;background:white;padding:12px 0;z-index:90}
.tab{flex:1;padding:13px 16px;border:2px solid #e0e0e0;background:white;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap}
.tab.active{background:#1976d2;color:white;border-color:#1976d2}
.notes-page .tab.active{background:#00897b;border-color:#00897b}
.tab:active{transform:scale(0.97)}
.tab-content{display:none}
.tab-content.active{display:block}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000}
.modal.active{display:flex;align-items:center;justify-content:center;padding:20px}
.modal-content{background:white;border-radius:18px;padding:26px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
.toast{position:fixed;bottom:80px;left:20px;right:20px;background:#323232;color:white;padding:16px 20px;border-radius:10px;z-index:2000;display:none;font-size:15px;font-weight:500}
.toast.show{display:block}
.record-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin:16px 0}
.record-card{background:#f8f9fa;border-radius:12px;padding:15px;border:2px solid #e0e0e0}
.record-card.delays{border-color:#ff9800;background:linear-gradient(135deg,#fff3e0,#ffe0b2)}
.record-card.absences{border-color:#f44336;background:linear-gradient(135deg,#ffebee,#ffcdd2)}
.record-card.notes{border-color:#00897b;background:linear-gradient(135deg,#e0f2f1,#b2dfdb)}
.record-card h4{font-size:15px;margin-bottom:10px;color:#333;border-bottom:2px solid rgba(0,0,0,0.1);padding-bottom:8px;font-weight:600}
.record-card.delays h4{color:#e65100}
.record-card.absences h4{color:#c62828}
.record-card.notes h4{color:#00695c}
.record-list{max-height:180px;overflow-y:auto}
.record-item{background:white;padding:9px;border-radius:7px;margin:5px 0;font-size:13px}
.record-item-header{display:flex;justify-content:space-between;align-items:flex-start}
.record-type{font-weight:600;font-size:12px}
.record-card.delays .record-type{color:#e65100}
.record-card.absences .record-type{color:#c62828}
.record-card.notes .record-type{color:#00695c}
.record-date{color:#666;font-size:11px;margin-top:2px}
.record-note-text{background:#f8f9fa;padding:8px;border-radius:6px;font-size:12px;margin-top:6px;border-right:3px solid #00897b;line-height:1.4}
.delete-btn{background:#f44336;color:white;border:none;padding:5px 9px;border-radius:5px;font-size:10px;cursor:pointer;font-weight:600}
.delete-btn:active{transform:scale(0.95)}
.selected-count{background:#4caf50;color:white;padding:12px;border-radius:10px;text-align:center;margin:12px 0;font-weight:600;font-size:15px}
.selected-count.absence{background:#d32f2f}
.selected-count.notes{background:#00897b}
.action-btns{position:sticky;bottom:70px;background:white;padding:16px 20px;box-shadow:0 -2px 10px rgba(0,0,0,0.1);margin:0 -20px;display:none;gap:12px}
.action-btns.show{display:flex}
.action-btns .btn{margin:0;padding:13px;font-size:15px}
.hidden{display:none}
.stats-page{background:#f5f5f5}
.stats-card{background:white;border-radius:12px;padding:20px;margin:15px 0;box-shadow:0 2px 4px rgba(0,0,0,0.08)}
.stats-card h3{font-size:18px;font-weight:600;color:#333;margin-bottom:15px;border-bottom:2px solid #e0e0e0;padding-bottom:10px}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:15px 0}
.stat-box{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:18px;border-radius:10px;text-align:center}
.stat-box.success{background:linear-gradient(135deg,#4caf50 0%,#45a049 100%)}
.stat-box.danger{background:linear-gradient(135deg,#f44336 0%,#d32f2f 100%)}
.stat-box.warning{background:linear-gradient(135deg,#ff9800 0%,#f57c00 100%)}
.stat-box.info{background:linear-gradient(135deg,#2196f3 0%,#1976d2 100%)}
.stat-number{font-size:32px;font-weight:700;margin:8px 0}
.stat-label{font-size:13px;opacity:0.95;font-weight:500}
.level-card{border-radius:10px;padding:16px;margin:12px 0;border-right:5px solid}
.level-1{background:#e8f5e9;border-color:#4caf50}
.level-1 .level-title{color:#2e7d32}
.level-2{background:#fff9c4;border-color:#ffc107}
.level-2 .level-title{color:#f57f17}
.level-3{background:#ffe0b2;border-color:#ff9800}
.level-3 .level-title{color:#e65100}
.level-4{background:#ffebee;border-color:#f44336}
.level-4 .level-title{color:#c62828}
.level-title{font-size:16px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.level-student{background:white;padding:10px 12px;border-radius:8px;margin:6px 0;font-size:14px;display:flex;justify-content:space-between;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.student-name-stat{font-weight:600;color:#333}
.student-days{color:#666;font-size:13px}
.level-empty{text-align:center;padding:20px;color:#999;font-size:14px}
.settings-input{display:flex;align-items:center;gap:10px;margin:10px 0}
.settings-input label{flex:1;font-size:14px;font-weight:500;color:#666}
.settings-input input{width:60px;padding:8px;border:2px solid #e0e0e0;border-radius:6px;text-align:center;font-size:14px;font-weight:600}
.percentage-circle{width:120px;height:120px;margin:20px auto;position:relative}
.percentage-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:28px;font-weight:700;color:#1976d2}
.settings-card{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:22px;margin:16px 0}
.settings-card h3{margin-bottom:12px;font-size:18px;font-weight:600}
/* CSS Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ø¯Ø¹Ù… */
.subscription-hero{
background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
color:white;
padding:30px;
text-align:center;
border-radius:15px;
margin:20px 0;
}
.app-logo{
width:100px;
height:100px;
background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
border-radius:22px;
display:flex;
align-items:center;
justify-content:center;
margin:0 auto 15px;
font-size:50px;
box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
.subscription-price{
font-size:48px;
font-weight:700;
margin:15px 0;
}
.subscription-price small{
font-size:18px;
opacity:0.9;
}
.payment-card{
background:white;
border-radius:15px;
padding:25px;
margin:20px 0;
box-shadow:0 4px 15px rgba(0,0,0,0.1);
border:2px solid #e0e0e0;
}
.payment-card h3{
color:#1976d2;
font-size:20px;
margin-bottom:20px;
display:flex;
align-items:center;
gap:10px;
}
.bank-info{
background:#f8f9fa;
padding:18px;
border-radius:10px;
margin:15px 0;
border-right:4px solid #1976d2;
}
.bank-info-row{
display:flex;
justify-content:space-between;
align-items:center;
margin:12px 0;
padding:10px 0;
border-bottom:1px solid #e0e0e0;
}
.bank-info-row:last-child{
border-bottom:none;
}
.bank-label{
font-weight:600;
color:#666;
font-size:14px;
}
.bank-value{
font-weight:700;
color:#1976d2;
font-size:15px;
direction:ltr;
text-align:left;
}
.copy-btn{
background:#4caf50;
color:white;
border:none;
padding:6px 12px;
border-radius:6px;
font-size:12px;
cursor:pointer;
margin-right:8px;
font-weight:600;
}
.copy-btn:active{
transform:scale(0.95);
}
.qr-container{
text-align:center;
padding:20px;
background:#f8f9fa;
border-radius:10px;
margin:15px 0;
}
.qr-code{
width:200px;
height:200px;
margin:15px auto;
border:3px solid #1976d2;
border-radius:10px;
padding:10px;
background:white;
}
.qr-code img{
width:100%;
height:100%;
object-fit:contain;
}
.activation-steps{
background:#e3f2fd;
padding:20px;
border-radius:10px;
margin:20px 0;
}
.activation-steps h4{
color:#1976d2;
margin-bottom:15px;
font-size:18px;
}
.step-item{
display:flex;
align-items:flex-start;
margin:15px 0;
}
.step-number{
background:#1976d2;
color:white;
width:30px;
height:30px;
border-radius:50%;
display:flex;
align-items:center;
justify-content:center;
font-weight:700;
font-size:14px;
margin-left:12px;
flex-shrink:0;
}
.step-text{
flex:1;
font-size:15px;
line-height:1.6;
color:#333;
}
.developer-info{
background:#f5f5f5;
padding:20px;
border-radius:10px;
text-align:center;
margin:20px 0;
border:2px solid #e0e0e0;
}
.developer-name{
font-size:18px;
font-weight:600;
color:#333;
margin:10px 0;
}
.developer-role{
color:#666;
font-size:14px;
margin-bottom:15px;
}
.settings-card p{color:#666;font-size:15px;margin-bottom:16px;line-height:1.6}
.app-logo {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #0A84FF 0%, #5AC8FA 100%);
    border-radius: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3),
                0 5px 15px rgba(10, 132, 255, 0.2);
    position: relative;
    overflow: hidden;
}

.app-logo::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
}

.app-logo-icon {
    font-size: 50px;
    position: relative;
    z-index: 1;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

/* CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© */
.lock-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.lock-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.lock-icon {
    font-size: 60px;
    margin-bottom: 20px;
}

.lock-title {
    font-size: 24px;
    margin-bottom: 15px;
    color: #333;
}

.lock-message {
    font-size: 16px;
    margin-bottom: 25px;
    color: #666;
    line-height: 1.5;
}

.activation-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 20px;
    text-align: center;
}

.trial-banner {
    background: linear-gradient(135deg, #ffeb3b 0%, #ffc107 100%);
    color: #333;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    font-size: 16px;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
}

.trial-banner.warning {
    background: linear-gradient(135deg, #ff5722 0%, #f44336 100%);
    color: white;
    animation: blink 1s infinite;
}

@keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
.whatsapp-link{display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg,#25d366 0%,#128c7e 100%);color:white;text-decoration:none;border-radius:10px;font-weight:600;font-size:15px;margin-top:10px}
.whatsapp-link:active{transform:scale(0.97)}

.app-logo {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #0A84FF 0%, #5AC8FA 100%);
    border-radius: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3),
                0 5px 15px rgba(10, 132, 255, 0.2);
    position: relative;
    overflow: hidden;
}

.app-logo::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
}

.app-logo-icon {
    font-size: 50px;
    position: relative;
    z-index: 1;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ */
.subscription-badge{
  position: fixed;
  top: 15px;
  right: 15px;
  background: white;
  border-radius: 12px;
  padding: 10px 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 1000;
  animation: slideInRight 0.5s ease;
}

.badge-icon{
  font-size: 24px;
  line-height: 1;
}

.badge-text{
  display: flex;
  flex-direction: column;
  line-height: 1.2;
}

.badge-days{
  font-size: 18px;
  font-weight: 700;
  color: #333;
}

.badge-label{
  font-size: 11px;
  color: #666;
}

/* Ø­Ø§Ù„Ø§Øª Ù…Ø®ØªÙ„ÙØ© */
.subscription-badge.trial{
  border-left: 4px solid #ff9800;
}

.subscription-badge.active{
  border-left: 4px solid #4caf50;
}

.subscription-badge.warning{
  border-left: 4px solid #f44336;
  animation: pulse 2s infinite;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* Ù„Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 768px) {
  .subscription-badge{
    top: 10px;
    right: 10px;
    padding: 8px 12px;
  }
  .badge-icon{
    font-size: 20px;
  }
  .badge-days{
    font-size: 16px;
  }
  .badge-label{
    font-size: 10px;
  }
}


/* Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Select ÙÙŠ iOS Safari */
.filter-select {
  -webkit-appearance: menulist;
  appearance: menulist;
  min-height: 44px; /* Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ù…Ø³ ÙÙŠ iOS */
}

/* Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ PWA */
@supports (-webkit-touch-callout: none) {
  .filter-select {
    background-color: white !important;
    border: 2px solid #e0e0e0 !important;
  }
  
  .filter-select option {
    background-color: white;
    color: #333;
  }
}

</style>
</head>
    
<body>
<div class="container">
<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ (ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©) -->
<div id="lockScreen" class="lock-screen" style="display:none">
    <div class="lock-content">
        <div class="lock-icon">ğŸ”’</div>
        <h2 class="lock-title">Ø§Ù†ØªÙ‡Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</h2>
        <p class="lock-message">
            Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¬Ø±Ø¨Ø© <strong>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ</strong>!<br>
            Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù…ÙŠØ²Ø§ØªØŒ<br>
            ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
        </p>

        <input 
            type="text" 
            id="activationCode" 
            class="activation-input" 
            placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„"
            maxlength="20">

        <button class="btn btn-primary" onclick="app.activateSubscription()">
            âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        </button>
<button class="btn btn-success" onclick="app.showPage('settings')" style="margin-top:10px">
ğŸ’³ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¢Ù† (100 Ø±ÙŠØ§Ù„)
</button>


        <p style="font-size:13px;color:#999;margin-top:20px">
            Ù„Ù… ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ØŸ 
            <a href="https://wa.me/966533371147" style="color:#1976d2;text-decoration:none;font-weight:600">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a>
        </p>
    </div>
</div>


<!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div id="mainPage" class="page active">
    
<header>
<h1>ğŸ“ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ</h1>
    
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ -->
<div id="subscriptionBadge" class="subscription-badge">
  <div class="badge-icon">ğŸ“¦</div>
  <div class="badge-text">
    <span class="badge-days">30</span>
    <span class="badge-label">ÙŠÙˆÙ… Ù…ØªØ¨Ù‚ÙŠ</span>
  </div>
</div>


<p>Ø°ÙƒØ§Ø¡ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…â€¦ ÙˆÙˆØ¶ÙˆØ­ ÙÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
</header>
<div class="content">
<input type="text" id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨...">
<ul id="studentsList" class="students-list"></ul>
<div id="emptyState" style="text-align:center;padding:50px 20px;color:#999">
<div style="font-size:60px">ğŸ”</div>
<div style="font-size:16px;margin-top:10px">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ø§Ù„Ø¨</div>
</div>
</div>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„ØªØ£Ø®Ø±Ø§Øª -->
<div id="delaysPage" class="page">
<header>
<h1>â° Ø§Ù„ØªØ£Ø®Ø±Ø§Øª</h1>
<p>Ø°ÙƒØ§Ø¡ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…â€¦ ÙˆÙˆØ¶ÙˆØ­ ÙÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
</header>
<div class="content">
<div class="tabs">
<button class="tab active" onclick="app.switchTab('delays','morning')">ØµØ¨Ø§Ø­ÙŠ</button>
<button class="tab" onclick="app.switchTab('delays','break')">ÙØ³Ø­Ø©</button>
<button class="tab" onclick="app.switchTab('delays','departure')">Ø§Ù†ØµØ±Ø§Ù</button>
<button class="tab" onclick="app.switchTab('delays','view')">Ø§Ø³ØªØ¹Ø±Ø§Ø¶</button>
</div>

<div id="delayMorningTab" class="tab-content active">
<input type="date" id="dateMorning" class="date-input">
<input type="text" id="searchMorning" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨...">
<div class="filters-container">
<select id="classMorning" class="filter-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option></select>
<select id="classroomMorning" class="filter-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option></select>
</div>
<div id="countMorning" class="selected-count hidden">ØªÙ… Ø§Ø®ØªÙŠØ§Ø± <span>0</span> Ø·Ø§Ù„Ø¨</div>
<ul id="listMorning" class="students-list"></ul>
</div>

<div id="delayBreakTab" class="tab-content">
<input type="date" id="dateBreak" class="date-input">
<input type="text" id="searchBreak" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨...">
<div class="filters-container">
<select id="classBreak" class="filter-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option></select>
<select id="classroomBreak" class="filter-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option></select>
</div>
<div id="countBreak" class="selected-count hidden">ØªÙ… Ø§Ø®ØªÙŠØ§Ø± <span>0</span> Ø·Ø§Ù„Ø¨</div>
<ul id="listBreak" class="students-list"></ul>
</div>

<div id="delayDepartureTab" class="tab-content">
<input type="date" id="dateDeparture" class="date-input">
<input type="text" id="searchDeparture" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨...">
<div class="filters-container">
<select id="classDeparture" class="filter-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option></select>
<select id="classroomDeparture" class="filter-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option></select>
</div>
<div id="countDeparture" class="selected-count hidden">ØªÙ… Ø§Ø®ØªÙŠØ§Ø± <span>0</span> Ø·Ø§Ù„Ø¨</div>
<ul id="listDeparture" class="students-list"></ul>
</div>

<div id="delayViewTab" class="tab-content">
<input type="text" id="searchDelayView" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…...">
<div id="delayViewList"></div>
</div>

<div id="delayActions" class="action-btns">
<button class="btn btn-primary" onclick="app.confirmAction('saveDelay')">ğŸ’¾ Ø­ÙØ¸</button>
<button class="btn btn-success" onclick="app.confirmAction('saveAndSendDelay')">ğŸ’¾ğŸ“¤ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„</button>
<button class="btn btn-warning" onclick="app.confirmAction('sendDelay')">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
</div>
</div>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„ØºÙŠØ§Ø¨ -->
<div id="absencesPage" class="page">
<header class="absence">
<h1>ğŸ“… Ø§Ù„ØºÙŠØ§Ø¨</h1>
<p>Ø°ÙƒØ§Ø¡ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…â€¦ ÙˆÙˆØ¶ÙˆØ­ ÙÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
</header>
<div class="content">
<div class="tabs">
<button class="tab active" onclick="app.switchTab('absence','daily')">ØºÙŠØ§Ø¨ ÙŠÙˆÙ…ÙŠ</button>
<button class="tab" onclick="app.switchTab('absence','view')">Ø§Ø³ØªØ¹Ø±Ø§Ø¶</button>
</div>

<div id="absenceDailyTab" class="tab-content active">
<input type="date" id="dateAbsence" class="date-input">
<input type="text" id="searchAbsence" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨...">
<div class="filters-container">
<select id="classAbsence" class="filter-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option></select>
<select id="classroomAbsence" class="filter-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option></select>
</div>
<div id="countAbsence" class="selected-count absence hidden">ØªÙ… Ø§Ø®ØªÙŠØ§Ø± <span>0</span> Ø·Ø§Ù„Ø¨</div>
<ul id="listAbsence" class="students-list"></ul>
</div>

<div id="absenceViewTab" class="tab-content">
<input type="text" id="searchAbsenceView" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…...">
<div id="absenceViewList"></div>
</div>

<div id="absenceActions" class="action-btns">
<button class="btn btn-primary" onclick="app.confirmAction('saveAbsence')">ğŸ’¾ Ø­ÙØ¸</button>
<button class="btn btn-success" onclick="app.confirmAction('saveAndSendAbsence')">ğŸ’¾ğŸ“¤ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„</button>
<button class="btn btn-warning" onclick="app.confirmAction('sendAbsence')">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
</div>
</div>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
<div id="notesPage" class="page notes-page">
<header class="notes">
<h1>ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h1>
<p>Ø°ÙƒØ§Ø¡ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…â€¦ ÙˆÙˆØ¶ÙˆØ­ ÙÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
</header>
<div class="content">
<div class="tabs">
<button class="tab active" onclick="app.switchTab('notes','add')">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©</button>
<button class="tab" onclick="app.switchTab('notes','view')">Ø§Ø³ØªØ¹Ø±Ø§Ø¶</button>
</div>

<div id="noteAddTab" class="tab-content active">
<div class="note-container">
<label class="note-label">ğŸ“ Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:</label>
<textarea id="noteTextarea" class="note-textarea" placeholder="Ù…Ø«Ø§Ù„: ØªÙ…ÙŠØ² ÙÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© - Ù„Ù… ÙŠØ­Ø¶Ø± Ø§Ù„ÙƒØªØ§Ø¨ - Ø³Ù„ÙˆÙƒ Ù…Ù…ØªØ§Ø²..." maxlength="500"></textarea>
<div class="note-char-count"><span id="noteCharCount">0</span> / 500 Ø­Ø±Ù</div>
</div>

<input type="date" id="dateNote" class="date-input">
<input type="text" id="searchNote" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨...">
<div class="filters-container">
<select id="classNote" class="filter-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option></select>
<select id="classroomNote" class="filter-select"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option></select>
</div>
<div id="countNote" class="selected-count notes hidden">ØªÙ… Ø§Ø®ØªÙŠØ§Ø± <span>0</span> Ø·Ø§Ù„Ø¨</div>
<ul id="listNote" class="students-list"></ul>
</div>

<div id="noteViewTab" class="tab-content">
<input type="text" id="searchNoteView" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…...">
<div id="noteViewList"></div>
</div>

<div id="noteActions" class="action-btns">
<button class="btn btn-notes" onclick="app.confirmAction('saveNote')">ğŸ’¾ Ø­ÙØ¸</button>
<button class="btn btn-success" onclick="app.confirmAction('saveAndSendNote')">ğŸ’¾ğŸ“¤ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„</button>
<button class="btn btn-warning" onclick="app.confirmAction('sendNote')">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
</div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ØµÙØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - Ø£Ø¶Ù Ù‚Ø¨Ù„ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div id="statsPage" class="page stats-page">
<header style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">
<h1>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h1>
<p>Ø°ÙƒØ§Ø¡ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…â€¦ ÙˆÙˆØ¶ÙˆØ­ ÙÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
</header>
<div class="content">
<div class="tabs">
<button class="tab active" onclick="app.switchTab('stats','daily')">Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
<button class="tab" onclick="app.switchTab('stats','weekly')">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</button>
<button class="tab" onclick="app.switchTab('stats','monthly')">Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</button>
<button class="tab" onclick="app.switchTab('stats','levels')">Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨</button>
</div>

<div id="statsDailyTab" class="tab-content active">
<div class="stats-card">
<h3>ğŸ“… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ… - <span id="dailyDate"></span></h3>
<div class="stats-grid">
<div class="stat-box info">
<div class="stat-number" id="dailyTotal">0</div>
<div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
</div>
<div class="stat-box success">
<div class="stat-number" id="dailyPresent">0</div>
<div class="stat-label">Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ†</div>
</div>
<div class="stat-box danger">
<div class="stat-number" id="dailyAbsent">0</div>
<div class="stat-label">Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ†</div>
</div>
<div class="stat-box warning">
<div class="stat-number" id="dailyLate">0</div>
<div class="stat-label">Ø§Ù„Ù…ØªØ£Ø®Ø±ÙˆÙ†</div>
</div>
</div>
<div style="background:#e3f2fd;padding:20px;border-radius:10px;text-align:center;margin-top:15px">
<div style="font-size:14px;color:#1976d2;margin-bottom:8px;font-weight:600">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
<div style="font-size:42px;font-weight:700;color:#1976d2" id="dailyPercentage">0%</div>
</div>
</div>
</div>

<div id="statsWeeklyTab" class="tab-content">
<div class="stats-card">
<h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
<div class="stats-grid">
<div class="stat-box info">
<div class="stat-number" id="weeklyDays">7</div>
<div class="stat-label">Ø£ÙŠØ§Ù…</div>
</div>
<div class="stat-box success">
<div class="stat-number" id="weeklyAvgPresent">0</div>
<div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¶ÙˆØ±</div>
</div>
<div class="stat-box danger">
<div class="stat-number" id="weeklyTotalAbsent">0</div>
<div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºÙŠØ§Ø¨</div>
</div>
<div class="stat-box warning">
<div class="stat-number" id="weeklyTotalLate">0</div>
<div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®Ø±Ø§Øª</div>
</div>
</div>
</div>
</div>

<div id="statsMonthlyTab" class="tab-content">
<div class="stats-card">
<h3>ğŸ“… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±</h3>
<div class="stats-grid">
<div class="stat-box info">
<div class="stat-number" id="monthlyDays">30</div>
<div class="stat-label">Ø£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</div>
</div>
<div class="stat-box success">
<div class="stat-number" id="monthlyAvgPresent">0</div>
<div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¶ÙˆØ±</div>
</div>
<div class="stat-box danger">
<div class="stat-number" id="monthlyTotalAbsent">0</div>
<div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºÙŠØ§Ø¨</div>
</div>
<div class="stat-box warning">
<div class="stat-number" id="monthlyTotalLate">0</div>
<div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®Ø±Ø§Øª</div>
</div>
</div>
<div class="stats-card">
<h3>ğŸ† Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± ØºÙŠØ§Ø¨Ø§Ù‹</h3>
<div id="topAbsentList"></div>
</div>
</div>
</div>

<div id="statsLevelsTab" class="tab-content">
<div class="stats-card">
<h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</h3>
<div class="settings-input">
<label>ğŸŸ¢ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„: Ù…Ù†</label>
<input type="number" id="level1Min" value="1" min="1">
<span>Ø¥Ù„Ù‰</span>
<input type="number" id="level1Max" value="5" min="1">
<span>Ø£ÙŠØ§Ù…</span>
</div>
<div class="settings-input">
<label>ğŸŸ¡ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù…Ù†</label>
<input type="number" id="level2Min" value="6" min="1">
<span>Ø¥Ù„Ù‰</span>
<input type="number" id="level2Max" value="10" min="1">
<span>Ø£ÙŠØ§Ù…</span>
</div>
<div class="settings-input">
<label>ğŸŸ  Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù„Ø«: Ù…Ù†</label>
<input type="number" id="level3Min" value="11" min="1">
<span>Ø¥Ù„Ù‰</span>
<input type="number" id="level3Max" value="15" min="1">
<span>Ø£ÙŠØ§Ù…</span>
</div>
<div class="settings-input">
<label>ğŸ”´ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø§Ø¨Ø¹: Ù…Ù†</label>
<input type="number" id="level4Min" value="16" min="1">
<span>Ø¥Ù„Ù‰</span>
<input type="number" id="level4Max" value="20" min="1">
<span>Ø£ÙŠØ§Ù…</span>
</div>
<button class="btn btn-primary" onclick="app.saveLevelSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</div>

<div class="level-card level-1" id="level1Card">
<div class="level-title">ğŸŸ¢ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„ (Ø¢Ù…Ù†)</div>
<div id="level1Students"></div>
</div>

<div class="level-card level-2" id="level2Card">
<div class="level-title">ğŸŸ¡ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ù†ØªØ¨Ø§Ù‡)</div>
<div id="level2Students"></div>
</div>

<div class="level-card level-3" id="level3Card">
<div class="level-title">ğŸŸ  Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ø§Ù„Ø« (ØªØ­Ø°ÙŠØ±)</div>
<div id="level3Students"></div>
</div>

<div class="level-card level-4" id="level4Card">
<div class="level-title">ğŸ”´ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø§Ø¨Ø¹ (Ø®Ø·Ø±!)</div>
<div id="level4Students"></div>
</div>
</div>
</div>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© -->
<div id="settingsPage" class="page">
<header>
<h1>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h1>
<p>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</p>
</header>
<div class="content">

<!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ø¯Ø¹Ù… -->
<div class="subscription-hero">
    <div class="app-logo">
        <div class="app-logo-icon">ğŸ‘¨â€ğŸ“</div>
    </div>
    <h2 style="font-size:24px;margin:10px 0">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ</h2>
    <p style="opacity:0.95;font-size:15px">Ø¥Ø¯Ø§Ø±Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</p>
    <div class="subscription-price">
        100 Ø±.Ø³
        <small>/ Ø³Ù†ÙˆÙŠØ§Ù‹</small>
    </div>
</div>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ -->
<div class="payment-card">
<h3>ğŸ’³ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹</h3>

<div class="bank-info">
<div class="bank-info-row">
<span class="bank-label">ğŸ¦ Ø§Ù„Ø¨Ù†Ùƒ:</span>
<span class="bank-value">Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ</span>
</div>

<div class="bank-info-row">
<span class="bank-label">ğŸ“‹ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†:</span>
<div style="display:flex;align-items:center;gap:8px">
<button class="copy-btn" onclick="app.copyText('SA4780000381608010039716')">Ù†Ø³Ø®</button>
<span class="bank-value" dir="ltr">SA47 8000 0381 6080 1003 9716</span>
</div>
</div>

<div class="bank-info-row">
<span class="bank-label">ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:</span>
<div style="display:flex;align-items:center;gap:8px">
<button class="copy-btn" onclick="app.copyText('381000010006080039716')">Ù†Ø³Ø®</button>
<span class="bank-value" dir="ltr">381000010006080039716</span>
</div>
</div>

<div class="bank-info-row">
<span class="bank-label">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº:</span>
<span class="bank-value">100 Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</span>
</div>
</div>

<!-- Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ -->
<div class="qr-container">
<h4 style="color:#1976d2;font-size:18px;margin-bottom:10px">ğŸ“± Ø§Ù…Ø³Ø­ Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</h4>
<p style="color:#666;font-size:14px;margin-bottom:15px">Ø§Ø³ØªØ®Ø¯Ù… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</p>
<div class="qr-code">
<img src="brkwd.jpg" alt="Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹" style="width:100%;height:100%;object-fit:contain">
</div>
<p style="color:#999;font-size:13px;margin-top:10px">Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¬ÙˆØ§Ù„</p>
</div>
</div>

<!-- Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„ -->
<div class="activation-steps">
<h4>ğŸš€ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„</h4>

<div class="step-item">
<div class="step-number">1</div>
<div class="step-text">Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº (100 Ø±ÙŠØ§Ù„) Ø¹Ø¨Ø± Ø§Ù„Ø¢ÙŠØ¨Ø§Ù† Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡</div>
</div>

<div class="step-item">
<div class="step-number">2</div>
<div class="step-text">Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© Ù„Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ù†Ùƒ</div>
</div>

<div class="step-item">
<div class="step-number">3</div>
<div class="step-text">Ø£Ø±Ø³Ù„ Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ: <strong>0533371147</strong></div>
</div>

<div class="step-item">
<div class="step-number">4</div>
<div class="step-text">Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ <strong>ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</strong> Ø®Ù„Ø§Ù„ Ø¯Ù‚Ø§Ø¦Ù‚</div>
</div>

<a href="https://wa.me/966533371147?text=Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ" 
   class="whatsapp-link" 
   target="_blank"
   style="width:100%;margin-top:15px;justify-content:center">
<span style="font-size:22px">ğŸ“±</span>
<span>ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</span>
</a>
</div>

<!-- Ø²Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ -->
<div class="settings-card" style="margin-bottom:20px;">
<h3 style="color:#1976d2;margin-bottom:15px;">ğŸ”‘ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h3>
<p style="color:#666;margin-bottom:15px;">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù…Ø¯Ø© Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©</p>

<input 
  type="text" 
  id="activationCodeInput" 
placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°ÙŠ Ø­ØµÙ„Øª Ø¹Ù„ÙŠÙ‡"
  style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;margin-bottom:15px;">

<button 
  onclick="app.activateSubscription()" 
  style="width:100%;padding:15px;background:#4caf50;color:white;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">
  âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¢Ù†
</button>
</div>

    
<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± -->
<div class="developer-info">
<div style="font-size:40px;margin-bottom:10px">ğŸ‘¨â€ğŸ’»</div>
<div class="developer-name">Ø£. Ø³Ù„Ø·Ø§Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ</div>
<div class="developer-role">Ù…Ø·ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
<p style="font-size:14px;color:#666;line-height:1.6">
Ù…ØªØ®ØµØµ ÙÙŠ ØªØ·ÙˆÙŠØ± Ø£Ù†Ø¸Ù…Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…<br>
Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© â€¢ Ø¯Ø¹Ù… Ù…Ø³ØªÙ…Ø± â€¢ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¯ÙˆØ±ÙŠØ©
</p>
</div>

<!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
<div class="settings-card">
<h3>ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
<p>Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù Excel ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: Ø§Ù„Ø§Ø³Ù… - Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ - Ø§Ù„Ø¬ÙˆØ§Ù„ - Ø§Ù„ØµÙ - Ø§Ù„ÙØµÙ„</p>
<input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none">
<button class="btn btn-primary" onclick="document.getElementById('excelFile').click()">ğŸ“‚ Ø§Ø®ØªØ± Ù…Ù„Ù Excel</button>
</div>

<!-- Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† -->
<div class="settings-card">
<h3>ğŸ—‘ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
<p>Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ</p>
<button class="btn btn-danger" onclick="app.confirmAction('reset')">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
</div>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div class="settings-card">
<h3>â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
<p style="font-size:15px;line-height:1.7">
<strong>Ø§Ù„Ø§Ø³Ù…:</strong> Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ<br>
<strong>Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</strong> 5.0.0<br>
<strong>Ø§Ù„ØªØ­Ø¯ÙŠØ«:</strong> Ø£ÙƒØªÙˆØ¨Ø± 2025<br>
<strong>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</strong> 100 Ø±ÙŠØ§Ù„ Ø³Ù†ÙˆÙŠØ§Ù‹
</p>
</div>

</div>
</div>

<!-- Navigation Bar -->
<div class="bottom-nav">
<button class="nav-item active" onclick="app.showPage('main')">
<span class="nav-icon">ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
</button>
<button class="nav-item" onclick="app.showPage('delays')">
<span class="nav-icon">â°</span>Ø§Ù„ØªØ£Ø®Ø±Ø§Øª
</button>
<button class="nav-item" onclick="app.showPage('absences')">
<span class="nav-icon">ğŸ“…</span>Ø§Ù„ØºÙŠØ§Ø¨
</button>
<button class="nav-item" onclick="app.showPage('notes')">
<span class="nav-icon">ğŸ“</span>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
</button>
<button class="nav-item" onclick="app.showPage('stats')">
<span class="nav-icon">ğŸ“Š</span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
</button>
<button class="nav-item" onclick="app.showPage('settings')">
<span class="nav-icon">âš™ï¸</span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
</button>
</div>

<!-- Modals -->
<div id="studentModal" class="modal" onclick="if(event.target.id==='studentModal')app.closeModal()">
<div class="modal-content" onclick="event.stopPropagation()">
<h2 style="text-align:center;color:#1976d2;margin-bottom:20px;font-size:20px">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
<div id="modalBody"></div>
<button class="btn btn-primary" onclick="app.closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
</div>
</div>

<div id="confirmModal" class="modal" onclick="if(event.target.id==='confirmModal')app.closeConfirm()">
<div class="modal-content" onclick="event.stopPropagation()">
<h3 id="confirmTitle" style="text-align:center;margin-bottom:12px;font-size:19px">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
<p id="confirmMsg" style="text-align:center;color:#666;margin-bottom:22px;font-size:15px">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
<div style="display:flex;gap:12px">
<button class="btn" style="flex:1;background:#f5f5f5;color:#333" onclick="app.closeConfirm()">Ø¥Ù„ØºØ§Ø¡</button>
<button class="btn btn-primary" style="flex:1" id="confirmYes">ØªØ£ÙƒÙŠØ¯</button>
</div>
</div>
</div>

<div id="toast" class="toast"></div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDV9YcTWPcGCJDAx5hoy4xz2i6Adg_3F5k",
  authDomain: "smart-attendance-system-63a71.firebaseapp.com",
  databaseURL: "https://smart-attendance-system-63a71-default-rtdb.firebaseio.com",
  projectId: "smart-attendance-system-63a71"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const app={
students:[],
delays:{},
absences:{},
notes:{},
subscriptions:{},
selected:{morning:new Set(),break:new Set(),departure:new Set(),absence:new Set(),note:new Set()},
currentTab:{delay:'morning',absence:'daily',notes:'add',stats:'daily'},

init() {
  this.loadData();
  this.setToday();
  if(!this.checkSubscription()) return;
  this.setupEvents();
  this.renderStudents();
  this.loadLevelSettings();
  this.updateAllStats();
  
  // ØªØ£Ø®ÙŠØ± Ù…Ù„Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù€ iOS (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹!)
  setTimeout(() => {
    this.populateFilters();
  }, 300);
  
  this.setupRealtimeSync();
  this.checkOnlineStatus(); 
  
  // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
  const badge = document.getElementById('subscriptionBadge');
  if(badge){
    badge.onclick = () => {
      this.showPage('settings');
    };
    badge.style.cursor = 'pointer';
  }
},

    // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ù†Ø´Ø§Ø¡ ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© 7 Ø£ÙŠØ§Ù…
initTrialSubscription(){
  const code = 'SK-TRIAL-' + Date.now();
  const endDate = new Date();
  endDate.setDate(endDate.getDate() + 7); // â† 7 Ø£ÙŠØ§Ù… ÙÙ‚Ø·
  
  this.subscriptions[code] = {
    active: true,
    startDate: new Date().toISOString(),
    endDate: endDate.toISOString(),
    isTrial: true
  };
  
  localStorage.setItem('activationCode', code);
  this.saveData();
  
  this.showToast('ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹! Ù„Ø¯ÙŠÙƒ 7 Ø£ÙŠØ§Ù… ØªØ¬Ø±Ø¨Ø© Ù…Ø¬Ø§Ù†ÙŠØ©', 5000);
  
  return code;
},



// ÙƒØ´Ù Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ø®Ø§Ø±Ø¬ init)
checkOnlineStatus(){
  const updateOnlineStatus = () => {
    const statusBadge = document.getElementById('subscriptionBadge');
    if(statusBadge){
      if(navigator.onLine){
        statusBadge.style.borderLeft = '4px solid #4caf50';
        this.syncPendingData(); // Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
      }else{
        statusBadge.style.borderLeft = '4px solid #ff9800';
        this.showToast('âš ï¸ ÙˆØ¶Ø¹ Ø£ÙˆÙÙ„Ø§ÙŠÙ† - Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„');
      }
    }
  };
  
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus();
},


// Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
savePendingData(data){
  const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
  pending.push({...data, timestamp: Date.now()});
  localStorage.setItem('pendingSync', JSON.stringify(pending));
},

// Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
syncPendingData(){
  const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
  if(pending.length === 0) return;
  
  const activationCode = localStorage.getItem('activationCode');
  if(!activationCode || !activationCode.startsWith('SK-')) return;
  
  this.showToast('ğŸ”„ Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
  
  // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase
  database.ref('subscriptions/' + activationCode).set({
    students: this.students,
    delays: this.delays,
    absences: this.absences,
    notes: this.notes,
    lastUpdate: Date.now()
  }).then(() => {
    localStorage.setItem('pendingSync', '[]');
    this.showToast('âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­');
  }).catch((error) => {
    console.log('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', error);
  });
},



setupRealtimeSync(){
const activationCode = localStorage.getItem('activationCode');
if(!activationCode || !activationCode.startsWith('SK-')) return;

database.ref('subscriptions/' + activationCode).on('value', (snapshot) => {
  const data = snapshot.val();
  if(data && data.lastUpdate && data.lastUpdate !== this.lastUpdate){
    this.lastUpdate = data.lastUpdate;
    this.students = data.students || [];
    this.delays = data.delays || {};
    this.absences = data.absences || {};
    this.notes = data.notes || {};
    this.renderStudents();
    this.showToast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
  }
});
},

lastUpdate: 0,

loadData(){
const activationCode = localStorage.getItem('activationCode');

if(!activationCode || !activationCode.startsWith('SK-')){
  // ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹
  this.students=JSON.parse(localStorage.getItem('students')||'[]');
  this.delays=JSON.parse(localStorage.getItem('delays')||'{}');
  this.absences=JSON.parse(localStorage.getItem('absences')||'{}');
  this.notes=JSON.parse(localStorage.getItem('notes')||'{}');
  return;
}

// ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
database.ref('subscriptions/' + activationCode).once('value').then((snapshot) => {
  const data = snapshot.val();
  if(data){
    this.students = data.students || [];
    this.delays = data.delays || {};
    this.absences = data.absences || {};
    this.notes = data.notes || {};

    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
    localStorage.setItem('students',JSON.stringify(this.students));
    localStorage.setItem('delays',JSON.stringify(this.delays));
    localStorage.setItem('absences',JSON.stringify(this.absences));
    localStorage.setItem('notes',JSON.stringify(this.notes));

    this.renderStudents();
  }else{
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©ØŒ Ø­Ù…Ù‘Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹
    this.students=JSON.parse(localStorage.getItem('students')||'[]');
    this.delays=JSON.parse(localStorage.getItem('delays')||'{}');
    this.absences=JSON.parse(localStorage.getItem('absences')||'{}');
    this.notes=JSON.parse(localStorage.getItem('notes')||'{}');
  }
}).catch((error)=>{
  console.log('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', error);
  // ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø®Ø·Ø£ØŒ Ø­Ù…Ù‘Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹
  this.students=JSON.parse(localStorage.getItem('students')||'[]');
  this.delays=JSON.parse(localStorage.getItem('delays')||'{}');
  this.absences=JSON.parse(localStorage.getItem('absences')||'{}');
  this.notes=JSON.parse(localStorage.getItem('notes')||'{}');
});
},

saveData(){
  // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ (Ù„Ù„Ø³Ø±Ø¹Ø©)
  localStorage.setItem('students', JSON.stringify(this.students));
  localStorage.setItem('delays', JSON.stringify(this.delays));
  localStorage.setItem('absences', JSON.stringify(this.absences));
  localStorage.setItem('notes', JSON.stringify(this.notes));
  
  // Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Firebase (Ù„Ù„Ø­Ù…Ø§ÙŠØ©)
  const code = localStorage.getItem('activationCode');
  if(code){
    const deviceId = this.getDeviceId();
    database.ref('backups/' + deviceId).set({
      students: this.students,
      delays: this.delays,
      absences: this.absences,
      notes: this.notes,
      lastBackup: new Date().toISOString()
    });
  }
},



setToday(){
const today=new Date().toISOString().split('T')[0];
['dateMorning','dateBreak','dateDeparture','dateAbsence','dateNote'].forEach(id=>{
const el=document.getElementById(id);
if(el)el.value=today;
});

    
},

setupEvents(){
const self=this;

document.getElementById('searchInput').addEventListener('input',function(e){
const q=e.target.value.toLowerCase();
if(!q){
document.getElementById('studentsList').innerHTML='';
document.getElementById('emptyState').style.display='block';
return;
}
document.getElementById('emptyState').style.display='none';
const filtered=self.students.filter(s=>
s.name.toLowerCase().includes(q)||s.phone.includes(q)||s.class.toLowerCase().includes(q)
);
self.renderStudents(filtered);
});

['Morning','Break','Departure','Absence','Note'].forEach(t=>{
const search=document.getElementById('search'+t);
if(search)search.addEventListener('input',function(){self.filterList(t.toLowerCase());});
const cls=document.getElementById('class'+t);
if(cls)cls.addEventListener('change',function(){self.filterList(t.toLowerCase());});
const clsr=document.getElementById('classroom'+t);
if(clsr)clsr.addEventListener('change',function(){self.filterList(t.toLowerCase());});
});

const views=['DelayView','AbsenceView','NoteView'];
views.forEach(v=>{
const el=document.getElementById('search'+v);
if(el)el.addEventListener('input',function(){
if(v==='DelayView')self.renderDelayView();
else if(v==='AbsenceView')self.renderAbsenceView();
else if(v==='NoteView')self.renderNoteView();
});
});

const noteTextarea=document.getElementById('noteTextarea');
if(noteTextarea){
noteTextarea.addEventListener('input',function(e){
document.getElementById('noteCharCount').textContent=e.target.value.length;
});
}

const excelFile=document.getElementById('excelFile');
if(excelFile){
excelFile.addEventListener('change',function(e){self.importExcel(e);});
}
},

renderStudents(list=[]){
const ul=document.getElementById('studentsList');
ul.innerHTML=list.map((s,i)=>{
const idx=this.students.indexOf(s);
const dCount=(this.delays[s.civil]||[]).length;
const aCount=(this.absences[s.civil]||[]).length;
const nCount=(this.notes[s.civil]||[]).length;
let badges='';
if(dCount>0)badges+=`<span class="badge delay">${dCount} ØªØ£Ø®Ø±</span>`;
if(aCount>0)badges+=`<span class="badge absence">${aCount} ØºÙŠØ§Ø¨</span>`;
if(nCount>0)badges+=`<span class="badge note">${nCount} Ù…Ù„Ø§Ø­Ø¸Ø©</span>`;
return`<li class="student-item" onclick="app.showStudent(${idx})">
<div class="student-name">${badges}${s.name}</div>
<div style="font-size:15px;color:#666;margin-top:4px">${s.class} - ${s.classroom} | ğŸ“ ${s.phone}</div>
</li>`;
}).join('');
},

populateFilters() {
  // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
  if (!this.students || this.students.length === 0) {
    console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨');
    return;
  }
  
  const classes = [...new Set(this.students.map(s => s.class))].filter(c => c).sort();
  const classrooms = [...new Set(this.students.map(s => s.classroom))].filter(c => c).sort();
  
  ['Morning', 'Break', 'Departure', 'Absence', 'Note'].forEach(t => {
    const cls = document.getElementById(`class${t}`);
    const clsr = document.getElementById(`classroom${t}`);
    
    if (cls) {
      // Ø§Ø­Ø°Ù Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£ÙˆÙ„Ø§Ù‹
      cls.innerHTML = '';
      
      // Ø£Ø¶Ù Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Ø§Ù„ÙƒÙ„';
      cls.appendChild(defaultOption);
      
      // Ø£Ø¶Ù Ø§Ù„ØµÙÙˆÙ
      classes.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        cls.appendChild(option);
      });
    }
    
    if (clsr) {
      // Ø§Ø­Ø°Ù Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£ÙˆÙ„Ø§Ù‹
      clsr.innerHTML = '';
      
      // Ø£Ø¶Ù Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Ø§Ù„ÙƒÙ„';
      clsr.appendChild(defaultOption);
      
      // Ø£Ø¶Ù Ø§Ù„ÙØµÙˆÙ„
      classrooms.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        clsr.appendChild(option);
      });
    }
  });
  
  // Ø¥Ø¬Ø¨Ø§Ø± Safari Ø¹Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù€ iOS)
  setTimeout(() => {
    document.querySelectorAll('.filter-select').forEach(select => {
      select.style.display = 'none';
      select.offsetHeight; // Force reflow
      select.style.display = '';
    });
  }, 100);
},


renderList(type){
const list=document.getElementById('list'+type.charAt(0).toUpperCase()+type.slice(1));
const key=type==='absence'?'absence':type==='note'?'note':type;
list.innerHTML=this.students.map((s,i)=>{
const idx=this.students.indexOf(s);
const checked=this.selected[key].has(idx)?'checked':'';
return`<li class="student-item">
<label style="display:flex;align-items:center;gap:12px;cursor:pointer">
<input type="checkbox" ${checked} onchange="app.toggleStudent('${key}',${idx})" style="width:22px;height:22px;cursor:pointer">
<div style="flex:1">
<div style="font-weight:600;font-size:16px">${s.name}</div>
<div style="font-size:14px;color:#666;margin-top:3px">${s.class} - ${s.classroom}</div>
</div>
</label>
</li>`;
}).join('');
this.updateCount(key);
},

filterList(type){
const T=type.charAt(0).toUpperCase()+type.slice(1);
const search=document.getElementById('search'+T).value.toLowerCase();
const cls=document.getElementById('class'+T).value;
const clsr=document.getElementById('classroom'+T).value;
const filtered=this.students.filter(s=>{
const matchSearch=!search||s.name.toLowerCase().includes(search);
const matchClass=!cls||s.class===cls;
const matchClassroom=!clsr||s.classroom===clsr;
return matchSearch&&matchClass&&matchClassroom;
});
const list=document.getElementById('list'+T);
const key=type==='absence'?'absence':type==='note'?'note':type;
list.innerHTML=filtered.map((s)=>{
const idx=this.students.indexOf(s);
const checked=this.selected[key].has(idx)?'checked':'';
return`<li class="student-item">
<label style="display:flex;align-items:center;gap:12px;cursor:pointer">
<input type="checkbox" ${checked} onchange="app.toggleStudent('${key}',${idx})" style="width:22px;height:22px;cursor:pointer">
<div style="flex:1">
<div style="font-weight:600;font-size:16px">${s.name}</div>
<div style="font-size:14px;color:#666;margin-top:3px">${s.class} - ${s.classroom}</div>
</div>
</label>
</li>`;
}).join('');
},

toggleStudent(key,idx){
this.selected[key].has(idx)?this.selected[key].delete(idx):this.selected[key].add(idx);
this.updateCount(key);
this.updateActions();
},

updateCount(key){
const T=key==='absence'?'Absence':key==='note'?'Note':key.charAt(0).toUpperCase()+key.slice(1);
const div=document.getElementById('count'+T);
const count=this.selected[key].size;
if(count>0){
div.classList.remove('hidden');
div.querySelector('span').textContent=count;
}else{
div.classList.add('hidden');
}
},

updateActions(){
const page=document.querySelector('.page.active').id;
if(page==='delaysPage'){
const key=this.currentTab.delay;
const actions=document.getElementById('delayActions');
this.selected[key].size>0&&this.currentTab.delay!=='view'?actions.classList.add('show'):actions.classList.remove('show');
}else if(page==='absencesPage'){
const actions=document.getElementById('absenceActions');
this.selected.absence.size>0&&this.currentTab.absence!=='view'?actions.classList.add('show'):actions.classList.remove('show');
}else if(page==='notesPage'){
const actions=document.getElementById('noteActions');
this.selected.note.size>0&&this.currentTab.notes!=='view'?actions.classList.add('show'):actions.classList.remove('show');
}
},

showPage(page){
document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
const pages=['main','delays','absences','notes','stats','settings'];
const idx=pages.indexOf(page);
document.getElementById(page+'Page').classList.add('active');
document.querySelectorAll('.nav-item')[idx].classList.add('active');
if(page==='delays')this.renderList(this.currentTab.delay);
if(page==='absences')this.currentTab.absence==='daily'?this.renderList('absence'):this.renderAbsenceView();
if(page==='notes')this.currentTab.notes==='add'?this.renderList('note'):this.renderNoteView();
if(page==='stats'){
this.currentTab.stats='daily';
// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
document.querySelectorAll('#statsPage .tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('#statsPage .tab-content').forEach(c=>c.classList.remove('active'));
document.querySelector('#statsPage .tab').classList.add('active');
document.getElementById('statsDailyTab').classList.add('active');
this.updateAllStats();
}

this.updateActions();
},

switchTab(page,tab){
const container=page==='delays'?'delaysPage':page==='absence'?'absencesPage':page==='notes'?'notesPage':'statsPage';
document.querySelectorAll(`#${container} .tab`).forEach(t=>t.classList.remove('active'));
document.querySelectorAll(`#${container} .tab-content`).forEach(t=>t.classList.remove('active'));
event.target.classList.add('active');
if(page==='delays'){
this.currentTab.delay=tab;
document.getElementById('delay'+tab.charAt(0).toUpperCase()+tab.slice(1)+'Tab').classList.add('active');
if(tab==='view')this.renderDelayView();
else this.renderList(tab);
}else if(page==='absence'){
this.currentTab.absence=tab;
document.getElementById('absence'+tab.charAt(0).toUpperCase()+tab.slice(1)+'Tab').classList.add('active');
if(tab==='view')this.renderAbsenceView();
else this.renderList('absence');

}else if(page==='notes'){
this.currentTab.notes=tab;
document.getElementById('note'+tab.charAt(0).toUpperCase()+tab.slice(1)+'Tab').classList.add('active');
if(tab==='view')this.renderNoteView();
else this.renderList('note');
}else if(page==='stats'){

this.currentTab.stats=tab;
document.querySelectorAll('#statsPage .tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('#statsPage .tab-content').forEach(c=>c.classList.remove('active'));
event.target.classList.add('active');
document.getElementById('stats'+tab.charAt(0).toUpperCase()+tab.slice(1)+'Tab').classList.add('active');
this.updateAllStats();
}
this.updateActions();
},

confirmAction(action){
  if(action==='saveDelay'||action==='saveAndSendDelay'||action==='sendDelay'){
    const key=this.currentTab.delay;
    const count=this.selected[key].size;
    if(count===0)return this.showToast('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø·Ø§Ù„Ø¨');
    let msg='';
    if(action==='saveDelay')msg=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ ØªØ£Ø®Ø± ${count} Ø·Ø§Ù„Ø¨ØŸ`;
    else if(action==='saveAndSendDelay')msg=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù€ ${count} Ø·Ø§Ù„Ø¨ØŸ`;
    else msg=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù€ ${count} Ø·Ø§Ù„Ø¨ØŸ`;
    this.showConfirm(msg,()=>{
      if(action==='saveDelay'){
        this.saveDelay();
        this.clearSelection('delay');
      }
      else if(action==='saveAndSendDelay'){
        this.saveDelay();
        setTimeout(()=>{
          this.sendDelay();
          setTimeout(()=>this.clearSelection('delay'),1000);
        },500);
      }
      else this.sendDelay();
    });
  }else if(action==='saveAbsence'||action==='saveAndSendAbsence'||action==='sendAbsence'){
    const count=this.selected.absence.size;
    if(count===0)return this.showToast('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø·Ø§Ù„Ø¨');
    let msg='';
    if(action==='saveAbsence')msg=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ ØºÙŠØ§Ø¨ ${count} Ø·Ø§Ù„Ø¨ØŸ`;
    else if(action==='saveAndSendAbsence')msg=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù€ ${count} Ø·Ø§Ù„Ø¨ØŸ`;
    else msg=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù€ ${count} Ø·Ø§Ù„Ø¨ØŸ`;
    this.showConfirm(msg,()=>{
      if(action==='saveAbsence'){
        this.saveAbsence();
        this.clearSelection('absence');
      }
      else if(action==='saveAndSendAbsence'){
        this.saveAbsence();
        setTimeout(()=>{
          this.sendAbsence();
          setTimeout(()=>this.clearSelection('absence'),1000);
        },500);
      }
      else this.sendAbsence();
    });
  }else if(action==='saveNote'||action==='saveAndSendNote'||action==='sendNote'){
    const count=this.selected.note.size;
    if(count===0)return this.showToast('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø·Ø§Ù„Ø¨');
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙÙ‚Ø· Ù„Ù„Ø­ÙØ¸ Ø£Ùˆ Ø§Ù„Ø­ÙØ¸+Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    if(action==='saveNote'||action==='saveAndSendNote'){
      const noteText=document.getElementById('noteTextarea').value.trim();
      if(!noteText)return this.showToast('âš ï¸ ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø£ÙˆÙ„Ø§Ù‹');
    }
    
    let msg='';
    if(action==='saveNote')msg=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù€ ${count} Ø·Ø§Ù„Ø¨ØŸ`;
    else if(action==='saveAndSendNote')msg=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù€ ${count} Ø·Ø§Ù„Ø¨ØŸ`;
    else msg=`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù€ ${count} Ø·Ø§Ù„Ø¨ØŸ`;
    this.showConfirm(msg,()=>{
      if(action==='saveNote'){
        this.saveNote();
        this.clearSelection('note');
      }
      else if(action==='saveAndSendNote'){
        this.saveNote();
        setTimeout(()=>{
          this.sendNote();
          setTimeout(()=>this.clearSelection('note'),1000);
        },500);
      }
      else this.sendNote();
    });
  }else if(action==='reset'){
    this.showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ£Ø®Ø±Ø§Øª ÙˆØ§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.',()=>this.resetApp());
  }
},



    saveDelay(){
  const key = this.currentTab.delay;
  const T = key.charAt(0).toUpperCase() + key.slice(1);
  const date = new Date(document.getElementById(`date${T}`).value).toLocaleDateString('ar-SA');
  const typeName = key === 'morning' ? 'ØªØ£Ø®Ø± ØµØ¨Ø§Ø­ÙŠ' : key === 'break' ? 'ØªØ£Ø®Ø± Ø¨Ø¹Ø¯ Ø§Ù„ÙØ³Ø­Ø©' : 'ØªØ£Ø®Ø± Ø§Ù„Ø§Ù†ØµØ±Ø§Ù';
  
  this.selected[key].forEach(i => {
    const civil = this.students[i].civil;
    if(!this.delays[civil]) this.delays[civil] = [];
    this.delays[civil].push({type: typeName, date});
  });
  
  // Ù„Ø§ ØªÙ…Ø³Ø­ selected Ù‡Ù†Ø§ - Ø³Ù†Ù…Ø³Ø­Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  // this.selected[key].clear(); â† Ø§Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
  
  this.renderList(key);
  this.saveData();
  this.showToast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
},


saveAbsence(){
const date=new Date(document.getElementById('dateAbsence').value).toLocaleDateString('ar-SA');
this.selected.absence.forEach(i=>{
const civil=this.students[i].civil;
if(!this.absences[civil])this.absences[civil]=[];
this.absences[civil].push({date});
});
//this.selected.absence.clear();
this.renderList('absence');
this.saveData();
this.updateActions();
this.showToast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
},

saveNote(){
  const noteText=document.getElementById('noteTextarea').value.trim();
  
  // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Øµ
  if(!noteText) {
    this.showToast('âš ï¸ ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  
  const date=new Date(document.getElementById('dateNote').value).toLocaleDateString('ar-SA');
  this.selected.note.forEach(i=>{
    const civil=this.students[i].civil;
    if(!this.notes[civil])this.notes[civil]=[];
    this.notes[civil].push({text:noteText,date});
  });
  
  // Ù„Ø§ ØªÙ…Ø³Ø­ selected Ù‡Ù†Ø§ - Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø³Ø­ ÙÙŠ clearSelection Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  // this.selected.note.clear();
  
  document.getElementById('noteTextarea').value='';
  document.getElementById('noteCharCount').textContent='0';
  this.renderList('note');
  this.saveData();
  this.updateActions();
  this.showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­');
},


sendDelay(){
  const key = this.currentTab.delay;
  const selected = Array.from(this.selected[key]);
  if(selected.length === 0) {
    this.showToast('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø·Ø§Ù„Ø¨');
    return;
  }
  
  const typeName = key === 'morning' ? 'ØªØ£Ø®Ø± ØµØ¨Ø§Ø­ÙŠ' : key === 'break' ? 'ØªØ£Ø®Ø± Ø¨Ø¹Ø¯ Ø§Ù„ÙØ³Ø­Ø©' : 'ØªØ£Ø®Ø± Ø§Ù„Ø§Ù†ØµØ±Ø§Ù';
  
  selected.forEach((i, index) => {
    const student = this.students[i];
    const phone = student.parentPhone || student.phone;
    
    if(!phone) {
      this.showToast(`âš ï¸ ${student.name}: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù…Ø³Ø¬Ù„`);
      return;
    }
    
    // ØµÙŠØ§ØºØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    const message = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡\n\n` +
                    `Ø¹Ø²ÙŠØ²ÙŠ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©: *${student.name}*\n\n` +
                    `Ù†ÙˆØ¯ Ø¥Ø¹Ù„Ø§Ù…ÙƒÙ… Ø¨Ø£Ù† Ø§Ø¨Ù†ÙƒÙ…/Ø§Ø¨Ù†ØªÙƒÙ… Ø³Ø¬Ù„ *${typeName}*\n\n` +
                    `ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}\n` +
                    `ğŸ• Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'})}\n\n` +
                    `Ù†Ø£Ù…Ù„ Ù…Ù†ÙƒÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„ØªØ¹Ø§ÙˆÙ†\n\n` +
                    `_Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ_`;
    
    // ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ²)
    let phoneNumber = phone.replace(/\D/g, '');
    
    // Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05
    if(phoneNumber.startsWith('05')) {
      phoneNumber = '966' + phoneNumber.substring(1);
    }
    
    // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¹ ØªØ£Ø®ÙŠØ± (3 Ø«ÙˆØ§Ù†ÙŠ Ø¨ÙŠÙ† ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©)
    setTimeout(() => {
      window.open(`https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`, '_blank');
    }, index * 3000);
  });
  
  this.showToast(`âœ… Ø³ÙŠØªÙ… ÙØªØ­ ${selected.length} Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„`);
},


sendAbsence(){
  const selected = Array.from(this.selected.absence);
  if(selected.length === 0) {
    this.showToast('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø·Ø§Ù„Ø¨');
    return;
  }
  
  selected.forEach((i, index) => {
    const student = this.students[i];
    const phone = student.parentPhone || student.phone;
    
    if(!phone) {
      this.showToast(`âš ï¸ ${student.name}: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù…Ø³Ø¬Ù„`);
      return;
    }
    
    // ØµÙŠØ§ØºØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    const message = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡\n\n` +
                    `Ø¹Ø²ÙŠØ²ÙŠ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©: *${student.name}*\n\n` +
                    `Ù†ÙˆØ¯ Ø¥Ø¹Ù„Ø§Ù…ÙƒÙ… Ø¨Ø£Ù† Ø§Ø¨Ù†ÙƒÙ…/Ø§Ø¨Ù†ØªÙƒÙ… *ØºØ§Ø¦Ø¨/Ø© Ø§Ù„ÙŠÙˆÙ…*\n\n` +
                    `ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}\n\n` +
                    `Ù†Ø£Ù…Ù„ Ù…Ù†ÙƒÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„Ø§Ø·Ù…Ø¦Ù†Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©\n\n` +
                    `_Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ_`;
    
    // ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
    let phoneNumber = phone.replace(/\D/g, '');
    
    // Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05
    if(phoneNumber.startsWith('05')) {
      phoneNumber = '966' + phoneNumber.substring(1);
    }
    
    // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¹ ØªØ£Ø®ÙŠØ± (3 Ø«ÙˆØ§Ù†ÙŠ Ø¨ÙŠÙ† ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©)
    setTimeout(() => {
      window.open(`https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`, '_blank');
    }, index * 3000);
  });
  
  this.showToast(`âœ… Ø³ÙŠØªÙ… ÙØªØ­ ${selected.length} Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„`);
},


sendNote(){
  const selected = Array.from(this.selected.note);
  
  if(selected.length === 0) {
    this.showToast('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø·Ø§Ù„Ø¨');
    return;
  }
  
  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ù…Ù† Ø¢Ø®Ø± Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ø­ÙÙˆØ¸Ø© Ø£Ùˆ Ù…Ù† textarea
  let noteText = document.getElementById('noteTextarea').value.trim();
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† textarea ÙØ§Ø±ØºØŒ Ø®Ø° Ø§Ù„Ù†Øµ Ù…Ù† Ø¢Ø®Ø± Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ø­ÙÙˆØ¸Ø©
  if(!noteText && selected.length > 0) {
    const firstStudent = this.students[selected[0]];
    const civil = firstStudent.civil;
    if(this.notes[civil] && this.notes[civil].length > 0) {
      noteText = this.notes[civil][this.notes[civil].length - 1].text;
    }
  }
  
  if(!noteText) {
    this.showToast('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„');
    return;
  }
  
  selected.forEach((i, index) => {
    const student = this.students[i];
    const phone = student.parentPhone || student.phone;
    
    if(!phone) {
      this.showToast(`âš ï¸ ${student.name}: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù…Ø³Ø¬Ù„`);
      return;
    }
    
    // ØµÙŠØ§ØºØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    const message = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡\n\n` +
                    `Ø¹Ø²ÙŠØ²ÙŠ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©: *${student.name}*\n\n` +
                    `ğŸ“ *Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:*\n` +
                    `${noteText}\n\n` +
                    `ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}\n\n` +
                    `Ù†Ø´ÙƒØ± Ù„ÙƒÙ… ØªØ¹Ø§ÙˆÙ†ÙƒÙ…\n\n` +
                    `_Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ_`;
    
    // ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
    let phoneNumber = phone.replace(/\D/g, '');
    
    // Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05
    if(phoneNumber.startsWith('05')) {
      phoneNumber = '966' + phoneNumber.substring(1);
    }
    
    // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¹ ØªØ£Ø®ÙŠØ± (3 Ø«ÙˆØ§Ù†ÙŠ Ø¨ÙŠÙ† ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©)
    setTimeout(() => {
      window.open(`https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`, '_blank');
    }, index * 3000);
  });
  
  this.showToast(`âœ… Ø³ÙŠØªÙ… ÙØªØ­ ${selected.length} Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„`);
},

    
clearSelection(type){
  if(type === 'delay'){
    const key = this.currentTab.delay;
    this.selected[key].clear();
    this.renderList(key);
  } else if(type === 'absence'){
    this.selected.absence.clear();
    this.renderList('absence');
  } else if(type === 'note'){
    this.selected.note.clear();
    this.renderList('note');
  }
  this.updateActions();
},


renderDelayView(){
const search=document.getElementById('searchDelayView').value.toLowerCase();
const all=[];
for(const civil in this.delays){
const s=this.students.find(st=>st.civil===civil);
if(s&&(!search||s.name.toLowerCase().includes(search))){
this.delays[civil].forEach((d,i)=>all.push({s,d,civil,i}));
}
}
all.sort((a,b)=>new Date(b.d.date)-new Date(a.d.date));
const div=document.getElementById('delayViewList');
if(all.length===0){
div.innerHTML='<div style="text-align:center;padding:50px;color:#999;font-size:15px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ£Ø®Ø±Ø§Øª</div>';
return;
}
div.innerHTML=all.map(item=>`
<div class="record-item" style="border-right:4px solid #ff9800;padding:14px;display:flex;justify-content:space-between;align-items:center">
<div style="flex:1">
<div style="font-weight:600;color:#e65100;font-size:15px">${item.s.name}</div>
<div style="font-size:13px;color:#666;margin-top:4px">${item.d.type} - ğŸ“… ${item.d.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteRecord('delay','${item.civil}',${item.i})">ğŸ—‘ï¸</button>
</div>
`).join('');
},

renderAbsenceView(){
const search=document.getElementById('searchAbsenceView').value.toLowerCase();
const all=[];
for(const civil in this.absences){
const s=this.students.find(st=>st.civil===civil);
if(s&&(!search||s.name.toLowerCase().includes(search))){
this.absences[civil].forEach((a,i)=>all.push({s,a,civil,i}));
}
}
all.sort((a,b)=>new Date(b.a.date)-new Date(a.a.date));
const div=document.getElementById('absenceViewList');
if(all.length===0){
div.innerHTML='<div style="text-align:center;padding:50px;color:#999;font-size:15px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨</div>';
return;
}
div.innerHTML=all.map(item=>`
<div class="record-item" style="border-right:4px solid #f44336;padding:14px;display:flex;justify-content:space-between;align-items:center">
<div style="flex:1">
<div style="font-weight:600;color:#c62828;font-size:15px">${item.s.name}</div>
<div style="font-size:13px;color:#666;margin-top:4px">ØºÙŠØ§Ø¨ ÙŠÙˆÙ…ÙŠ - ğŸ“… ${item.a.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteRecord('absence','${item.civil}',${item.i})">ğŸ—‘ï¸</button>
</div>
`).join('');
},

renderNoteView(){
const search=document.getElementById('searchNoteView').value.toLowerCase();
const all=[];
for(const civil in this.notes){
const s=this.students.find(st=>st.civil===civil);
if(s&&(!search||s.name.toLowerCase().includes(search))){
this.notes[civil].forEach((n,i)=>all.push({s,n,civil,i}));
}
}
all.sort((a,b)=>new Date(b.n.date)-new Date(a.n.date));
const div=document.getElementById('noteViewList');
if(all.length===0){
div.innerHTML='<div style="text-align:center;padding:50px;color:#999;font-size:15px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>';
return;
}
div.innerHTML=all.map(item=>`
<div class="record-item" style="border-right:4px solid #00897b;padding:14px">
<div class="record-item-header">
<div style="flex:1">
<div style="font-weight:600;color:#00695c;font-size:15px">${item.s.name}</div>
<div style="font-size:13px;color:#666;margin-top:4px">ğŸ“… ${item.n.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteRecord('note','${item.civil}',${item.i})">ğŸ—‘ï¸</button>
</div>
<div class="record-note-text">${item.n.text}</div>
</div>
`).join('');
},

deleteRecord(type,civil,idx){
if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ'))return;
if(type==='delay'){
this.delays[civil].splice(idx,1);
if(this.delays[civil].length===0)delete this.delays[civil];
this.renderDelayView();
}else if(type==='absence'){
this.absences[civil].splice(idx,1);
if(this.absences[civil].length===0)delete this.absences[civil];
this.renderAbsenceView();
}else if(type==='note'){
this.notes[civil].splice(idx,1);
if(this.notes[civil].length===0)delete this.notes[civil];
this.renderNoteView();
}
this.saveData();
this.showToast('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
},

showStudent(idx){
const s=this.students[idx];
const delays=this.delays[s.civil]||[];
const absences=this.absences[s.civil]||[];
const notes=this.notes[s.civil]||[];
const modal=document.getElementById('studentModal');
const body=document.getElementById('modalBody');
body.innerHTML=`
<div style="margin-bottom:18px">
<div style="margin:12px 0;padding:12px 0;border-bottom:1px solid #f0f0f0">
<strong style="color:#666;font-size:15px">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:</strong> <span style="font-size:16px">${s.name}</span>
</div>
<div style="margin:12px 0;padding:12px 0;border-bottom:1px solid #f0f0f0">
<strong style="color:#666;font-size:15px">ğŸ†” Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ:</strong> <span style="font-size:16px">${s.civil}</span>
</div>
<div style="margin:12px 0;padding:12px 0;border-bottom:1px solid #f0f0f0">
<strong style="color:#666;font-size:15px">ğŸ“± Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> <span style="font-size:16px">${s.phone}</span>
</div>
<div style="margin:12px 0;padding:12px 0;border-bottom:1px solid #f0f0f0">
<strong style="color:#666;font-size:15px">ğŸ“š Ø§Ù„ØµÙ:</strong> <span style="font-size:16px">${s.class}</span>
</div>
<div style="margin:12px 0;padding:12px 0">
<strong style="color:#666;font-size:15px">ğŸ« Ø§Ù„ÙØµÙ„:</strong> <span style="font-size:16px">${s.classroom}</span>
</div>
</div>
<div class="record-grid">
<div class="record-card delays">
<h4>â° Ø§Ù„ØªØ£Ø®Ø±Ø§Øª (${delays.length})</h4>
<div class="record-list">
${delays.length>0?delays.map((d,i)=>`
<div class="record-item">
<div class="record-item-header">
<div class="record-info">
<div class="record-type">${d.type}</div>
<div class="record-date">ğŸ“… ${d.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteFromModal('delay','${s.civil}',${i})">ğŸ—‘ï¸</button>
</div>
</div>
`).join(''):'<div style="text-align:center;color:#4caf50;padding:12px;font-size:13px">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ£Ø®Ø±Ø§Øª</div>'}
</div>
</div>
<div class="record-card absences">
<h4>ğŸ“… Ø§Ù„ØºÙŠØ§Ø¨ (${absences.length})</h4>
<div class="record-list">
${absences.length>0?absences.map((a,i)=>`
<div class="record-item">
<div class="record-item-header">
<div class="record-info">
<div style="font-weight:600;color:#c62828;font-size:12px">ØºÙŠØ§Ø¨ ÙŠÙˆÙ…ÙŠ</div>
<div class="record-date">ğŸ“… ${a.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteFromModal('absence','${s.civil}',${i})">ğŸ—‘ï¸</button>
</div>
</div>
`).join(''):'<div style="text-align:center;color:#4caf50;padding:12px;font-size:13px">âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨</div>'}
</div>
</div>
<div class="record-card notes">
<h4>ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (${notes.length})</h4>
<div class="record-list">
${notes.length>0?notes.map((n,i)=>`
<div class="record-item">
<div class="record-item-header">
<div class="record-info">
<div class="record-type">Ù…Ù„Ø§Ø­Ø¸Ø©</div>
<div class="record-date">ğŸ“… ${n.date}</div>
</div>
<button class="delete-btn" onclick="app.deleteFromModal('note','${s.civil}',${i})">ğŸ—‘ï¸</button>
</div>
<div class="record-note-text">${n.text}</div>
</div>
`).join(''):'<div style="text-align:center;color:#4caf50;padding:12px;font-size:13px">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>'}
</div>
</div>
</div>
`;
modal.classList.add('active');
},

deleteFromModal(type,civil,idx){
if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ'))return;
if(type==='delay'){
this.delays[civil].splice(idx,1);
if(this.delays[civil].length===0)delete this.delays[civil];
}else if(type==='absence'){
this.absences[civil].splice(idx,1);
if(this.absences[civil].length===0)delete this.absences[civil];
}else if(type==='note'){
this.notes[civil].splice(idx,1);
if(this.notes[civil].length===0)delete this.notes[civil];
}
this.saveData();
this.closeModal();
this.renderStudents();
this.showToast('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
},

closeModal(){
document.getElementById('studentModal').classList.remove('active');
},

showConfirm(msg,onYes){
document.getElementById('confirmMsg').textContent=msg;
document.getElementById('confirmYes').onclick=function(){
app.closeConfirm();
onYes();
};
document.getElementById('confirmModal').classList.add('active');
},

closeConfirm(){
document.getElementById('confirmModal').classList.remove('active');
},

importExcel(e){
const file=e.target.files[0];
if(!file)return;
const reader=new FileReader();
const self=this;
reader.onload=function(ev){
try{
const data=new Uint8Array(ev.target.result);
const wb=XLSX.read(data,{type:'array'});
const sheet=wb.Sheets[wb.SheetNames[0]];
const json=XLSX.utils.sheet_to_json(sheet);
self.students=json.map(r=>({
name:r['Ø§Ù„Ø§Ø³Ù…']||r['Name']||'',
civil:String(r['Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ']||r['Civil']||''),
phone:String(r['Ø§Ù„Ø¬ÙˆØ§Ù„']||r['Phone']||''),
class:r['Ø§Ù„ØµÙ']||r['Class']||'',
classroom:r['Ø§Ù„ÙØµÙ„']||r['Classroom']||''
}));
self.saveData();
self.populateFilters();
self.showToast(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${self.students.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`);
e.target.value='';
}catch(err){
self.showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
}
};
reader.readAsArrayBuffer(file);
},

resetApp(){
localStorage.clear();
this.students=[];
this.delays={};
this.absences={};
this.notes={};
this.selected={morning:new Set(),break:new Set(),departure:new Set(),absence:new Set(),note:new Set()};
document.getElementById('studentsList').innerHTML='';
document.getElementById('noteTextarea').value='';
document.getElementById('noteCharCount').textContent='0';
this.showToast('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
this.showPage('main');
},

showToast(msg){
const toast=document.getElementById('toast');
toast.textContent=msg;
toast.classList.add('show');
setTimeout(function(){toast.classList.remove('show');},3000);
},  

// Ù†Ø¸Ø§Ù… Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
subscription: {
    trialDays: 30,
    activationCodes: [],
},

// ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
checkSubscription(){
  let code = localStorage.getItem('activationCode');
  
  // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ - Ø£Ù†Ø´Ø¦ ØªØ¬Ø±Ø¨Ø© 7 Ø£ÙŠØ§Ù…
  if(!code){
    code = this.initTrialSubscription();
  }
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ù† localStorage
  const storedSubs = localStorage.getItem('subscriptions');
  if(storedSubs){
    this.subscriptions = JSON.parse(storedSubs);
  }
  
  const subscription = this.subscriptions[code];
  
  if(!subscription || !subscription.active){
    document.getElementById('lockScreen').style.display = 'flex';
    return false;
  }
  
  const days = this.calculateRemainingDays(subscription.endDate);
  
  // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
  if(subscription.isTrial){
    if(days === 2){
      this.showToast('â° ØªØ¨Ù‚Ù‰ ÙŠÙˆÙ…Ø§Ù† Ù…Ù† Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©!', 8000);
    } else if(days === 1){
      this.showToast('ğŸ”¥ Ø¢Ø®Ø± ÙŠÙˆÙ…! Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ', 10000);
    } else if(days === 0){
      this.showToast('âš ï¸ Ø§Ù†ØªÙ‡Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©', 5000);
    }
  }
  
  this.updateSubscriptionBadge(days);
  
  if(days <= 0){
    document.getElementById('lockScreen').style.display = 'flex';
    return false;
  }
  
  return true;
},

calculateRemainingDays(endDate){
  const now = new Date();
  const end = new Date(endDate);
  const diff = end - now;
  return Math.ceil(diff / (1000 * 60 * 60 * 24));
},

updateSubscriptionBadge(days){
  const badge = document.getElementById('subscriptionBadge');
  if(!badge) return;
  
  const daysEl = badge.querySelector('.badge-days');
  const labelEl = badge.querySelector('.badge-label');
  
  if(daysEl) daysEl.textContent = days;
  if(labelEl) labelEl.textContent = days === 1 ? 'ÙŠÙˆÙ… Ù…ØªØ¨Ù‚ÙŠ' : 'Ø£ÙŠØ§Ù… Ù…ØªØ¨Ù‚ÙŠØ©';
  
  // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
  badge.classList.remove('trial', 'warning', 'active');
  if(days <= 3){
    badge.classList.add('warning');
  } else if(days <= 7){
    badge.classList.add('trial');
  } else {
    badge.classList.add('active');
  }
},



// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¬Ù‡Ø§Ø²
getDeviceId(){
  let deviceId = localStorage.getItem('deviceId');
  
  if(!deviceId){
    // Ø£Ù†Ø´Ø¦ Ù…Ø¹Ø±Ù‘Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù‡Ø§Ø² (Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡)
    deviceId = 'device-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('deviceId', deviceId);
  }
  
  return deviceId;
},

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ¬Ø±Ø¨Ø©
async checkTrialExpiry(code){
  const deviceId = this.getDeviceId();
  
  try {
    const snapshot = await database.ref('trials/' + deviceId).once('value');
    const trial = snapshot.val();
    
    if(trial){
      const startDate = new Date(trial.startDate);
      const today = new Date();
      const daysUsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
      
      if(daysUsed >= trial.trialDays){
        this.showTrialExpiredMessage(daysUsed);
        this.showPage('lock');
      } else {
        const remaining = trial.trialDays - daysUsed;
        this.showToast(`â° ØªØ¨Ù‚Ù‰ ${remaining} ÙŠÙˆÙ… Ù…Ù† Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©`);
      }
    }
  } catch(error){
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚:', error);
  }
},

// Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ¬Ø±Ø¨Ø©
showTrialExpiredMessage(daysUsed){
  const msg = `Ø§Ù†ØªÙ‡Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© (${daysUsed} ÙŠÙˆÙ…)\n\n` +
              `ğŸ“Š Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø£Ù…Ø§Ù†!\n` +
              `Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù€:\n` +
              `â€¢ ${this.students.length} Ø·Ø§Ù„Ø¨\n` +
              `â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª\n\n` +
              `Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„`;
  
  alert(msg);
},


// ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ù†Ø± Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©

 updateTrialBanner(days,isActivated){
  const badge=document.getElementById('subscriptionBadge');
  const daysSpan=badge?.querySelector('.badge-days');
  const labelSpan=badge?.querySelector('.badge-label');
  const iconDiv=badge?.querySelector('.badge-icon');
  
  if(!badge) return;
  
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  badge.classList.remove('trial','active','warning');
  
  if(isActivated){
    // Ø§Ø´ØªØ±Ø§Ùƒ Ù…ÙØ¹Ù‘Ù„
    iconDiv.textContent='âœ…';
    daysSpan.textContent=days;
    labelSpan.textContent='ÙŠÙˆÙ… Ù…ØªØ¨Ù‚ÙŠ';
    badge.classList.add('active');
  }else{
    // ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
    if(days<=3){
      iconDiv.textContent='âš ï¸';
      badge.classList.add('warning');
    }else if(days<=7){
      iconDiv.textContent='â°';
      badge.classList.add('warning');
    }else{
      iconDiv.textContent='ğŸ“¦';
      badge.classList.add('trial');
    }
    daysSpan.textContent=days;
    labelSpan.textContent='ÙŠÙˆÙ… ØªØ¬Ø±ÙŠØ¨ÙŠ';
  }
  
  badge.style.display='flex';
},
   

// Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„
showLockScreen() {
    const lockScreen = document.getElementById('lockScreen');
    if (lockScreen) {
        lockScreen.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
},

// Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„
hideLockScreen() {
    const lockScreen = document.getElementById('lockScreen');
    if (lockScreen) {
        lockScreen.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
},

// ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
activateSubscription(){
  let code = document.getElementById('activationCode')?.value?.trim().toUpperCase();
  
  // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø§Ù„Ø¹Ù†ØµØ±ØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  if(!code){
    code = document.getElementById('activationCodeInput')?.value?.trim().toUpperCase();
  }
  
  if(!code){
    this.showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„');
    return;
  }
  
  if(!code.startsWith('SK-')){
    this.showToast('âš ï¸ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ - ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ SK-');
    return;
  }
  
  // Ø­Ø¯Ø¯ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
  const isTrial = code.includes('TRIAL');
  const endDate = new Date();
  
  if(isTrial){
    endDate.setDate(endDate.getDate() + 7); // 7 Ø£ÙŠØ§Ù…
  } else {
    endDate.setFullYear(endDate.getFullYear() + 1); // Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©
  }
  
  this.subscriptions[code] = {
    active: true,
    startDate: new Date().toISOString(),
    endDate: endDate.toISOString(),
    isTrial: isTrial,
    paid: !isTrial
  };
  
  localStorage.setItem('activationCode', code);
  localStorage.setItem('subscriptions', JSON.stringify(this.subscriptions));
  this.saveData();
  
  // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„
  document.getElementById('lockScreen').style.display = 'none';
  
  this.showToast('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø¨Ù†Ø¬Ø§Ø­!', 5000);
  
  setTimeout(() => {
    this.showPage('main');
    location.reload();
  }, 2000);
},



// Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ (Ù„Ù„Ù…Ø·ÙˆØ±)
addActivationCode(code) {
    this.subscription.activationCodes.push(code.toUpperCase());
    localStorage.setItem('validCodes', JSON.stringify(this.subscription.activationCodes));
},

// Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©
copyText(text){
if(navigator.clipboard){
navigator.clipboard.writeText(text).then(()=>{
this.showToast('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­');
}).catch(()=>{
this.showToast('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®');
});
}else{
const textarea=document.createElement('textarea');
textarea.value=text;
textarea.style.position='fixed';
textarea.style.opacity='0';
document.body.appendChild(textarea);
textarea.select();
try{
document.execCommand('copy');
this.showToast('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­');
}catch(err){
this.showToast('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®');
}
document.body.removeChild(textarea);
}
},

// Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
levelSettings:{
level1:{min:1,max:5},
level2:{min:6,max:10},
level3:{min:11,max:15},
level4:{min:16,max:20}
},

// ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
loadLevelSettings(){
const stored=localStorage.getItem('levelSettings');
if(stored){
this.levelSettings=JSON.parse(stored);
this.applyLevelSettings();
}
},

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„
applyLevelSettings(){
document.getElementById('level1Min').value=this.levelSettings.level1.min;
document.getElementById('level1Max').value=this.levelSettings.level1.max;
document.getElementById('level2Min').value=this.levelSettings.level2.min;
document.getElementById('level2Max').value=this.levelSettings.level2.max;
document.getElementById('level3Min').value=this.levelSettings.level3.min;
document.getElementById('level3Max').value=this.levelSettings.level3.max;
document.getElementById('level4Min').value=this.levelSettings.level4.min;
document.getElementById('level4Max').value=this.levelSettings.level4.max;
},

// Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
saveLevelSettings(){
this.levelSettings={
level1:{
min:parseInt(document.getElementById('level1Min').value),
max:parseInt(document.getElementById('level1Max').value)
},
level2:{
min:parseInt(document.getElementById('level2Min').value),
max:parseInt(document.getElementById('level2Max').value)
},
level3:{
min:parseInt(document.getElementById('level3Min').value),
max:parseInt(document.getElementById('level3Max').value)
},
level4:{
min:parseInt(document.getElementById('level4Min').value),
max:parseInt(document.getElementById('level4Max').value)
}
};
localStorage.setItem('levelSettings',JSON.stringify(this.levelSettings));
this.renderAbsenceLevels();
this.showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
},

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
calculateDailyStats(){
const today=new Date().toLocaleDateString('ar-SA');
let absentToday=0;
let lateToday=0;
for(const civil in this.absences){
if(this.absences[civil].some(a=>a.date===today))absentToday++;
}
for(const civil in this.delays){
if(this.delays[civil].some(d=>d.date===today))lateToday++;
}
const total=this.students.length;
const present=total-absentToday;
const percentage=total>0?Math.round((present/total)*100):0;
document.getElementById('dailyDate').textContent=today;
document.getElementById('dailyTotal').textContent=total;
document.getElementById('dailyPresent').textContent=present;
document.getElementById('dailyAbsent').textContent=absentToday;
document.getElementById('dailyLate').textContent=lateToday;
document.getElementById('dailyPercentage').textContent=percentage+'%';
},

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
calculateWeeklyStats(){
const now=new Date();
const weekAgo=new Date(now.getTime()-(7*24*60*60*1000));
let totalAbsent=0;
let totalLate=0;
for(const civil in this.absences){
totalAbsent+=this.absences[civil].filter(a=>{
const date=new Date(a.date.split('/').reverse().join('-'));
return date>=weekAgo&&date<=now;
}).length;
}
for(const civil in this.delays){
totalLate+=this.delays[civil].filter(d=>{
const date=new Date(d.date.split('/').reverse().join('-'));
return date>=weekAgo&&date<=now;
}).length;
}
const avgPresent=this.students.length>0?Math.round((this.students.length*7-totalAbsent)/7):0;
document.getElementById('weeklyDays').textContent='7';
document.getElementById('weeklyAvgPresent').textContent=avgPresent;
document.getElementById('weeklyTotalAbsent').textContent=totalAbsent;
document.getElementById('weeklyTotalLate').textContent=totalLate;
},

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
calculateMonthlyStats(){
const now=new Date();
const monthAgo=new Date(now.getFullYear(),now.getMonth(),1);
let totalAbsent=0;
let totalLate=0;
const absentCounts={};
for(const civil in this.absences){
const count=this.absences[civil].filter(a=>{
const date=new Date(a.date.split('/').reverse().join('-'));
return date>=monthAgo&&date<=now;
}).length;
totalAbsent+=count;
if(count>0)absentCounts[civil]=count;
}
for(const civil in this.delays){
totalLate+=this.delays[civil].filter(d=>{
const date=new Date(d.date.split('/').reverse().join('-'));
return date>=monthAgo&&date<=now;
}).length;
}
const days=now.getDate();
const avgPresent=this.students.length>0?Math.round((this.students.length*days-totalAbsent)/days):0;
document.getElementById('monthlyDays').textContent=days;
document.getElementById('monthlyAvgPresent').textContent=avgPresent;
document.getElementById('monthlyTotalAbsent').textContent=totalAbsent;
document.getElementById('monthlyTotalLate').textContent=totalLate;
const sorted=Object.entries(absentCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
const listDiv=document.getElementById('topAbsentList');
if(sorted.length===0){
listDiv.innerHTML='<div class="level-empty">âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>';
}else{
listDiv.innerHTML=sorted.map(([civil,count])=>{
const s=this.students.find(st=>st.civil===civil);
return s?`<div class="level-student">
<span class="student-name-stat">${s.name}</span>
<span class="student-days">${count} ÙŠÙˆÙ…</span>
</div>`:'';
}).join('');
}
},

// Ø¹Ø±Ø¶ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨
renderAbsenceLevels(){
const levels={1:[],2:[],3:[],4:[]};
for(const civil in this.absences){
const count=this.absences[civil].length;
const s=this.students.find(st=>st.civil===civil);
if(!s)continue;
if(count>=this.levelSettings.level1.min&&count<=this.levelSettings.level1.max){
levels[1].push({student:s,days:count});
}else if(count>=this.levelSettings.level2.min&&count<=this.levelSettings.level2.max){
levels[2].push({student:s,days:count});
}else if(count>=this.levelSettings.level3.min&&count<=this.levelSettings.level3.max){
levels[3].push({student:s,days:count});
}else if(count>=this.levelSettings.level4.min&&count<=this.levelSettings.level4.max){
levels[4].push({student:s,days:count});
}
}
for(let i=1;i<=4;i++){
const div=document.getElementById(`level${i}Students`);
if(levels[i].length===0){
div.innerHTML='<div class="level-empty">âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>';
}else{
div.innerHTML=levels[i].map(item=>`
<div class="level-student">
<span class="student-name-stat">${item.student.name}</span>
<span class="student-days">${item.days} ÙŠÙˆÙ…</span>
</div>
`).join('');
}
}
},

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
updateAllStats(){
this.calculateDailyStats();
this.calculateWeeklyStats();
this.calculateMonthlyStats();
this.renderAbsenceLevels();
}
};

document.addEventListener('DOMContentLoaded',function(){app.init();});


// Ø¯Ø¹Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
if ('serviceWorker' in navigator && 'SyncManager' in window) {
  navigator.serviceWorker.ready.then(swRegistration => {
    return swRegistration.sync.register('sync-data');
  });
}

    
</script>

</body>
</html>
