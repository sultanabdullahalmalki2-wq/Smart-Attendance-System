<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a237e">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ - Ù…ØªÙ‚Ø¯Ù… v6.0</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">    
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Tajawal',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;overflow-x:hidden}
.container{max-width:1400px;margin:0 auto;padding:20px}
.nav{background:white;border-radius:15px;padding:15px;margin-bottom:20px;display:flex;justify-content:space-around;box-shadow:0 5px 20px rgba(0,0,0,0.1);position:sticky;top:20px;z-index:100;overflow-x:auto}
.nav-item{flex:1;text-align:center;padding:12px;border-radius:10px;cursor:pointer;transition:all 0.3s;color:#666;font-weight:500;min-width:90px}
.nav-item:hover{background:#f5f5f5;transform:translateY(-2px)}
.nav-item.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 15px rgba(102,126,234,0.4)}
.nav-item i{display:block;font-size:22px;margin-bottom:5px}
.nav-item span{font-size:13px}
.sub-tabs{background:white;border-radius:12px;padding:10px;margin-bottom:20px;display:flex;gap:10px;box-shadow:0 3px 10px rgba(0,0,0,0.08)}
.sub-tab{flex:1;padding:12px 20px;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.3s;color:#666;font-weight:600;background:#f8f9fa}
.sub-tab:hover{background:#e9ecef}
.sub-tab.active{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:white;box-shadow:0 3px 12px rgba(17,153,142,0.3)}
.page{display:none;animation:fadeIn 0.5s}
.page.active{display:block}
.sub-page{display:none}
.sub-page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.card{background:white;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 5px 20px rgba(0,0,0,0.1)}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0;flex-wrap:wrap;gap:10px}
.card-title{font-size:1.5rem;font-weight:700;color:#1a237e;display:flex;align-items:center;gap:10px}
.card-title i{font-size:1.8rem;color:#667eea}
.btn{padding:12px 24px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s;font-family:'Tajawal',sans-serif;display:inline-flex;align-items:center;gap:8px;justify-content:center}
.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 15px rgba(102,126,234,0.4)}
.btn-primary:hover{transform:translateY(-2px)}
.btn-success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:white}
.btn-danger{background:linear-gradient(135deg,#eb3349 0%,#f45c43 100%);color:white}
.btn-warning{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white}
.btn-info{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white}
.btn-secondary{background:#f5f5f5;color:#666}
.btn-whatsapp{background:#25d366;color:white}
.form-group{margin-bottom:20px}
.form-label{display:block;margin-bottom:8px;font-weight:600;color:#333;font-size:15px}
.form-input,.form-select,.form-textarea{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;font-family:'Tajawal',sans-serif;transition:all 0.3s}
.form-textarea{min-height:120px;resize:vertical}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
.filters-section{background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:20px}
.filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px}
.filter-actions{display:flex;gap:10px;flex-wrap:wrap}
.student-list{display:grid;gap:15px}
.student-item{background:#f8f9fa;padding:15px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;transition:all 0.3s;border-right:4px solid transparent}
.student-item:hover{background:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.08);transform:translateX(-5px);border-right-color:#667eea}
.student-item.selected{background:#e3f2fd;border-right-color:#2196f3}
.student-checkbox{width:20px;height:20px;cursor:pointer;margin-left:10px}
.student-info{flex:1}
.student-name{font-size:1.1rem;font-weight:700;color:#1a237e;margin-bottom:5px}
.student-details{display:flex;gap:15px;flex-wrap:wrap;font-size:14px;color:#666}
.student-detail{display:flex;align-items:center;gap:5px}
.student-detail i{color:#667eea}
.student-record{margin-top:10px;padding:10px;background:rgba(102,126,234,0.05);border-radius:8px;display:flex;gap:15px;flex-wrap:wrap;font-size:13px}
.record-badge{padding:4px 10px;border-radius:15px;font-weight:600;display:inline-flex;align-items:center;gap:5px}
.record-badge.delays{background:#fff3cd;color:#856404}
.record-badge.absences{background:#f8d7da;color:#721c24}
.record-badge.notes{background:#d1ecf1;color:#0c5460}
.student-actions{display:flex;gap:10px}
.btn-icon{width:40px;height:40px;border-radius:10px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s;font-size:16px}
.btn-icon.edit{background:#667eea;color:white}
.btn-icon.delete{background:#f45c43;color:white}
.btn-icon:hover{transform:scale(1.1)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
.stat-card{background:white;padding:20px;border-radius:12px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,0.1);transition:all 0.3s}
.stat-card:hover{transform:translateY(-5px)}
.stat-icon{font-size:2.5rem;margin-bottom:10px}
.stat-value{font-size:2rem;font-weight:900;margin-bottom:5px}
.stat-label{color:#666;font-size:14px;font-weight:500}
.levels-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
.level-card{padding:20px;border-radius:12px;border-right:5px solid;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
.level-card.safe{background:#d4edda;border-right-color:#28a745}
.level-card.attention{background:#fff3cd;border-right-color:#ffc107}
.level-card.warning{background:#ffe0b2;border-right-color:#fd7e14}
.level-card.danger{background:#f8d7da;border-right-color:#dc3545}
.level-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.level-title{font-size:1.2rem;font-weight:700}
.level-count{font-size:2rem;font-weight:900}
.level-threshold{font-size:13px;color:#666;margin-bottom:10px}
.level-students{max-height:200px;overflow-y:auto}
.level-student{padding:8px;background:white;margin-bottom:5px;border-radius:6px;font-size:14px;display:flex;justify-content:space-between}
.search-box{position:relative;margin-bottom:20px}
.search-input{width:100%;padding:15px 50px 15px 20px;border:2px solid #e0e0e0;border-radius:12px;font-size:16px}
.search-input:focus{border-color:#667eea}
.search-icon{position:absolute;left:20px;top:50%;transform:translateY(-50%);color:#667eea;font-size:20px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;overflow-y:auto}
.modal.active{display:flex}
.modal-content{background:white;border-radius:20px;padding:30px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;margin:20px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
.modal-title{font-size:1.5rem;font-weight:700;color:#1a237e}
.modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#666;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%}
.modal-close:hover{background:#f0f0f0}
.empty-state{text-align:center;padding:60px 20px;color:#666}
.empty-icon{font-size:4rem;margin-bottom:20px;opacity:0.5}
.empty-text{font-size:1.2rem;margin-bottom:10px}
.toast{position:fixed;bottom:30px;right:30px;background:white;padding:15px 20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.2);z-index:10000;display:flex;align-items:center;gap:12px;min-width:300px;transform:translateX(400px);transition:transform 0.3s}
.toast.show{transform:translateX(0)}
.toast-icon{font-size:24px}
.toast.success{border-right:4px solid #38ef7d}
.toast.success .toast-icon{color:#38ef7d}
.toast.error{border-right:4px solid #f45c43}
.toast.error .toast-icon{color:#f45c43}
.toast.info{border-right:4px solid #667eea}
.toast.info .toast-icon{color:#667eea}
.subscription-badge{background:white;padding:15px 20px;border-radius:12px;display:flex;align-items:center;gap:15px;margin-bottom:20px;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
.subscription-icon{font-size:2rem}
.subscription-info{flex:1}
.subscription-status{font-weight:700;font-size:16px;margin-bottom:5px}
.subscription-expiry{font-size:13px;color:#666}
.subscription-badge.trial{border-right:4px solid #ff9800}
.subscription-badge.active{border-right:4px solid #4caf50}
#lockScreen,#paymentPage{position:fixed;top:0;left:0;width:100vw;min-height:100vh;z-index:99999;overflow-y:auto}
.lock-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(26,35,126,0.95) 0%,rgba(13,71,161,0.95) 100%)}
.lock-container,.payment-container{position:relative;z-index:1;max-width:500px;margin:0 auto;padding:20px;min-height:100vh;display:flex;flex-direction:column;justify-content:center}
.lock-header{text-align:center;margin-bottom:30px}
.lock-icon-main{font-size:70px;margin-bottom:15px}
.lock-main-title{color:white;font-size:2rem;margin-bottom:10px;font-weight:900}
.lock-subtitle{color:rgba(255,255,255,0.9);font-size:1.1rem}
.features-grid{display:grid;gap:15px;margin-bottom:30px}
.feature-item{background:rgba(255,255,255,0.1);padding:20px;border-radius:15px;display:flex;gap:15px}
.feature-icon{font-size:2rem;min-width:50px;height:50px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center}
.feature-content{flex:1}
.feature-title{color:white;font-size:1.1rem;font-weight:700;margin-bottom:5px}
.feature-text{color:rgba(255,255,255,0.8);font-size:14px}
.btn-subscribe-main{width:100%;padding:18px;background:linear-gradient(135deg,#ffd89b 0%,#19547b 100%);color:white;border:none;border-radius:15px;font-size:1.2rem;font-weight:900;cursor:pointer;margin-bottom:15px}
.warning-box{background:rgba(244,67,54,0.15);border:2px solid rgba(244,67,54,0.5);border-radius:15px;padding:20px;margin-top:20px;display:flex;gap:15px}
.warning-icon{font-size:2rem;color:#ff5252}
.warning-content{flex:1;color:white}
.countdown-timer{background:rgba(244,67,54,0.3);padding:4px 12px;border-radius:20px;font-weight:900;color:#ffeb3b}
.payment-methods{display:grid;gap:15px;margin-bottom:30px}
.payment-method{background:rgba(255,255,255,0.95);padding:20px;border-radius:15px;cursor:pointer;border:3px solid transparent}
.payment-method.selected{border-color:#ffd89b;background:white}
.method-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
.method-icon{font-size:2rem;min-width:50px;height:50px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:12px;display:flex;align-items:center;justify-content:center}
.method-title h3{font-size:1.2rem;color:#1a237e}
.method-content{display:none;margin-top:15px;padding-top:15px;border-top:2px solid #f0f0f0}
.payment-method.selected .method-content{display:block}
.bank-info{background:#e3f2fd;padding:15px;border-radius:10px;margin-bottom:15px}
.bank-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px dashed rgba(0,0,0,0.1)}
.activation-section{background:rgba(255,255,255,0.95);padding:25px;border-radius:15px;text-align:center}
.activation-input-group{display:flex;gap:10px}
.activation-input{flex:1;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;text-align:center;font-family:monospace;text-transform:uppercase}
@media (max-width:768px){
.nav{padding:10px 5px}
.nav-item{padding:10px 5px;font-size:12px;min-width:70px}
.stats-grid{grid-template-columns:repeat(2,1fr)}
.filters-grid{grid-template-columns:1fr}
.student-item{flex-direction:column;align-items:start;gap:15px}
.levels-grid{grid-template-columns:1fr}
}
.w-100{width:100%}
.d-flex{display:flex}
.gap-10{gap:10px}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-thumb{background:#667eea;border-radius:10px}

.btn:disabled, .btn-icon:disabled, input:disabled, select:disabled, textarea:disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    pointer-events: none !important;
}
.disabled-action {
    pointer-events: none !important;
    opacity: 0.5 !important;
    cursor: not-allowed !important;
}
</style>
</head>
<body>

<div id="lockScreen" style="display:none;">
<div class="lock-overlay"></div>
<div class="lock-container">
<div class="lock-header">
<div class="lock-icon-main">ğŸ”’</div>
<h1 class="lock-main-title">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ</h1>
<p class="lock-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø´Ø§Ù…Ù„Ø©</p>
</div>
<div class="features-grid">
<div class="feature-item"><div class="feature-icon">ğŸ“Š</div><div class="feature-content"><div class="feature-title">ØªÙ‚Ø§Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠØ©</div><div class="feature-text">ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ø§Ù…Ù„Ø©</div></div></div>
<div class="feature-item"><div class="feature-icon">ğŸ“±</div><div class="feature-content"><div class="feature-title">ÙˆØ§ØªØ³Ø§Ø¨</div><div class="feature-text">Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</div></div></div>
</div>
<button class="btn-subscribe-main" onclick="app.showPaymentPage()">ğŸš€ Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† - 35 Ø±ÙŠØ§Ù„</button>
<div class="warning-box">
<span class="warning-icon">âš ï¸</span>
<div class="warning-content"><strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù…ØªØ¨Ù‚ÙŠ <span class="countdown-timer" id="trialDaysLeft">7</span> Ø£ÙŠØ§Ù…</div>
</div>
</div>
</div>

<div id="paymentPage" style="display:none;">
<div class="lock-overlay"></div>
<div class="payment-container">
<button class="btn btn-secondary" onclick="app.hidePaymentPage()" style="margin-bottom:20px;">â† Ø±Ø¬ÙˆØ¹</button>
<div class="payment-header" style="text-align:center;margin-bottom:30px;">
<div style="font-size:60px;margin-bottom:15px;">ğŸ’³</div>
<h2 style="color:white;font-size:2rem;margin-bottom:10px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹</h2>
</div>
<div class="payment-methods">
<div class="payment-method" id="bankTransfer" onclick="app.selectPaymentMethod('bank')">
<div class="method-header">
<div class="method-icon">ğŸ¦</div>
<div class="method-title"><h3>Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ</h3></div>
<input type="radio" name="paymentMethod" value="bank">
</div>
<div class="method-content">
<div class="bank-info">
<div class="bank-row"><span>Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†:</span><span style="font-family:monospace;">SA1234567891234567891234</span></div>
<div class="bank-row" style="border:none;"><span>Ø§Ù„Ù…Ø¨Ù„Øº:</span><span style="color:#11998e;font-weight:bold;">35 Ø±ÙŠØ§Ù„</span></div>
</div>
</div>
</div>
<div class="payment-method" id="whatsappPay" onclick="app.selectPaymentMethod('whatsapp')">
<div class="method-header">
<div class="method-icon">ğŸ’¬</div>
<div class="method-title"><h3>ÙˆØ§ØªØ³Ø§Ø¨</h3></div>
<input type="radio" name="paymentMethod" value="whatsapp">
</div>
<div class="method-content">
<a href="https://wa.me/966533371147?text=Ø£Ø±ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…" class="btn btn-whatsapp w-100" target="_blank" style="text-decoration:none;justify-content:center;"><i class="fab fa-whatsapp"></i> ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù†</a>
</div>
</div>
</div>
<div class="activation-section">
<h3 style="color:#1a237e;margin-bottom:10px;">Ù‡Ù„ Ù„Ø¯ÙŠÙƒ ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ØŸ</h3>
<div class="activation-input-group">
<input type="text" id="activationCodeInput" data-allow="true" placeholder="SK-XXXXX-XXXXX" class="activation-input">
<button onclick="app.activateSubscription()" class="btn btn-success" data-allow="true">ØªÙØ¹ÙŠÙ„</button>
</div>
</div>
</div>
</div>

<div class="container">

<nav class="nav">
<div class="nav-item active" onclick="app.showPage('home')"><i class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
<div class="nav-item" onclick="app.showPage('students')"><i class="fas fa-users"></i><span>Ø§Ù„Ø·Ù„Ø§Ø¨</span></div>
<div class="nav-item" onclick="app.showPage('attendance')"><i class="fas fa-clipboard-check"></i><span>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</span></div>
<div class="nav-item" onclick="app.showPage('notes')"><i class="fas fa-sticky-note"></i><span>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span></div>
<div class="nav-item" onclick="app.showPage('statistics')"><i class="fas fa-chart-bar"></i><span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span></div>
<div class="nav-item" onclick="app.showPage('reports')"><i class="fas fa-file-alt"></i><span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></div>
<div class="nav-item" onclick="app.showPage('settings')"><i class="fas fa-cog"></i><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
</nav>

<div id="homePage" class="page active">
<div class="subscription-badge trial" id="subscriptionBadge">
<div class="subscription-icon">â°</div>
<div class="subscription-info">
<div class="subscription-status" id="subscriptionStatus">ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</div>
<div class="subscription-expiry" id="subscriptionExpiry">Ù…ØªØ¨Ù‚ÙŠ 7 Ø£ÙŠØ§Ù…</div>
<div id="activationCodeDisplay" style="font-family:monospace;font-weight:bold;color:#667eea;margin-top:5px;"></div>
</div>
<button class="btn btn-warning" onclick="app.showPaymentPage()" data-allow="true">Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†</button>
</div>

<div class="stats-grid">
<div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value" id="totalStudents">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div></div>
<div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-value" id="presentToday">0</div><div class="stat-label">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</div></div>
<div class="stat-card"><div class="stat-icon">â°</div><div class="stat-value" id="delaysToday">0</div><div class="stat-label">Ø§Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</div></div>
<div class="stat-card"><div class="stat-icon">âŒ</div><div class="stat-value" id="absentToday">0</div><div class="stat-label">Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</div></div>
<div class="stat-card"><div class="stat-icon">ğŸ“</div><div class="stat-value" id="notesToday">0</div><div class="stat-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div></div>
</div>

<div class="card">
<div class="card-header"><h2 class="card-title"><i class="fas fa-bolt"></i>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h2></div>
<div class="d-flex gap-10" style="flex-wrap:wrap;">
<button class="btn btn-primary" onclick="app.showPage('students')"><i class="fas fa-user-plus"></i>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
<button class="btn btn-success" onclick="app.showPage('attendance')"><i class="fas fa-clipboard-check"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
<button class="btn btn-warning" onclick="app.showPage('notes')"><i class="fas fa-sticky-note"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©</button>
<button class="btn btn-info" onclick="app.showPage('reports')"><i class="fas fa-file-export"></i>Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ±</button>
</div>
</div>
</div>

<div id="studentsPage" class="page">
<div class="card">
<div class="card-header">
<h2 class="card-title"><i class="fas fa-users"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
<button class="btn btn-primary" onclick="app.showAddStudentModal()"><i class="fas fa-user-plus"></i>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
</div>

<div class="search-box">
<input type="text" class="search-input" id="studentSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." oninput="app.searchStudents()">
<i class="fas fa-search search-icon"></i>
</div>

<div class="d-flex gap-10" style="margin-bottom:20px;flex-wrap:wrap;">
<label for="excelFile" class="btn btn-success" style="margin:0;cursor:pointer;"><i class="fas fa-file-excel"></i>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</label>
<input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none;">
<button class="btn btn-primary" onclick="app.exportStudentsExcel()"><i class="fas fa-download"></i>ØªØµØ¯ÙŠØ± Excel</button>
<button class="btn btn-danger" onclick="app.deleteAllStudents()"><i class="fas fa-trash"></i>Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
</div>

<div id="studentsList"></div>
</div>
</div>

<div id="attendancePage" class="page">
<div class="sub-tabs">
<div class="sub-tab active" onclick="app.showSubPage('delays')">â° Ø§Ù„ØªØ£Ø®ÙŠØ±</div>
<div class="sub-tab" onclick="app.showSubPage('absences')">âŒ Ø§Ù„ØºÙŠØ§Ø¨</div>
</div>

<div id="delaysSubPage" class="sub-page active">
<div class="card">
<div class="card-header">
<h2 class="card-title"><i class="fas fa-clock"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ£Ø®ÙŠØ±</h2>
<input type="date" class="form-input" id="delaysDate" style="width:auto;" onchange="app.loadDelays()">
</div>

<div class="filters-section">
<div class="filters-grid">
<div><label class="form-label">Ø§Ù„ØµÙ</label><select class="form-select" id="delaysGradeFilter" onchange="app.loadDelays()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option></select></div>
<div><label class="form-label">Ø§Ù„ÙØµÙ„</label><select class="form-select" id="delaysClassFilter" onchange="app.loadDelays()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option></select></div>
</div>
<div class="filter-actions">
<button class="btn btn-primary" onclick="app.selectAllDelays()"><i class="fas fa-check-square"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
<button class="btn btn-secondary" onclick="app.deselectAllDelays()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
<button class="btn btn-success" onclick="app.saveDelaysToRecord()"><i class="fas fa-save"></i>Ø­ÙØ¸</button>
<button class="btn btn-whatsapp" onclick="app.sendDelaysWhatsApp()"><i class="fab fa-whatsapp"></i>ÙˆØ§ØªØ³Ø§Ø¨</button>
</div>
</div>

<div class="search-box">
<input type="text" class="search-input" id="delaysSearch" placeholder="Ø¨Ø­Ø«..." oninput="app.searchDelays()">
<i class="fas fa-search search-icon"></i>
</div>

<div id="delaysList"></div>
</div>
</div>

<div id="absencesSubPage" class="sub-page">
<div class="card">
<div class="card-header">
<h2 class="card-title"><i class="fas fa-user-times"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</h2>
<input type="date" class="form-input" id="absencesDate" style="width:auto;" onchange="app.loadAbsences()">
</div>

<div class="filters-section">
<div class="filters-grid">
<div><label class="form-label">Ø§Ù„ØµÙ</label><select class="form-select" id="absencesGradeFilter" onchange="app.loadAbsences()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option></select></div>
<div><label class="form-label">Ø§Ù„ÙØµÙ„</label><select class="form-select" id="absencesClassFilter" onchange="app.loadAbsences()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option></select></div>
</div>
<div class="filter-actions">
<button class="btn btn-primary" onclick="app.selectAllAbsences()"><i class="fas fa-check-square"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
<button class="btn btn-secondary" onclick="app.deselectAllAbsences()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
<button class="btn btn-success" onclick="app.saveAbsencesToRecord()"><i class="fas fa-save"></i>Ø­ÙØ¸</button>
<button class="btn btn-whatsapp" onclick="app.sendAbsencesWhatsApp()"><i class="fab fa-whatsapp"></i>ÙˆØ§ØªØ³Ø§Ø¨</button>
</div>
</div>

<div class="search-box">
<input type="text" class="search-input" id="absencesSearch" placeholder="Ø¨Ø­Ø«..." oninput="app.searchAbsences()">
<i class="fas fa-search search-icon"></i>
</div>

<div id="absencesList"></div>
</div>
</div>
</div>

<div id="notesPage" class="page">
<div class="card">
<div class="card-header">
<h2 class="card-title"><i class="fas fa-sticky-note"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
<input type="date" class="form-input" id="notesDate" style="width:auto;" onchange="app.loadNotes()">
</div>

<div class="filters-section">
<div class="filters-grid">
<div><label class="form-label">Ø§Ù„ØµÙ</label><select class="form-select" id="notesGradeFilter" onchange="app.loadNotes()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option></select></div>
<div><label class="form-label">Ø§Ù„ÙØµÙ„</label><select class="form-select" id="notesClassFilter" onchange="app.loadNotes()"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option></select></div>
</div>
<div><label class="form-label">Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label><textarea class="form-textarea" id="noteText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©..."></textarea></div>
<div class="filter-actions">
<button class="btn btn-primary" onclick="app.selectAllNotes()"><i class="fas fa-check-square"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
<button class="btn btn-secondary" onclick="app.deselectAllNotes()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
<button class="btn btn-success" onclick="app.saveNotesToRecord()"><i class="fas fa-save"></i>Ø­ÙØ¸</button>
<button class="btn btn-whatsapp" onclick="app.sendNotesWhatsApp()"><i class="fab fa-whatsapp"></i>ÙˆØ§ØªØ³Ø§Ø¨</button>
</div>
</div>

<div class="search-box">
<input type="text" class="search-input" id="notesSearch" placeholder="Ø¨Ø­Ø«..." oninput="app.searchNotes()">
<i class="fas fa-search search-icon"></i>
</div>

<div id="notesList"></div>
</div>
</div>

<div id="statisticsPage" class="page">
<div class="sub-tabs">
<div class="sub-tab active" onclick="app.showSubPage('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
<div class="sub-tab" onclick="app.showSubPage('levels')">ğŸ¯ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨</div>
</div>

<div id="statsSubPage" class="sub-page active">
<div class="card">
<div class="card-header"><h2 class="card-title"><i class="fas fa-chart-line"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨</h2></div>

<div class="sub-tabs">
<div class="sub-tab active" onclick="app.showStatsView('daily')">ğŸ“… ÙŠÙˆÙ…ÙŠ</div>
<div class="sub-tab" onclick="app.showStatsView('weekly')">ğŸ“† Ø£Ø³Ø¨ÙˆØ¹ÙŠ</div>
<div class="sub-tab" onclick="app.showStatsView('monthly')">ğŸ—“ï¸ Ø´Ù‡Ø±ÙŠ</div>
</div>

<div id="dailyStats" class="sub-page active">
<div class="form-group"><label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" class="form-input" id="dailyStatsDate" onchange="app.generateDailyStats()"></div>
<div id="dailyStatsContent"></div>
</div>

<div id="weeklyStats" class="sub-page">
<div class="form-group"><label class="form-label">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label><input type="week" class="form-input" id="weeklyStatsDate" onchange="app.generateWeeklyStats()"></div>
<div id="weeklyStatsContent"></div>
</div>

<div id="monthlyStats" class="sub-page">
<div class="form-group"><label class="form-label">Ø§Ù„Ø´Ù‡Ø±</label><input type="month" class="form-input" id="monthlyStatsDate" onchange="app.generateMonthlyStats()"></div>
<div id="monthlyStatsContent"></div>
</div>
</div>
</div>

<div id="levelsSubPage" class="sub-page">
<div class="card">
<div class="card-header">
<h2 class="card-title"><i class="fas fa-layer-group"></i>Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨</h2>
<button class="btn btn-primary" onclick="app.showLevelsSettings()"><i class="fas fa-sliders-h"></i>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</div>
<div class="levels-grid" id="levelsGrid"></div>
</div>
</div>
</div>

<div id="reportsPage" class="page">
<div class="card">
<div class="card-header"><h2 class="card-title"><i class="fas fa-print"></i>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2></div>

<div class="form-group"><label class="form-label">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
<select class="form-select" id="reportType">
<option value="delays">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ£Ø®ÙŠØ±</option>
<option value="absences">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨</option>
<option value="notes">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
<option value="comprehensive">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</option>
</select>
</div>

<div class="form-group"><label class="form-label">Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
<select class="form-select" id="reportScope" onchange="app.handleReportScope()">
<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</option>
<option value="dateRange">Ù†Ø·Ø§Ù‚ Ø²Ù…Ù†ÙŠ</option>
<option value="student">Ø·Ø§Ù„Ø¨ Ù…Ø­Ø¯Ø¯</option>
</select>
</div>

<div id="dateRangeSection" style="display:none;">
<div class="d-flex gap-10" style="flex-wrap:wrap;margin-bottom:20px;">
<div style="flex:1;" class="form-group"><label class="form-label">Ù…Ù†</label><input type="date" class="form-input" id="reportStartDate"></div>
<div style="flex:1;" class="form-group"><label class="form-label">Ø¥Ù„Ù‰</label><input type="date" class="form-input" id="reportEndDate"></div>
</div>
</div>

<div id="studentSection" style="display:none;">
<div class="form-group"><label class="form-label">Ø§Ù„Ø·Ø§Ù„Ø¨</label><select class="form-select" id="reportStudent"></select></div>
</div>

<div class="d-flex gap-10" style="flex-wrap:wrap;margin-top:20px;">
<button class="btn btn-primary" onclick="app.generatePrintReport()"><i class="fas fa-eye"></i>Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
<button class="btn btn-success" onclick="app.printReport()"><i class="fas fa-print"></i>Ø·Ø¨Ø§Ø¹Ø©</button>
<button class="btn btn-info" onclick="app.exportReportExcel()"><i class="fas fa-file-excel"></i>Excel</button>
</div>

<div id="reportPreview" style="margin-top:30px;"></div>
</div>
</div>

<div id="settingsPage" class="page">
<div class="card">
<div class="card-header"><h2 class="card-title"><i class="fas fa-cog"></i>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2></div>

<div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input type="text" class="form-input" id="schoolName" value="Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©"></div>
<div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</label><input type="text" class="form-input" id="teacherName" value="Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯"></div>

<div style="background:#f8f9fa;padding:20px;border-radius:12px;margin:20px 0;">
<h3 style="color:#1a237e;margin-bottom:15px;"><i class="fas fa-crown" style="color:#ffd700;"></i> Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h3>
<div style="display:grid;gap:10px;">
<div style="display:flex;justify-content:space-between;padding:10px;background:white;border-radius:8px;"><span>Ø§Ù„Ø­Ø§Ù„Ø©:</span><span id="settingsStatus">ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</span></div>
<div style="display:flex;justify-content:space-between;padding:10px;background:white;border-radius:8px;"><span>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</span><span id="settingsExpiry">--</span></div>
<div style="display:flex;justify-content:space-between;padding:10px;background:white;border-radius:8px;"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span><span id="settingsDaysLeft">7 Ø£ÙŠØ§Ù…</span></div>
</div>
</div>

<div style="background:#e3f2fd;padding:20px;border-radius:12px;margin-bottom:20px;">
<h3 style="color:#1a237e;margin-bottom:10px;"><i class="fas fa-key"></i> Ø§Ù„ØªÙØ¹ÙŠÙ„</h3>
<input type="text" id="activationCodeSettings" data-allow="true" placeholder="SK-XXXXX-XXXXX" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;margin-bottom:15px;font-family:monospace;text-align:center;text-transform:uppercase;">
<button onclick="app.activateSubscription('settings')" class="btn btn-success w-100" data-allow="true"><i class="fas fa-check-circle"></i> ØªÙØ¹ÙŠÙ„</button>
<button onclick="app.showPaymentPage()" class="btn btn-primary w-100" data-allow="true" style="margin-top:10px;"><i class="fas fa-shopping-cart"></i> Ø´Ø±Ø§Ø¡ ÙƒÙˆØ¯</button>
</div>

<div class="d-flex gap-10" style="flex-wrap:wrap;">
<button class="btn btn-primary" onclick="app.saveSettings()"><i class="fas fa-save"></i>Ø­ÙØ¸</button>
<button class="btn btn-danger" onclick="app.resetApp()"><i class="fas fa-redo"></i>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
</div>

<div style="margin-top:30px;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:12px;color:white;text-align:center;">
<div style="font-size:2.5rem;margin-bottom:10px;">ğŸ‘¨â€ğŸ’»</div>
<h3 style="margin-bottom:5px;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ</h3>
<p style="font-size:14px;opacity:0.9;margin-bottom:15px;">v6.0 | Ø£ÙƒØªÙˆØ¨Ø± 2025</p>
<a href="https://wa.me/966533371147" class="btn btn-whatsapp" target="_blank" style="display:inline-flex;text-decoration:none;"><i class="fab fa-whatsapp"></i>ØªÙˆØ§ØµÙ„</a>
</div>
</div>
</div>

</div>

<div id="studentModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title" id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</h3>
<button class="modal-close" onclick="app.closeStudentModal()">Ã—</button>
</div>
<form onsubmit="app.saveStudent(event)">
<div class="form-group"><label class="form-label">Ø§Ù„Ø§Ø³Ù…</label><input type="text" class="form-input" id="studentName" required></div>
<div class="form-group"><label class="form-label">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</label><input type="text" class="form-input" id="studentID" required></div>
<div class="form-group"><label class="form-label">Ø§Ù„Ø¬ÙˆØ§Ù„</label><input type="tel" class="form-input" id="studentPhone"></div>
<div class="form-group"><label class="form-label">Ø§Ù„ØµÙ</label><select class="form-select" id="studentGrade" required><option value="">Ø§Ø®ØªØ±</option></select></div>
<div class="form-group"><label class="form-label">Ø§Ù„ÙØµÙ„</label><select class="form-select" id="studentClass" required><option value="">Ø§Ø®ØªØ±</option></select></div>
<div class="d-flex gap-10"><button type="submit" class="btn btn-primary" style="flex:1;">Ø­ÙØ¸</button><button type="button" class="btn btn-secondary" style="flex:1;" onclick="app.closeStudentModal()">Ø¥Ù„ØºØ§Ø¡</button></div>
</form>
</div>
</div>

<div id="levelsModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</h3>
<button class="modal-close" onclick="app.closeLevelsModal()">Ã—</button>
</div>
<form onsubmit="app.saveLevelsSettings(event)">
<div class="form-group"><label class="form-label">ğŸŸ¢ Ø¢Ù…Ù† (Ù…Ù†-Ø¥Ù„Ù‰)</label><div class="d-flex gap-10"><input type="number" class="form-input" id="safeMin" value="0" min="0"><input type="number" class="form-input" id="safeMax" value="2" min="0"></div></div>
<div class="form-group"><label class="form-label">ğŸŸ¡ Ø§Ù†ØªØ¨Ù‡ (Ù…Ù†-Ø¥Ù„Ù‰)</label><div class="d-flex gap-10"><input type="number" class="form-input" id="attentionMin" value="3" min="0"><input type="number" class="form-input" id="attentionMax" value="5" min="0"></div></div>
<div class="form-group"><label class="form-label">ğŸŸ  ØªØ­Ø°ÙŠØ± (Ù…Ù†-Ø¥Ù„Ù‰)</label><div class="d-flex gap-10"><input type="number" class="form-input" id="warningMin" value="6" min="0"><input type="number" class="form-input" id="warningMax" value="10" min="0"></div></div>
<div class="form-group"><label class="form-label">ğŸ”´ Ø®Ø·Ø± (Ù…Ù†)</label><input type="number" class="form-input" id="dangerMin" value="11" min="0"></div>
<div class="d-flex gap-10"><button type="submit" class="btn btn-primary" style="flex:1;">Ø­ÙØ¸</button><button type="button" class="btn btn-secondary" style="flex:1;" onclick="app.closeLevelsModal()">Ø¥Ù„ØºØ§Ø¡</button></div>
</form>
</div>
</div>

<div id="toast" class="toast"></div>

<script>
const firebaseConfig={apiKey:"AIzaSyAWcfGHGtV0123456789",authDomain:"attendance.firebaseapp.com",databaseURL:"https://attendance.firebaseio.com",projectId:"attendance"};
firebase.initializeApp(firebaseConfig);

class AttendanceApp{
constructor(){
this.students=[];this.delays={};this.absences={};this.notes={};
this.grades=['Ø§Ù„Ø£ÙˆÙ„','Ø§Ù„Ø«Ø§Ù†ÙŠ','Ø§Ù„Ø«Ø§Ù„Ø«','Ø§Ù„Ø±Ø§Ø¨Ø¹','Ø§Ù„Ø®Ø§Ù…Ø³','Ø§Ù„Ø³Ø§Ø¯Ø³'];
this.classes=['Ø£','Ø¨','Ø¬','Ø¯'];this.currentStudentId=null;
this.subscription={status:'trial',startDate:new Date().toISOString(),
expiryDate:new Date(Date.now()+7*24*60*60*1000).toISOString(),
activationCode:'',isActive:false};
this.levelsConfig={safe:{min:0,max:2},attention:{min:3,max:5},
warning:{min:6,max:10},danger:{min:11,max:999}};
this.init();
}

init(){
this.loadFromLocalStorage();this.setupEventListeners();
this.populateGradeClassSelects();this.updateUI();
this.checkSubscription();this.setTodayDate();
}

setupEventListeners(){
const excelFile=document.getElementById('excelFile');
if(excelFile)excelFile.addEventListener('change',(e)=>this.importExcel(e));
}

showPage(page){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    const pageEl=document.getElementById(page+'Page');
    if(pageEl) pageEl.classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n=>{
        const oncl = n.getAttribute('onclick') || '';
        if(oncl.includes(`showPage('${page}')`) || oncl.includes(`showPage("${page}")`)) n.classList.add('active');
    });
    if(page==='students')this.updateStudentsList();
    if(page==='attendance'){this.showSubPage('delays');this.loadDelays();}
    if(page==='notes')this.loadNotes();
    if(page==='statistics'){this.showSubPage('stats');this.showStatsView('daily');}
    if(page==='reports')this.populateReportStudents();
    if(page==='settings')this.loadSettings();
}
if(page==='notes')this.loadNotes();
if(page==='statistics'){this.showSubPage('stats');this.showStatsView('daily');}
if(page==='reports')this.populateReportStudents();
if(page==='settings')this.loadSettings();
}

showSubPage(subPage){
    if(subPage==='delays'||subPage==='absences'){
        document.querySelectorAll('#attendancePage .sub-tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('#attendancePage .sub-page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('#attendancePage .sub-tab').forEach(t=>{
            const oncl = t.getAttribute('onclick') || '';
            if(oncl.includes(`showSubPage('${subPage}')`) || oncl.includes(`showSubPage("${subPage}")`)) t.classList.add('active');
        });
        const sp=document.getElementById(subPage+'SubPage');
        if(sp) sp.classList.add('active');
        if(subPage==='delays') this.loadDelays();
        if(subPage==='absences') this.loadAbsences();
    } else if(subPage==='stats'||subPage==='levels'){
        document.querySelectorAll('#statisticsPage > .sub-tabs .sub-tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('#statisticsPage > .sub-page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('#statisticsPage > .sub-tabs .sub-tab').forEach(t=>{
            const oncl = t.getAttribute('onclick') || '';
            if(oncl.includes(`showSubPage('${subPage}')`) || oncl.includes(`showSubPage("${subPage}")`)) t.classList.add('active');
        });
        const sp=document.getElementById(subPage+'SubPage');
        if(sp) sp.classList.add('active');
        if(subPage==='stats') this.showStatsView('daily');
        if(subPage==='levels') this.generateLevels();
    }
}else if(subPage==='stats'||subPage==='levels'){
document.querySelectorAll('#statisticsPage > .sub-tabs .sub-tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('#statisticsPage > .sub-page').forEach(p=>p.classList.remove('active'));
event.target.classList.add('active');
document.getElementById(subPage+'SubPage').classList.add('active');
if(subPage==='stats')this.showStatsView('daily');
if(subPage==='levels')this.generateLevels();
}
}

showStatsView(view){
    document.querySelectorAll('#statsSubPage .sub-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('#statsSubPage .sub-page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('#statsSubPage .sub-tab').forEach(t=>{
        const oncl = t.getAttribute('onclick') || '';
        if(oncl.includes(`showStatsView('${view}')`) || oncl.includes(`showStatsView("${view}")`)) t.classList.add('active');
    });
    const vp=document.getElementById(view+'Stats');
    if(vp) vp.classList.add('active');
    if(view==='daily') this.generateDailyStats();
    if(view==='weekly') this.generateWeeklyStats();
    if(view==='monthly') this.generateMonthlyStats();
}

showAddStudentModal(){
document.getElementById('modalTitle').textContent='Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨';
document.getElementById('studentModal').classList.add('active');
this.currentStudentId=null;
document.querySelector('#studentModal form').reset();
}

showEditStudentModal(id){
const student=this.students.find(s=>s.id===id);
if(!student)return;
document.getElementById('modalTitle').textContent='ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨';
document.getElementById('studentName').value=student.name;
document.getElementById('studentID').value=student.civilId;
document.getElementById('studentPhone').value=student.phone||'';
document.getElementById('studentGrade').value=student.grade;
document.getElementById('studentClass').value=student.class;
document.getElementById('studentModal').classList.add('active');
this.currentStudentId=id;
}

closeStudentModal(){
document.getElementById('studentModal').classList.remove('active');
this.currentStudentId=null;
}

saveStudent(event){
event.preventDefault();
const student={
id:this.currentStudentId||Date.now().toString(),
name:document.getElementById('studentName').value.trim(),
civilId:document.getElementById('studentID').value.trim(),
phone:document.getElementById('studentPhone').value.trim(),
grade:document.getElementById('studentGrade').value,
class:document.getElementById('studentClass').value,
addedDate:this.currentStudentId?
(this.students.find(s=>s.id===this.currentStudentId)?.addedDate||new Date().toISOString()):
new Date().toISOString()
};

if(this.currentStudentId){
const index=this.students.findIndex(s=>s.id===this.currentStudentId);
this.students[index]=student;
this.showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«','success');
}else{
this.students.push(student);
this.showToast('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©','success');
}

this.saveToLocalStorage();
this.updateStudentsList();
this.closeStudentModal();
this.updateStats();
}

deleteStudent(id){
if(!confirm('Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ'))return;
this.students=this.students.filter(s=>s.id!==id);
Object.keys(this.delays).forEach(date=>delete this.delays[date][id]);
Object.keys(this.absences).forEach(date=>delete this.absences[date][id]);
Object.keys(this.notes).forEach(date=>delete this.notes[date][id]);
this.saveToLocalStorage();
this.updateStudentsList();
this.showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù','success');
this.updateStats();
}

deleteAllStudents(){
if(!confirm('Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ'))return;
if(prompt('Ø§ÙƒØªØ¨ "Ù†Ø¹Ù…"')!=='Ù†Ø¹Ù…')return;
this.students=[];this.delays={};this.absences={};this.notes={};
this.saveToLocalStorage();
this.updateStudentsList();
this.updateStats();
this.showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù','info');
}

searchStudents(){
const searchTerm=document.getElementById('studentSearch').value.toLowerCase();
const filtered=this.students.filter(s=>
s.name.toLowerCase().includes(searchTerm)||
s.civilId.includes(searchTerm)
);
this.updateStudentsList(filtered);
}

updateStudentsList(students=this.students){
const list=document.getElementById('studentsList');
if(students.length===0){
list.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</div></div>';
return;
}

list.innerHTML='<div class="student-list">'+students.map(s=>{
const record=this.getStudentRecord(s.id);
return `
<div class="student-item">
<div class="student-info">
<div class="student-name">${s.name}</div>
<div class="student-details">
<span class="student-detail"><i class="fas fa-id-card"></i>${s.civilId}</span>
<span class="student-detail"><i class="fas fa-phone"></i>${s.phone||'--'}</span>
<span class="student-detail"><i class="fas fa-graduation-cap"></i>${s.grade} - ${s.class}</span>
</div>
<div class="student-record">
<span class="record-badge delays"><i class="fas fa-clock"></i> ${record.delays}</span>
<span class="record-badge absences"><i class="fas fa-times-circle"></i> ${record.absences}</span>
<span class="record-badge notes"><i class="fas fa-sticky-note"></i> ${record.notes}</span>
</div>
</div>
<div class="student-actions">
<button class="btn-icon edit" onclick="app.showEditStudentModal('${s.id}')"><i class="fas fa-edit"></i></button>
<button class="btn-icon delete" onclick="app.deleteStudent('${s.id}')"><i class="fas fa-trash"></i></button>
</div>
</div>
`;
}).join('')+'</div>';
}

getStudentRecord(studentId){
let delays=0,absences=0,notes=0;
Object.keys(this.delays).forEach(date=>{if(this.delays[date][studentId])delays++;});
Object.keys(this.absences).forEach(date=>{if(this.absences[date][studentId])absences++;});
Object.keys(this.notes).forEach(date=>{if(this.notes[date][studentId])notes++;});
return{delays,absences,notes};
}

importExcel(e){
const file=e.target.files[0];
if(!file)return;
const reader=new FileReader();
reader.onload=(ev)=>{
try{
const data=new Uint8Array(ev.target.result);
const workbook=XLSX.read(data,{type:'array'});
const firstSheet=workbook.Sheets[workbook.SheetNames[0]];
const jsonData=XLSX.utils.sheet_to_json(firstSheet,{header:1});

let imported=0;
const newGrades=new Set(this.grades);
const newClasses=new Set(this.classes);

for(let i=1;i<jsonData.length;i++){
const row=jsonData[i];
if(!row[0])continue;

const grade=String(row[3]||'').trim();
const classVal=String(row[4]||'').trim();

if(grade&&!newGrades.has(grade))newGrades.add(grade);
if(classVal&&!newClasses.has(classVal))newClasses.add(classVal);

const student={
id:Date.now().toString()+i,
name:String(row[0]||'').trim(),
civilId:String(row[1]||'').trim(),
phone:String(row[2]||'').trim(),
grade:grade,
class:classVal,
addedDate:new Date().toISOString()
};

if(student.name&&student.civilId&&student.grade&&student.class){
this.students.push(student);
imported++;
}
}

this.grades=Array.from(newGrades);
this.classes=Array.from(newClasses);
this.populateGradeClassSelects();
this.saveToLocalStorage();
this.updateStudentsList();
this.updateStats();
this.showToast(`Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${imported} Ø·Ø§Ù„Ø¨`,'success');
e.target.value='';
}catch(error){
this.showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù','error');
}
};
reader.readAsArrayBuffer(file);
}

exportStudentsExcel(){
if(this.students.length===0){
this.showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨','error');
return;
}

const data=[
['#','Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ø³Ø¬Ù„','Ø§Ù„Ø¬ÙˆØ§Ù„','Ø§Ù„ØµÙ','Ø§Ù„ÙØµÙ„','Ø§Ù„ØªØ£Ø®ÙŠØ±','Ø§Ù„ØºÙŠØ§Ø¨','Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª'],
...this.students.map((s,i)=>{
const record=this.getStudentRecord(s.id);
return[i+1,s.name,s.civilId,s.phone||'',s.grade,s.class,record.delays,record.absences,record.notes];
})
];

const ws=XLSX.utils.aoa_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,'Ø§Ù„Ø·Ù„Ø§Ø¨');
XLSX.writeFile(wb,`Ø§Ù„Ø·Ù„Ø§Ø¨_${new Date().toISOString().split('T')[0]}.xlsx`);
this.showToast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±','success');
}

populateGradeClassSelects(){
['studentGrade','delaysGradeFilter','absencesGradeFilter','notesGradeFilter'].forEach(id=>{
const select=document.getElementById(id);
if(select){
const currentValue=select.value;
const isFilter=id.includes('Filter');
select.innerHTML=isFilter?'<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>':'<option value="">Ø§Ø®ØªØ±</option>';
this.grades.forEach(grade=>{
select.innerHTML+=`<option value="${grade}">${grade}</option>`;
});
if(currentValue)select.value=currentValue;
}
});

['studentClass','delaysClassFilter','absencesClassFilter','notesClassFilter'].forEach(id=>{
const select=document.getElementById(id);
if(select){
const currentValue=select.value;
const isFilter=id.includes('Filter');
select.innerHTML=isFilter?'<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>':'<option value="">Ø§Ø®ØªØ±</option>';
this.classes.forEach(cls=>{
select.innerHTML+=`<option value="${cls}">${cls}</option>`;
});
if(currentValue)select.value=currentValue;
}
});
}

loadDelays(){
const date=document.getElementById('delaysDate').value;
if(!date)return;

const gradeFilter=document.getElementById('delaysGradeFilter').value;
const classFilter=document.getElementById('delaysClassFilter').value;

let filtered=this.students;
if(gradeFilter)filtered=filtered.filter(s=>s.grade===gradeFilter);
if(classFilter)filtered=filtered.filter(s=>s.class===classFilter);

const list=document.getElementById('delaysList');
if(filtered.length===0){
list.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div></div>';
return;
}

list.innerHTML='<div class="student-list">'+filtered.map(s=>{
const isDelayed=this.delays[date]?.[s.id]||false;
return`
<div class="student-item ${isDelayed?'selected':''}" id="delay_${s.id}">
<input type="checkbox" class="student-checkbox" ${isDelayed?'checked':''} onchange="app.toggleDelay('${s.id}')">
<div class="student-info">
<div class="student-name">${s.name}</div>
<div class="student-details">
<span class="student-detail"><i class="fas fa-graduation-cap"></i>${s.grade} - ${s.class}</span>
</div>
</div>
</div>
`;
}).join('')+'</div>';
}

toggleDelay(studentId){
const date=document.getElementById('delaysDate').value;
if(!this.delays[date])this.delays[date]={};
this.delays[date][studentId]=!this.delays[date][studentId];
if(!this.delays[date][studentId])delete this.delays[date][studentId];
document.getElementById(`delay_${studentId}`).classList.toggle('selected');
}

searchDelays(){
const searchTerm=document.getElementById('delaysSearch').value.toLowerCase();
document.querySelectorAll('#delaysList .student-item').forEach(item=>{
const name=item.querySelector('.student-name').textContent.toLowerCase();
item.style.display=name.includes(searchTerm)?'':'none';
});
}

selectAllDelays(){
const date=document.getElementById('delaysDate').value;
if(!this.delays[date])this.delays[date]={};
document.querySelectorAll('#delaysList .student-checkbox').forEach(cb=>{
cb.checked=true;
const studentId=cb.parentElement.id.replace('delay_','');
this.delays[date][studentId]=true;
cb.parentElement.classList.add('selected');
});
}

deselectAllDelays(){
const date=document.getElementById('delaysDate').value;
if(this.delays[date])this.delays[date]={};
document.querySelectorAll('#delaysList .student-checkbox').forEach(cb=>{
cb.checked=false;
cb.parentElement.classList.remove('selected');
});
}

saveDelaysToRecord(){
this.saveToLocalStorage();
this.showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸','success');
this.updateStats();
}

sendDelaysWhatsApp(){
const date=document.getElementById('delaysDate').value;
const delayed=this.delays[date]||{};
const delayedStudents=this.students.filter(s=>delayed[s.id]);

if(delayedStudents.length===0){
this.showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯','error');
return;
}

const schoolName=localStorage.getItem('schoolName')||'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©';
let message=`*ØªØ£Ø®ÙŠØ± - ${schoolName}*
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(date).toLocaleDateString('ar-SA')}

`;
delayedStudents.forEach((s,i)=>{
message+=`${i+1}. ${s.name} - ${s.grade} ${s.class}
`;
});

window.open(`https://wa.me/?text=${encodeURIComponent(message)}`,'_blank');
}

loadAbsences(){
const date=document.getElementById('absencesDate').value;
if(!date)return;

const gradeFilter=document.getElementById('absencesGradeFilter').value;
const classFilter=document.getElementById('absencesClassFilter').value;

let filtered=this.students;
if(gradeFilter)filtered=filtered.filter(s=>s.grade===gradeFilter);
if(classFilter)filtered=filtered.filter(s=>s.class===classFilter);

const list=document.getElementById('absencesList');
if(filtered.length===0){
list.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div></div>';
return;
}

list.innerHTML='<div class="student-list">'+filtered.map(s=>{
const isAbsent=this.absences[date]?.[s.id]||false;
return`
<div class="student-item ${isAbsent?'selected':''}" id="absence_${s.id}">
<input type="checkbox" class="student-checkbox" ${isAbsent?'checked':''} onchange="app.toggleAbsence('${s.id}')">
<div class="student-info">
<div class="student-name">${s.name}</div>
<div class="student-details">
<span class="student-detail"><i class="fas fa-graduation-cap"></i>${s.grade} - ${s.class}</span>
</div>
</div>
</div>
`;
}).join('')+'</div>';
}

toggleAbsence(studentId){
const date=document.getElementById('absencesDate').value;
if(!this.absences[date])this.absences[date]={};
this.absences[date][studentId]=!this.absences[date][studentId];
if(!this.absences[date][studentId])delete this.absences[date][studentId];
document.getElementById(`absence_${studentId}`).classList.toggle('selected');
}

searchAbsences(){
const searchTerm=document.getElementById('absencesSearch').value.toLowerCase();
document.querySelectorAll('#absencesList .student-item').forEach(item=>{
const name=item.querySelector('.student-name').textContent.toLowerCase();
item.style.display=name.includes(searchTerm)?'':'none';
});
}

selectAllAbsences(){
const date=document.getElementById('absencesDate').value;
if(!this.absences[date])this.absences[date]={};
document.querySelectorAll('#absencesList .student-checkbox').forEach(cb=>{
cb.checked=true;
const studentId=cb.parentElement.id.replace('absence_','');
this.absences[date][studentId]=true;
cb.parentElement.classList.add('selected');
});
}

deselectAllAbsences(){
const date=document.getElementById('absencesDate').value;
if(this.absences[date])this.absences[date]={};
document.querySelectorAll('#absencesList .student-checkbox').forEach(cb=>{
cb.checked=false;
cb.parentElement.classList.remove('selected');
});
}

saveAbsencesToRecord(){
this.saveToLocalStorage();
this.showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸','success');
this.updateStats();
}

sendAbsencesWhatsApp(){
const date=document.getElementById('absencesDate').value;
const absent=this.absences[date]||{};
const absentStudents=this.students.filter(s=>absent[s.id]);

if(absentStudents.length===0){
this.showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯','error');
return;
}

const schoolName=localStorage.getItem('schoolName')||'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©';
let message=`*ØºÙŠØ§Ø¨ - ${schoolName}*
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(date).toLocaleDateString('ar-SA')}

`;
absentStudents.forEach((s,i)=>{
message+=`${i+1}. ${s.name} - ${s.grade} ${s.class}
`;
});

window.open(`https://wa.me/?text=${encodeURIComponent(message)}`,'_blank');
}

loadNotes(){
const date=document.getElementById('notesDate').value;
if(!date)return;

const gradeFilter=document.getElementById('notesGradeFilter').value;
const classFilter=document.getElementById('notesClassFilter').value;

let filtered=this.students;
if(gradeFilter)filtered=filtered.filter(s=>s.grade===gradeFilter);
if(classFilter)filtered=filtered.filter(s=>s.class===classFilter);

const list=document.getElementById('notesList');
if(filtered.length===0){
list.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div></div>';
return;
}

list.innerHTML='<div class="student-list">'+filtered.map(s=>{
const hasNote=this.notes[date]?.[s.id]||false;
return`
<div class="student-item ${hasNote?'selected':''}" id="note_${s.id}">
<input type="checkbox" class="student-checkbox" ${hasNote?'checked':''} onchange="app.toggleNote('${s.id}')">
<div class="student-info">
<div class="student-name">${s.name}</div>
<div class="student-details">
<span class="student-detail"><i class="fas fa-graduation-cap"></i>${s.grade} - ${s.class}</span>
</div>
${hasNote?`<div style="margin-top:8px;padding:8px;background:#fff3cd;border-radius:6px;font-size:13px;">${this.notes[date][s.id]}</div>`:''}
</div>
</div>
`;
}).join('')+'</div>';
}

toggleNote(studentId){
const checkbox=document.querySelector(`#note_${studentId} .student-checkbox`);
const item=document.getElementById(`note_${studentId}`);
if(checkbox.checked){
item.classList.add('selected');
}else{
item.classList.remove('selected');
const date=document.getElementById('notesDate').value;
if(this.notes[date]?.[studentId]){
delete this.notes[date][studentId];
this.loadNotes();
}
}
}

searchNotes(){
const searchTerm=document.getElementById('notesSearch').value.toLowerCase();
document.querySelectorAll('#notesList .student-item').forEach(item=>{
const name=item.querySelector('.student-name').textContent.toLowerCase();
item.style.display=name.includes(searchTerm)?'':'none';
});
}

selectAllNotes(){
document.querySelectorAll('#notesList .student-checkbox').forEach(cb=>{
cb.checked=true;
cb.parentElement.classList.add('selected');
});
}

deselectAllNotes(){
document.querySelectorAll('#notesList .student-checkbox').forEach(cb=>{
cb.checked=false;
cb.parentElement.classList.remove('selected');
});
}

saveNotesToRecord(){
const date=document.getElementById('notesDate').value;
const noteText=document.getElementById('noteText').value.trim();

if(!noteText){
this.showToast('Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©','error');
return;
}

const selectedStudents=[];
document.querySelectorAll('#notesList .student-checkbox:checked').forEach(cb=>{
const studentId=cb.parentElement.id.replace('note_','');
selectedStudents.push(studentId);
});

if(selectedStudents.length===0){
this.showToast('Ø­Ø¯Ø¯ Ø·Ø§Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','error');
return;
}

if(!this.notes[date])this.notes[date]={};
selectedStudents.forEach(id=>{
this.notes[date][id]=noteText;
});

this.saveToLocalStorage();
this.showToast(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù€ ${selectedStudents.length} Ø·Ø§Ù„Ø¨`,'success');
document.getElementById('noteText').value='';
this.loadNotes();
this.updateStats();
}

sendNotesWhatsApp(){
const date=document.getElementById('notesDate').value;
const noteText=document.getElementById('noteText').value.trim();

const selectedStudents=[];
document.querySelectorAll('#notesList .student-checkbox:checked').forEach(cb=>{
const studentId=cb.parentElement.id.replace('note_','');
const student=this.students.find(s=>s.id===studentId);
if(student)selectedStudents.push(student);
});

if(selectedStudents.length===0||!noteText){
this.showToast('Ø­Ø¯Ø¯ Ø·Ù„Ø§Ø¨ ÙˆØ§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©','error');
return;
}

const schoolName=localStorage.getItem('schoolName')||'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©';
let message=`*Ù…Ù„Ø§Ø­Ø¸Ø© - ${schoolName}*
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(date).toLocaleDateString('ar-SA')}

*Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:* ${noteText}

`;
selectedStudents.forEach((s,i)=>{
message+=`${i+1}. ${s.name} - ${s.grade} ${s.class}
`;
});

window.open(`https://wa.me/?text=${encodeURIComponent(message)}`,'_blank');
}

generateDailyStats(){
const date=document.getElementById('dailyStatsDate').value||new Date().toISOString().split('T')[0];
document.getElementById('dailyStatsDate').value=date;

const delayed=this.delays[date]||{};
const absent=this.absences[date]||{};
const noted=this.notes[date]||{};

const delayedCount=Object.keys(delayed).length;
const absentCount=Object.keys(absent).length;
const notedCount=Object.keys(noted).length;
const presentCount=this.students.length-absentCount;

document.getElementById('dailyStatsContent').innerHTML=`
<div class="stats-grid">
<div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-value">${presentCount}</div><div class="stat-label">Ø­Ø§Ø¶Ø±</div></div>
<div class="stat-card"><div class="stat-icon">â°</div><div class="stat-value">${delayedCount}</div><div class="stat-label">Ù…ØªØ£Ø®Ø±</div></div>
<div class="stat-card"><div class="stat-icon">âŒ</div><div class="stat-value">${absentCount}</div><div class="stat-label">ØºØ§Ø¦Ø¨</div></div>
<div class="stat-card"><div class="stat-icon">ğŸ“</div><div class="stat-value">${notedCount}</div><div class="stat-label">Ù…Ù„Ø§Ø­Ø¸Ø©</div></div>
</div>
`;
}

generateWeeklyStats(){
const weekInput=document.getElementById('weeklyStatsDate').value;
if(!weekInput)return;

const[year,week]=weekInput.split('-W');
const dates=this.getWeekDates(year,week);

let totalDelays=0,totalAbsences=0,totalNotes=0;
dates.forEach(date=>{
totalDelays+=Object.keys(this.delays[date]||{}).length;
totalAbsences+=Object.keys(this.absences[date]||{}).length;
totalNotes+=Object.keys(this.notes[date]||{}).length;
});

document.getElementById('weeklyStatsContent').innerHTML=`
<div class="stats-grid">
<div class="stat-card"><div class="stat-icon">â°</div><div class="stat-value">${totalDelays}</div><div class="stat-label">Ø§Ù„ØªØ£Ø®ÙŠØ±</div></div>
<div class="stat-card"><div class="stat-icon">âŒ</div><div class="stat-value">${totalAbsences}</div><div class="stat-label">Ø§Ù„ØºÙŠØ§Ø¨</div></div>
<div class="stat-card"><div class="stat-icon">ğŸ“</div><div class="stat-value">${totalNotes}</div><div class="stat-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div></div>
</div>
`;
}

generateMonthlyStats(){
const monthInput=document.getElementById('monthlyStatsDate').value;
if(!monthInput)return;

const[year,month]=monthInput.split('-');
const dates=this.getMonthDates(year,month);

let totalDelays=0,totalAbsences=0,totalNotes=0;
dates.forEach(date=>{
totalDelays+=Object.keys(this.delays[date]||{}).length;
totalAbsences+=Object.keys(this.absences[date]||{}).length;
totalNotes+=Object.keys(this.notes[date]||{}).length;
});

document.getElementById('monthlyStatsContent').innerHTML=`
<div class="stats-grid">
<div class="stat-card"><div class="stat-icon">â°</div><div class="stat-value">${totalDelays}</div><div class="stat-label">Ø§Ù„ØªØ£Ø®ÙŠØ±</div></div>
<div class="stat-card"><div class="stat-icon">âŒ</div><div class="stat-value">${totalAbsences}</div><div class="stat-label">Ø§Ù„ØºÙŠØ§Ø¨</div></div>
<div class="stat-card"><div class="stat-icon">ğŸ“</div><div class="stat-value">${totalNotes}</div><div class="stat-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div></div>
</div>
`;
}

getWeekDates(year,week){
const dates=[];
const firstDayOfYear=new Date(year,0,1);
const daysOffset=(parseInt(week)-1)*7;
const startDate=new Date(firstDayOfYear.setDate(firstDayOfYear.getDate()+daysOffset));
for(let i=0;i<7;i++){
const date=new Date(startDate);
date.setDate(startDate.getDate()+i);
dates.push(date.toISOString().split('T')[0]);
}
return dates;
}

getMonthDates(year,month){
const dates=[];
const daysInMonth=new Date(year,month,0).getDate();
for(let day=1;day<=daysInMonth;day++){
const date=new Date(year,month-1,day);
dates.push(date.toISOString().split('T')[0]);
}
return dates;
}

generateLevels(){
const levels={safe:[],attention:[],warning:[],danger:[]};

this.students.forEach(s=>{
const absenceCount=Object.keys(this.absences).filter(date=>this.absences[date][s.id]).length;
if(absenceCount>=this.levelsConfig.danger.min)levels.danger.push({...s,absenceCount});
else if(absenceCount>=this.levelsConfig.warning.min)levels.warning.push({...s,absenceCount});
else if(absenceCount>=this.levelsConfig.attention.min)levels.attention.push({...s,absenceCount});
else levels.safe.push({...s,absenceCount});
});

document.getElementById('levelsGrid').innerHTML=`
<div class="level-card safe">
<div class="level-header"><div class="level-title">ğŸŸ¢ Ø¢Ù…Ù†</div><div class="level-count">${levels.safe.length}</div></div>
<div class="level-threshold">Ù…Ù† ${this.levelsConfig.safe.min} Ø¥Ù„Ù‰ ${this.levelsConfig.safe.max} Ø£ÙŠØ§Ù…</div>
<div class="level-students">${levels.safe.map(s=>`<div class="level-student"><span>${s.name}</span><span>${s.absenceCount} ÙŠÙˆÙ…</span></div>`).join('')}</div>
</div>
<div class="level-card attention">
<div class="level-header"><div class="level-title">ğŸŸ¡ Ø§Ù†ØªØ¨Ù‡</div><div class="level-count">${levels.attention.length}</div></div>
<div class="level-threshold">Ù…Ù† ${this.levelsConfig.attention.min} Ø¥Ù„Ù‰ ${this.levelsConfig.attention.max} Ø£ÙŠØ§Ù…</div>
<div class="level-students">${levels.attention.map(s=>`<div class="level-student"><span>${s.name}</span><span>${s.absenceCount} ÙŠÙˆÙ…</span></div>`).join('')}</div>
</div>
<div class="level-card warning">
<div class="level-header"><div class="level-title">ğŸŸ  ØªØ­Ø°ÙŠØ±</div><div class="level-count">${levels.warning.length}</div></div>
<div class="level-threshold">Ù…Ù† ${this.levelsConfig.warning.min} Ø¥Ù„Ù‰ ${this.levelsConfig.warning.max} Ø£ÙŠØ§Ù…</div>
<div class="level-students">${levels.warning.map(s=>`<div class="level-student"><span>${s.name}</span><span>${s.absenceCount} ÙŠÙˆÙ…</span></div>`).join('')}</div>
</div>
<div class="level-card danger">
<div class="level-header"><div class="level-title">ğŸ”´ Ø®Ø·Ø±</div><div class="level-count">${levels.danger.length}</div></div>
<div class="level-threshold">Ù…Ù† ${this.levelsConfig.danger.min} ÙŠÙˆÙ… ÙØ£ÙƒØ«Ø±</div>
<div class="level-students">${levels.danger.map(s=>`<div class="level-student"><span>${s.name}</span><span>${s.absenceCount} ÙŠÙˆÙ…</span></div>`).join('')}</div>
</div>
`;
}

showLevelsSettings(){
document.getElementById('levelsModal').classList.add('active');
document.getElementById('safeMin').value=this.levelsConfig.safe.min;
document.getElementById('safeMax').value=this.levelsConfig.safe.max;
document.getElementById('attentionMin').value=this.levelsConfig.attention.min;
document.getElementById('attentionMax').value=this.levelsConfig.attention.max;
document.getElementById('warningMin').value=this.levelsConfig.warning.min;
document.getElementById('warningMax').value=this.levelsConfig.warning.max;
document.getElementById('dangerMin').value=this.levelsConfig.danger.min;
}

closeLevelsModal(){
document.getElementById('levelsModal').classList.remove('active');
}

saveLevelsSettings(event){
event.preventDefault();
this.levelsConfig={
safe:{min:parseInt(document.getElementById('safeMin').value),max:parseInt(document.getElementById('safeMax').value)},
attention:{min:parseInt(document.getElementById('attentionMin').value),max:parseInt(document.getElementById('attentionMax').value)},
warning:{min:parseInt(document.getElementById('warningMin').value),max:parseInt(document.getElementById('warningMax').value)},
danger:{min:parseInt(document.getElementById('dangerMin').value),max:999}
};
this.saveToLocalStorage();
this.closeLevelsModal();
this.generateLevels();
this.showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸','success');
}

handleReportScope(){
const scope=document.getElementById('reportScope').value;
document.getElementById('dateRangeSection').style.display=scope==='dateRange'?'block':'none';
document.getElementById('studentSection').style.display=scope==='student'?'block':'none';
}

populateReportStudents(){
const select=document.getElementById('reportStudent');
select.innerHTML='<option value="">Ø§Ø®ØªØ±</option>'+
this.students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}

generatePrintReport(){
const type=document.getElementById('reportType').value;
const scope=document.getElementById('reportScope').value;

let html=`<div style="padding:20px;background:white;border-radius:12px;">`;
html+=`<h2 style="text-align:center;color:#1a237e;margin-bottom:20px;">ØªÙ‚Ø±ÙŠØ± ${this.getReportTypeName(type)}</h2>`;

if(type==='comprehensive'){
html+=this.generateComprehensiveReport(scope);
}else{
html+=this.generateSpecificReport(type,scope);
}

html+=`</div>`;
document.getElementById('reportPreview').innerHTML=html;
}

getReportTypeName(type){
const names={delays:'Ø§Ù„ØªØ£Ø®ÙŠØ±',absences:'Ø§Ù„ØºÙŠØ§Ø¨',notes:'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª',comprehensive:'Ø´Ø§Ù…Ù„'};
return names[type]||type;
}

generateComprehensiveReport(scope){
let html='<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#667eea;color:white;">';
html+='<th style="padding:10px;border:1px solid #ddd;">Ø§Ù„Ø§Ø³Ù…</th>';
html+='<th style="padding:10px;border:1px solid #ddd;">Ø§Ù„ØµÙ</th>';
html+='<th style="padding:10px;border:1px solid #ddd;">Ø§Ù„ØªØ£Ø®ÙŠØ±</th>';
html+='<th style="padding:10px;border:1px solid #ddd;">Ø§Ù„ØºÙŠØ§Ø¨</th>';
html+='<th style="padding:10px;border:1px solid #ddd;">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>';
html+='</tr></thead><tbody>';

let students=this.students;
if(scope==='student'){
const studentId=document.getElementById('reportStudent').value;
students=this.students.filter(s=>s.id===studentId);
}

students.forEach(s=>{
const record=this.getStudentRecord(s.id);
html+='<tr>';
html+=`<td style="padding:10px;border:1px solid #ddd;">${s.name}</td>`;
html+=`<td style="padding:10px;border:1px solid #ddd;">${s.grade} - ${s.class}</td>`;
html+=`<td style="padding:10px;border:1px solid #ddd;">${record.delays}</td>`;
html+=`<td style="padding:10px;border:1px solid #ddd;">${record.absences}</td>`;
html+=`<td style="padding:10px;border:1px solid #ddd;">${record.notes}</td>`;
html+='</tr>';
});

html+='</tbody></table>';
return html;
}

generateSpecificReport(type,scope){
const dataMap={delays:this.delays,absences:this.absences,notes:this.notes};
const data=dataMap[type];

let html='<div>';
Object.keys(data).forEach(date=>{
const records=data[date];
if(Object.keys(records).length>0){
html+=`<h3 style="color:#667eea;margin:15px 0;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(date).toLocaleDateString('ar-SA')}</h3>`;
html+='<ul>';
Object.keys(records).forEach(studentId=>{
const student=this.students.find(s=>s.id===studentId);
if(student){
const noteText=type==='notes'?` - ${records[studentId]}`:'';
html+=`<li style="padding:8px;border-bottom:1px solid #eee;">${student.name} - ${student.grade} ${student.class}${noteText}</li>`;
}
});
html+='</ul>';
}
});
html+='</div>';
return html;
}

printReport(){
window.print();
}

exportReportExcel(){
const type=document.getElementById('reportType').value;
const data=[
['#','Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ø³Ø¬Ù„','Ø§Ù„ØµÙ','Ø§Ù„ÙØµÙ„','Ø§Ù„ØªØ£Ø®ÙŠØ±','Ø§Ù„ØºÙŠØ§Ø¨','Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª'],
...this.students.map((s,i)=>{
const record=this.getStudentRecord(s.id);
return[i+1,s.name,s.civilId,s.grade,s.class,record.delays,record.absences,record.notes];
})
];

const ws=XLSX.utils.aoa_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,'Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
XLSX.writeFile(wb,`ØªÙ‚Ø±ÙŠØ±_${type}_${new Date().toISOString().split('T')[0]}.xlsx`);
this.showToast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±','success');
}

loadSettings(){
document.getElementById('schoolName').value=localStorage.getItem('schoolName')||'Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©';
document.getElementById('teacherName').value=localStorage.getItem('teacherName')||'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯';

const expiry=new Date(this.subscription.expiryDate);
const daysLeft=Math.ceil((expiry-new Date())/(1000*60*60*24));

document.getElementById('settingsStatus').textContent=this.subscription.isActive?'Ù…ÙØ¹Ù‘Ù„ âœ“':'ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©';
document.getElementById('settingsExpiry').textContent=expiry.toLocaleDateString('ar-SA');
document.getElementById('settingsDaysLeft').textContent=`${Math.max(0,daysLeft)} Ø£ÙŠØ§Ù…`;
}

saveSettings(){
localStorage.setItem('schoolName',document.getElementById('schoolName').value);
localStorage.setItem('teacherName',document.getElementById('teacherName').value);
this.showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸','success');
}

resetApp(){
if(!confirm('Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ØŸ'))return;
localStorage.clear();
location.reload();
}

checkSubscription(){
    const now=new Date();
    const expiry=new Date(this.subscription.expiryDate);
    const daysLeft=Math.ceil((expiry-now)/(1000*60*60*24));

    document.getElementById('trialDaysLeft').textContent=Math.max(0,daysLeft);

    if(this.subscription.isActive){
        document.getElementById('subscriptionStatus').textContent='Ù…ÙØ¹Ù‘Ù„ âœ“';
        document.getElementById('subscriptionExpiry').textContent=`ÙŠÙ†ØªÙ‡ÙŠ ${expiry.toLocaleDateString('ar-SA')}`;
        document.getElementById('subscriptionBadge').className='subscription-badge active';
        document.getElementById('lockScreen').style.display='none';
        this.displayActivationCode();
    } else if(daysLeft>0){
        document.getElementById('subscriptionStatus').textContent='ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©';
        document.getElementById('subscriptionExpiry').textContent=`Ù…ØªØ¨Ù‚ÙŠ ${daysLeft} Ø£ÙŠØ§Ù…`;
        document.getElementById('subscriptionBadge').className='subscription-badge trial';
        document.getElementById('lockScreen').style.display='none';
    } else {
        document.getElementById('lockScreen').style.display='flex';
    }
    setTimeout(() => this.applyActionLockState(), 100);
}`;
document.getElementById('subscriptionBadge').className='subscription-badge active';
document.getElementById('lockScreen').style.display='none';
this.displayActivationCode();
}else if(daysLeft>0){
document.getElementById('subscriptionStatus').textContent='ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©';
document.getElementById('subscriptionExpiry').textContent=`Ù…ØªØ¨Ù‚ÙŠ ${daysLeft} Ø£ÙŠØ§Ù…`;
document.getElementById('subscriptionBadge').className='subscription-badge trial';
document.getElementById('lockScreen').style.display='none';
}else{
document.getElementById('lockScreen').style.display='flex';
}
}

displayActivationCode(){
if(this.subscription.activationCode&&this.subscription.isActive){
const displayElement=document.getElementById('activationCodeDisplay');
if(displayElement){
displayElement.textContent=`ÙƒÙˆØ¯: ${this.subscription.activationCode}`;
}
}
}

activateSubscription(source='payment'){
const inputId=source==='settings'?'activationCodeSettings':'activationCodeInput';
const code=document.getElementById(inputId).value.trim().toUpperCase();

if(!code){
this.showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯','error');
return;
}

if(!/^SK-[A-Z0-9]{5}-[A-Z0-9]{5}$/.test(code)){
this.showToast('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­','error');
return;
}

this.subscription.status='active';
this.subscription.isActive=true;
this.subscription.activationCode=code;
this.subscription.expiryDate=new Date(Date.now()+365*24*60*60*1000).toISOString();

this.saveToLocalStorage();
this.checkSubscription();
this.hidePaymentPage();
this.showToast('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„!','success');
setTimeout(()=>location.reload(),2000);
}

showPaymentPage(){
document.getElementById('lockScreen').style.display='none';
document.getElementById('paymentPage').style.display='flex';
}

hidePaymentPage(){
document.getElementById('paymentPage').style.display='none';
document.getElementById('lockScreen').style.display='flex';
}

selectPaymentMethod(method){
document.querySelectorAll('.payment-method').forEach(m=>m.classList.remove('selected'));
document.querySelectorAll('[name="paymentMethod"]').forEach(r=>r.checked=false);

if(method==='bank'){
document.getElementById('bankTransfer').classList.add('selected');
document.querySelector('#bankTransfer input').checked=true;
}else if(method==='whatsapp'){
document.getElementById('whatsappPay').classList.add('selected');
document.querySelector('#whatsappPay input').checked=true;
}
}

copyToClipboard(text){
navigator.clipboard.writeText(text).then(()=>{
this.showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø®','success');
});
}

setTodayDate(){
const today=new Date().toISOString().split('T')[0];
['delaysDate','absencesDate','notesDate','dailyStatsDate'].forEach(id=>{
const input=document.getElementById(id);
if(input)input.value=today;
});
}

updateStats(){
const total=this.students.length;
document.getElementById('totalStudents').textContent=total;

const today=new Date().toISOString().split('T')[0];
const todayDelays=this.delays[today]||{};
const todayAbsences=this.absences[today]||{};
const todayNotes=this.notes[today]||{};

const delaysCount=Object.keys(todayDelays).length;
const absentCount=Object.keys(todayAbsences).length;
const notesCount=Object.keys(todayNotes).length;
const presentCount=total-absentCount;

document.getElementById('delaysToday').textContent=delaysCount;
document.getElementById('absentToday').textContent=absentCount;
document.getElementById('notesToday').textContent=notesCount;
document.getElementById('presentToday').textContent=presentCount;
}

updateUI(){
this.updateStudentsList();
this.updateStats();
}

saveToLocalStorage(){
localStorage.setItem('students',JSON.stringify(this.students));
localStorage.setItem('delays',JSON.stringify(this.delays));
localStorage.setItem('absences',JSON.stringify(this.absences));
localStorage.setItem('notes',JSON.stringify(this.notes));
localStorage.setItem('subscription',JSON.stringify(this.subscription));
localStorage.setItem('levelsConfig',JSON.stringify(this.levelsConfig));
localStorage.setItem('grades',JSON.stringify(this.grades));
localStorage.setItem('classes',JSON.stringify(this.classes));
}

loadFromLocalStorage(){
const students=localStorage.getItem('students');
const delays=localStorage.getItem('delays');
const absences=localStorage.getItem('absences');
const notes=localStorage.getItem('notes');
const subscription=localStorage.getItem('subscription');
const levelsConfig=localStorage.getItem('levelsConfig');
const grades=localStorage.getItem('grades');
const classes=localStorage.getItem('classes');

if(students)this.students=JSON.parse(students);
if(delays)this.delays=JSON.parse(delays);
if(absences)this.absences=JSON.parse(absences);
if(notes)this.notes=JSON.parse(notes);
if(subscription)this.subscription={...this.subscription,...JSON.parse(subscription)};
if(levelsConfig)this.levelsConfig=JSON.parse(levelsConfig);
if(grades)this.grades=JSON.parse(grades);
if(classes)this.classes=JSON.parse(classes);

this.updateStudentsList();
this.updateStats();
}

showToast(message,type='info'){
const toast=document.getElementById('toast');
const icons={success:'âœ“',error:'âœ—',info:'â„¹'};

toast.innerHTML=`<div class="toast-icon">${icons[type]}</div><div>${message}</div>`;
toast.className=`toast ${type} show`;

setTimeout(()=>toast.classList.remove('show'),3000);
}
}

var app=new AttendanceApp(); window.app=app;
</script>
</body>
</html>
